@* Support Chat Widget - Customer can chat with Admin/Manager/Staff *@
@if (User.Identity?.IsAuthenticated == true && !User.IsInRole("Admin") && !User.IsInRole("Manager") && !User.IsInRole("Staff"))
{
    <!-- Support Chat Widget -->
    <div id="support-chat-widget">
        <!-- Floating Button -->
        <button id="support-chat-btn" class="support-chat-floating-btn" aria-label="Chat with Support">
            <i class="fas fa-headset"></i>
            <span class="support-unread-badge" id="support-unread-badge" style="display: none;">0</span>
        </button>

        <!-- Chat Window -->
        <div id="support-chat-window" class="support-chat-window" style="display: none;">
            <!-- Chat Header -->
            <div class="support-chat-header">
                <div class="support-chat-header-info">
                    <div class="support-avatar-wrapper">
                        <div class="support-avatar support-logo">
                            <img src="~/images/logos/bloomie_logo.png" alt="Bloomie Shop" />
                        </div>
                        <span class="status-dot"></span>
                    </div>
                    <div>
                        <h3 class="support-chat-title">Hỗ Trợ Khách Hàng</h3>
                        <p class="support-chat-status" id="support-status">
                            Đang hoạt động
                        </p>
                    </div>
                </div>
                <button class="support-chat-close-btn" id="support-chat-close-btn" aria-label="Close">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Working Hours Banner -->
            <div id="working-hours-banner" class="working-hours-banner">
                <div class="working-hours-content">
                    <div class="working-hours-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="working-hours-info">
                        <div class="working-hours-status">
                            <span class="status-badge" id="shop-status-badge">Đang tải...</span>
                        </div>
                        <div class="working-hours-time">
                            <span id="working-hours-text">8:00 AM - 10:00 PM</span>
                        </div>
                        <div class="working-hours-next">
                            <small id="next-available-text"></small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div class="support-chat-messages" id="support-chat-messages">
                <div class="support-chat-welcome">
                    <i class="fas fa-comments"></i>
                    <p>Xin chào! Chúng tôi có thể giúp gì cho bạn?</p>
                </div>
                
                <!-- Quick Questions -->
                <div class="support-quick-questions" id="support-quick-questions">
                    <p class="quick-questions-title">Câu hỏi thường gặp:</p>
                    <button class="quick-question-btn" data-message="Tôi muốn kiểm tra đơn hàng">
                        <i class="fas fa-box"></i> Kiểm tra đơn hàng
                    </button>
                    <button class="quick-question-btn" data-message="Làm sao để đổi/trả hàng?">
                        <i class="fas fa-exchange-alt"></i> Đổi/trả hàng
                    </button>
                    <button class="quick-question-btn" data-message="Thời gian giao hàng bao lâu?">
                        <i class="fas fa-truck"></i> Thời gian giao hàng
                    </button>
                    <button class="quick-question-btn" data-message="Làm sao để thanh toán?">
                        <i class="fas fa-credit-card"></i> Phương thức thanh toán
                    </button>
                    <button class="quick-question-btn" data-message="Tôi có thể đặt hoa theo yêu cầu không?">
                        <i class="fas fa-palette"></i> Đặt hoa theo yêu cầu
                    </button>
                    <button class="quick-question-btn" data-message="Sản phẩm có bảo hành không?">
                        <i class="fas fa-shield-alt"></i> Chính sách bảo hành
                    </button>
                </div>
            </div>

            <!-- Typing Indicator -->
            <div class="support-typing-indicator" id="support-typing-indicator" style="display: none;">
                <span></span><span></span><span></span>
                <span class="typing-text">Nhân viên đang gõ...</span>
            </div>

            <!-- Input Area -->
            <div class="support-chat-input-area">
                <button id="support-attach-btn" class="support-attach-btn" aria-label="Attach" title="Gửi kèm đơn hàng/sản phẩm">
                    <i class="fas fa-paperclip"></i>
                </button>
                
                <!-- Image dropdown -->
                <div class="support-image-dropdown" style="position: relative; display: inline-block;">
                    <button id="support-image-btn" class="support-attach-btn" aria-label="Send Image" title="Gửi ảnh">
                        <i class="fas fa-image"></i>
                    </button>
                    <div id="support-image-menu" class="support-dropdown-menu" style="display: none;">
                        <a href="#" id="support-choose-image-btn">
                            <i class="fas fa-folder-open"></i> Chọn ảnh
                        </a>
                        <a href="#" id="support-capture-image-btn">
                            <i class="fas fa-camera"></i> Chụp ảnh
                        </a>
                    </div>
                </div>
                
                <input type="file" id="support-image-input" accept="image/*" style="display: none;">
                <textarea 
                       id="support-message-input" 
                       class="support-message-input" 
                       placeholder="Nhập tin nhắn..."
                       maxlength="1000"
                       rows="1"
                       style="resize: none; overflow-y: hidden; min-height: 40px; max-height: 120px;"></textarea>
                <button id="support-send-btn" class="support-send-btn" aria-label="Send Message">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="support-camera-modal" class="support-modal" style="display: none;">
        <div class="support-modal-content" style="max-width: 600px; background: #1a1a1a; border-radius: 16px; overflow: hidden;">
            <div class="support-modal-header" style="background: #1a1a1a; color: white; padding: 15px 20px; border-bottom: 1px solid #333;">
                <h5 style="margin: 0; display: flex; align-items: center; gap: 8px;">
                    <i class="fas fa-camera"></i> Chụp ảnh
                </h5>
                <button id="support-close-camera-btn" class="support-modal-close" style="color: white;">&times;</button>
            </div>
            <div class="support-modal-body" style="padding: 0; background: #000; position: relative;">
                <video id="support-camera-video" autoplay playsinline style="width: 100%; height: 400px; object-fit: cover;"></video>
                <canvas id="support-camera-canvas" style="display: none;"></canvas>
                <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10;">
                    <button id="support-capture-photo-btn" style="width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; cursor: pointer;">
                        <i class="fas fa-circle" style="font-size: 35px; color: #dc3545;"></i>
                    </button>
                </div>
            </div>
            <div class="support-modal-footer" style="background: #1a1a1a; padding: 15px 20px; border-top: 1px solid #333; display: flex; justify-content: center;">
                <button id="support-cancel-camera-btn" style="padding: 10px 20px; background: transparent; border: 1px solid white; color: white; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Hủy
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="support-image-preview-modal" class="support-modal" style="display: none;">
        <div class="support-modal-content" style="max-width: 500px;">
            <div class="support-modal-header">
                <h5>Xem trước ảnh</h5>
                <button id="support-close-preview-btn" class="support-modal-close">&times;</button>
            </div>
            <div class="support-modal-body" style="text-align: center; background: #f8f9fa; padding: 20px;">
                <img id="support-preview-image" src="" alt="Preview" style="max-width: 100%; max-height: 400px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
            </div>
            <div class="support-modal-footer">
                <button id="support-cancel-preview-btn" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button id="support-confirm-send-image-btn" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-paper-plane"></i> Gửi ảnh
                </button>
            </div>
        </div>
    </div>

    <!-- Attach Menu Modal -->
    <div id="support-attach-menu" class="support-attach-menu" style="display: none;">
        <div class="attach-menu-content">
            <button class="attach-menu-item" id="attach-order-btn">
                <i class="fas fa-shopping-bag"></i>
                <span>Gửi đơn hàng</span>
            </button>
            <button class="attach-menu-item" id="attach-product-btn">
                <i class="fas fa-box"></i>
                <span>Gửi sản phẩm</span>
            </button>
        </div>
    </div>

    <!-- Select Order Modal -->
    <div id="support-order-modal" class="support-modal" style="display: none;">
        <div class="support-modal-content">
            <div class="support-modal-header">
                <h4>Chọn đơn hàng</h4>
                <button class="support-modal-close" data-modal="order">&times;</button>
            </div>
            <div class="support-modal-body" id="order-list-container">
                <p class="text-center text-muted">Đang tải...</p>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="support-image-lightbox" class="support-modal" style="display: none; z-index: 10000;">
        <div class="support-modal-content" style="max-width: 90vw; max-height: 90vh; background: transparent; box-shadow: none; padding: 0;">
            <button class="support-modal-close" onclick="document.getElementById('support-image-lightbox').style.display='none'" style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: white; border: none; font-size: 30px; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; z-index: 10001;">&times;</button>
            <img id="support-lightbox-image" src="" alt="Preview" style="max-width: 90vw; max-height: 90vh; border-radius: 12px; object-fit: contain;">
        </div>
    </div>

    <!-- Select Product Modal -->
    <div id="support-product-modal" class="support-modal" style="display: none;">
        <div class="support-modal-content">
            <div class="support-modal-header">
                <h4>Chọn sản phẩm</h4>
                <button class="support-modal-close" data-modal="product">&times;</button>
            </div>
            <div class="support-modal-body" id="product-list-container">
                <input type="text" id="product-search" class="form-control mb-3" placeholder="Tìm kiếm sản phẩm...">
                <div id="product-list">
                    <p class="text-center text-muted">Đang tải...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Support Chat Widget Styles */
        #support-chat-widget {
            position: fixed;
            bottom: 100px;
            right: 20px;
            z-index: 9998;
        }

        .support-chat-floating-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .support-chat-floating-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .support-chat-floating-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .support-unread-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ef4444;
            color: white;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 12px;
            font-weight: bold;
            min-width: 20px;
            text-align: center;
            animation: pulse 2s infinite;
        }

        @@keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .support-chat-window {
            position: fixed;
            bottom: 160px;
            right: 20px;
            width: 380px;
            height: 550px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 5px 40px rgba(0,0,0,0.15);
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s ease;
        }

        @@keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .support-chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .support-chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .support-avatar-wrapper {
            position: relative;
            display: inline-block;
        }

        .support-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255,255,255,0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            overflow: hidden;
        }

        .support-avatar.support-logo {
            background: white;
            padding: 4px;
        }

        .support-avatar-wrapper .status-dot {
            position: absolute;
            bottom: 2px;
            right: 2px;
            width: 10px;
            height: 10px;
            border: 2px solid white;
        }

        .support-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .support-chat-title {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .support-chat-status {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            background-color: #10b981;
            border-radius: 50%;
            display: block;
        }

        @@keyframes pulse-green {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        .support-chat-close-btn {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            transition: transform 0.2s;
        }

        .support-chat-close-btn:hover {
            transform: rotate(90deg);
        }

        /* Working Hours Banner */
        .working-hours-banner {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-bottom: 2px solid #bae6fd;
            padding: 12px 15px;
            animation: slideDown 0.4s ease;
        }

        @@keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .working-hours-content {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .working-hours-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            flex-shrink: 0;
        }

        .working-hours-info {
            flex: 1;
        }

        .working-hours-status {
            margin-bottom: 4px;
        }

        .status-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .status-badge.open {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.closed {
            background: #fee2e2;
            color: #991b1b;
        }

        .working-hours-time {
            font-size: 13px;
            font-weight: 600;
            color: #0c4a6e;
            margin-bottom: 2px;
        }

        .working-hours-next {
            font-size: 11px;
            color: #475569;
        }

        /* Rate Limit Warning Animation */
        @@keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .support-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
        }

        .support-chat-welcome {
            text-align: center;
            padding: 30px 20px;
            color: #6b7280;
        }

        .support-chat-welcome i {
            font-size: 48px;
            color: #667eea;
            margin-bottom: 15px;
        }

        .support-quick-questions {
            padding: 15px;
            background: #f9fafb;
            border-radius: 12px;
            margin: 15px;
        }

        .quick-questions-title {
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 10px;
            text-align: center;
        }

        .quick-question-btn {
            display: block;
            width: 100%;
            padding: 10px 15px;
            margin-bottom: 8px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            color: #374151;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .quick-question-btn:last-child {
            margin-bottom: 0;
        }

        .quick-question-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            transform: translateX(5px);
        }

        .quick-question-btn i {
            margin-right: 8px;
            width: 16px;
            text-align: center;
        }

        .support-message {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }

        /* Attachment Card Styles */
        .support-attachment-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.2s;
            max-width: 320px;
        }

        .support-attachment-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        .support-attachment-header {
            background: #f9fafb;
            padding: 10px 15px;
            font-size: 13px;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        .support-attachment-body {
            display: flex;
            gap: 12px;
            padding: 15px;
        }

        .support-attachment-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            flex-shrink: 0;
        }

        .support-attachment-info {
            flex: 1;
            min-width: 0;
        }

        .support-attachment-title {
            font-size: 14px;
            font-weight: 600;
            color: #111827;
            margin: 0 0 6px 0;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .support-attachment-detail {
            font-size: 12px;
            color: #6b7280;
            margin: 0 0 8px 0;
        }

        .support-attachment-price {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }

        .support-attachment-price .price-current {
            font-size: 16px;
            font-weight: 700;
            color: #ef4444;
        }

        .support-attachment-price .price-original {
            font-size: 12px;
            color: #9ca3af;
            text-decoration: line-through;
        }

        .support-attachment-status {
            margin-top: 6px;
        }

        .support-attachment-status .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-primary { background: #e0e7ff; color: #3730a3; }
        .badge-danger { background: #fee2e2; color: #991b1b; }
        .badge-secondary { background: #f3f4f6; color: #4b5563; }

        .support-attachment-footer {
            background: #f9fafb;
            padding: 10px 15px;
            font-size: 12px;
            color: #6b7280;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .support-attachment-footer i {
            cursor: pointer;
            padding: 4px;
            transition: color 0.2s;
        }

        .support-attachment-footer i:hover {
            color: #667eea;
        }

        @@keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .support-message.from-staff {
            justify-content: flex-start;
        }

        .support-message.from-customer {
            justify-content: flex-end;
        }

        .support-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .support-message-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .support-message-content {
            max-width: 70%;
        }

        .support-message-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .support-message.from-staff .support-message-bubble {
            background: white;
            color: #1f2937;
            border-bottom-left-radius: 4px;
        }

        .support-message.from-customer .support-message-bubble {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .support-message-image {
            margin: 4px 0;
        }

        .support-message-image img {
            transition: transform 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .support-message-image img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .support-message-time {
            font-size: 11px;
            color: #9ca3af;
            margin-top: 4px;
        }

        .support-message-options {
            position: relative;
            display: inline-flex;
            align-items: center;
            flex-shrink: 0;
            margin-right: 4px;
        }

        .support-message-options-btn {
            background: #f9fafb;
            border: none;
            color: #9ca3af;
            font-size: 14px;
            cursor: pointer;
            padding: 0;
            border-radius: 50%;
            opacity: 0;
            transition: all 0.2s ease;
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .support-message.from-customer:hover .support-message-options-btn {
            opacity: 1;
        }

        .support-message-options-btn:hover {
            background: #e5e7eb;
            color: #6b7280;
            transform: scale(1.1);
        }

        .support-message-options-btn:active {
            transform: scale(0.9);
            background: #d1d5db;
        }

        .support-message-options-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
        }

        .support-message-options-menu.show {
            display: block;
        }

        .support-message-options-menu button {
            width: 100%;
            padding: 10px 16px;
            border: none;
            background: transparent;
            text-align: left;
            cursor: pointer;
            color: #ef4444;
            font-size: 14px;
            transition: background 0.2s;
        }

        .support-message-options-menu button:hover {
            background: #fee2e2;
        }

        .support-message-options-menu button i {
            margin-right: 8px;
        }

        .support-message-recalled {
            font-style: italic;
            color: #6b7280 !important;
            background: #f3f4f6 !important;
            padding: 12px 16px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .support-message-recalled i {
            color: #9ca3af;
            font-size: 16px;
        }

        /* Quick Action Buttons */
        .support-quick-action-btn {
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            padding: 10px 16px;
            border-radius: 24px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .support-quick-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .support-quick-action-btn:active {
            transform: translateX(5px) scale(0.98);
        }

        .support-message-status {
            font-size: 11px;
            margin-left: 6px;
            white-space: nowrap;
        }

        .support-message-status.sent {
            color: #9ca3af;
        }

        .support-message-status.delivered {
            color: #9ca3af;
        }

        .support-message-status.read {
            color: #3b82f6;
        }

        .support-message-status i {
            font-size: 12px;
            margin-right: 2px;
        }

        .support-typing-indicator {
            padding: 10px 15px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .support-typing-indicator span:not(.typing-text) {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            animation: typing 1.4s infinite;
        }

        .support-typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .support-typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @@keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }

        /* Image Dropdown Menu */
        .support-dropdown-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            margin-bottom: 8px;
            min-width: 150px;
            z-index: 1000;
        }

        .support-dropdown-menu a {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            color: #374151;
            text-decoration: none;
            transition: background 0.2s;
        }

        .support-dropdown-menu a:first-child {
            border-radius: 8px 8px 0 0;
        }

        .support-dropdown-menu a:last-child {
            border-radius: 0 0 8px 8px;
        }

        .support-dropdown-menu a:hover {
            background: #f3f4f6;
        }

        .support-dropdown-menu a i {
            width: 18px;
            color: #667eea;
        }

        /* Camera Modal */
        #support-capture-photo-btn {
            transition: transform 0.2s;
        }

        #support-capture-photo-btn:hover {
            transform: scale(1.1);
        }

        #support-capture-photo-btn:active {
            transform: scale(0.95);
        }

        .typing-text {
            font-size: 12px;
            color: #6b7280;
        }

        .support-chat-input-area {
            padding: 15px;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 10px;
            border-radius: 0 0 12px 12px;
        }

        .support-message-input {
            flex: 1;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            padding: 10px 15px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
        }

        .support-message-input:focus {
            border-color: #667eea;
        }

        .support-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #667eea;
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .support-send-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .support-send-btn:disabled {
            background: #d1d5db;
            cursor: not-allowed;
            transform: scale(1);
        }

        .support-attach-btn {
            background: transparent;
            border: none;
            color: #667eea;
            font-size: 20px;
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }

        .support-attach-btn:hover {
            color: #764ba2;
            transform: scale(1.1);
        }

        /* Attach Menu */
        .support-attach-menu {
            position: fixed;
            bottom: 110px;
            right: 30px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 9999;
            padding: 8px;
        }

        .attach-menu-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .attach-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #374151;
            font-size: 14px;
            text-align: left;
            width: 200px;
        }

        .attach-menu-item:hover {
            background: #f3f4f6;
            color: #667eea;
        }

        .attach-menu-item i {
            font-size: 18px;
        }

        /* Modals */
        .support-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .support-modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 600px;
            display: flex;
            flex-direction: column;
        }

        .support-modal-header {
            padding: 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .support-modal-header h4 {
            margin: 0;
            color: #667eea;
        }

        .support-modal-close {
            background: transparent;
            border: none;
            font-size: 28px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .support-modal-close:hover {
            color: #374151;
        }

        .support-modal-body {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }
        
        .support-modal-footer {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .support-modal-footer button {
            transition: all 0.2s;
        }
        
        .support-modal-footer button:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        #support-camera-video {
            transition: opacity 0.1s;
        }

        .order-item, .product-item {
            padding: 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .order-item:hover, .product-item:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .product-item {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .product-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 6px;
        }

        /* Mobile Responsive */
        @@media (max-width: 768px) {
            .support-chat-window {
                width: calc(100vw - 20px);
                height: calc(100vh - 180px);
                right: 10px;
                bottom: 160px;
            }
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
    <script>
        let supportChatConnection = null;
        let currentConversationId = null;
        let typingTimeout = null;
        let currentUserAvatar = '';
        const currentUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';

        document.addEventListener('DOMContentLoaded', function() {
            initSupportChat();
        });

        function initSupportChat() {
            // Initialize current user avatar
            currentUserAvatar = getUserAvatar();
            
            const chatBtn = document.getElementById('support-chat-btn');
            const chatWindow = document.getElementById('support-chat-window');
            const closeBtn = document.getElementById('support-chat-close-btn');
            const sendBtn = document.getElementById('support-send-btn');
            const messageInput = document.getElementById('support-message-input');

            // Load working hours info
            loadWorkingHours();
            
            // Update working hours every minute
            setInterval(loadWorkingHours, 60000);

            // Toggle chat window
            chatBtn.addEventListener('click', function() {
                const isVisible = chatWindow.style.display !== 'none';
                chatWindow.style.display = isVisible ? 'none' : 'flex';
                
                if (!isVisible) {
                    openSupportChat();
                    // Disable AI chatbot when support chat opens
                    const aiChatBtn = document.getElementById('chat-main-btn');
                    if (aiChatBtn) aiChatBtn.classList.add('disabled');
                } else {
                    // Enable AI chatbot when support chat closes
                    const aiChatBtn = document.getElementById('chat-main-btn');
                    if (aiChatBtn) aiChatBtn.classList.remove('disabled');
                }
            });

            closeBtn.addEventListener('click', function() {
                chatWindow.style.display = 'none';
                // Enable AI chatbot when support chat closes
                const aiChatBtn = document.getElementById('chat-main-btn');
                if (aiChatBtn) aiChatBtn.classList.remove('disabled');
            });

            // Send message
            sendBtn.addEventListener('click', sendSupportMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendSupportMessage();
                }
            });

            // Auto-resize textarea
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 120) + 'px';
            });

            // Image upload functionality
            const imageBtn = document.getElementById('support-image-btn');
            const imageMenu = document.getElementById('support-image-menu');
            const imageInput = document.getElementById('support-image-input');
            const chooseImageBtn = document.getElementById('support-choose-image-btn');
            const captureImageBtn = document.getElementById('support-capture-image-btn');
            
            let currentImageFile = null;
            let cameraStream = null;
            
            // Toggle image menu
            imageBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                imageMenu.style.display = imageMenu.style.display === 'none' ? 'block' : 'none';
            });
            
            // Close menu when clicking outside
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.support-image-dropdown')) {
                    imageMenu.style.display = 'none';
                }
            });
            
            // Choose image from library
            chooseImageBtn.addEventListener('click', function(e) {
                e.preventDefault();
                imageMenu.style.display = 'none';
                imageInput.click();
            });
            
            // Capture image from camera
            captureImageBtn.addEventListener('click', async function(e) {
                e.preventDefault();
                imageMenu.style.display = 'none';
                
                try {
                    const cameraVideo = document.getElementById('support-camera-video');
                    cameraStream = await navigator.mediaDevices.getUserMedia({ 
                        video: { facingMode: 'environment' } 
                    });
                    cameraVideo.srcObject = cameraStream;
                    document.getElementById('support-camera-modal').style.display = 'flex';
                } catch (error) {
                    console.error('Camera error:', error);
                    alert('Không thể truy cập camera. Vui lòng kiểm tra quyền truy cập.');
                }
            });
            
            // Stop camera
            function stopCamera() {
                if (cameraStream) {
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                    document.getElementById('support-camera-video').srcObject = null;
                }
            }
            
            // Close camera modal
            document.getElementById('support-close-camera-btn').addEventListener('click', function() {
                stopCamera();
                document.getElementById('support-camera-modal').style.display = 'none';
            });
            
            document.getElementById('support-cancel-camera-btn').addEventListener('click', function() {
                stopCamera();
                document.getElementById('support-camera-modal').style.display = 'none';
            });
            
            // Capture photo
            document.getElementById('support-capture-photo-btn').addEventListener('click', function() {
                const video = document.getElementById('support-camera-video');
                const canvas = document.getElementById('support-camera-canvas');
                
                // Flash effect
                video.style.opacity = '0.3';
                setTimeout(() => { video.style.opacity = '1'; }, 100);
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                canvas.getContext('2d').drawImage(video, 0, 0);
                
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        alert('Lỗi khi chụp ảnh');
                        return;
                    }
                    
                    currentImageFile = new File([blob], 'camera-photo-' + Date.now() + '.jpg', { type: 'image/jpeg' });
                    
                    // Stop camera and show preview
                    stopCamera();
                    document.getElementById('support-camera-modal').style.display = 'none';
                    
                    // Show preview
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.getElementById('support-preview-image').src = e.target.result;
                        document.getElementById('support-image-preview-modal').style.display = 'flex';
                    };
                    reader.readAsDataURL(currentImageFile);
                }, 'image/jpeg', 0.9);
            });
            
            // Handle image selection from file
            imageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (!file) return;

                // Validate file type
                if (!file.type.startsWith('image/')) {
                    alert('Vui lòng chọn file ảnh');
                    return;
                }

                // Validate file size (max 5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('Kích thước ảnh không được vượt quá 5MB');
                    return;
                }

                currentImageFile = file;
                
                // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('support-preview-image').src = e.target.result;
                    document.getElementById('support-image-preview-modal').style.display = 'flex';
                };
                reader.readAsDataURL(file);
                
                e.target.value = '';
            });
            
            // Close preview modal
            document.getElementById('support-close-preview-btn').addEventListener('click', function() {
                document.getElementById('support-image-preview-modal').style.display = 'none';
                currentImageFile = null;
            });
            
            document.getElementById('support-cancel-preview-btn').addEventListener('click', function() {
                document.getElementById('support-image-preview-modal').style.display = 'none';
                currentImageFile = null;
            });
            
            // Confirm send image
            document.getElementById('support-confirm-send-image-btn').addEventListener('click', async function() {
                if (!currentImageFile) return;
                
                if (!supportChatConnection || !currentConversationId) {
                    alert('Vui lòng mở chat trước khi gửi ảnh');
                    return;
                }

                try {
                    // Disable button
                    this.disabled = true;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang gửi...';
                    
                    // Upload image
                    const formData = new FormData();
                    formData.append('image', currentImageFile);

                    const uploadResponse = await fetch('/api/supportchat/upload-image', {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Upload failed');
                    }

                    const uploadResult = await uploadResponse.json();

                    // Send message with attachment
                    await supportChatConnection.invoke('SendMessage', currentConversationId, '[Đã gửi ảnh]', uploadResult.imageUrl);

                    // Close modal and reset
                    document.getElementById('support-image-preview-modal').style.display = 'none';
                    currentImageFile = null;
                    
                } catch (error) {
                    console.error('Error uploading image:', error);
                    alert('Không thể gửi ảnh. Vui lòng thử lại.');
                } finally {
                    // Re-enable button
                    this.disabled = false;
                    this.innerHTML = '<i class="fas fa-paper-plane"></i> Gửi ảnh';
                }
            });

            // Quick question buttons
            document.addEventListener('click', function(e) {
                if (e.target.closest('.quick-question-btn')) {
                    const btn = e.target.closest('.quick-question-btn');
                    const message = btn.getAttribute('data-message');
                    messageInput.value = message;
                    sendSupportMessage();
                }
            });

            // Attach button
            const attachBtn = document.getElementById('support-attach-btn');
            const attachMenu = document.getElementById('support-attach-menu');
            const attachOrderBtn = document.getElementById('attach-order-btn');
            const attachProductBtn = document.getElementById('attach-product-btn');

            attachBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                attachMenu.style.display = attachMenu.style.display === 'none' ? 'block' : 'none';
            });

            document.addEventListener('click', function() {
                attachMenu.style.display = 'none';
            });

            attachOrderBtn.addEventListener('click', function() {
                attachMenu.style.display = 'none';
                showOrderModal();
            });

            attachProductBtn.addEventListener('click', function() {
                attachMenu.style.display = 'none';
                showProductModal();
            });

            // Modal close buttons
            document.querySelectorAll('.support-modal-close').forEach(btn => {
                btn.addEventListener('click', function() {
                    const modalType = this.dataset.modal;
                    document.getElementById(`support-${modalType}-modal`).style.display = 'none';
                });
            });

            // Close modals on background click
            document.querySelectorAll('.support-modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.style.display = 'none';
                    }
                });
            });

            // Typing indicator - CHỈ gọi khi có nội dung
            messageInput.addEventListener('input', function() {
                if (supportChatConnection && currentConversationId && this.value.trim().length > 0) {
                    supportChatConnection.invoke('Typing', currentConversationId).catch(err => console.error(err));
                    
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        supportChatConnection.invoke('StopTyping', currentConversationId).catch(err => console.error(err));
                    }, 1000);
                } else if (supportChatConnection && currentConversationId) {
                    // Nếu xóa hết text thì stop typing ngay
                    supportChatConnection.invoke('StopTyping', currentConversationId).catch(err => console.error(err));
                }
            });

            // Load unread count
            loadUnreadCount();
            setInterval(loadUnreadCount, 30000); // Update every 30 seconds
        }

        async function loadWorkingHours() {
            try {
                const response = await fetch('/api/supportchat/working-hours');
                if (!response.ok) throw new Error('Failed to load working hours');

                const data = await response.json();
                
                // Update status badge
                const statusBadge = document.getElementById('shop-status-badge');
                statusBadge.textContent = data.status;
                statusBadge.className = 'status-badge ' + (data.isOpen ? 'open' : 'closed');
                
                // Update working hours text
                document.getElementById('working-hours-text').textContent = 
                    `${data.workingDays} • ${data.workingHours}`;
                
                // Update next available
                const nextText = document.getElementById('next-available-text');
                nextText.textContent = data.nextAvailable;
                
                // Update status dot and header status
                const statusDot = document.querySelector('.support-avatar-wrapper .status-dot');
                const headerStatus = document.getElementById('support-status');
                
                if (data.isOpen) {
                    statusDot.style.backgroundColor = '#10b981';
                    statusDot.style.animation = 'pulse-green 2s infinite';
                    headerStatus.textContent = 'Đang hoạt động';
                } else {
                    statusDot.style.backgroundColor = '#ef4444';
                    statusDot.style.animation = 'none';
                    headerStatus.textContent = 'Ngoài giờ làm việc';
                }
                
            } catch (error) {
                console.error('Error loading working hours:', error);
            }
        }

        async function openSupportChat() {
            try {
                // Start or get conversation
                const response = await fetch('/api/supportchat/conversation/start', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                });

                if (!response.ok) throw new Error('Failed to start conversation');

                const data = await response.json();
                currentConversationId = data.conversationId;

                // Connect to SignalR
                await connectSignalR();

                // Join conversation group
                if (supportChatConnection && currentConversationId) {
                    await supportChatConnection.invoke('JoinConversation', currentConversationId);
                }

                // Load messages
                await loadMessages();

                // Mark as read
                if (supportChatConnection) {
                    await supportChatConnection.invoke('MarkAsRead', currentConversationId);
                }

                // Update unread count after marking as read
                await loadUnreadCount();

            } catch (error) {
                console.error('Error opening support chat:', error);
                showChatError('Không thể kết nối. Vui lòng thử lại sau.');
            }
        }

        async function connectSignalR() {
            if (supportChatConnection) return;

            supportChatConnection = new signalR.HubConnectionBuilder()
                .withUrl("/chatHub")
                .withAutomaticReconnect()
                .build();

            // Receive message
            supportChatConnection.on("ReceiveMessage", function(data) {
                if (data.conversationId === currentConversationId) {
                    displayMessage(data);
                    
                    // Mark as read if window is open
                    const chatWindow = document.getElementById('support-chat-window');
                    if (chatWindow.style.display !== 'none') {
                        supportChatConnection.invoke('MarkAsRead', currentConversationId)
                            .then(() => loadUnreadCount())
                            .catch(err => console.error(err));
                    } else {
                        loadUnreadCount();
                    }
                }
            });

            // Typing indicator
            supportChatConnection.on("UserTyping", function(data) {
                if (data.conversationId === currentConversationId && data.isStaff) {
                    document.getElementById('support-typing-indicator').style.display = 'flex';
                }
            });

            supportChatConnection.on("UserStoppedTyping", function(data) {
                if (data.conversationId === currentConversationId && data.isStaff) {
                    document.getElementById('support-typing-indicator').style.display = 'none';
                }
            });

            // Messages read - Update status icons
            supportChatConnection.on("MessagesRead", function(data) {
                if (data.conversationId === currentConversationId && data.readBy === 'staff') {
                    // Update all customer messages to show "read" status
                    const customerMessages = document.querySelectorAll('#support-chat-messages .support-message.from-customer');
                    customerMessages.forEach(msgDiv => {
                        const statusSpan = msgDiv.querySelector('.support-message-status');
                        if (statusSpan) {
                            statusSpan.className = 'support-message-status read';
                            statusSpan.innerHTML = '<i class="fas fa-check-double"></i> Đã xem';
                        }
                    });
                }
            });

            // Error handler
            supportChatConnection.on("Error", function(errorMessage) {
                showChatError(errorMessage || 'Có lỗi xảy ra từ server');
            });

            // Rate limit handler
            supportChatConnection.on("RateLimitExceeded", function(data) {
                showRateLimitWarning(data.message, data.remainingSeconds);
            });

            // User blocked handler
            supportChatConnection.on("UserBlocked", function(data) {
                showBlockedWarning(data.message, data.reason);
            });

            // User unblocked handler
            supportChatConnection.on("UserUnblocked", function(data) {
                showUnblockedNotification(data.message);
            });

            // Spam detected handler
            supportChatConnection.on("SpamDetected", function(data) {
                showSpamWarning(data.message, data.violationCount, data.maxViolations);
            });

            // Connection lifecycle handlers
            supportChatConnection.onclose(async () => {
                setTimeout(async () => {
                    try {
                        await supportChatConnection.start();
                        if (currentConversationId) {
                            await supportChatConnection.invoke('JoinConversation', currentConversationId);
                        }
                    } catch (err) {
                        console.error('Reconnection failed:', err);
                    }
                }, 3000);
            });

            supportChatConnection.onreconnected(() => {
                if (currentConversationId) {
                    supportChatConnection.invoke('JoinConversation', currentConversationId);
                }
            });

            try {
                await supportChatConnection.start();
                
                // Join conversation
                if (currentConversationId) {
                    await supportChatConnection.invoke('JoinConversation', currentConversationId);
                }
            } catch (error) {
                console.error('SignalR connection error:', error);
                showChatError('Không thể kết nối chat. Vui lòng tải lại trang.');
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch(`/api/supportchat/conversation/${currentConversationId}/messages?pageSize=50`);
                if (!response.ok) throw new Error('Failed to load messages');

                const messages = await response.json();
                const messagesContainer = document.getElementById('support-chat-messages');
                messagesContainer.innerHTML = '';

                if (messages.length === 0) {
                    // Show welcome and quick questions for new conversations
                    messagesContainer.innerHTML = `
                        <div class="support-chat-welcome">
                            <i class="fas fa-comments"></i>
                            <p>Xin chào! Chúng tôi có thể giúp gì cho bạn?</p>
                        </div>
                        <div class="support-quick-questions" id="support-quick-questions">
                            <p class="quick-questions-title">Câu hỏi thường gặp:</p>
                            <button class="quick-question-btn" data-message="Tôi muốn kiểm tra đơn hàng">
                                <i class="fas fa-box"></i> Kiểm tra đơn hàng
                            </button>
                            <button class="quick-question-btn" data-message="Làm sao để đổi/trả hàng?">
                                <i class="fas fa-exchange-alt"></i> Đổi/trả hàng
                            </button>
                            <button class="quick-question-btn" data-message="Thời gian giao hàng bao lâu?">
                                <i class="fas fa-truck"></i> Thời gian giao hàng
                            </button>
                            <button class="quick-question-btn" data-message="Làm sao để thanh toán?">
                                <i class="fas fa-credit-card"></i> Phương thức thanh toán
                            </button>
                            <button class="quick-question-btn" data-message="Tôi có thể đặt hoa theo yêu cầu không?">
                                <i class="fas fa-palette"></i> Đặt hoa theo yêu cầu
                            </button>
                            <button class="quick-question-btn" data-message="Sản phẩm có bảo hành không?">
                                <i class="fas fa-shield-alt"></i> Chính sách bảo hành
                            </button>
                        </div>`;
                } else {
                    messages.forEach(msg => displayMessage(msg));
                }

                scrollToBottom();
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        function displayMessage(data) {
            const messagesContainer = document.getElementById('support-chat-messages');
            const welcome = messagesContainer.querySelector('.support-chat-welcome');
            if (welcome) welcome.remove();
            
            // Hide quick questions after first message
            const quickQuestions = document.getElementById('support-quick-questions');
            if (quickQuestions) quickQuestions.style.display = 'none';

            const messageDiv = document.createElement('div');
            messageDiv.className = `support-message ${data.isFromStaff ? 'from-staff' : 'from-customer'}`;
            if (data.id) {
                messageDiv.dataset.messageId = data.id;
            }

            const time = new Date(data.sentAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

            // Check if message has attachment (image)
            let messageContent = '';
            if (data.attachmentUrl) {
                messageContent = `
                    <div class="support-message-image">
                        <img src="${data.attachmentUrl}" alt="Sent image" onclick="openImageLightbox('${data.attachmentUrl}')" style="max-width: 250px; max-height: 250px; border-radius: 12px; cursor: pointer; object-fit: cover;">
                    </div>`;
            }
            // Check if message is image (old format)
            else if (data.message.startsWith('[IMAGE:')) {
                const imageUrl = data.message.substring(7, data.message.length - 1);
                messageContent = `
                    <div class="support-message-image">
                        <img src="${imageUrl}" alt="Sent image" onclick="openImageLightbox('${imageUrl}')" style="max-width: 250px; max-height: 250px; border-radius: 12px; cursor: pointer; object-fit: cover;">
                    </div>`;
            } else if (data.message.startsWith('[ATTACHMENT:')) {
                try {
                    const jsonStr = data.message.substring(12, data.message.length - 1);
                    const attachment = JSON.parse(jsonStr);
                    
                    if (attachment.type === 'product') {
                        const headerText = data.isFromStaff ? 'Bloomie giới thiệu sản phẩm cho bạn' : 'Bạn đang hỏi về sản phẩm này';
                        messageContent = `
                            <div class="support-attachment-card" onclick="window.open('${attachment.url}', '_blank');" style="cursor: pointer;">
                                <div class="support-attachment-header">${headerText}</div>
                                <div class="support-attachment-body">
                                    <img src="${attachment.imageUrl}" alt="${attachment.productName}" class="support-attachment-image">
                                    <div class="support-attachment-info">
                                        <h4 class="support-attachment-title">${attachment.productName}</h4>
                                        <div class="support-attachment-price">
                                            <span class="price-current">${attachment.discountPrice && attachment.discountPrice < attachment.price ? attachment.discountPrice.toLocaleString('vi-VN') : attachment.price.toLocaleString('vi-VN')}đ</span>
                                            ${attachment.discountPrice && attachment.discountPrice < attachment.price ? `<span class="price-original">${attachment.price.toLocaleString('vi-VN')}đ</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>`;
                    } else if (attachment.type === 'order') {
                        const statusClass = getOrderStatusColor(attachment.status);
                        const headerText = data.isFromStaff ? 'Bloomie đang hỗ trợ đơn hàng của bạn' : 'Bạn đang hỏi về đơn hàng này';
                        messageContent = `
                            <div class="support-attachment-card" onclick="window.open('${attachment.url}', '_blank');" style="cursor: pointer;">
                                <div class="support-attachment-header">${headerText}</div>
                                <div class="support-attachment-body">
                                    <img src="${attachment.imageUrl}" alt="Order" class="support-attachment-image">
                                    <div class="support-attachment-info">
                                        <h4 class="support-attachment-title">${attachment.orderId}</h4>
                                        <p class="support-attachment-detail">1 Sản Phẩm, Tổng đơn hàng: ${attachment.totalAmount.toLocaleString('vi-VN')}đ</p>
                                        <div class="support-attachment-status">
                                            <span class="badge badge-${statusClass}">${attachment.status}</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="support-attachment-footer">
                                    Mã đơn hàng: ${attachment.orderId} <i class="fas fa-copy" onclick="event.stopPropagation(); navigator.clipboard.writeText('${attachment.orderId}');" title="Copy mã đơn hàng"></i>
                                </div>
                            </div>`;
                    } else if (attachment.type === 'blog') {
                        messageContent = `
                            <div class="support-attachment-card" onclick="window.open('${attachment.url}', '_blank');" style="cursor: pointer;">
                                <div class="support-attachment-header"><i class="fas fa-newspaper"></i> Bloomie gửi bạn bài viết hữu ích</div>
                                <div class="support-attachment-body">
                                    <img src="${attachment.imageUrl || '/images/blog-placeholder.png'}" alt="${attachment.title}" class="support-attachment-image">
                                    <div class="support-attachment-info">
                                        <h4 class="support-attachment-title">${attachment.title}</h4>
                                        <p class="support-attachment-detail">${attachment.summary || 'Nhấn để xem chi tiết...'}</p>
                                    </div>
                                </div>
                                <div class="support-attachment-footer">
                                    <i class="fas fa-external-link-alt"></i> Nhấn để đọc toàn bộ bài viết
                                </div>
                            </div>`;
                    }
                } catch (e) {
                    console.error('Error parsing attachment:', e);
                    messageContent = `<div class="support-message-bubble">${escapeHtml(data.message)}</div>`;
                }
            } else if (!data.attachmentUrl) {
                // Kiểm tra xem có quick actions không
                if (data.message.includes('[QUICK_ACTIONS]') && data.message.includes('[/QUICK_ACTIONS]')) {
                    const startIndex = data.message.indexOf('[QUICK_ACTIONS]') + 15;
                    const endIndex = data.message.indexOf('[/QUICK_ACTIONS]');
                    const mainMessage = data.message.substring(0, data.message.indexOf('[QUICK_ACTIONS]')).trim();
                    const actionsText = data.message.substring(startIndex, endIndex).trim();
                    const actions = actionsText.split('\n').filter(line => line.trim() && line.includes('|'));
                    
                    const formattedMainMessage = escapeHtml(mainMessage).replace(/\n/g, '<br>');
                    let buttonsHtml = '<div class="support-quick-action-buttons" style="display: flex; flex-direction: column; gap: 8px; margin-top: 12px;">';
                    
                    actions.forEach(action => {
                        const [label, message] = action.split('|').map(s => s.trim());
                        buttonsHtml += `
                            <button class="support-quick-action-btn" onclick="sendQuickAction('${escapeHtml(message).replace(/'/g, "\\'")}')">
                                ${label}
                            </button>
                        `;
                    });
                    
                    buttonsHtml += '</div>';
                    messageContent = `<div class="support-message-bubble">${formattedMainMessage}${buttonsHtml}</div>`;
                } else {
                    // Tin nhắn thường - format line breaks (only if not image)
                    const formattedMessage = escapeHtml(data.message).replace(/\n/g, '<br>');
                    messageContent = `<div class="support-message-bubble">${formattedMessage}</div>`;
                }
            }

            // Determine message status text (only for customer's own messages)
            let statusText = '';
            if (!data.isFromStaff) {
                if (data.readAt) {
                    // Đã xem (có ReadAt timestamp)
                    statusText = '<span class="support-message-status read"><i class="fas fa-check-double"></i> Đã xem</span>';
                } else if (data.isRead) {
                    // Đã nhận (IsRead = true nhưng chưa có ReadAt)
                    statusText = '<span class="support-message-status delivered"><i class="fas fa-check-double"></i> Đã nhận</span>';
                } else if (data.id) {
                    // Đã gửi (có ID nghĩa là đã lưu vào DB)
                    statusText = '<span class="support-message-status sent"><i class="fas fa-check"></i> Đã gửi</span>';
                }
            }

            // Determine avatar to use
            const avatarToUse = data.senderAvatar || currentUserAvatar || '/images/profiles/default-avatar.png';
            
            // Kiểm tra xem tin nhắn có được gửi trong vòng 5 phút không (chỉ cho customer)
            // KHÔNG hiển thị nút 3 chấm nếu tin nhắn đã bị thu hồi
            const timeSinceSent = data.sentAt ? (new Date() - new Date(data.sentAt)) / 1000 / 60 : 0; // minutes
            const isRecalled = data.message === '[Tin nhắn đã được thu hồi]';
            const canRecall = !data.isFromStaff && data.id && timeSinceSent <= 5 && !isRecalled;
            
            messageDiv.innerHTML = `
                ${data.isFromStaff ? `
                    <div class="support-message-avatar">
                        ${data.senderAvatar ? 
                            `<img src="${data.senderAvatar}" alt="Staff" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : 
                            `<img src="/images/logos/bloomie_logo.png" alt="Bloomie" style="width: 100%; height: 100%; object-fit: cover;">`
                        }
                    </div>
                ` : ''}
                ${!data.isFromStaff && canRecall ? `
                    <div class="support-message-options">
                        <button class="support-message-options-btn" onclick="toggleMessageMenu(event, ${data.id})">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="support-message-options-menu" id="message-menu-${data.id}">
                            <button onclick="recallMessage(${data.id})">
                                <i class="fas fa-undo"></i> Thu hồi tin nhắn
                            </button>
                        </div>
                    </div>
                ` : ''}
                <div class="support-message-content">
                    ${messageContent}
                    <div class="support-message-time">
                        ${time} ${statusText}
                    </div>
                </div>
                ${!data.isFromStaff ? `
                    <div class="support-message-avatar">
                        ${avatarToUse ? `<img src="${avatarToUse}" alt="You" style="width: 100%; height: 100%; object-fit: cover; border-radius: 50%;">` : '<i class="fas fa-user-circle" style="font-size: 32px; color: #667eea;"></i>'}
                    </div>
                ` : ''}
            `;

            messagesContainer.appendChild(messageDiv);
            scrollToBottom();
        }

        async function sendSupportMessage() {
            const input = document.getElementById('support-message-input');
            const message = input.value.trim();

            if (!message) return;

            if (!supportChatConnection) {
                showChatError('Chưa kết nối. Vui lòng đóng và mở lại chat.');
                return;
            }

            if (!currentConversationId) {
                showChatError('Không tìm thấy hội thoại. Vui lòng thử lại.');
                return;
            }

            try {
                // Check connection state
                if (supportChatConnection.state !== signalR.HubConnectionState.Connected) {
                    await supportChatConnection.start();
                    await supportChatConnection.invoke('JoinConversation', currentConversationId);
                }

                await supportChatConnection.invoke('SendMessage', currentConversationId, message, null);
                
                input.value = '';
                
                // Reset textarea height về kích thước ban đầu
                input.style.height = 'auto';
                
                // Stop typing indicator
                await supportChatConnection.invoke('StopTyping', currentConversationId);
            } catch (error) {
                console.error('Error sending message:', error);
                showChatError('Không thể gửi tin nhắn. Vui lòng thử lại.');
            }
        }

        async function loadUnreadCount() {
            try {
                const response = await fetch('/api/supportchat/unread-count');
                if (!response.ok) return;

                const data = await response.json();
                const badge = document.getElementById('support-unread-badge');
                
                if (data.unreadCount > 0) {
                    badge.textContent = data.unreadCount;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            } catch (error) {
                console.error('Error loading unread count:', error);
            }
        }

        function scrollToBottom() {
            const container = document.getElementById('support-chat-messages');
            container.scrollTop = container.scrollHeight;
        }

        function getUserAvatar() {
            @if (User.Identity.IsAuthenticated)
            {
                var userProfileImage = User.Claims.FirstOrDefault(c => c.Type == "ProfileImageUrl")?.Value;
                @:return '@(userProfileImage ?? "/images/profiles/default-avatar.png")';
            }
            else
            {
                @:return null;
            }
        }

        function showChatError(message) {
            const messagesContainer = document.getElementById('support-chat-messages');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'text-align: center; padding: 10px; color: #ef4444; font-size: 14px;';
            errorDiv.textContent = message;
            messagesContainer.appendChild(errorDiv);
            
            setTimeout(() => errorDiv.remove(), 3000);
        }

        function showRateLimitWarning(message, remainingSeconds) {
            // Disable input
            const input = document.getElementById('support-message-input');
            const sendBtn = document.getElementById('support-send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            
            // Show warning message
            const messagesContainer = document.getElementById('support-chat-messages');
            const warningDiv = document.createElement('div');
            warningDiv.id = 'rate-limit-warning';
            warningDiv.style.cssText = `
                text-align: center; 
                padding: 15px 20px; 
                margin: 10px; 
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 2px solid #f59e0b;
                border-radius: 12px;
                color: #92400e;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                animation: shake 0.5s;
            `;
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #f59e0b; margin-bottom: 8px;"></i>
                <div>${message}</div>
                <div style="margin-top: 8px; font-size: 18px; color: #f59e0b;" id="countdown-timer">${remainingSeconds}s</div>
            `;
            messagesContainer.appendChild(warningDiv);
            scrollToBottom();
            
            // Countdown timer
            let timeLeft = remainingSeconds;
            const countdownInterval = setInterval(() => {
                timeLeft--;
                const timerEl = document.getElementById('countdown-timer');
                if (timerEl) {
                    timerEl.textContent = `${timeLeft}s`;
                }
                
                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    warningDiv.remove();
                    input.disabled = false;
                    sendBtn.disabled = false;
                    input.placeholder = 'Nhập tin nhắn...';
                }
            }, 1000);
            
            input.placeholder = `Vui lòng đợi ${remainingSeconds} giây...`;
        }

        function showBlockedWarning(message, reason) {
            // Disable input permanently
            const input = document.getElementById('support-message-input');
            const sendBtn = document.getElementById('support-send-btn');
            input.disabled = true;
            sendBtn.disabled = true;
            input.placeholder = 'Bạn đã bị chặn khỏi chat';
            
            // Show warning message
            const messagesContainer = document.getElementById('support-chat-messages');
            
            // Remove any existing blocked warning
            const existingWarning = document.getElementById('blocked-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            const warningDiv = document.createElement('div');
            warningDiv.id = 'blocked-warning';
            warningDiv.style.cssText = `
                text-align: center; 
                padding: 20px 25px; 
                margin: 10px; 
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                border: 2px solid #ef4444;
                border-radius: 12px;
                color: #7f1d1d;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
                animation: shake 0.5s;
            `;
            
            let reasonText = reason ? `<div style="margin-top: 8px; font-size: 13px; color: #991b1b;">Lý do: ${reason}</div>` : '';
            
            warningDiv.innerHTML = `
                <i class="fas fa-ban" style="font-size: 32px; color: #ef4444; margin-bottom: 10px;"></i>
                <div style="font-size: 16px; margin-bottom: 5px;">Tài khoản bị chặn</div>
                <div style="font-size: 13px; color: #991b1b;">${message}</div>
                ${reasonText}
                <div style="margin-top: 12px; font-size: 12px; color: #7f1d1d;">
                    <i class="fas fa-info-circle"></i> Vui lòng liên hệ quản trị viên để được hỗ trợ
                </div>
            `;
            messagesContainer.appendChild(warningDiv);
            scrollToBottom();
        }

        function showUnblockedNotification(message) {
            // Re-enable input
            const input = document.getElementById('support-message-input');
            const sendBtn = document.getElementById('support-send-btn');
            input.disabled = false;
            sendBtn.disabled = false;
            input.placeholder = 'Nhập tin nhắn...';
            
            // Remove blocked warning if exists
            const existingWarning = document.getElementById('blocked-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            // Show success notification
            const messagesContainer = document.getElementById('support-chat-messages');
            const notificationDiv = document.createElement('div');
            notificationDiv.style.cssText = `
                text-align: center; 
                padding: 15px 20px; 
                margin: 10px; 
                background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
                border: 2px solid #10b981;
                border-radius: 12px;
                color: #064e3b;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                animation: slideInRight 0.5s;
            `;
            
            notificationDiv.innerHTML = `
                <i class="fas fa-check-circle" style="font-size: 28px; color: #10b981; margin-bottom: 8px;"></i>
                <div style="font-size: 15px; margin-bottom: 3px;">Tài khoản đã được mở khóa</div>
                <div style="font-size: 13px; color: #065f46;">${message}</div>
            `;
            
            messagesContainer.appendChild(notificationDiv);
            scrollToBottom();
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                notificationDiv.style.opacity = '0';
                notificationDiv.style.transform = 'translateX(100%)';
                notificationDiv.style.transition = 'all 0.5s ease-out';
                setTimeout(() => notificationDiv.remove(), 500);
            }, 10000);
        }

        function showSpamWarning(message, violationCount, maxViolations) {
            const messagesContainer = document.getElementById('support-chat-messages');
            
            // Remove any existing spam warning
            const existingWarning = document.getElementById('spam-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
            
            const warningDiv = document.createElement('div');
            warningDiv.id = 'spam-warning';
            warningDiv.style.cssText = `
                text-align: center; 
                padding: 18px 22px; 
                margin: 10px; 
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                border: 2px solid #f59e0b;
                border-radius: 12px;
                color: #92400e;
                font-size: 14px;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
                animation: shake 0.5s;
            `;
            
            const remaining = maxViolations - violationCount;
            const warningLevel = remaining === 1 ? '🚨 Cảnh báo nghiêm trọng!' : remaining === 2 ? '⚠️ Cảnh báo!' : '⚠️ Lưu ý!';
            const progressBar = `
                <div style="width: 100%; height: 8px; background: #fde68a; border-radius: 4px; margin: 10px 0; overflow: hidden;">
                    <div style="width: ${(violationCount / maxViolations) * 100}%; height: 100%; background: ${remaining === 1 ? '#dc2626' : remaining === 2 ? '#f59e0b' : '#10b981'}; transition: width 0.3s;"></div>
                </div>
            `;
            
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="font-size: 28px; color: #f59e0b; margin-bottom: 8px;"></i>
                <div style="font-size: 16px; margin-bottom: 5px;">${warningLevel}</div>
                <div style="font-size: 13px; color: #92400e; margin-bottom: 8px;">${message}</div>
                ${progressBar}
                <div style="font-size: 12px; color: #92400e;">
                    Vi phạm: <strong>${violationCount}/${maxViolations}</strong> lần
                    ${remaining > 0 ? ` • Còn <strong>${remaining}</strong> lần nữa sẽ bị khóa tài khoản` : ''}
                </div>
            `;
            messagesContainer.appendChild(warningDiv);
            scrollToBottom();
            
            // Auto remove after 10 seconds
            setTimeout(() => {
                warningDiv.remove();
            }, 10000);
        }

        function showChatLoading(message) {
            const messagesContainer = document.getElementById('support-chat-messages');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'chat-loading-indicator';
            loadingDiv.style.cssText = 'text-align: center; padding: 10px; color: #667eea; font-size: 14px;';
            loadingDiv.innerHTML = `<i class="fas fa-spinner fa-spin"></i> ${message}`;
            messagesContainer.appendChild(loadingDiv);
        }

        function hideChatLoading() {
            const loadingDiv = document.getElementById('chat-loading-indicator');
            if (loadingDiv) loadingDiv.remove();
        }

        function openImageLightbox(imageUrl) {
            const lightbox = document.getElementById('support-image-lightbox');
            const lightboxImage = document.getElementById('support-lightbox-image');
            lightboxImage.src = imageUrl;
            lightbox.style.display = 'flex';
            lightbox.style.alignItems = 'center';
            lightbox.style.justifyContent = 'center';
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Show order selection modal
        async function showOrderModal() {
            const modal = document.getElementById('support-order-modal');
            const container = document.getElementById('order-list-container');
            modal.style.display = 'flex';
            
            try {
                const response = await fetch('/api/orderapi');
                if (!response.ok) throw new Error('Failed to load orders');
                
                const result = await response.json();
                const orders = result.data || result || [];
                
                if (!orders || orders.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Bạn chưa có đơn hàng nào</p>';
                    return;
                }
                
                container.innerHTML = orders.map(order => {
                    // Lấy ảnh sản phẩm đầu tiên trong đơn hàng
                    const orderDetailsKey = order.orderDetails || order.OrderDetails;
                    const firstProductImage = orderDetailsKey && orderDetailsKey.length > 0 
                        ? (orderDetailsKey[0].productImage || orderDetailsKey[0].ProductImage || orderDetailsKey[0].images?.[0]?.url || '/images/default-product.png')
                        : '/images/default-product.png';
                    
                    // API có thể trả về id/Id/ID
                    const orderId = order.id || order.Id || order.ID;
                    const orderIdString = order.orderId || order.OrderId;
                    
                    return `
                        <div class="order-item" onclick="sendOrderLink(${orderId}, '${orderIdString}', '${order.orderDate || order.OrderDate}', ${order.totalAmount || order.TotalAmount}, '${order.status || order.Status}', '${firstProductImage}')">
                            <div><strong>Đơn hàng: #${orderIdString || orderId}</strong></div>
                            <div class="text-muted small">Ngày đặt: ${new Date(order.orderDate || order.OrderDate).toLocaleDateString('vi-VN')}</div>
                            <div class="text-muted small">Tổng tiền: ${(order.totalAmount || order.TotalAmount).toLocaleString('vi-VN')}đ</div>
                            <div><span class="badge bg-${getOrderStatusColor(order.status || order.Status)}">${order.status || order.Status}</span></div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading orders:', error);
                container.innerHTML = '<p class="text-center text-danger">Không thể tải danh sách đơn hàng</p>';
            }
        }

        // Show product selection modal
        async function showProductModal() {
            const modal = document.getElementById('support-product-modal');
            const container = document.getElementById('product-list');
            modal.style.display = 'flex';
            
            loadProducts();
            
            // Search functionality
            const searchInput = document.getElementById('product-search');
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    loadProducts(this.value);
                }, 500);
            });
        }

        async function loadProducts(searchTerm = '') {
            const container = document.getElementById('product-list');
            container.innerHTML = '<p class="text-center text-muted">Đang tải...</p>';
            
            try {
                const url = `/api/productapi/products?${searchTerm ? 'search=' + encodeURIComponent(searchTerm) + '&' : ''}pageSize=20`;
                    
                const response = await fetch(url);
                if (!response.ok) throw new Error('Failed to load products');
                
                const result = await response.json();
                const products = result.data || result || [];
                
                if (!products || products.length === 0) {
                    container.innerHTML = '<p class="text-center text-muted">Không tìm thấy sản phẩm</p>';
                    return;
                }
                
                container.innerHTML = products.map(product => {
                    const productImage = product.imageUrl || (product.images && product.images[0]) || '/images/no-image.png';
                    const discountPrice = product.discountedPrice || product.discountPrice || null;
                    const hasDiscount = discountPrice && discountPrice < product.price && product.hasDiscount;
                    
                    return `
                        <div class="product-item" onclick="sendProductLink(${product.id}, \`${product.name.replace(/`/g, '').replace(/'/g, "\\'")}\`, ${product.price}, '${productImage}', ${hasDiscount ? discountPrice : null})">
                            <img src="${productImage}" alt="${product.name}" onerror="this.src='/images/no-image.png'">
                            <div>
                                <div><strong>${product.name}</strong></div>
                                <div class="small">
                                    ${hasDiscount ? `<span class="text-danger">${discountPrice.toLocaleString('vi-VN')}đ</span> <span class="text-muted" style="text-decoration: line-through;">${product.price.toLocaleString('vi-VN')}đ</span>` : `<span class="text-danger">${product.price.toLocaleString('vi-VN')}đ</span>`}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading products:', error);
                container.innerHTML = '<p class="text-center text-danger">Không thể tải danh sách sản phẩm</p>';
            }
        }

        async function sendOrderLink(id, orderId, orderDate, totalAmount, status, imageUrl) {
            // Nếu id undefined, hiển thị lỗi
            if (!id || id === 'undefined') {
                showChatError('Không thể gửi đơn hàng - thiếu ID');
                return;
            }
            
            // Gửi dạng JSON để phía nhận có thể parse và hiển thị đẹp
            const attachmentData = {
                type: 'order',
                id: parseInt(id),
                orderId: orderId,
                orderDate: orderDate,
                totalAmount: totalAmount,
                status: status,
                imageUrl: imageUrl,
                url: `${window.location.origin}/Order/Details/${parseInt(id)}`
            };
            
            const message = `[ATTACHMENT:${JSON.stringify(attachmentData)}]`;
            document.getElementById('support-order-modal').style.display = 'none';
            
            // Gửi luôn tin nhắn
            try {
                await supportChatConnection.invoke('SendMessage', currentConversationId, message, null);
            } catch (error) {
                console.error('Error sending order link:', error);
                showChatError('Không thể gửi thông tin đơn hàng. Vui lòng thử lại.');
            }
        }

        async function sendProductLink(productId, productName, price, imageUrl, discountPrice) {
            // Gửi dạng JSON để phía nhận có thể parse và hiển thị đẹp
            const attachmentData = {
                type: 'product',
                productId: productId,
                productName: productName,
                price: price,
                discountPrice: discountPrice,
                imageUrl: imageUrl,
                url: `${window.location.origin}/Product/Details/${productId}`
            };
            
            const message = `[ATTACHMENT:${JSON.stringify(attachmentData)}]`;
            document.getElementById('support-product-modal').style.display = 'none';
            
            // Gửi luôn tin nhắn
            try {
                await supportChatConnection.invoke('SendMessage', currentConversationId, message, null);
            } catch (error) {
                console.error('Error sending product link:', error);
                showChatError('Không thể gửi thông tin sản phẩm. Vui lòng thử lại.');
            }
        }

        function getOrderStatusColor(status) {
            const colors = {
                'Chờ xác nhận': 'warning',
                'Đã xác nhận': 'info',
                'Đang giao': 'primary',
                'Đã giao': 'success',
                'Đã hủy': 'danger'
            };
            return colors[status] || 'secondary';
        }

        // Toggle message options menu
        function toggleMessageMenu(event, messageId) {
            event.stopPropagation();
            const menu = document.getElementById(`message-menu-${messageId}`);
            
            // Close all other menus
            document.querySelectorAll('.support-message-options-menu').forEach(m => {
                if (m.id !== `message-menu-${messageId}`) {
                    m.classList.remove('show');
                }
            });
            
            menu.classList.toggle('show');
        }

        // Close menu when clicking outside
        document.addEventListener('click', function() {
            document.querySelectorAll('.support-message-options-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        });

        // Recall message function
        async function recallMessage(messageId) {
            if (!confirm('Bạn có chắc chắn muốn thu hồi tin nhắn này không?')) {
                return;
            }

            try {
                const response = await fetch(`/api/supportchat/message/${messageId}/recall`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', errorText);
                    let errorMessage = 'Không thể thu hồi tin nhắn';
                    try {
                        const errorJson = JSON.parse(errorText);
                        errorMessage = errorJson.message || errorMessage;
                    } catch (e) {
                        errorMessage = errorText || errorMessage;
                    }
                    alert(errorMessage);
                    return;
                }

                const result = await response.json();

                if (result.success || response.ok) {
                    // Cập nhật UI: tìm và thay đổi tin nhắn thành "[Tin nhắn đã được thu hồi]"
                    const messageElements = document.querySelectorAll('.support-message');
                    const currentTime = new Date().toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                    
                    messageElements.forEach(msgEl => {
                        if (msgEl.dataset.messageId == messageId) {
                            // Ẩn nút 3 chấm
                            const optionsBtn = msgEl.querySelector('.support-message-options');
                            if (optionsBtn) {
                                optionsBtn.remove();
                            }
                            
                            // Cập nhật nội dung tin nhắn
                            const contentDiv = msgEl.querySelector('.support-message-content');
                            if (contentDiv) {
                                contentDiv.innerHTML = `
                                    <div class="support-message-bubble support-message-recalled">
                                        <i class="fas fa-ban"></i> Tin nhắn đã được thu hồi
                                    </div>
                                    <div class="support-message-time">${currentTime}</div>
                                `;
                            }
                        }
                    });

                    // Notify via SignalR (sẽ làm ở bước tiếp theo)
                    if (supportChatConnection && result.conversationId) {
                        await supportChatConnection.invoke('RecallMessage', result.conversationId, messageId);
                    }
                } else {
                    alert(result.message || 'Không thể thu hồi tin nhắn');
                }
            } catch (error) {
                console.error('Error recalling message:', error);
                alert('Có lỗi xảy ra khi thu hồi tin nhắn');
            }
        }

        // Send quick action message
        async function sendQuickAction(message) {
            const input = document.getElementById('support-message-input');
            input.value = message;
            await sendSupportMessage();
        }
    </script>
}
