<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Bloomie</title>
    <link rel="icon" type="image/png" href="/images/BloomieFavicon.png" sizes="32x32" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <style>
        :root {
            --primary: #C41E3A;
            --accent: #F4A261;
            --light: #FFFFFF;
            --dark: #2B2D42;
            --gray: #8D99AE;
            --shadow-sm: 0 4px 15px rgba(0,0,0,0.08);
            --shadow-lg: 0 20px 40px rgba(0,0,0,0.12);
            --transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
        }
        *, *::before, *::after { box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Roboto', sans-serif;
            background: var(--light);
            color: var(--dark);
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            line-height: 1.6;
            opacity: 0;
            transition: opacity 0.4s ease-in-out;
        }
        body.page-loaded {
            opacity: 1;
        }
        body.page-transitioning {
            opacity: 0;
        }

        /* Top Bar */
        .top-bar {
            background: var(--primary);
            color: #fff;
            padding: 8px 20px;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(196, 30, 58, 0.15);
        }
        .top-bar a { color: #fff; text-decoration: none; font-weight: 500; }
        .top-bar a:hover { text-decoration: underline; }

        /* Header */
        .header-top {
            background: #fff;
            padding: 15px 20px 0;
            position: relative;
            z-index: 200;
            box-shadow: none;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
        }
        .header-search {
            flex: 0 0 auto;
            max-width: 420px;
            margin: 0;
            padding-top: 15px;
            order: 1;
            position: relative;
            z-index: 201;
        }
        .search-bar {
            display: flex;
            align-items: center;
            background: #fff;
            border: 2px solid #eee;
            border-radius: 50px;
            padding: 10px 18px;
            transition: var(--transition);
            box-shadow: none;
        }
        .search-bar:focus-within {
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(196, 30, 58, 0.15);
            transform: scale(1.02);
        }
        .search-bar input[type="text"] {
            border: none;
            outline: none;
            flex: 1;
            font-size: 1rem;
            font-family: 'Roboto', sans-serif;
        }
        .search-bar button {
            background: transparent;
            border: none;
            color: var(--primary);
            font-size: 1.25rem;
            cursor: pointer;
            padding: 0 10px;
            transition: var(--transition);
        }
        .search-bar button:hover { color: var(--accent); transform: scale(1.1); }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-top: 15px;
            margin-left: auto;
            order: 2;
            position: relative;
            z-index: 201;
        }
        .action-btn {
            background: transparent;
            color: var(--dark);
            font-weight: 600;
            padding: 10px 18px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            transition: var(--transition);
            white-space: nowrap;
            cursor: pointer;
        }
        .action-btn:hover {
            background: rgba(196, 30, 58, 0.1);
            color: var(--primary);
            transform: translateY(-2px);
        }
        .action-btn .badge {
            background: var(--primary);
            color: #fff;
            font-size: 0.7rem;
            padding: 4px 8px;
            border-radius: 50%;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Logo */
        .header-brand {
            position: relative;
            left: 50%;
            transform: translateX(-50%);
            margin-top: -80px;
            margin-bottom: -40px;
            z-index: 300;
            text-align: center;
            pointer-events: none;
        }
        .header-brand a {
            display: inline-block;
            pointer-events: auto;
        }
        .header-brand img {
            height: 200px;
            filter: none;
            transition: var(--transition);
            background: none;
            border-radius: 0;
            padding: 0;
        }
        .header-brand a:hover img { transform: scale(1.05); }

        /* Main Nav */
        .main-nav {
            background: #fff;
            padding: 10px 0 10px 0;
            box-shadow: none;
            border-top: none;
            border-bottom: none;
            margin-top: -80px;
            z-index: 150;
            position: relative;
        }
        .main-menu {
            max-width: 1500px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 50px;
            position: relative;
            z-index: 151;
        }
        .nav-left {
            display: flex;
            gap: 25px;
            list-style: none;
            margin: 0;
            padding: 0;
            flex: 1;
            justify-content: flex-start;
        }
        .nav-right {
            display: flex;
            gap: 25px;
            list-style: none;
            margin: 0;
            padding: 0;
            flex: 1;
            justify-content: flex-end;
        }
        .main-menu .dropdown {
            position: relative !important;
        }
        .main-menu .dropdown-menu {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            margin-top: 0 !important;
            display: none;
            min-width: 180px;
            box-shadow: var(--shadow-sm);
        }
        .main-menu .dropdown:hover .dropdown-menu {
            display: block !important;
        }
        .nav-link {
            color: var(--dark);
            font-weight: 700;
            font-size: 1.08rem;
            text-decoration: none;
            padding: 10px 0;
            position: relative;
            transition: var(--transition);
            border-bottom: none !important;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            width: 0 !important;
            opacity: 0 !important;
            height: 3px;
            background: var(--primary);
            transition: var(--transition);
            transform: translateX(-50%);
            border-radius: 2px;
            pointer-events: none;
        }
        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100% !important;
            opacity: 1 !important;
        }
        .nav-link:hover, .nav-link.active { color: var(--primary); }

        /* Carousel */
        #promoCarousel {
            margin: 0px 0 40px;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }
        .carousel-item {
            height: 520px;
            position: relative;
        }
        .carousel-item::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(135deg, rgba(0,0,0,0.4), rgba(0,0,0,0.6));
            z-index: 1;
        }
        .carousel-media {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 8s ease;
        }
        .carousel-item:hover .carousel-media { transform: scale(1.05); }
        .carousel-caption {
            position: absolute;
            bottom: 40px;
            left: 50px;
            max-width: 420px;
            background: linear-gradient(135deg, rgba(196, 30, 58, 0.92), rgba(244, 162, 97, 0.85));
            padding: 25px 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            z-index: 2;
            animation: fadeInUp 0.8s ease-out;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .carousel-caption h5 {
            font-family: 'Playfair Display', serif;
            font-size: 2.4rem;
            margin: 0 0 12px;
            color: #fff;
        }
        .carousel-caption p { font-size: 1.1rem; margin-bottom: 18px; color: #fff; }
        .carousel-caption .btn {
            background: #fff;
            color: var(--primary);
            font-weight: 700;
            padding: 12px 28px;
            border-radius: 50px;
            font-size: 1rem;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }
        .carousel-caption .btn:hover {
            background: var(--accent);
            color: #fff;
            transform: translateY(-3px);
        }

        /* Category Section */
        .category-section h2 {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
            text-align: center;
            margin-bottom: 50px;
            position: relative;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .category-section h2::after {
            content: '';
            width: 50px;
            height: 3px;
            background: var(--primary);
            position: absolute;
            bottom: -15px;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 0;
        }
        .category-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 30px;
            justify-items: center;
        }
        .category-item {
            text-align: center;
            transition: var(--transition);
        }
        .category-img {
            width: 210px;
            height: 210px;
            object-fit: cover;
            border-radius: 50%;
            border: 6px solid #fff;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
        }
        .category-item:hover .category-img {
            transform: scale(1.1);
            box-shadow: 0 15px 35px rgba(196, 30, 58, 0.2);
        }
        .category-item h3 {
            font-size: 1.35rem;
            color: var(--primary);
            margin-top: 18px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Product Card */
        .product-card {
            background: #fff;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .product-card:hover {
            transform: translateY(-15px) scale(1.02);
            box-shadow: var(--shadow-lg);
        }
        .product-card img {
            height: 240px;
            object-fit: cover;
            transition: var(--transition);
        }
        .product-card:hover img { transform: scale(1.05); }
        .product-card .promo-badge {
            position: absolute;
            top: 15px;
            left: 15px;
            background: var(--primary);
            color: #fff;
            font-size: 0.8rem;
            padding: 6px 12px;
            border-radius: 50px;
            font-weight: 600;
            z-index: 1;
        }
        .product-card h3 {
            font-family: 'Playfair Display', serif;
            font-size: 1.35rem;
            color: var(--dark);
            margin: 15px 20px 8px;
            height: 54px;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .product-card .price {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0 20px 15px;
        }
        .product-card .btn {
            margin: 0 20px 10px;
            background: linear-gradient(135deg, var(--primary), #E63946);
            color: #fff;
            border: none;
            padding: 12px;
            border-radius: 50px;
            font-weight: 600;
            transition: var(--transition);
        }
        .product-card .btn:hover {
            background: var(--accent);
            transform: translateY(-2px);
        }
        .quick-view {
            margin: 0 20px 15px;
            background: #f8f9fa;
            color: var(--dark);
            padding: 10px;
            border-radius: 50px;
            font-weight: 600;
            opacity: 0;
            transform: translateY(10px);
            transition: var(--transition);
        }
        .product-card:hover .quick-view { opacity: 1; transform: translateY(0); }

        /* Footer */
        .footer {
            background: #fff;
            padding: 60px 0 30px;
            margin-top: auto;
            border-top: 1px solid #eee;
        }
        .footer .row {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin: 0 -15px;
        }
        .footer-col {
            flex: 1;
            min-width: 220px;
            padding: 0 15px;
        }
        .footer h5 {
            font-family: 'Playfair Display', serif;
            color: var(--primary);
            font-size: 1.4rem;
            margin-bottom: 20px;
        }
        .footer p, .footer a {
            font-size: 0.95rem;
            color: var(--gray);
            transition: var(--transition);
        }
        .footer a:hover { color: var(--primary) !important; transform: translateX(5px); }
        .footer-links ul { list-style: none; padding: 0; margin: 0; }
        .footer-links ul li { margin-bottom: 10px; }
        .footer-links ul li a {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
        }
        .social-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .social-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            border-radius: 8px;
            background: #fff;
            border: 1px solid #eee;
            text-decoration: none;
            color: var(--gray);
            font-size: 0.95rem;
            transition: var(--transition);
        }
        .social-btn img {
            width: 18px;
            height: 18px;
        }
        .social-btn:hover {
            background: var(--primary);
            color: #fff !important;
            transform: translateX(5px);
            box-shadow: var(--shadow-sm);
        }
        .newsletter-form {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            max-width: 320px;
        }
        .newsletter-form input {
            flex: 1;
            padding: 12px 18px;
            border: 1px solid #ddd;
            border-radius: 50px;
            font-size: 0.95rem;
        }
        .newsletter-form button {
            background: var(--primary);
            color: #fff;
            border: none;
            padding: 12px 24px;
            border-radius: 50px;
            font-weight: 600;
        }
        .footer-divider { border-top: 1px solid #ddd; margin: 30px 0; }

        /* Modals */
        .camera-modal, .analysis-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 2000;
            padding: 20px;
        }
        .camera-modal video, .camera-modal canvas, .camera-modal img,
        .analysis-modal img {
            max-width: 90%;
            max-height: 65vh;
            border-radius: 16px;
            box-shadow: var(--shadow-lg);
        }

        /* Flower Detection Modal */
        .flower-detection-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        .flower-detection-container {
            position: relative;
            width: 95%;
            height: 95%;
            max-width: 1400px;
            max-height: 900px;
            display: flex;
            flex-direction: column;
            background: #000;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.8);
        }
        .flower-preview {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #1a1a1a;
        }
        .flower-preview video,
        .flower-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .flower-back-btn {
            position: absolute;
            top: 30px;
            left: 30px;
            background: rgba(0,0,0,0.7);
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            width: 56px;
            height: 56px;
            color: white;
            font-size: 24px;
            cursor: pointer;
            transition: var(--transition);
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flower-back-btn:hover {
            background: rgba(0,0,0,0.9);
            border-color: rgba(255,255,255,0.6);
            transform: scale(1.1);
        }
        #flowerLiveIndicator {
            position: absolute;
            top: 30px;
            right: 30px;
            background: #dc3545;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.5);
        }
        .flower-stop-live-btn {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            background: #dc3545;
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
            padding: 16px 40px;
            border-radius: 50px;
            font-weight: bold;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.6);
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .flower-stop-live-btn:hover {
            background: #bb2d3b;
            transform: translateX(-50%) scale(1.05);
            box-shadow: 0 6px 25px rgba(220, 53, 69, 0.8);
        }
        .live-dot {
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            animation: pulse 1.5s infinite;
        }
        @@keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.9); }
        }
        .flower-actions {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to top, rgba(0,0,0,0.95), rgba(0,0,0,0.8), transparent);
            padding: 50px 40px 40px;
        }
        .flower-btn {
            border: none;
            padding: 10px 16px;
            border-radius: 10px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            transition: var(--transition);
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }
        .flower-btn i {
            font-size: 20px;
        }
        .flower-btn-primary {
            background: var(--primary);
            color: white;
        }
        .flower-btn-primary:hover {
            background: #A01828;
            transform: translateY(-2px);
        }
        .flower-btn-secondary {
            background: white;
            color: var(--primary);
        }
        .flower-btn-secondary:hover {
            background: #f5f5f5;
            transform: translateY(-2px);
        }
        #flowerDetectionResult {
            /* Container cho kết quả - không set position ở đây, để JS xử lý */
            z-index: 5;
        }

        /* Animations */
        @@keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .category-section, .product-section { animation: fadeInUp 0.8s ease-out; }

        /* Responsive */
        @@media (max-width: 992px) {
            .main-menu { gap: 50px; flex-wrap: wrap; justify-content: center; }
            .header-brand img { height: 140px; }
            .carousel-item { height: 400px; }
            .carousel-caption { left: 20px; right: 20px; bottom: 20px; padding: 18px; }
            
            .flower-detection-container {
                width: 100%;
                height: 100%;
                max-width: none;
                max-height: none;
                border-radius: 0;
            }
            .flower-actions {
                padding: 40px 20px 30px;
            }
            .flower-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
            .flower-btn i {
                font-size: 18px;
            }
            #flowerDetectionResult {
                padding: 20px;
            }
        }
        @@media (max-width: 768px) {
            .header-top { padding-bottom: 70px; }
            .search-bar { max-width: 100%; }
            .header-actions { gap: 8px; }
            .action-btn { padding: 8px 12px; font-size: 0.85rem; }
            
            .flower-back-btn {
                width: 48px;
                height: 48px;
                font-size: 20px;
                top: 20px;
                left: 20px;
            }
            #flowerLiveIndicator {
                padding: 8px 16px;
                font-size: 13px;
                top: 20px;
                right: 20px;
            }
            .flower-stop-live-btn {
                padding: 12px 30px;
                font-size: 16px;
                bottom: 30px;
            }
        }

        /* Fix: Inline form */
        form[style="display:inline;"] {
            margin: 0;
            padding: 0;
            display: inline;
        }

        /* Global Notification */
        .global-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #4CAF50;
            color: #fff;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            justify-content: space-between;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, visibility 0.3s ease, transform 0.3s ease;
            z-index: 9999;
            min-width: 300px;
        }
        .global-notification.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        .global-notification.error {
            background: #D0021B;
        }
        .global-notification.success {
            background: #4CAF50;
        }
        .global-notification.info {
            background: #2196F3;
        }
        .global-notification .close-btn {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.2rem;
            margin-left: 15px;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .global-notification .close-btn:hover {
            color: #ddd;
        }
    </style>
</head>
<body>
    <!-- Global Notification -->
    <div id="globalNotification" class="global-notification">
        <span id="globalNotificationMessage"></span>
        <button onclick="closeGlobalNotification()" class="close-btn">×</button>
    </div>

    <!-- Top Bar -->
    <div class="top-bar">
        <div><i class="bi bi-truck"></i> Giao hoa nhanh 60 phút tại <a href="#">TP.HCM</a></div>
        <div class="language-selector">
            <a href="#"><img src="https://flagcdn.com/16x12/gb.png" alt="EN"> English</a>
        </div>
    </div>

    <!-- Header -->
    <header class="header-top">
        <div class="header-search">
            <form asp-controller="Product" asp-action="Index" method="get" class="search-bar">
                <input type="text" name="searchString" id="searchInput" placeholder="Tìm hoa, bó hoa, hoặc tải ảnh..." />
                <input type="file" id="imageFile" accept="image/*" style="display:none;" />
                <button type="submit"><i class="bi bi-search"></i></button>
                <button type="button" onclick="document.getElementById('imageFile').click()"><i class="bi bi-upload"></i></button>
                <button type="button" onclick="openCameraModal()"><i class="bi bi-camera"></i></button>
                <button type="button" onclick="openFlowerDetectionModal()" title="Nhận diện hoa AI">
                    <i class="bi bi-stars"></i>
                </button>
            </form>
        </div>

        <div class="header-actions">
            <div class="login-partial">
                @if (User.Identity?.IsAuthenticated ?? false)
                {
                    <div class="dropdown">
                        <a class="dropdown-toggle action-btn" href="#" data-bs-toggle="dropdown">
                            <i class="bi bi-person"></i> @User.Identity.Name
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" asp-controller="Account" asp-action="Profile"><i class="fas fa-user"></i> Tài khoản</a></li>
                            @if (User.IsInRole("User"))
                            {
                                <li><a class="dropdown-item" asp-controller="Order" asp-action="Index"><i class="fas fa-shopping-bag"></i> Đơn hàng</a></li>
                                <li><a class="dropdown-item" asp-controller="WishList" asp-action="Index"><i class="fas fa-heart"></i> Sản phẩm yêu thích</a></li>
                                <li><a class="dropdown-item" asp-controller="Promotion" asp-action="MyVouchers"><i class="fas fa-ticket-alt"></i> Ví Voucher</a></li>
                            }
                            <li><a class="dropdown-item" asp-controller="Account" asp-action="Logout"><i class="fas fa-sign-out-alt"></i> Đăng xuất</a></li>
                        </ul>
                    </div>
                }
                else
                {
                    <form asp-controller="Account" asp-action="Login" method="get" style="display:inline;">
                        <button class="action-btn" type="submit">
                            <i class="fas fa-sign-in-alt"></i> Đăng nhập
                        </button>
                    </form>
                }
            </div>

            <!-- Giỏ hàng -->
            <form asp-controller="ShoppingCart" asp-action="Index" method="get" style="display:inline;">
                <button class="action-btn position-relative" type="submit">
                    <i class="bi bi-cart-fill"></i> Giỏ hàng
                    <span id="cartCount" class="badge">@await Component.InvokeAsync("CartCount")</span>
                </button>
            </form>
        </div>
    </header>

    <!-- Logo Overlap -->
    <div class="header-brand">
        <a asp-controller="Home" asp-action="Index">
            <img src="/images/logos/bloomie_logo.png" alt="Bloomie Flower Shop">
        </a>
    </div>

    <!-- Main Nav -->
    <nav class="main-nav">
        <div class="main-menu">
            @await Html.PartialAsync("_CategoryMenu")
        </div>
    </nav>

    <!-- Main Content -->
    <main style="flex: 1;">
        @if (ViewContext.RouteData.Values["Controller"]?.ToString() == "Home" && ViewContext.RouteData.Values["Action"]?.ToString() == "Index")
        {
            <!-- Carousel -->
            <div id="promoCarousel" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-indicators">
                    <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="0" class="active"></button>
                    <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="1"></button>
                    <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="2"></button>
                    <button type="button" data-bs-target="#promoCarousel" data-bs-slide-to="3"></button>
                </div>
                <div class="carousel-inner">
                    <div class="carousel-item active">
                        <img src="/images/banners/banner1.gif" class="carousel-media" alt="Khuyến mãi" loading="lazy">
                        <div class="carousel-caption">
                            <h5>Phục vụ 24/24</h5>
                            <p>Có dịch vụ giao nhanh trong 60 phút</p>
                            <a href="#" class="btn">Tìm hiểu ngay</a>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="/images/banners/banner2.gif" class="carousel-media" alt="Bó hoa" loading="lazy">
                        <div class="carousel-caption">
                            <h5>Bó Hoa Tùy Chỉnh</h5>
                            <p>Thiết kế bó hoa theo ý thích của bạn</p>
                            <a href="#" class="btn">Tùy chỉnh ngay</a>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="/images/banners/banner3.gif" class="carousel-media" alt="Hoa sinh nhật" loading="lazy">
                        <div class="carousel-caption">
                            <h5>Hoa Sinh Nhật Đẹp</h5>
                            <p>Gửi lời chúc ý nghĩa với hoa tươi</p>
                            <a href="#" class="btn">Xem ngay</a>
                        </div>
                    </div>
                    <div class="carousel-item">
                        <img src="/images/banners/banner4.gif" class="carousel-media" alt="Giao hoa" loading="lazy">
                        <div class="carousel-caption">
                            <h5>Giao Hoa Tận Nơi</h5>
                            <p>Giao nhanh trong 2 giờ tại TP.HCM</p>
                            <a href="#" class="btn">Đặt ngay</a>
                        </div>
                    </div>
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#promoCarousel" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#promoCarousel" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>

            <!-- Danh mục -->
            <div class="container">
                <section class="category-section">
                    <h2>MẪU HOA MỚI 2025</h2>
                    <div class="category-grid">
                        <div class="category-item">
                            <a asp-controller="Product" asp-action="Index" asp-route-categoryName="Lãng Mạn">
                                <img src="/images/logos/hoa_tinh_yeu.webp" alt="Hoa tình yêu" class="category-img" />
                            </a>
                            <h3>HOA TÌNH YÊU</h3>
                        </div>
                        <div class="category-item">
                            <a asp-controller="Product" asp-action="Index" asp-route-categoryName="Sinh Nhật">
                                <img src="/images/logos/hoa_sinh_nhat.jpg" alt="Hoa sinh nhật" class="category-img" />
                            </a>
                            <h3>HOA SINH NHẬT</h3>
                        </div>
                        <div class="category-item">
                            <a asp-controller="Product" asp-action="Index" asp-route-categoryName="Hoa Cưới">
                                <img src="/images/logos/hoa_cuoi.jpg" alt="Hoa cưới" class="category-img" />
                            </a>
                            <h3>HOA CƯỚI</h3>
                        </div>
                        <div class="category-item">
                            <a asp-controller="Product" asp-action="Index" asp-route-categoryName="Chúc Mừng">
                                <img src="/images/logos/hoa_chuc_mung.jpg" alt="Hoa chúc mừng" class="category-img" />
                            </a>
                            <h3>HOA CHÚC MỪNG</h3>
                        </div>
                    </div>
                </section>
            </div>
        }

        <div class="container">
            <div class="main-content">@RenderBody()</div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="row">
                <!-- Cột 1 -->
                <div class="footer-col">
                    <h5>Bloomie Flower Shop</h5>
                    <p class="text-muted">Cửa hàng hoa tươi hàng đầu Việt Nam, mang đến những bó hoa ý nghĩa cho mọi dịp đặc biệt.</p>
                    <p class="mb-1"><i class="bi bi-geo-alt me-2"></i> Trụ sở: 456 Đường Hoa Hồng, Quận 3, TP. HCM</p>
                    <p class="mb-1"><i class="bi bi-telephone me-2"></i> Hotline: (028) 9876-5432</p>
                    <p class="mb-1"><i class="bi bi-envelope me-2"></i> Email: bloomieshop25@gmail.vn</p>
                    <p><i class="bi bi-globe me-2"></i> Website: <a href="https://bloomieshop.vn" target="_blank">bloomieshop.vn</a></p>
                </div>
                <!-- Cột 2 -->
                <div class="footer-col">
                    <h5>Hỗ trợ khách hàng</h5>
                    <div class="footer-links">
                        <ul>
                            <li><a asp-controller="Home" asp-action="FAQ"><i class="bi bi-question-circle me-2"></i> Câu hỏi thường gặp</a></li>
                            <li><a asp-controller="Home" asp-action="Contact"><i class="bi bi-headset me-2"></i> Liên hệ hỗ trợ</a></li>
                            <li><a asp-controller="Home" asp-action="ShippingPolicy"><i class="bi bi-truck me-2"></i> Chính sách giao hàng</a></li>
                            <li><a asp-controller="Home" asp-action="ReturnPolicy"><i class="bi bi-arrow-return-left me-2"></i> Chính sách đổi trả</a></li>
                            <li><a asp-controller="Home" asp-action="PaymentMethods"><i class="bi bi-credit-card me-2"></i> Phương thức thanh toán</a></li>
                        </ul>
                    </div>
                </div>
                <!-- Cột 3 -->
                <div class="footer-col">
                    <h5>Danh mục sản phẩm</h5>
                    <div class="footer-links">
                        <ul>
                            <li><a asp-controller="Product" asp-action="Index" asp-route-categoryId="1"><i class="bi bi-flower1 me-2"></i> Hoa sinh nhật</a></li>
                            <li><a asp-controller="Product" asp-action="Index" asp-route-categoryId="2"><i class="bi bi-flower1 me-2"></i> Hoa chúc mừng</a></li>
                            <li><a asp-controller="Product" asp-action="Index" asp-route-categoryId="3"><i class="bi bi-flower1 me-2"></i> Hoa tình yêu</a></li>
                            <li><a asp-controller="Product" asp-action="Index" asp-route-categoryId="4"><i class="bi bi-flower1 me-2"></i> Hoa chia buồn</a></li>
                            <li><a asp-controller="Product" asp-action="Index"><i class="bi bi-flower1 me-2"></i> Xem tất cả</a></li>
                        </ul>
                    </div>
                </div>
                <!-- Cột 4 -->
                <div class="footer-col">
                    <h5>Thông tin cửa hàng</h5>
                    <div class="footer-links">
                        <ul>
                            <li><a asp-controller="Home" asp-action="About"><i class="bi bi-info-circle me-2"></i> Về Bloomie</a></li>
                            <li><a asp-controller="Home" asp-action="StoreLocations"><i class="bi bi-geo-alt me-2"></i> Danh sách cửa hàng</a></li>
                            <li><a href="https://www.facebook.com/bloomie" target="_blank"><i class="bi bi-facebook me-2"></i> Fanpage Bloomie</a></li>
                            <li><a asp-controller="Home" asp-action="FlowerMeanings"><i class="bi bi-flower1 me-2"></i> Ý nghĩa các loài hoa</a></li>
                            <li><a asp-controller="Blog" asp-action="Index"><i class="bi bi-book me-2"></i> Blog về hoa</a></li>
                        </ul>
                    </div>
                </div>
                <!-- Cột 5 -->
                <div class="footer-col">
                    <h5>Cam kết của chúng tôi</h5>
                    <div class="footer-links">
                        <ul>
                            <li><a><i class="bi bi-check-circle me-2"></i> Hoa tươi 100%, nhập mới mỗi ngày</a></li>
                            <li><a><i class="bi bi-check-circle me-2"></i> Giao hoa nhanh trong 60 phút</a></li>
                            <li><a><i class="bi bi-check-circle me-2"></i> Hoàn tiền 100% nếu không hài lòng</a></li>
                            <li><a><i class="bi bi-check-circle me-2"></i> Hỗ trợ tận tình 24/7</a></li>
                        </ul>
                    </div>
                </div>
            </div>

            <hr class="footer-divider" />
            <div class="row">
                <div class="footer-col">
                    <h5>Chi nhánh Bloomie</h5>
                    <p><strong>Shop Hoa TP.HCM:</strong> 230B Võ Thị Sáu, P.6, Quận 3 - (028) 1234-5678</p>
                    <p><strong>Shop Hoa Hà Nội:</strong> 32A Đường 730, Quận Hoàn Kiếm - (024) 8765-4321</p>
                    <p><strong>Shop Hoa Đà Nẵng:</strong> 45 Nguyễn Văn Linh, Hải Châu - (0236) 456-7890</p>
                    <p><strong>Shop Hoa Cần Thơ:</strong> 181 Thống Nhất, Ninh Kiều - (0292) 234-5678</p>
                </div>
                <div class="footer-col" style="flex: 2;">
                    <h5>Giới thiệu về Bloomie</h5>
                    <p class="text-muted">Bloomie Flower Shop là địa chỉ cung cấp hoa tươi uy tín tại Việt Nam. Chúng tôi tự hào mang đến những bó hoa tinh tế, ý nghĩa, giúp bạn gửi gắm tình cảm trong mọi dịp đặc biệt. Với hệ thống cửa hàng tại TP.HCM, Hà Nội, Đà Nẵng và Cần Thơ, Bloomie luôn sẵn sàng phục vụ bạn với dịch vụ giao hoa nhanh chóng và tận tâm.</p>
                </div>
                <div class="footer-col">
                    <h5>Theo dõi chúng tôi</h5>
                    <div class="social-links">
                        <a href="https://www.google.com/bloomie" class="social-btn" aria-label="Instagram">
                            <img src="https://www.google.com/favicon.ico" alt="Google Logo"> Google
                        </a>
                        <a href="https://www.facebook.com/bloomie" class="social-btn" aria-label="Facebook">
                            <img src="https://www.facebook.com/favicon.ico" alt="Facebook Logo"> Facebook
                        </a>
                        <a href="https://www.twitter.com/bloomie" class="social-btn" aria-label="Twitter">
                            <img src="https://www.twitter.com/favicon.ico" alt="Twitter Logo"> Twitter
                        </a>
                    </div>
                    <div class="newsletter mt-3">
                        <h5>Đăng ký nhận tin</h5>
                        <div class="newsletter-form">
                            <input type="email" placeholder="Email của bạn" aria-label="Email đăng ký nhận tin" required>
                            <button type="submit" aria-label="Đăng ký nhận tin">Đăng ký</button>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="footer-divider" />
            <div class="text-center">
                <p class="text-muted mb-0">© 2025 - Bloomie Flower Shop | Tất cả quyền được bảo lưu</p>
            </div>
        </div>
    </footer>

    <!-- Modals -->
    <div id="cameraModal" class="camera-modal">
        <video id="video" autoplay playsinline></video>
        <canvas id="canvas" style="display:none;"></canvas>
        <img id="capturedImage" style="display:none;" />
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button id="captureBtn" onclick="captureImage()" class="btn btn-primary">Chụp ảnh</button>
            <button id="submitBtn" onclick="submitImageFromCamera()" class="btn btn-success" style="display:none;">Gửi ảnh</button>
            <button onclick="closeCameraModal()" class="btn btn-danger">Đóng</button>
        </div>
    </div>

    <div id="analysisModal" class="analysis-modal">
        <img id="analysisImage" />
        <div style="margin-top:20px;">
            <p>Đang phân tích ảnh...</p>
            <button onclick="closeAnalysisModal()" class="btn btn-danger">Hủy</button>
        </div>
    </div>

    <!-- Flower Detection Modal -->
    <div id="flowerDetectionModal" class="flower-detection-modal">
        <div class="flower-detection-container">
            <!-- Video/Image Display -->
            <div class="flower-preview">
                <video id="flowerVideo" autoplay playsinline></video>
                <video id="flowerUploadedVideo" controls style="display:none;"></video>
                <img id="flowerCapturedImage" style="display:none;" />
                
                <!-- Back Button -->
                <button onclick="closeFlowerDetectionModal()" class="flower-back-btn">
                    <i class="fas fa-arrow-left"></i>
                </button>
                
                <!-- Live Indicator -->
                <div id="flowerLiveIndicator" style="display:none;">
                    <span class="live-dot"></span> LIVE
                </div>
                
                <!-- Stop Live Button (chỉ hiện khi live mode) -->
                <button id="flowerStopLiveBtn" onclick="toggleFlowerRealTimeMode()" class="flower-stop-live-btn" style="display:none;">
                    <i class="fas fa-stop"></i> Dừng Live
                </button>
                
                <!-- Capture from Uploaded Video Button -->
                <button id="flowerVideoCaptureBtn" onclick="captureFromUploadedVideo()" style="display:none; position: absolute; bottom: 40px; right: 40px; z-index: 10; background: #C41E3A; color: white; border: none; padding: 12px 20px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.3);">
                    <i class="fas fa-camera"></i> Chụp khung hình
                </button>
            </div>
            
            <!-- Result Overlay -->
            <div id="flowerDetectionResult"></div>
            
            <!-- Action Buttons (when no result) -->
            <div class="flower-actions" id="flowerActions">
                <h3 style="color: white; text-align: center; margin-bottom: 10px; font-size: 22px; font-weight: bold;">Nhận diện hoa AI</h3>
                <p style="color: rgba(255,255,255,0.85); text-align: center; font-size: 14px; margin-bottom: 24px;">
                    Chọn chế độ nhận diện để bắt đầu
                </p>
                <div style="display: flex; gap: 10px; justify-content: center;">
                    <button id="flowerLiveScanBtn" onclick="toggleFlowerRealTimeMode()" class="flower-btn flower-btn-primary">
                        <i class="fas fa-play"></i><span>Live</span>
                    </button>
                    <button onclick="captureFlowerOnce()" class="flower-btn flower-btn-secondary">
                        <i class="fas fa-camera"></i><span>Chụp ảnh</span>
                    </button>
                    <button onclick="uploadFlowerImage()" class="flower-btn flower-btn-secondary">
                        <i class="fas fa-upload"></i><span>Tải ảnh</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/flower-detection.js" asp-append-version="true"></script>
    <script>
        // Carousel lazy load
        document.addEventListener('DOMContentLoaded', function () {
            const carousel = document.querySelector('#promoCarousel');
            if (carousel) {
                carousel.addEventListener('slide.bs.carousel', function (e) {
                    const activeSlide = e.relatedTarget;
                    const img = activeSlide.querySelector('.carousel-media');
                    if (img) img.setAttribute('loading', 'lazy');
                });
            }
        });

        // Camera & Image Search
        let stream = null;
        let isImageSearch = false;

        function openCameraModal() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');
            const captureBtn = document.getElementById('captureBtn');
            const submitBtn = document.getElementById('submitBtn');
            modal.style.display = 'flex';
            captureBtn.style.display = 'inline-block';
            submitBtn.style.display = 'none';
            video.style.display = 'block';
            canvas.style.display = 'none';
            capturedImage.style.display = 'none';
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(s => { stream = s; video.srcObject = stream; })
                .catch(err => { console.error('Error:', err); alert('Không thể truy cập camera.'); closeCameraModal(); });
        }

        function captureImage() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const capturedImage = document.getElementById('capturedImage');
            const captureBtn = document.getElementById('captureBtn');
            const submitBtn = document.getElementById('submitBtn');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            capturedImage.src = canvas.toDataURL('image/jpeg');
            capturedImage.style.display = 'block';
            video.style.display = 'none';
            captureBtn.style.display = 'none';
            submitBtn.style.display = 'inline-block';
            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        }

        function closeCameraModal() {
            const modal = document.getElementById('cameraModal');
            const video = document.getElementById('video');
            modal.style.display = 'none';
            if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
            video.srcObject = null;
        }

        function closeAnalysisModal() {
            const modal = document.getElementById('analysisModal');
            const img = document.getElementById('analysisImage');
            modal.style.display = 'none';
            img.src = ''; img.style.display = 'none';
            isImageSearch = false;
            document.getElementById('imageFile').value = '';
            document.getElementById('searchInput').value = '';
        }

        function submitImage(blob, filename = 'captured-image.jpg', signal) {
            const modal = document.getElementById('analysisModal');
            const img = document.getElementById('analysisImage');
            img.src = URL.createObjectURL(blob);
            img.style.display = 'block';
            modal.style.display = 'flex';
            const formData = new FormData();
            formData.append('imageFile', blob, filename);
            return fetch('/Product/ImageSearch', { method: 'POST', body: formData, signal })
                .then(r => { if (!r.ok) throw new Error(`Lỗi: ${r.status}`); return r.json(); })
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirectUrl || `/Product/Index?colors=${encodeURIComponent(data.colors.join(','))}&presentations=${encodeURIComponent(data.presentation)}`;
                    } else {
                        alert(data.message || 'Không thể phân tích ảnh.');
                    }
                })
                .catch(err => {
                    if (err.name === 'AbortError') alert('Timeout: Phân tích quá lâu (15s).');
                    else alert(err.message || 'Lỗi xảy ra.');
                    throw err;
                })
                .finally(() => closeAnalysisModal());
        }

        function submitImageFromCamera() {
            const canvas = document.getElementById('canvas');
            isImageSearch = true;
            document.getElementById('searchInput').value = 'captured-image.jpg';
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);
            canvas.toBlob(blob => {
                if (!blob) { alert('Lỗi xử lý ảnh.'); closeCameraModal(); clearTimeout(timeoutId); return; }
                submitImage(blob, 'captured-image.jpg', controller.signal).finally(() => {
                    clearTimeout(timeoutId);
                    closeCameraModal();
                });
            }, 'image/jpeg');
        }

        document.getElementById('imageFile').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { alert('Ảnh tối đa 5MB.'); e.target.value = ''; return; }
                if (!['image/jpeg', 'image/png', 'image/webp'].includes(file.type)) { alert('Chỉ hỗ trợ JPG, PNG, WebP.'); e.target.value = ''; return; }
                isImageSearch = true;
                document.getElementById('searchInput').value = file.name;
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);
                submitImage(file, file.name, controller.signal).finally(() => clearTimeout(timeoutId));
            }
        });

        document.querySelector('.search-bar').addEventListener('submit', function (e) {
            const input = document.getElementById('searchInput');
            if (isImageSearch || !input.value.trim()) e.preventDefault();
        });

        document.getElementById('searchInput').addEventListener('input', function () {
            isImageSearch = false;
            document.getElementById('imageFile').value = '';
        });

        // Smooth Page Transition
        document.addEventListener('DOMContentLoaded', function() {
            // Fade in page on load
            document.body.classList.add('page-loaded');
            
            // Handle all navigation links
            const links = document.querySelectorAll('a:not([target="_blank"]):not([href^="#"]):not([href^="javascript:"]):not([data-bs-toggle])');
            
            links.forEach(link => {
                link.addEventListener('click', function(e) {
                    const href = this.getAttribute('href');
                    
                    // Skip if it's a hash link, javascript, modal, or dropdown
                    if (!href || href === '#' || href.startsWith('javascript:') || 
                        this.hasAttribute('data-bs-toggle') || this.closest('.dropdown-menu')) {
                        return;
                    }
                    
                    // Skip if it's opening in new tab
                    if (this.target === '_blank') {
                        return;
                    }
                    
                    e.preventDefault();
                    
                    // Add transitioning class for fade out
                    document.body.classList.add('page-transitioning');
                    
                    // Navigate after fade out completes
                    setTimeout(() => {
                        window.location.href = href;
                    }, 400);
                });
            });
        });

        // Global notification functions
        function showGlobalNotification(message, type = 'success') {
            const notification = document.getElementById('globalNotification');
            const notificationMessage = document.getElementById('globalNotificationMessage');
            
            notificationMessage.textContent = message;
            notification.classList.remove('success', 'error');
            notification.classList.add('show', type);
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function closeGlobalNotification() {
            const notification = document.getElementById('globalNotification');
            notification.classList.remove('show');
        }

        // Check for success message from TempData
        @if (TempData["SuccessMessage"] != null)
        {
            <text>
            document.addEventListener('DOMContentLoaded', function() {
                showGlobalNotification(@Html.Raw(System.Text.Json.JsonSerializer.Serialize(TempData["SuccessMessage"])), 'success');
            });
            </text>
        }
    </script>
    @RenderSection("Scripts", required: false)

    <!-- ============================================ -->
    <!-- BLOOMIE AI CHATBOT WIDGET -->
    <!-- ============================================ -->
    <partial name="_ChatWidget" />
    
    <!-- ============================================ -->
    <!-- SUPPORT CHAT WIDGET (Customer ↔ Staff) -->
    <!-- ============================================ -->
    <partial name="_SupportChatWidget" />
</body>
</html>