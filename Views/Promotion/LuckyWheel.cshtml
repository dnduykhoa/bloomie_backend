@model List<Bloomie.Models.Entities.VoucherCampaign>
@{
    ViewData["Title"] = "V√≤ng Quay May M·∫Øn";
    var userSpins = ViewBag.UserSpins as Dictionary<int, int> ?? new Dictionary<int, int>();
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var totalCampaigns = Model.Count();
    var activeCampaigns = Model.Count(c => c.IsActive);
}

<!-- Simple Customer-Friendly Header -->
<div class="customer-header">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home")"><i class="fas fa-home me-1"></i>Trang ch·ªß</a></li>
                <li class="breadcrumb-item"><a href="@Url.Action("VoucherCampaigns", "Promotion")">Khuy·∫øn m√£i</a></li>
                <li class="breadcrumb-item active" aria-current="page">V√≤ng Quay May M·∫Øn</li>
            </ol>
        </nav>

        <!-- Simple Title -->
        <div class="header-title-section">
            <h1 class="header-title">
                <i class="fas fa-gift me-2"></i>
                V√≤ng Quay May M·∫Øn
            </h1>
            <p class="header-subtitle">Quay v√† nh·∫≠n voucher gi·∫£m gi√° h·∫•p d·∫´n!</p>
        </div>
    </div>
</div>

<div class="container py-4">

<style>
    /* Simple Customer-Friendly Header */
    .customer-header {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        padding: 2.5rem 0;
        margin-bottom: 2rem;
        position: relative;
        width: 100vw;
        left: 50%;
        margin-left: -50vw;
    }

    .customer-header .breadcrumb {
        background: none;
        padding: 0;
        margin: 0;
        font-size: 0.875rem;
    }

    .customer-header .breadcrumb-item a {
        color: rgba(255, 255, 255, 0.8);
        text-decoration: none;
        transition: color 0.2s;
    }

    .customer-header .breadcrumb-item a:hover {
        color: white;
    }

    .customer-header .breadcrumb-item.active {
        color: white;
    }

    .customer-header .breadcrumb-item + .breadcrumb-item::before {
        content: ">";
        color: rgba(255, 255, 255, 0.6);
        float: none;
        padding-right: 0.5rem;
        padding-left: 0.35rem;
    }

    .header-title-section {
        text-align: center;
        margin-top: 1rem;
    }

    .header-title {
        font-size: 2.5rem;
        font-weight: 700;
        color: white;
        margin: 0 0 0.5rem 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header-subtitle {
        font-size: 1.1rem;
        color: rgba(255, 255, 255, 0.9);
        margin: 0;
    }

    @@media (max-width: 576px) {
        .customer-header {
            padding: 2rem 0;
        }

        .header-title {
            font-size: 1.75rem;
        }

        .header-subtitle {
            font-size: 1rem;
        }
    }
    
    .campaign-card {
        border: none;
        border-radius: 20px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        height: 100%;
    }
    
    .campaign-card:hover {
        transform: translateY(-10px);
        box-shadow: 0 15px 35px rgba(255, 193, 7, 0.3);
    }
    
    .campaign-banner {
        height: 200px;
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        position: relative;
        overflow: hidden;
    }
    
    .campaign-banner::before {
        content: '';
        position: absolute;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
        animation: pulse 3s ease-in-out infinite;
    }
    
    @@keyframes pulse {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.2); }
    }
    
    .campaign-icon {
        font-size: 80px;
        color: white;
        text-shadow: 0 4px 10px rgba(0,0,0,0.2);
        position: relative;
        z-index: 1;
        animation: rotate 4s linear infinite;
    }
    
    @@keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    .spins-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255,255,255,0.95);
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        color: #ff9800;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 2;
    }
    
    .time-badge {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 6px 12px;
        border-radius: 10px;
        font-size: 12px;
        display: inline-block;
    }
    
    .ended-badge {
        background: linear-gradient(135deg, #dc3545 0%, #e67e22 100%);
    }
    
    .play-button {
        background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: bold;
        color: white;
        transition: all 0.3s;
        box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
    }
    
    .play-button:hover:not(:disabled) {
        transform: scale(1.05);
        box-shadow: 0 6px 20px rgba(255, 152, 0, 0.5);
        background: linear-gradient(135deg, #ff9800 0%, #ffc107 100%);
    }
    
    .play-button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #6c757d;
    }

    /* Wheel Modal Styles */
    .wheel-container {
        position: relative;
        width: 500px;
        height: 500px;
        margin: 0 auto;
    }
    
    .wheel-canvas {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        box-shadow: 0 0 30px rgba(255, 193, 7, 0.5);
    }
    
    .wheel-pointer {
        position: absolute;
        top: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 20px solid transparent;
        border-right: 20px solid transparent;
        border-top: 40px solid #dc3545;
        z-index: 10;
        filter: drop-shadow(0 2px 5px rgba(0,0,0,0.3));
    }
    
    .spin-button-wheel {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 100px;
        height: 100px;
        border-radius: 50%;
        background: linear-gradient(145deg, #ffc107, #ff9800);
        border: 5px solid white;
        box-shadow: 0 5px 20px rgba(0,0,0,0.3);
        cursor: pointer;
        z-index: 10;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: white;
        font-size: 18px;
        transition: all 0.3s;
    }
    
    .spin-button-wheel:hover:not(:disabled) {
        transform: translate(-50%, -50%) scale(1.1);
        box-shadow: 0 8px 25px rgba(255, 193, 7, 0.5);
    }
    
    .spin-button-wheel:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        background: #6c757d;
    }
</style>

<div class="container py-5">
    @if (!isAuthenticated)
    {
        <div class="alert alert-warning text-center shadow-sm" style="border-radius: 15px;">
            <i class="bi bi-info-circle-fill me-2"></i>
            <strong>Vui l√≤ng <a asp-controller="Account" asp-action="Login" class="alert-link fw-bold text-decoration-underline">ƒëƒÉng nh·∫≠p</a> ƒë·ªÉ tham gia v√≤ng quay!</strong>
        </div>
    }

    @if (!Model.Any())
    {
        <div class="text-center py-5">
            <i class="bi bi-inbox" style="font-size: 100px; color: #dee2e6;"></i>
            <h4 class="mt-3 text-muted">Ch∆∞a c√≥ ch∆∞∆°ng tr√¨nh v√≤ng quay n√†o!</h4>
            <p class="text-muted">H√£y quay l·∫°i sau nh√©!</p>
        </div>
    }
    else
    {
        <div class="row g-4">
            @foreach (var campaign in Model)
            {
                var now = DateTime.Now;
                var isRunning = campaign.IsActive && campaign.StartDate <= now && campaign.EndDate >= now;
                var isEnded = campaign.EndDate < now;
                var spinsLeft = userSpins.ContainsKey(campaign.Id) ? userSpins[campaign.Id] : 0;

                <div class="col-lg-4 col-md-6">
                    <div class="card campaign-card">
                        <div class="campaign-banner d-flex align-items-center justify-content-center">
                            <i class="bi bi-gift-fill campaign-icon"></i>
                            @if (isAuthenticated && isRunning)
                            {
                                <div class="spins-badge">
                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                    <strong>@spinsLeft</strong> l∆∞·ª£t
                                </div>
                            }
                        </div>
                        
                        <div class="card-body p-4">
                            <h4 class="card-title fw-bold mb-3">@campaign.Name</h4>
                            
                            @if (!string.IsNullOrEmpty(campaign.Description))
                            {
                                <p class="card-text text-muted mb-3">@campaign.Description</p>
                            }
                            
                            <div class="mb-3">
                                @if (isEnded)
                                {
                                    <span class="time-badge ended-badge">
                                        <i class="bi bi-x-circle me-1"></i>ƒê√£ k·∫øt th√∫c
                                    </span>
                                }
                                else if (isRunning)
                                {
                                    <span class="time-badge">
                                        <i class="bi bi-check-circle me-1"></i>ƒêang di·ªÖn ra
                                    </span>
                                }
                                else
                                {
                                    <span class="time-badge" style="background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);">
                                        <i class="bi bi-clock me-1"></i>S·∫Øp di·ªÖn ra
                                    </span>
                                }
                            </div>
                            
                            <div class="small text-muted mb-3">
                                <div class="mb-1">
                                    <i class="bi bi-calendar-check me-2"></i>
                                    <strong>T·ª´:</strong> @campaign.StartDate.ToString("dd/MM/yyyy HH:mm")
                                </div>
                                <div>
                                    <i class="bi bi-calendar-x me-2"></i>
                                    <strong>ƒê·∫øn:</strong> @campaign.EndDate.ToString("dd/MM/yyyy HH:mm")
                                </div>
                            </div>
                            
                            <div class="d-grid">
                                @if (!isAuthenticated)
                                {
                                    <a asp-controller="Account" asp-action="Login" class="btn play-button">
                                        <i class="bi bi-box-arrow-in-right me-2"></i>ƒêƒÉng nh·∫≠p ƒë·ªÉ ch∆°i
                                    </a>
                                }
                                else if (isEnded)
                                {
                                    <button class="btn play-button" disabled>
                                        <i class="bi bi-x-circle me-2"></i>ƒê√£ k·∫øt th√∫c
                                    </button>
                                }
                                else if (!isRunning)
                                {
                                    <button class="btn play-button" disabled>
                                        <i class="bi bi-clock me-2"></i>Ch∆∞a b·∫Øt ƒë·∫ßu
                                    </button>
                                }
                                else if (spinsLeft <= 0)
                                {
                                    <button class="btn play-button" disabled>
                                        <i class="bi bi-x-circle me-2"></i>H·∫øt l∆∞·ª£t quay
                                    </button>
                                }
                                else
                                {
                                    <button class="btn play-button" onclick="openWheelModal(@campaign.Id, '@campaign.Name', @spinsLeft)">
                                        <i class="bi bi-play-circle-fill me-2"></i>Quay ngay!
                                    </button>
                                }
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- Wheel Modal -->
<div class="modal fade" id="wheelModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-warning" id="wheelModalTitle"></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center mb-3">
                    <span class="badge bg-warning text-dark px-3 py-2" id="spinsLeftBadge"></span>
                </div>
                
                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <canvas id="wheelCanvas" class="wheel-canvas"></canvas>
                    <button id="spinButton" class="spin-button-wheel">QUAY</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Result Modal -->
<div class="modal fade" id="resultModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0" style="border-radius: 20px;">
            <div class="modal-body p-0">
                <div class="card border-0 shadow-lg" style="border-radius: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <button type="button" class="btn-close position-absolute top-0 end-0 m-3 btn-close-white" data-bs-dismiss="modal"></button>
                    <div class="card-body p-5 text-white text-center">
                        <div class="mb-3">
                            <i class="bi bi-trophy-fill" style="font-size: 80px; color: #ffd700; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));"></i>
                        </div>
                        <h2 class="fw-bold mb-4">üéâ Ch√∫c M·ª´ng B·∫°n! üéâ</h2>
                        <div class="bg-white text-dark p-4 rounded-4 mb-4 shadow">
                            <h4 class="fw-bold text-warning mb-2" id="spinResultCode"></h4>
                            <h5 class="mb-0 text-success" id="spinResultDiscount"></h5>
                        </div>
                        <p class="mb-4 opacity-75 fs-5">Voucher ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o t√†i kho·∫£n c·ªßa b·∫°n</p>
                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                            <a asp-controller="Promotion" asp-action="MyVouchers" class="btn btn-light btn-lg rounded-pill px-4">
                                <i class="bi bi-ticket-perforated me-2"></i>Xem voucher
                            </a>
                            <a asp-controller="Product" asp-action="Index" class="btn btn-warning btn-lg rounded-pill px-4">
                                <i class="bi bi-bag-check me-2"></i>Mua s·∫Øm ngay
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Canvas Confetti Library -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    
    <script>
        const campaignVouchers = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(ViewBag.CampaignVouchers ?? new Dictionary<int, List<object>>()));
        
        let currentCampaignId = 0;
        let currentSpinsLeft = 0;
        let wheelCanvas, ctx, spinButton;
        let isSpinning = false;
        let currentRotation = 0;
        let lastTickAngle = 0; // ƒê·ªÉ ph√°t √¢m thanh tick
        let lightOffset = 0; // ƒê·ªÉ t·∫°o hi·ªáu ·ª©ng √°nh s√°ng ch·∫°y

        // T·∫°o √¢m thanh (s·ª≠ d·ª•ng Web Audio API)
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTickSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800; // T·∫ßn s·ªë cao cho √¢m "tick"
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.05);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.05);
        }
        
        function playWinSound() {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.setValueAtTime(523, audioContext.currentTime); // C5
            oscillator.frequency.setValueAtTime(659, audioContext.currentTime + 0.1); // E5
            oscillator.frequency.setValueAtTime(784, audioContext.currentTime + 0.2); // G5
            
            gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.4);
        }
        
        function fireConfetti(isLucky) {
            if (isLucky) {
                // N·∫øu tr√∫ng √¥ "Ch√∫c may m·∫Øn" - √≠t ph√°o h∆°n
                confetti({
                    particleCount: 50,
                    spread: 60,
                    origin: { y: 0.6 }
                });
            } else {
                // Tr√∫ng voucher th·∫≠t - b·∫Øn ph√°o ho√†nh tr√°ng
                const duration = 3000;
                const end = Date.now() + duration;
                
                (function frame() {
                    confetti({
                        particleCount: 3,
                        angle: 60,
                        spread: 55,
                        origin: { x: 0 },
                        colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff']
                    });
                    confetti({
                        particleCount: 3,
                        angle: 120,
                        spread: 55,
                        origin: { x: 1 },
                        colors: ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff']
                    });
                    
                    if (Date.now() < end) {
                        requestAnimationFrame(frame);
                    }
                })();
            }
        }

        function openWheelModal(campaignId, campaignName, spinsLeft) {
            currentCampaignId = campaignId;
            currentSpinsLeft = spinsLeft;
            lastTickAngle = 0; // Reset
            
            document.getElementById('wheelModalTitle').textContent = campaignName;
            updateSpinsBadge();
            
            const modal = new bootstrap.Modal(document.getElementById('wheelModal'));
            modal.show();
            
            // Initialize wheel after modal is shown
            setTimeout(() => {
                initWheel(campaignId);
            }, 300);
        }

        function updateSpinsBadge() {
            document.getElementById('spinsLeftBadge').textContent = `C√≤n ${currentSpinsLeft} l∆∞·ª£t quay`;
        }

        function initWheel(campaignId) {
            wheelCanvas = document.getElementById('wheelCanvas');
            ctx = wheelCanvas.getContext('2d');
            spinButton = document.getElementById('spinButton');
            
            wheelCanvas.width = 500;
            wheelCanvas.height = 500;
            
            // B·∫Øt ƒë·∫ßu animation loop cho hi·ªáu ·ª©ng √°nh s√°ng
            function animateLights() {
                if (!isSpinning) {
                    drawWheel(campaignId);
                }
                requestAnimationFrame(animateLights);
            }
            animateLights();
            
            spinButton.onclick = () => spinWheel(campaignId);
        }

        function drawWheel(campaignId) {
            const prizes = campaignVouchers[campaignId] ? campaignVouchers[campaignId].map(v => v.text) : ['LUCKY'];
            const numPrizes = prizes.length;
            const arc = (2 * Math.PI) / numPrizes;
            const colors = ['#FF6B6B', '#4ECDC4', '#FFE66D', '#95E1D3', '#F38181', '#AA96DA', '#FCBAD3', '#FFFFD2', '#A8D8EA', '#FFAAA7'];
            
            ctx.clearRect(0, 0, 500, 500);
            ctx.save();
            ctx.translate(250, 250);
            ctx.rotate(currentRotation);
            
            // Kim ch·ªâ ·ªü ph√≠a TR√äN (g√≥c -90¬∞ = 12h)
            // ƒê·ªÉ √¥ ƒë·∫ßu ti√™n (index 0) c√≥ GI·ªÆA n·∫±m ƒë√∫ng ·ªü kim:
            // B·∫Øt ƒë·∫ßu v·∫Ω t·ª´: -90¬∞ - arc/2 (ƒë·ªÉ gi·ªØa √¥ 0 = -90¬∞)
            const pointerAngle = -Math.PI / 2; // Kim ·ªü 12h
            const startAngle = pointerAngle - arc / 2; // √î 0 b·∫Øt ƒë·∫ßu
            
            // T√≠nh √¥ n√†o ƒëang ·ªü d∆∞·ªõi kim ch·ªâ
            // currentRotation l√† g√≥c ƒë√£ xoay, kim lu√¥n ·ªü -œÄ/2
            // √î 0 c√≥ gi·ªØa ·ªü startAngle + arc/2, sau khi xoay currentRotation
            // √î i c√≥ gi·ªØa ·ªü: startAngle + (i + 0.5) * arc + currentRotation
            // √î ƒëang ·ªü kim khi: startAngle + (i + 0.5) * arc + currentRotation ‚âà pointerAngle (mod 2œÄ)
            
            let currentSlotIndex = -1;
            for (let i = 0; i < numPrizes; i++) {
                const slotMiddleAngle = startAngle + (i + 0.5) * arc;
                // G√≥c tuy·ªát ƒë·ªëi c·ªßa gi·ªØa √¥ sau khi xoay
                const absoluteAngle = slotMiddleAngle + currentRotation;
                // Normalize v·ªÅ [0, 2œÄ]
                const normalized = ((absoluteAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                const pointerNormalized = ((pointerAngle % (2 * Math.PI)) + 2 * Math.PI) % (2 * Math.PI);
                
                // Ki·ªÉm tra xem √¥ n√†y c√≥ g·∫ßn kim kh√¥ng (trong ph·∫°m vi arc/2)
                let diff = Math.abs(normalized - pointerNormalized);
                if (diff > Math.PI) diff = 2 * Math.PI - diff; // X·ª≠ l√Ω wrap-around
                
                if (diff < arc / 2) {
                    currentSlotIndex = i;
                    break;
                }
            }
            
            for (let i = 0; i < numPrizes; i++) {
                const angle1 = startAngle + i * arc;
                const angle2 = startAngle + (i + 1) * arc;
                
                let fillColor = colors[i % colors.length];
                
                // N·∫øu ƒëang quay v√† l√† √¥ hi·ªán t·∫°i - l√†m s√°ng m√†u g·ªëc l√™n
                if (isSpinning && i === currentSlotIndex) {
                    // Chuy·ªÉn hex sang RGB r·ªìi l√†m s√°ng
                    const hex = fillColor.replace('#', '');
                    let r = parseInt(hex.substr(0, 2), 16);
                    let g = parseInt(hex.substr(2, 2), 16);
                    let b = parseInt(hex.substr(4, 2), 16);
                    
                    // TƒÉng ƒë·ªô s√°ng b·∫±ng c√°ch nh√¢n l√™n (gi·ªØ m√†u ƒë·∫≠m h∆°n)
                    const brightMultiplier = 1.5; // S√°ng g·∫•p 1.5 l·∫ßn
                    r = Math.min(255, Math.round(r * brightMultiplier));
                    g = Math.min(255, Math.round(g * brightMultiplier));
                    b = Math.min(255, Math.round(b * brightMultiplier));
                    
                    fillColor = `rgb(${r}, ${g}, ${b})`;
                }
                
                ctx.beginPath();
                ctx.fillStyle = fillColor;
                ctx.moveTo(0, 0);
                ctx.arc(0, 0, 240, angle1, angle2);
                ctx.lineTo(0, 0);
                ctx.fill();
                ctx.stroke();
                
                // Hi·ªáu ·ª©ng spotlight khi ƒëang quay - ch·ªâ l√†m t·ªëi c√°c √¥ kh√°c
                if (isSpinning && i !== currentSlotIndex) {
                    // C√°c √¥ kh√°c - ch√¨m xu·ªëng
                    ctx.beginPath();
                    ctx.fillStyle = 'rgba(0, 0, 0, 0.6)';
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, 240, angle1, angle2);
                    ctx.lineTo(0, 0);
                    ctx.fill();
                }
                
                ctx.save();
                ctx.rotate(startAngle + (i + 0.5) * arc);
                
                // ƒê·ªïi m√†u ch·ªØ: ƒêen khi √¥ ƒëang s√°ng, Tr·∫Øng khi b√¨nh th∆∞·ªùng ho·∫∑c ch√¨m
                if (isSpinning && i === currentSlotIndex) {
                    ctx.fillStyle = '#000'; // Ch·ªØ ƒëen khi √¥ s√°ng
                } else {
                    ctx.fillStyle = '#fff'; // Ch·ªØ tr·∫Øng b√¨nh th∆∞·ªùng
                }
                
                ctx.font = 'bold 18px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(prizes[i], 150, 10);
                ctx.restore();
            }
            
            ctx.restore();
            
            // V·∫Ω hi·ªáu ·ª©ng √°nh s√°ng LED ch·∫°y quanh v√≤ng
            drawLights();
        }
        
        function drawLights() {
            const numLights = 24; // S·ªë l∆∞·ª£ng ƒë√®n LED
            const radius = 250; // B√°n k√≠nh v√≤ng s√°ng
            
            for (let i = 0; i < numLights; i++) {
                const angle = (i / numLights) * Math.PI * 2;
                const x = 250 + Math.cos(angle) * radius;
                const y = 250 + Math.sin(angle) * radius;
                
                // T·∫°o hi·ªáu ·ª©ng ch·∫°y b·∫±ng c√°ch thay ƒë·ªïi ƒë·ªô s√°ng theo lightOffset
                const brightness = Math.abs(Math.sin((i + lightOffset) * 0.5));
                
                // Gradient cho m·ªói ƒë√®n
                const gradient = ctx.createRadialGradient(x, y, 0, x, y, 8);
                gradient.addColorStop(0, `rgba(255, 215, 0, ${brightness})`);
                gradient.addColorStop(0.5, `rgba(255, 193, 7, ${brightness * 0.7})`);
                gradient.addColorStop(1, `rgba(255, 152, 0, 0)`);
                
                ctx.fillStyle = gradient;
                ctx.beginPath();
                ctx.arc(x, y, 8, 0, Math.PI * 2);
                ctx.fill();
                
                // V·∫Ω vi·ªÅn s√°ng
                if (brightness > 0.7) {
                    ctx.strokeStyle = `rgba(255, 255, 255, ${brightness})`;
                    ctx.lineWidth = 2;
                    ctx.stroke();
                }
            }
            
            // TƒÉng offset ƒë·ªÉ t·∫°o hi·ªáu ·ª©ng ch·∫°y
            lightOffset += 0.15;
        }

        function spinWheel(campaignId) {
            if (isSpinning || currentSpinsLeft <= 0) return;
            
            isSpinning = true;
            spinButton.disabled = true;
            
            $.ajax({
                url: '@Url.Action("SpinLuckyWheel", "Promotion")',
                method: 'POST',
                data: { 
                    campaignId: campaignId,
                    __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
                },
                success: function(response) {
                    if (response.success) {
                        const wonIndex = response.wonIndex || 0;
                        const prizes = campaignVouchers[campaignId] || [];
                        const numPrizes = prizes.length;
                        const arc = (2 * Math.PI) / numPrizes;
                        
                        const spins = 5;
                        
                        // Kim ·ªü -90¬∞ (12h). √î wonIndex c√≥ gi·ªØa ·ªü: -90¬∞ + wonIndex * arc
                        const pointerAngle = -Math.PI / 2;
                        const middleOfWonSlot = pointerAngle + wonIndex * arc;
                        
                        // Xoay ƒë·ªÉ gi·ªØa √¥ wonIndex v·ªÅ v·ªã tr√≠ kim
                        // Ta c·∫ßn: middleOfWonSlot + targetRotation = pointerAngle (mod 2œÄ)
                        // => targetRotation = pointerAngle - middleOfWonSlot + 5 v√≤ng
                        const targetRotation = currentRotation + (spins * 2 * Math.PI) + (pointerAngle - middleOfWonSlot);
                        
                        animateSpin(campaignId, targetRotation, () => {
                            currentSpinsLeft--;
                            updateSpinsBadge();
                            
                            // ·∫®n modal v√≤ng quay
                            const wheelModal = bootstrap.Modal.getInstance(document.getElementById('wheelModal'));
                            wheelModal.hide();
                            
                            // Hi·ªÉn th·ªã k·∫øt qu·∫£ trong modal ri√™ng
                            setTimeout(() => {
                                const modalBody = document.querySelector('#resultModal .card-body');
                                
                                // Thay ƒë·ªïi n·ªôi dung d·ª±a tr√™n isLucky
                                if (response.isLucky) {
                                    // Tr√∫ng √¥ "Ch√∫c may m·∫Øn" - kh√¥ng c√≥ th∆∞·ªüng
                                    modalBody.innerHTML = `
                                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3 btn-close-white" data-bs-dismiss="modal"></button>
                                        <div class="mb-3">
                                            <i class="bi bi-emoji-smile" style="font-size: 80px; color: #ffc107; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));"></i>
                                        </div>
                                        <h2 class="fw-bold mb-4">${response.voucherCode}</h2>
                                        <div class="bg-white bg-opacity-25 text-white p-4 rounded-4 mb-4">
                                            <h5 class="mb-0">${response.voucherDiscount}</h5>
                                        </div>
                                        <p class="mb-4 opacity-75 fs-6">
                                            ${currentSpinsLeft > 0 
                                                ? 'B·∫°n c√≤n ' + currentSpinsLeft + ' l∆∞·ª£t quay, th·ª≠ l·∫°i nh√©!' 
                                                : 'H·∫πn g·∫∑p l·∫°i b·∫°n trong chi·∫øn d·ªãch ti·∫øp theo!'}
                                        </p>
                                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                                            <button type="button" class="btn btn-light btn-lg rounded-pill px-4" data-bs-dismiss="modal">
                                                <i class="bi bi-x-circle me-2"></i>ƒê√≥ng
                                            </button>
                                            <a href="/Product/Index" class="btn btn-warning btn-lg rounded-pill px-4">
                                                <i class="bi bi-bag-check me-2"></i>Xem s·∫£n ph·∫©m
                                            </a>
                                        </div>
                                    `;
                                } else {
                                    // Tr√∫ng voucher th·∫≠t
                                    modalBody.innerHTML = `
                                        <button type="button" class="btn-close position-absolute top-0 end-0 m-3 btn-close-white" data-bs-dismiss="modal"></button>
                                        <div class="mb-3">
                                            <i class="bi bi-trophy-fill" style="font-size: 80px; color: #ffd700; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));"></i>
                                        </div>
                                        <h2 class="fw-bold mb-4">üéâ Ch√∫c M·ª´ng B·∫°n! üéâ</h2>
                                        <div class="bg-white text-dark p-4 rounded-4 mb-4 shadow">
                                            <h4 class="fw-bold text-warning mb-2">${response.voucherCode}</h4>
                                            <h5 class="mb-0 text-success">${response.voucherDiscount}</h5>
                                        </div>
                                        <p class="mb-4 opacity-75 fs-5">Voucher ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o t√†i kho·∫£n c·ªßa b·∫°n</p>
                                        <div class="d-flex gap-2 justify-content-center flex-wrap">
                                            <a href="/Promotion/MyVouchers" class="btn btn-light btn-lg rounded-pill px-4">
                                                <i class="bi bi-ticket-perforated me-2"></i>Xem voucher
                                            </a>
                                            <a href="/Product/Index" class="btn btn-warning btn-lg rounded-pill px-4">
                                                <i class="bi bi-bag-check me-2"></i>Mua s·∫Øm ngay
                                            </a>
                                        </div>
                                    `;
                                }
                                
                                const resultModal = new bootstrap.Modal(document.getElementById('resultModal'));
                                resultModal.show();
                                
                                // B·∫Øn ph√°o hoa khi modal hi·ªÉn th·ªã
                                setTimeout(() => {
                                    fireConfetti(response.isLucky);
                                }, 300);
                                
                                // Reload trang sau khi ƒë√≥ng modal k·∫øt qu·∫£ ƒë·ªÉ c·∫≠p nh·∫≠t s·ªë l∆∞·ª£t quay
                                document.getElementById('resultModal').addEventListener('hidden.bs.modal', function () {
                                    location.reload();
                                }, { once: true });
                            }, 500);
                            
                            spinButton.disabled = currentSpinsLeft <= 0;
                            isSpinning = false;
                        });
                    } else {
                        alert(response.message || 'C√≥ l·ªói x·∫£y ra!');
                        isSpinning = false;
                        spinButton.disabled = false;
                    }
                },
                error: function() {
                    alert('L·ªói k·∫øt n·ªëi!');
                    isSpinning = false;
                    spinButton.disabled = false;
                }
            });
        }

        function animateSpin(campaignId, targetRotation, callback) {
            const duration = 4000;
            const startRotation = currentRotation;
            const startTime = Date.now();
            const prizes = campaignVouchers[campaignId] || [];
            const numPrizes = prizes.length;
            const arc = (2 * Math.PI) / numPrizes;
            
            lastTickAngle = Math.floor(currentRotation / arc); // Reset tick counter
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                
                currentRotation = startRotation + (targetRotation - startRotation) * easeOut;
                
                // Ph√°t √¢m thanh tick khi qua m·ªói √¥ (ch·ªâ khi ƒëang quay nhanh)
                const currentTickAngle = Math.floor(currentRotation / arc);
                if (currentTickAngle !== lastTickAngle && progress < 0.9) {
                    playTickSound();
                    lastTickAngle = currentTickAngle;
                }
                
                drawWheel(campaignId);
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    currentRotation = targetRotation;
                    while (currentRotation < 0) currentRotation += 2 * Math.PI;
                    while (currentRotation >= 2 * Math.PI) currentRotation -= 2 * Math.PI;
                    
                    drawWheel(campaignId);
                    playWinSound(); // Ph√°t √¢m thanh chi·∫øn th·∫Øng
                    callback();
                }
            }
            
            animate();
        }
    </script>
}

@Html.AntiForgeryToken()
