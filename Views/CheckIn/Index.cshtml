@using Bloomie.Models.Entities
@{
    ViewData["Title"] = "ƒêi·ªÉm danh h√†ng ng√†y";
    var userPoints = ViewBag.UserPoints as UserPoints;
    var checkInHistory = ViewBag.CheckInHistory as List<UserCheckIn>;
    var canCheckIn = ViewBag.CanCheckInToday as bool?;
}

<style>
    .checkin-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .points-summary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    .points-summary h2 {
        font-size: 2.5rem;
        margin: 10px 0;
    }
    .points-summary p {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    .checkin-button {
        background: white;
        color: #667eea;
        border: none;
        padding: 15px 40px;
        border-radius: 25px;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .checkin-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    }
    .checkin-button:disabled {
        background: #ccc;
        color: #666;
        cursor: not-allowed;
    }
    .streak-info {
        display: flex;
        gap: 20px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
    .streak-card {
        background: rgba(255,255,255,0.2);
        padding: 15px 25px;
        border-radius: 10px;
        text-align: center;
    }
    .streak-card h3 {
        font-size: 2rem;
        margin: 5px 0;
    }
    .streak-card p {
        margin: 0;
        font-size: 0.9rem;
    }
    .streak-progress {
        background: rgba(255,255,255,0.2);
        padding: 20px;
        border-radius: 10px;
        margin-top: 20px;
    }
    .progress-bar-custom {
        background: rgba(255,255,255,0.3);
        height: 30px;
        border-radius: 15px;
        overflow: hidden;
        position: relative;
    }
    .progress-fill {
        background: linear-gradient(90deg, #fff, #ffd700);
        height: 100%;
        transition: width 0.5s ease;
        display: flex;
        align-items: center;
        justify-content: flex-end;
        padding-right: 10px;
        font-weight: bold;
        color: #667eea;
    }
    .milestone-badge {
        display: inline-block;
        background: #ffd700;
        color: #667eea;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        margin-top: 10px;
        animation: pulse 2s infinite;
    }
    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }
    .rewards-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 15px;
        margin: 30px 0;
    }
    @@media (max-width: 768px) {
        .rewards-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        .reward-day {
            padding: 15px 10px;
        }
        .points-summary h2 {
            font-size: 2rem;
        }
        .streak-info {
            justify-content: center;
        }
    }
    @@media (max-width: 480px) {
        .rewards-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .reward-day {
            padding: 12px 8px;
            font-size: 0.9rem;
        }
        .reward-day .points {
            font-size: 1.2rem;
        }
    }
    .reward-day {
        background: white;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        transition: all 0.3s;
    }
    .reward-day.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        transform: scale(1.05);
    }
    .reward-day.completed {
        background: #4CAF50;
        color: white;
    }
    .reward-day h4 {
        margin: 10px 0 5px 0;
        font-size: 1rem;
    }
    .reward-day .points {
        font-size: 1.5rem;
        font-weight: bold;
        margin: 5px 0;
    }
    .reward-day.active {
        animation: glow 1.5s ease-in-out infinite;
    }
    @@keyframes glow {
        0%, 100% { box-shadow: 0 0 10px rgba(102, 126, 234, 0.5); }
        50% { box-shadow: 0 0 20px rgba(102, 126, 234, 0.8), 0 0 30px rgba(102, 126, 234, 0.6); }
    }
    .checkin-success-animation {
        animation: successBounce 0.6s ease;
    }
    @@keyframes successBounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }
    .history-section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .history-item {
        padding: 15px;
        border-bottom: 1px solid #eee;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .history-item:last-child {
        border-bottom: none;
    }
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin: 20px 0;
    }
    .calendar-day {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
        position: relative;
    }
    .calendar-day.checked {
        background: #4CAF50;
        color: white;
    }
    .calendar-day.today {
        border: 3px solid #667eea;
    }
    .calendar-day .date {
        font-weight: bold;
        font-size: 1.2rem;
    }
    .calendar-day .points-badge {
        position: absolute;
        top: 5px;
        right: 5px;
        background: #ff9800;
        color: white;
        border-radius: 10px;
        padding: 2px 8px;
        font-size: 0.8rem;
    }
</style>

<div class="checkin-container">
    <div class="points-summary">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1>ƒêi·ªÉm danh h√†ng ng√†y</h1>
                <h2>üéÅ @(userPoints?.TotalPoints ?? 0) ƒêi·ªÉm</h2>
                <p>ƒêi·ªÉm danh li√™n t·ª•c ƒë·ªÉ nh·∫≠n th√™m ƒëi·ªÉm th∆∞·ªüng!</p>
                
                <div class="streak-info">
                    <div class="streak-card">
                        <h3>@(userPoints?.ConsecutiveCheckIns ?? 0)</h3>
                        <p>Ng√†y li√™n t·ª•c</p>
                    </div>
                    <div class="streak-card">
                        <h3>@(userPoints?.LifetimePoints ?? 0)</h3>
                        <p>T·ªïng ƒëi·ªÉm t√≠ch l≈©y</p>
                    </div>
                </div>
                
                @{
                    var currentStreak = userPoints?.ConsecutiveCheckIns ?? 0;
                    var progressPercent = Math.Min((currentStreak * 100.0) / 7, 100);
                    var nextReward = currentStreak >= 7 ? 50 : (currentStreak + 1) switch {
                        1 => 5, 2 => 10, 3 => 15, 4 => 20,
                        5 => 25, 6 => 30, 7 => 50, _ => 5
                    };
                }
                
                <div class="streak-progress">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <small>Ti·∫øn tr√¨nh streak: @currentStreak/7 ng√†y</small>
                        <small>@string.Format("{0:0}%", progressPercent)</small>
                    </div>
                    <div class="progress-bar-custom">
                        <div class="progress-fill" style="width: @string.Format("{0:0}%", progressPercent)">
                            @if (progressPercent >= 20)
                            {
                                <span>@currentStreak/7</span>
                            }
                        </div>
                    </div>
                    @if (currentStreak >= 7)
                    {
                        <div class="milestone-badge">
                            üéâ ƒê√£ ƒë·∫°t streak t·ªëi ƒëa! Ti·∫øp t·ª•c ƒë·ªÉ nh·∫≠n 50 ƒëi·ªÉm/ng√†y
                        </div>
                    }
                    else if (currentStreak > 0)
                    {
                        <small class="d-block mt-2" style="opacity: 0.9;">
                            ƒêi·ªÉm danh ng√†y mai ƒë·ªÉ nh·∫≠n <strong>@nextReward ƒëi·ªÉm</strong>!
                        </small>
                    }
                </div>
            </div>
            <div class="col-md-4 text-center">
                <button id="checkInBtn" class="checkin-button" 
                        @((canCheckIn ?? true) ? "" : "disabled")>
                    @((canCheckIn ?? true) ? "ƒêi·ªÉm danh ngay" : "ƒê√£ ƒëi·ªÉm danh h√¥m nay")
                </button>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="mb-0">Ph·∫ßn th∆∞·ªüng theo ng√†y</h3>
        <small class="text-muted">
            <i class="fas fa-info-circle"></i> ƒêi·ªÉm danh li√™n t·ª•c ƒë·ªÉ tƒÉng ph·∫ßn th∆∞·ªüng!
        </small>
    </div>
    <div class="rewards-grid">
        @for (int day = 1; day <= 7; day++)
        {
            var points = day switch {
                1 => 5, 2 => 10, 3 => 15, 4 => 20,
                5 => 25, 6 => 30, 7 => 50, _ => 0
            };
            var currentDay = userPoints?.ConsecutiveCheckIns ?? 0;
            var isActive = day == currentDay + 1 && (canCheckIn ?? false);
            var isCompleted = day <= currentDay;
            var isCurrent = day == currentDay && !(canCheckIn ?? false);
            var cssClass = isActive ? "active" : (isCompleted ? "completed" : "");
            
            <div class="reward-day @cssClass" @(isActive ? "title='ƒêi·ªÉm danh h√¥m nay ƒë·ªÉ nh·∫≠n ph·∫ßn th∆∞·ªüng n√†y!'" : "")>
                <div class="day-label">Ng√†y @day</div>
                <div class="points">+@points</div>
                <div class="points-label">ƒëi·ªÉm</div>
                @if (isCompleted)
                {
                    <div style="margin-top: 10px; font-size: 1.5rem;">‚úì</div>
                }
                else if (isActive)
                {
                    <div style="margin-top: 10px; font-size: 1.2rem;">üëÜ</div>
                }
                @if (day == 7)
                {
                    <div style="margin-top: 5px; font-size: 0.8rem;">üéâ Bonus!</div>
                }
            </div>
        }
    </div>

    <div class="history-section">
        <h3 class="mb-4">L·ªãch s·ª≠ ƒëi·ªÉm danh th√°ng n√†y</h3>
        @if (checkInHistory != null && checkInHistory.Any())
        {
            @foreach (var checkIn in checkInHistory)
            {
                <div class="history-item">
                    <div>
                        <strong>@checkIn.CheckInDate.ToString("dd/MM/yyyy")</strong>
                        <span class="text-muted ms-3">Ng√†y th·ª© @checkIn.ConsecutiveDays</span>
                    </div>
                    <div>
                        <span class="badge bg-success">+@checkIn.PointsEarned ƒëi·ªÉm</span>
                    </div>
                </div>
            }
        }
        else
        {
            <p class="text-center text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ ƒëi·ªÉm danh trong th√°ng n√†y</p>
        }
    </div>

    <div class="text-center mt-4">
        <a href="@Url.Action("Index", "PointShop")" class="btn btn-lg btn-primary">
            üéÅ ƒê·ªïi ƒëi·ªÉm l·∫•y qu√†
        </a>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        $(document).ready(function() {
            $('#checkInBtn').click(function() {
                var btn = $(this);
                btn.prop('disabled', true).text('ƒêang x·ª≠ l√Ω...');
                
                $.post('@Url.Action("DailyCheckIn", "CheckIn")', function(response) {
                    if (response.success) {
                        // Add success animation
                        btn.addClass('checkin-success-animation');
                        
                        var streakEmoji = response.consecutiveDays >= 7 ? 'üî•' : '‚≠ê';
                        var bonusMessage = response.consecutiveDays === 7 ? 
                            '<p style="color: #ffd700; font-size: 1.3rem;">üéâ <strong>Streak 7 ng√†y ho√†n th√†nh!</strong> üéâ</p>' : '';
                        var nextDayPoints = response.consecutiveDays >= 7 ? 50 : 
                            (response.consecutiveDays + 1) > 7 ? 50 : [5,10,15,20,25,30,50][response.consecutiveDays];
                        
                        Swal.fire({
                            icon: 'success',
                            title: 'üéä ƒêi·ªÉm danh th√†nh c√¥ng!',
                            html: `
                                <div style="font-size: 1.2rem; text-align: center;">
                                    <div style="font-size: 3rem; margin: 20px 0;">
                                        ${streakEmoji.repeat(Math.min(response.consecutiveDays, 7))}
                                    </div>
                                    ${bonusMessage}
                                    <p style="font-size: 1.5rem; color: #667eea; font-weight: bold;">
                                        +${response.pointsEarned} ƒëi·ªÉm
                                    </p>
                                    <hr>
                                    <p>Streak hi·ªán t·∫°i: <strong>${response.consecutiveDays} ng√†y</strong></p>
                                    <p>T·ªïng ƒëi·ªÉm: <strong>${response.totalPoints} üíé</strong></p>
                                    ${response.consecutiveDays < 7 ? 
                                        `<p style="color: #666; margin-top: 15px;">
                                            ƒêi·ªÉm danh ng√†y mai ƒë·ªÉ nh·∫≠n <strong>${nextDayPoints} ƒëi·ªÉm</strong>!
                                        </p>` : 
                                        `<p style="color: #666; margin-top: 15px;">
                                            Ti·∫øp t·ª•c streak ƒë·ªÉ nh·∫≠n <strong>50 ƒëi·ªÉm</strong> m·ªói ng√†y!
                                        </p>`
                                    }
                                </div>
                            `,
                            confirmButtonText: 'Tuy·ªát v·ªùi!',
                            confirmButtonColor: '#667eea',
                            showClass: {
                                popup: 'animate__animated animate__bounceIn'
                            }
                        }).then(function() {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Oops...',
                            text: response.message,
                            confirmButtonColor: '#667eea'
                        });
                        btn.prop('disabled', false).text('ƒêi·ªÉm danh ngay');
                    }
                }).fail(function() {
                    Swal.fire({
                        icon: 'error',
                        title: 'L·ªói k·∫øt n·ªëi',
                        text: 'Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn server. Vui l√≤ng th·ª≠ l·∫°i!',
                        confirmButtonColor: '#667eea'
                    });
                    btn.prop('disabled', false).text('ƒêi·ªÉm danh ngay');
                });
            });
        });
    </script>
}
