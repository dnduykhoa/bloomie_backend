@using Bloomie.Models.Entities
@model Bloomie.Models.Entities.VoucherCampaign
@{
    ViewData["Title"] = "Ch·ªânh S·ª≠a Ch∆∞∆°ng Tr√¨nh";
    Layout = "~/Areas/Manager/Views/Shared/_ManagerLayout.cshtml";
    var config = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(Model.Config ?? "{}");
    var spinsPerUser = config.TryGetProperty("SpinsPerUser", out var spinsElement) ? spinsElement.GetInt32() : 3;
}

<div class="container-fluid mt-2 p-0">
    <div class="card shadow-sm border-0">
        <div class="card-body p-4">
            <h2 class="fw-bold text-dark mb-3">
                <i class="fas fa-edit text-primary me-2"></i> Ch·ªânh S·ª≠a Ch∆∞∆°ng Tr√¨nh @Model.Name
            </h2>

            <form asp-action="EditCampaign" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" name="id" value="@Model.Id" />

                <div class="row">
                    <!-- Th√¥ng tin c∆° b·∫£n -->
                    <div class="col-md-6">
                        <h5 class="mb-3 fw-bold text-dark">Th√¥ng Tin C∆° B·∫£n</h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√™n Chi·∫øn D·ªãch <span class="text-danger">*</span></label>
                            <input type="text" name="name" class="form-control" value="@Model.Name" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">M√¥ T·∫£</label>
                            <textarea name="description" class="form-control" rows="3">@Model.Description</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Lo·∫°i Chi·∫øn D·ªãch</label>
                            <input type="text" class="form-control" value="@(Model.Type == CampaignType.FlashSale ? "Flash Sale" : "V√≤ng Quay May M·∫Øn")" disabled>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Banner Image (URL)</label>
                            <input type="url" name="bannerImage" class="form-control" value="@Model.BannerImage" placeholder="https://example.com/image.jpg">
                        </div>
                    </div>

                    <!-- Th·ªùi gian -->
                    <div class="col-md-6">
                        <h5 class="mb-3 fw-bold text-dark">Th·ªùi Gian Di·ªÖn Ra</h5>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ng√†y B·∫Øt ƒê·∫ßu <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="startDate" class="form-control" 
                                   value="@Model.StartDate.ToString("yyyy-MM-ddTHH:mm")" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Ng√†y K·∫øt Th√∫c <span class="text-danger">*</span></label>
                            <input type="datetime-local" name="endDate" class="form-control" 
                                   value="@Model.EndDate.ToString("yyyy-MM-ddTHH:mm")" required>
                        </div>

                        @if (Model.Type == CampaignType.LuckyWheel)
                        {
                            <div class="mb-3">
                                <label class="form-label fw-bold">S·ªë L∆∞·ª£t Quay/User <span class="text-danger">*</span></label>
                                <input type="number" name="spinsPerUser" class="form-control" 
                                       value="@spinsPerUser" min="1" max="10" required>
                                <small class="text-muted">S·ªë l∆∞·ª£t quay t·ªëi ƒëa m·ªói ng∆∞·ªùi d√πng</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label fw-bold">C·∫•u H√¨nh Voucher & T·ª∑ L·ªá</label>
                                <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#voucherConfigModal">
                                    <i class="fas fa-cog me-1"></i>C·∫•u H√¨nh Voucher
                                </button>
                                <input type="hidden" id="voucherRatesJson" name="voucherRatesJson" value="">
                                <div id="voucherPreview" class="mt-2 small text-muted">
                                    @if (config.TryGetProperty("VoucherRates", out var voucherRates))
                                    {
                                        <strong>Danh s√°ch voucher hi·ªán t·∫°i:</strong><br>
                                        @foreach (var vr in voucherRates.EnumerateArray())
                                        {
                                            if (vr.TryGetProperty("Id", out var idEl) && vr.TryGetProperty("Rate", out var rateEl))
                                            {
                                                var isLucky = vr.TryGetProperty("IsLucky", out var luckyEl) && luckyEl.GetBoolean();
                                                if (isLucky)
                                                {
                                                    <span class="badge bg-warning text-dark">üçÄ Ch√∫c May M·∫Øn - T·ª∑ l·ªá: @((rateEl.GetDouble() * 100).ToString("0.0"))%</span>
                                                }
                                                else
                                                {
                                                    <span class="badge bg-info">ID: @idEl.GetInt32() - T·ª∑ l·ªá: @((rateEl.GetDouble() * 100).ToString("0.0"))%</span>
                                                }
                                            }
                                        }
                                    }
                                </div>
                            </div>
                        }

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>ƒê√£ ph√°t:</strong> @Model.CollectedCount voucher
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                    <a asp-action="ManageCampaigns" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> L∆∞u thay ƒë·ªïi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #0e7490;
        --secondary-color: #06b6d4;
        --text-dark: #1e293b;
        --text-light: #ffffff;
        --background-light: #f0fdfa;
    }
    
    h2 { 
        font-family: 'Inter', sans-serif; 
        font-size: 1.75rem; 
        font-weight: 600; 
        color: var(--text-dark); 
    }
    
    .container-fluid { 
        padding: 0 !important; 
        margin: 0 !important; 
        width: 100% !important; 
    }
    
    .card { 
        border-radius: 8px; 
        background-color: #ffffff; 
    }
    
    .card-body { 
        padding: 20px; 
    }

    .btn-primary, .btn-secondary {
        border-radius: 6px; 
        padding: 8px 16px; 
        font-size: 0.9rem; 
        transition: all 0.2s ease;
    }
    
    .btn-primary { 
        background-color: var(--primary-color); 
        border-color: var(--primary-color); 
    }
    
    .btn-primary:hover { 
        background-color: #0891b2; 
        border-color: #0891b2; 
        transform: translateY(-1px); 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
    }

    .btn-secondary { 
        background-color: #6b7280; 
        border-color: #6b7280; 
    }
    
    .btn-secondary:hover { 
        background-color: #4b5563; 
        transform: translateY(-1px); 
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
        outline: none;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-dark);
        margin-bottom: 6px;
        font-weight: 500;
    }

    .alert {
        border-radius: 6px;
    }

    h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--text-dark);
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.85rem;
        border-radius: 6px;
        transition: all 0.2s ease;
    }

    .btn-outline-primary:hover,
    .btn-outline-warning:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .btn-danger.btn-sm:hover {
        transform: scale(1.05);
        box-shadow: 0 2px 6px rgba(220, 38, 38, 0.4);
    }

    .modal-header {
        border-radius: 8px 8px 0 0;
    }

    .badge {
        padding: 6px 10px;
        border-radius: 4px;
        font-size: 0.85rem;
        margin-right: 4px;
        margin-bottom: 4px;
    }
</style>

<!-- Modal C·∫•u H√¨nh Voucher -->
@if (Model.Type == CampaignType.LuckyWheel)
{
    <div class="modal fade" id="voucherConfigModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-cog me-2"></i>C·∫•u H√¨nh Voucher & T·ª∑ L·ªá Tr√∫ng
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="voucherRatesContainer">
                        @if (config.TryGetProperty("VoucherRates", out var existingRates))
                        {
                            int index = 0;
                            foreach (var vr in existingRates.EnumerateArray())
                            {
                                if (vr.TryGetProperty("Id", out var idEl) && vr.TryGetProperty("Rate", out var rateEl))
                                {
                                    var isLucky = vr.TryGetProperty("IsLucky", out var luckyEl) && luckyEl.GetBoolean();
                                    
                                    if (isLucky)
                                    {
                                        // Lucky Slot
                                        <div class="row mb-2 voucher-rate-row lucky-slot-row" style="background-color: #fff3cd; padding: 10px; border-radius: 5px;">
                                            <div class="col-7">
                                                <label class="form-label small mb-1">
                                                    <i class="fas fa-clover text-warning me-1"></i>
                                                    <strong>√î "Ch√∫c May M·∫Øn L·∫ßn Sau"</strong>
                                                </label>
                                                <input type="text" class="form-control" value="Kh√¥ng tr√∫ng th∆∞·ªüng" disabled>
                                                <input type="hidden" class="lucky-slot-marker" value="lucky">
                                            </div>
                                            <div class="col-4">
                                                <label class="form-label small mb-1">T·ª∑ l·ªá (0-1)</label>
                                                <input type="number" class="form-control rate-input" step="0.01" min="0" max="1" 
                                                       value="@rateEl.GetDouble()" placeholder="T·ª∑ l·ªá (0-1)">
                                            </div>
                                            <div class="col-1">
                                                <label class="form-label small mb-1 d-block">&nbsp;</label>
                                                <button type="button" class="btn btn-danger btn-sm remove-voucher">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        // Regular Voucher
                                        <div class="row mb-2 voucher-rate-row">
                                            <div class="col-7">
                                                <select class="form-select voucher-select">
                                                    @foreach (var pc in ViewBag.PromotionCodes as List<PromotionCode>)
                                                    {
                                                        var discountDisplay = pc.IsPercent 
                                                            ? $"{pc.Value}%" 
                                                            : $"{pc.Value:N0}ƒë";
                                                        <option value="@pc.Id" selected="@(pc.Id == idEl.GetInt32())">
                                                            @pc.Code - @discountDisplay
                                                        </option>
                                                    }
                                                </select>
                                            </div>
                                            <div class="col-4">
                                                <input type="number" class="form-control rate-input" step="0.01" min="0" max="1" 
                                                       value="@rateEl.GetDouble()" placeholder="T·ª∑ l·ªá (0-1)">
                                            </div>
                                            <div class="col-1">
                                                <button type="button" class="btn btn-danger btn-sm remove-voucher">
                                                    <i class="fas fa-trash-alt"></i>
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    index++;
                                }
                            }
                        }
                    </div>
                    <button type="button" class="btn btn-success btn-sm mt-2" id="addVoucherBtn">
                        <i class="fas fa-plus-circle me-1"></i>Th√™m Voucher
                    </button>
                    <button type="button" class="btn btn-outline-warning btn-sm mt-2 ms-2" id="addLuckySlotBtn">
                        <i class="fas fa-clover me-1"></i>Th√™m √î "Ch√∫c May M·∫Øn"
                    </button>
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>L∆∞u √Ω:</strong> T·ªïng t·ª∑ l·ªá n√™n = 1.0 (100%). V√≠ d·ª•: 0.3 + 0.4 + 0.3 = 1.0
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-warning" id="saveVoucherConfig">
                        <i class="fas fa-check-circle me-1"></i>√Åp D·ª•ng
                    </button>
                </div>
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            const promoCodes = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(
                ((List<PromotionCode>)ViewBag.PromotionCodes).Select(pc => new { 
                    id = pc.Id, 
                    display = $"{pc.Code} - {(pc.IsPercent ? $"{pc.Value}%" : $"{pc.Value:N0}ƒë")}"
                })
            ));

            $('#addVoucherBtn').click(function() {
                const row = $('<div class="row mb-2 voucher-rate-row">');
                const selectCol = $('<div class="col-7">');
                const select = $('<select class="form-select voucher-select">');
                promoCodes.forEach(pc => {
                    select.append($('<option>').val(pc.id).text(pc.display));
                });
                selectCol.append(select);
                
                const rateCol = $('<div class="col-4">');
                rateCol.append($('<input type="number" class="form-control rate-input" step="0.01" min="0" max="1" placeholder="T·ª∑ l·ªá (0-1)">'));
                
                const btnCol = $('<div class="col-1">');
                btnCol.append($('<button type="button" class="btn btn-danger btn-sm remove-voucher"><i class="fas fa-trash-alt"></i></button>'));
                
                row.append(selectCol, rateCol, btnCol);
                $('#voucherRatesContainer').append(row);
            });

            $('#addLuckySlotBtn').click(function() {
                const row = $('<div class="row mb-2 voucher-rate-row lucky-slot-row" style="background-color: #fff3cd; padding: 10px; border-radius: 5px;">');
                
                const labelCol = $('<div class="col-7">');
                labelCol.append(`
                    <label class="form-label small mb-1">
                        <i class="fas fa-clover text-warning me-1"></i>
                        <strong>√î "Ch√∫c May M·∫Øn L·∫ßn Sau"</strong>
                    </label>
                    <input type="text" class="form-control" value="Kh√¥ng tr√∫ng th∆∞·ªüng" disabled>
                    <input type="hidden" class="lucky-slot-marker" value="lucky">
                    <small class="text-muted">User tr√∫ng √¥ n√†y s·∫Ω KH√îNG nh·∫≠n ƒë∆∞·ª£c voucher</small>
                `);
                
                const rateCol = $('<div class="col-4">');
                rateCol.append(`
                    <label class="form-label small mb-1">T·ª∑ l·ªá (0-1)</label>
                    <input type="number" class="form-control rate-input" step="0.01" min="0" max="1" value="0.2" placeholder="T·ª∑ l·ªá (0-1)">
                `);
                
                const btnCol = $('<div class="col-1">');
                btnCol.append(`
                    <label class="form-label small mb-1 d-block">&nbsp;</label>
                    <button type="button" class="btn btn-danger btn-sm remove-voucher"><i class="fas fa-trash-alt"></i></button>
                `);
                
                row.append(labelCol, rateCol, btnCol);
                $('#voucherRatesContainer').append(row);
            });

            $(document).on('click', '.remove-voucher', function() {
                $(this).closest('.voucher-rate-row').remove();
            });

            $('#saveVoucherConfig').click(function() {
                const voucherRates = [];
                $('.voucher-rate-row').each(function() {
                    const rate = parseFloat($(this).find('.rate-input').val()) || 0;
                    
                    // Check if this is a lucky slot
                    const isLuckySlot = $(this).find('.lucky-slot-marker').length > 0;
                    
                    if (isLuckySlot) {
                        // Lucky slot (no prize)
                        if (rate >= 0) {
                            voucherRates.push({ Id: 0, Rate: rate, IsLucky: true });
                        }
                    } else {
                        // Regular voucher slot
                        const id = parseInt($(this).find('.voucher-select').val());
                        if (id && rate >= 0) {
                            voucherRates.push({ Id: id, Rate: rate, IsLucky: false });
                        }
                    }
                });

                // T√≠nh t·ªïng t·ª∑ l·ªá
                let totalRate = voucherRates.reduce((sum, vr) => sum + vr.Rate, 0);
                totalRate = Math.round(totalRate * 100) / 100; // l√†m tr√≤n 2 s·ªë th·∫≠p ph√¢n

                if (totalRate > 1) {
                    alert('T·ªïng t·ª∑ l·ªá v∆∞·ª£t qu√° 100%. Vui l√≤ng gi·∫£m l·∫°i!');
                    return;
                }
                if (totalRate < 1 && voucherRates.length > 0) {
                    // T·ª± ƒë·ªông c·ªông ph·∫ßn thi·∫øu v√†o entry cu·ªëi c√πng
                    const missing = Math.round((1 - totalRate) * 100) / 100;
                    voucherRates[voucherRates.length - 1].Rate += missing;
                    totalRate = 1;
                    alert('H·ªá th·ªëng ƒë√£ t·ª± ƒë·ªông c·ªông ph·∫ßn thi·∫øu v√†o entry cu·ªëi c√πng ƒë·ªÉ ƒë·ªß 100%.');
                }

                $('#voucherRatesJson').val(JSON.stringify(voucherRates));
                $('#voucherConfigModal').modal('hide');

                // Preview
                let preview = '<strong>ƒê√£ c·∫•u h√¨nh:</strong><br>';
                voucherRates.forEach(vr => {
                    if (vr.IsLucky) {
                        preview += `<span class="badge bg-warning text-dark">üçÄ Ch√∫c May M·∫Øn - T·ª∑ l·ªá: ${(vr.Rate * 100).toFixed(1)}%</span> `;
                    } else {
                        preview += `<span class="badge bg-info">ID: ${vr.Id} - T·ª∑ l·ªá: ${(vr.Rate * 100).toFixed(1)}%</span> `;
                    }
                });
                $('#voucherPreview').html(preview);
            });
        </script>
    }
}
