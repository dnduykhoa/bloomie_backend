@model Bloomie.Models.Entities.PointReward
@{
    ViewData["Title"] = "S·ª≠a ph·∫ßn qu√†";
    Layout = "~/Areas/Manager/Views/Shared/_ManagerLayout.cshtml";
    var promotionCodes = ViewBag.PromotionCodes as List<Bloomie.Models.Entities.PromotionCode>;
}

<div class="container-fluid mt-2 p-0">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-dark">
                    <i class="fas fa-edit text-primary me-2"></i> Ch·ªânh S·ª≠a Ph·∫ßn Qu√† ƒê·ªïi ƒêi·ªÉm
                </h2>
            </div>
            <form asp-action="EditPointReward" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="row">
                    <!-- C·ªôt tr√°i -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-tag"></i> T√™n ph·∫ßn qu√† <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" value="@Model.Name" required 
                                   placeholder="VD: Voucher gi·∫£m 50.000ƒë">
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-align-left"></i> M√¥ t·∫£</label>
                            <textarea class="form-control" name="description" rows="3" 
                                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ph·∫ßn qu√†">@Model.Description</textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-coins"></i> S·ªë ƒëi·ªÉm c·∫ßn thi·∫øt <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="pointsCost" value="@Model.PointsCost" 
                                   required min="1" placeholder="Nh·∫≠p s·ªë ƒëi·ªÉm">
                            <small class="text-muted">User c·∫ßn bao nhi√™u ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi ph·∫ßn qu√† n√†y</small>
                        </div>

                        @{
                            var currentPromotionType = Model.PromotionCode?.Promotion?.Type;
                        }
                        
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-list"></i> Lo·∫°i voucher <span class="text-danger">*</span></label>
                            <select class="form-select" id="promotionTypeFilter" required>
                                <option value="">-- Ch·ªçn lo·∫°i voucher --</option>
                                @{
                                    var selectedType0 = (int?)currentPromotionType == 0;
                                    var selectedType1 = (int?)currentPromotionType == 1;
                                    var selectedType2 = (int?)currentPromotionType == 2;
                                    var selectedType3 = (int?)currentPromotionType == 3;
                                }
                                <option value="0" selected="@(selectedType0 ? "selected" : null)">üì¶ Gi·∫£m gi√° ƒë∆°n h√†ng</option>
                                <option value="1" selected="@(selectedType1 ? "selected" : null)">üè∑Ô∏è Gi·∫£m gi√° s·∫£n ph·∫©m</option>
                                <option value="2" selected="@(selectedType2 ? "selected" : null)">üöö Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</option>
                                <option value="3" selected="@(selectedType3 ? "selected" : null)">üéÅ Mua X t·∫∑ng Y</option>
                            </select>
                            <small class="text-muted">Ch·ªçn lo·∫°i voucher ƒë·ªÉ l·ªçc danh s√°ch m√£ khuy·∫øn m√£i</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-ticket-alt"></i> Ch·ªçn m√£ khuy·∫øn m√£i  <span class="text-danger">*</span></label>
                            <select class="form-select" name="promotionCodeId" id="promotionCodeId" required>
                                <option value="">-- Ch·ªçn m√£ khuy·∫øn m√£i --</option>
                            </select>
                            <small class="text-muted">Ch·ªçn m√£ khuy·∫øn m√£i c·ª• th·ªÉ</small>
                            
                            @if (promotionCodes != null && promotionCodes.Any())
                            {
                                <!-- Hidden data for JavaScript -->
                                <div id="promotionCodesData" style="display: none;" data-selected-id="@Model.PromotionCodeId">
                                    @foreach (var code in promotionCodes)
                                    {
                                        var typeValue = (int)(code.Promotion?.Type ?? 0);
                                        var displayText = $"{code.Code} - ";
                                        if (code.IsPercent)
                                        {
                                            displayText += $"Gi·∫£m {code.Value}%";
                                        }
                                        else
                                        {
                                            displayText += $"Gi·∫£m {code.Value:N0}‚Ç´";
                                        }
                                        if (code.Promotion != null)
                                        {
                                            displayText += $" ({code.Promotion.Name})";
                                        }
                                        <div class="promo-code-item" 
                                             data-id="@code.Id" 
                                             data-type="@typeValue" 
                                             data-text="@displayText">
                                        </div>
                                    }
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" name="isActive" 
                                       id="isActive" value="true" @(Model.IsActive ? "checked" : "")
                                       role="switch" style="width: 3em; height: 1.5em;">
                                <label class="form-check-label ms-2" for="isActive">
                                    <strong>K√≠ch ho·∫°t</strong>
                                </label>
                            </div>
                            <small class="text-muted">User ch·ªâ th·∫•y v√† ƒë·ªïi ƒë∆∞·ª£c khi ph·∫ßn qu√† ƒëang k√≠ch ho·∫°t</small>
                        </div>
                    </div>

                    <!-- C·ªôt ph·∫£i -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-box"></i> T·ªìn kho</label>
                            <input type="number" class="form-control" name="stock" value="@Model.Stock" min="0" 
                                   placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n">
                            <small class="text-muted">S·ªë l∆∞·ª£ng ph·∫ßn qu√† c√≥ th·ªÉ ƒë·ªïi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-calendar-alt"></i> H·∫°n s·ª≠ d·ª•ng (ng√†y) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="validDays" value="@Model.ValidDays" 
                                   required min="1" placeholder="30">
                            <small class="text-muted">Voucher c√≥ hi·ªáu l·ª±c bao nhi√™u ng√†y sau khi ƒë·ªïi</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-image"></i> ·∫¢nh ph·∫ßn qu√†</label>
                            
                            @if (!string.IsNullOrEmpty(Model.ImageUrl))
                            {
                                <div class="mb-2">
                                    <img src="@Model.ImageUrl" alt="@Model.Name" class="img-thumbnail" 
                                         style="max-width: 100%; max-height: 200px;">
                                    <p class="text-muted small mt-1">·∫¢nh hi·ªán t·∫°i</p>
                                </div>
                            }
                            
                            <input type="file" class="form-control" name="imageFile" accept="image/*" id="imageInput"
                                   onchange="previewImage(event)">
                            <small class="text-muted">Ch·ªçn ·∫£nh m·ªõi ƒë·ªÉ thay th·∫ø (ƒë·ªÉ tr·ªëng n·∫øu gi·ªØ nguy√™n)</small>
                            
                            <div class="mt-3" id="imagePreview" style="display: none;">
                                <p class="text-info small">·∫¢nh m·ªõi:</p>
                                <img id="preview" src="" alt="Preview" class="img-thumbnail" 
                                     style="max-width: 100%; max-height: 200px;">
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-clock me-2"></i>
                            <small>
                                <strong>Ng√†y t·∫°o:</strong> @Model.CreatedDate.ToString("dd/MM/yyyy HH:mm")
                            </small>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <small class="text-muted">
                        <span class="text-danger">*</span> Tr∆∞·ªùng b·∫Øt bu·ªôc
                    </small>
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center">
                    <a asp-controller="AdminPromotion" asp-action="ManageCampaigns" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i
                    </a>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i> L∆∞u Thay ƒê·ªïi
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-info">
            <i class="fas fa-lightbulb"></i> <strong>G·ª£i √Ω:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>Voucher:</strong> C·∫ßn ch·ªçn Promotion Code ƒë·ªÉ user c√≥ th·ªÉ s·ª≠ d·ª•ng khi checkout</li>
                <li><strong>ƒêi·ªÉm c·∫ßn thi·∫øt:</strong> N√™n c√¢n ƒë·ªëi v·ªõi gi√° tr·ªã ph·∫ßn qu√† (VD: Voucher 50k = 500 ƒëi·ªÉm)</li>
                <li><strong>T·ªìn kho:</strong> ƒê·ªÉ tr·ªëng n·∫øu mu·ªën kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng ƒë·ªïi</li>
                <li><strong>H·∫°n s·ª≠ d·ª•ng:</strong> Th·ªùi gian voucher c√≥ hi·ªáu l·ª±c sau khi user ƒë·ªïi</li>
            </ul>
        </div>
    </div>
</div>

<style>
    :root {
        --primary-color: #0e7490;
        --text-dark: #1e293b;
    }
    
    h2 { 
        font-family: 'Inter', sans-serif; 
        font-size: 1.75rem; 
        font-weight: 600; 
        color: var(--text-dark); 
    }
    
    .container-fluid { 
        padding: 0 !important; 
        margin: 0 !important; 
        width: 100% !important; 
    }
    
    .card { 
        border-radius: 8px; 
        background-color: #ffffff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    }
    
    .card-body { 
        padding: 24px; 
    }

    .form-label {
        font-weight: 500;
        color: var(--text-dark);
        margin-bottom: 0.5rem;
    }

    .form-label i {
        color: var(--primary-color);
        margin-right: 4px;
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 10px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
        outline: none;
    }

    .btn-primary, .btn-secondary {
        border-radius: 6px;
        padding: 8px 16px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
    }

    .btn-primary:hover {
        background-color: #0891b2;
        border-color: #0891b2;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .btn-secondary {
        background-color: #6b7280;
        border-color: #6b7280;
    }

    .btn-secondary:hover {
        background-color: #4b5563;
        border-color: #4b5563;
        transform: translateY(-1px);
    }

    .form-check-switch .form-check-input {
        cursor: pointer;
    }

    .alert-info {
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
        background-color: #eff6ff;
        color: #1e40af;
    }

    .img-thumbnail {
        border-radius: 8px;
        border: 2px solid #e5e7eb;
        padding: 8px;
    }

    .text-danger {
        font-size: 0.875rem;
    }

    hr {
        margin: 1.5rem 0;
        border-color: #e5e7eb;
    }
</style>

<script>
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    // Filter promotion codes based on selected type
    function filterPromotionCodes() {
        const selectedType = document.getElementById('promotionTypeFilter').value;
        const promotionCodeSelect = document.getElementById('promotionCodeId');
        const promoCodesDataDiv = document.getElementById('promotionCodesData');
        const promoCodesData = document.querySelectorAll('#promotionCodesData .promo-code-item');
        const selectedId = promoCodesDataDiv ? promoCodesDataDiv.dataset.selectedId : null;
        
        // Clear current options
        promotionCodeSelect.innerHTML = '<option value="">-- Ch·ªçn m√£ khuy·∫øn m√£i --</option>';
        
        if (selectedType === '') {
            promotionCodeSelect.disabled = true;
            promotionCodeSelect.innerHTML = '<option value="">-- Vui l√≤ng ch·ªçn lo·∫°i voucher tr∆∞·ªõc --</option>';
            return;
        }
        
        // Enable and populate options
        promotionCodeSelect.disabled = false;
        let hasOptions = false;
        
        promoCodesData.forEach(function(item) {
            if (item.dataset.type === selectedType) {
                const option = document.createElement('option');
                option.value = item.dataset.id;
                option.textContent = item.dataset.text;
                
                // Select the current value
                if (selectedId && item.dataset.id === selectedId) {
                    option.selected = true;
                }
                
                promotionCodeSelect.appendChild(option);
                hasOptions = true;
            }
        });
        
        if (!hasOptions) {
            promotionCodeSelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ m√£ khuy·∫øn m√£i n√†o cho lo·∫°i n√†y --</option>';
            promotionCodeSelect.disabled = true;
        }
    }

    document.getElementById('promotionTypeFilter').addEventListener('change', filterPromotionCodes);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        filterPromotionCodes();
    });
</script>
