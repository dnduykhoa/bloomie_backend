@model Bloomie.Models.ViewModels.PromotionProductDiscountVM
@{
    ViewData["Title"] = "Thêm mã giảm giá sản phẩm";
    Layout = "~/Areas/Manager/Views/Shared/_ManagerLayout.cshtml";
    var products = ViewBag.Products as List<Bloomie.Models.Entities.Product>;
    var categories = ViewBag.Categories as List<Bloomie.Models.Entities.Category>;
}

<div class="container-fluid mt-2 p-0">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-dark">
                    <i class="fas fa-percent text-primary me-2"></i> Thêm mới mã giảm giá sản phẩm
                </h2>
            </div>

<div class="row justify-content-center">
    <div class="col-lg-7">
        <form asp-action="CreateProductDiscount" method="post" id="promoForm">
            <!-- Card: Mã khuyến mãi -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Mã khuyến mãi</div>
                <div class="card-body row g-2 align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input asp-for="Code" class="form-control" placeholder="VD: COUPON10" required id="Code" />
                            <button type="button" class="btn btn-outline-secondary" id="btnRandomCode">Tạo mã ngẫu nhiên</button>
                        </div>
                        <span asp-validation-for="Code" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-2 text-center bg-light">
                            <b id="previewCode">Mã khuyến mãi</b>
                            <div class="small text-muted">Chưa có thông tin chi tiết</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Card: Giá trị -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Giá trị</div>
                <div class="card-body row g-2">
                    <div class="col-md-6">
                        <label class="form-label">Giá trị khuyến mãi</label>
                        <div class="input-group align-items-stretch">
                            <div class="btn-group me-1" role="group" id="discountTypeGroup">
                                <button type="button" class="btn btn-outline-primary" id="btnMoney">Số tiền</button>
                                <button type="button" class="btn btn-outline-primary" id="btnPercent">%</button>
                            </div>
                            <input asp-for="Value" class="form-control" type="number" min="0" required id="ValueInput" />
                            <span class="input-group-text" id="unitLabel">đ</span>
                        </div>
                        <input type="hidden" asp-for="IsPercent" id="IsPercentHidden" />
                        <span asp-validation-for="Value" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Giá trị giảm tối đa</label>
                        <input asp-for="MaxDiscount" class="form-control" type="number" min="0" />
                        <span asp-validation-for="MaxDiscount" class="text-danger"></span>
                    </div>
                    <!-- Di chuyển phần "Áp dụng cho" vào đây -->
                    <div class="mt-3">
                        <label class="form-label fw-bold">Áp dụng cho</label>
                        <div class="row g-2 align-items-center">
                            <div class="col-auto">
                                <input class="form-check-input" type="radio" name="ApplyType" id="applyProduct" value="product" checked />
                                <label class="form-check-label me-3" for="applyProduct">Sản phẩm</label>
                            </div>
                            <div class="col-auto">
                                <input class="form-check-input" type="radio" name="ApplyType" id="applyCategory" value="category" />
                                <label class="form-check-label" for="applyCategory">Danh mục sản phẩm</label>
                            </div>
                        </div>
                        <!-- Product Select Box -->
                        <div id="productSelectBox" class="mt-2">
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="productSearch" placeholder="Tìm kiếm sản phẩm" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMulti">Chọn nhiều</button>
                                <div id="productSearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="productMultiSelected" class="mb-2"></div>
                            <select asp-for="ProductIds" class="form-select d-none" multiple size="5" id="productList">
                                @if (products != null)
                                {
                                    foreach (var p in products)
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                }
                            </select>
                            <span asp-validation-for="ProductIds" class="text-danger"></span>
                            <!-- Modal chọn nhiều sản phẩm -->
                            <div class="modal fade" id="productMultiModal" tabindex="-1" aria-labelledby="productMultiModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                        <div class="modal-header border-0 pb-0">
                                            <h5 class="modal-title fw-bold" id="productMultiModalLabel">Chọn sản phẩm</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body pt-2">
                                            <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalProductSearch" placeholder="Tìm kiếm theo tên, mã SKU, Barcode sản phẩm" autocomplete="off" style="background:#f6f6f6;" />
                                            <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalProductList" style="max-height:400px;">
                                                @if (products != null)
                                                {
                                                    foreach (var p in products)
                                                    {
                                                        <label class="list-group-item d-flex align-items-center py-2 px-3 product-list-item" data-name="@p.Name?.ToLower()">
                                                            <input type="checkbox" class="form-check-input me-3 product-multi-checkbox" value="@p.Id" id="multiProduct_@p.Id">
                                                            <img src="@(p.ImageUrl ?? "/wwwroot/profiles/default.png")" alt="@p.Name" style="width:32px;height:32px;object-fit:cover;border-radius:6px;" class="me-3 border" />
                                                            <span class="flex-grow-1">@p.Name</span>
                                                        </label>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Huỷ</button>
                                            <button type="button" class="btn btn-primary px-4" id="btnProductMultiDone">Áp dụng</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Category Select Box -->
                        <div id="categorySelectBox" style="display:none;" class="mt-2">
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="categorySearchInput" placeholder="Tìm kiếm danh mục" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMultiCategory">Chọn nhiều</button>
                                <div id="categorySearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="categoryMultiSelected" class="mb-2"></div>
                            <select class="form-select d-none" name="CategoryIds" id="categoryList" multiple>
                                @if (categories != null)
                                {
                                    foreach (var c in categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </select>
                            <!-- Modal chọn nhiều danh mục -->
                            <div class="modal fade" id="categoryMultiModal" tabindex="-1" aria-labelledby="categoryMultiModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                        <div class="modal-header border-0 pb-0">
                                            <h5 class="modal-title fw-bold" id="categoryMultiModalLabel">Chọn danh mục áp dụng</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body pt-2">
                                            <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalCategorySearch" placeholder="Tìm kiếm danh mục..." autocomplete="off" style="background:#f6f6f6;" />
                                            <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalCategoryList" style="max-height:400px;">
                                                @if (categories != null)
                                                {
                                                    foreach (var c in categories)
                                                    {
                                                        <label class="list-group-item d-flex align-items-center py-2 px-3 category-list-item" data-name="@c.Name?.ToLower()">
                                                            <input type="checkbox" class="form-check-input me-3 category-multi-checkbox" value="@c.Id" id="multiCategory_@c.Id">
                                                            <span class="flex-grow-1">@c.Name</span>
                                                        </label>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Đóng</button>
                                            <button type="button" class="btn btn-primary px-4" id="btnCategoryMultiDone">Xong</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Card: Điều kiện áp dụng -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Điều kiện áp dụng</div>
                <div class="card-body">
                    <div class="form-check">
                        <input asp-for="ConditionType" class="form-check-input" type="radio" value="None" checked id="condNone" />
                        <label class="form-check-label" for="condNone">Không có</label>
                    </div>
                    <div class="form-check mb-1">
                        <input asp-for="ConditionType" class="form-check-input" type="radio" value="MinOrderValue" id="condMinOrderValue" />
                        <label class="form-check-label" for="condMinOrderValue">Tổng giá trị đơn hàng tối thiểu</label>
                        <div class="input-group mt-2 ms-4" id="groupMinOrderValue" style="display:none;max-width:220px;">
                            <input asp-for="MinOrderValue" class="form-control" type="number" min="0" step="1000" id="inputMinOrderValue" placeholder="Nhập số tiền" />
                            <span class="input-group-text">đ</span>
                        </div>
                    </div>
                    <div class="form-check mb-1">
                        <input asp-for="ConditionType" class="form-check-input" type="radio" value="MinProductValue" id="condMinProductValue" />
                        <label class="form-check-label" for="condMinProductValue">Tổng giá trị sản phẩm được khuyến mãi tối thiểu</label>
                        <div class="input-group mt-2 ms-4" id="groupMinProductValue" style="display:none;max-width:220px;">
                            <input asp-for="MinProductValue" class="form-control" type="number" min="0" step="1000" id="inputMinProductValue" placeholder="Nhập số tiền" />
                            <span class="input-group-text">đ</span>
                        </div>
                    </div>
                    <div class="form-check mb-1">
                        <input asp-for="ConditionType" class="form-check-input" type="radio" value="MinProductQuantity" id="condMinProductQuantity" />
                        <label class="form-check-label" for="condMinProductQuantity">Tổng số lượng sản phẩm được khuyến mãi tối thiểu</label>
                        <div class="input-group mt-2 ms-4" id="groupMinProductQuantity" style="display:none;max-width:180px;">
                            <input asp-for="MinProductQuantity" class="form-control" type="number" min="0" step="1" id="inputMinProductQuantity" placeholder="Nhập số lượng" />
                            <span class="input-group-text">sản phẩm</span>
                        </div>
                    </div>
                    <span asp-validation-for="ConditionValue" class="text-danger"></span>
                    <span asp-validation-for="MinOrderValue" class="text-danger"></span>
                    <span asp-validation-for="MinProductValue" class="text-danger"></span>
                    <span asp-validation-for="MinProductQuantity" class="text-danger"></span>
                </div>
            </div>
            <!-- Card: Giới hạn sử dụng -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Giới hạn sử dụng</div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="limitUsageCheckbox" />
                        <label class="form-check-label" for="limitUsageCheckbox">Giới hạn sử dụng</label>
                    </div>
                    <div class="mb-2" id="usageLimitInputWrapper" style="display:none;">
                        <label class="form-label">Số lần sử dụng tối đa</label>
                        <div class="input-group" style="max-width:200px;">
                            <input asp-for="UsageLimit" class="form-control text-center" min="1" />
                            <span class="input-group-text">lần</span>
                        </div>
                        <span asp-validation-for="UsageLimit" class="text-danger"></span>
                    </div>
                    <div class="form-check mb-2">
                        <input asp-for="LimitPerCustomer" class="form-check-input" type="checkbox" id="LimitPerCustomer" />
                        <label class="form-check-label" for="LimitPerCustomer">Mỗi khách hàng chỉ được sử dụng mã giảm giá này 1 lần</label>
                    </div>
                </div>
            </div>
            <!-- Card: Kết hợp khuyến mãi -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Kết hợp khuyến mãi</div>
                <div class="card-body">
                    <div class="form-check">
                        <input asp-for="AllowCombineOrder" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Giảm giá đơn hàng</label>
                    </div>
                    <div class="form-check">
                        <input asp-for="AllowCombineProduct" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Giảm giá sản phẩm</label>
                    </div>
                    <div class="form-check">
                        <input asp-for="AllowCombineShipping" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Miễn phí vận chuyển</label>
                    </div>
                </div>
            </div>
            <!-- Card: Thời gian -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Thời gian</div>
                <div class="card-body row g-2 align-items-center">
                    <div class="col">
                        <label class="form-label">Ngày bắt đầu</label>
                        <input asp-for="StartDate" class="form-control" type="datetime-local" required />
                    </div>
                    <div class="col">
                        <label class="form-label">Ngày kết thúc</label>
                        <input asp-for="EndDate" class="form-control" type="datetime-local" id="endDateInput" disabled />
                    </div>
                    <div class="col-auto align-self-end">
                        <input type="checkbox" id="noEndDate" class="form-check-input" checked />
                        <label for="noEndDate" class="form-check-label">Không có ngày kết thúc</label>
                    </div>
                </div>
            </div>

            <!-- Card: Công khai -->
            <div class="card mb-3 border-primary">
                <div class="card-header bg-light">
                    <i class="bi bi-globe text-primary me-2"></i>
                    <span class="fw-bold">Công khai - Hiển thị trên trang Vouchers để users tự thu thập</span>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input type="checkbox" name="IsPublic" value="true" class="form-check-input" id="isPublicCheck" role="switch" style="width: 3rem; height: 1.5rem; cursor: pointer;" />
                        <input type="hidden" name="IsPublic" value="false" />
                        <label class="form-check-label ms-2" for="isPublicCheck" style="cursor: pointer;">
                            <span class="fw-semibold">Cho phép hiển thị công khai</span>
                        </label>
                    </div>
                    <div class="alert alert-info mt-3 mb-0" style="border-left: 4px solid #0dcaf0;">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>
                            <strong>Lưu ý:</strong> Nếu chọn, mã này sẽ xuất hiện trên trang Vouchers công khai để users tự lưu vào ví của họ.
                        </small>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                <a asp-action="CreateTypeSelect" asp-route-tab="code" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Tạo mã khuyến mãi
                </button>
            </div>
        </form>
    </div>
    <!-- Cột Tổng quan -->
    <div class="col-lg-5">
        <div class="card mb-3">
            <div class="card-header fw-bold">Tổng quan khuyến mãi</div>
            <div class="card-body" id="promoSummary">
                <!-- Trạng thái trống -->
                <div id="summaryEmpty" style="display:none;">
                    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height:270px;">
                        <div style="position:relative;width:90%;max-width:320px;background:#fff;border-radius:18px;border:2px dashed #b6b6b6;box-shadow:0 2px 8px #0001;overflow:hidden;">
                            <div style="background:#f5f5f5;border-bottom:1.5px dashed #b6b6b6;padding:10px 0 8px 0;text-align:center;font-weight:600;font-size:1.15rem;letter-spacing:1px;">
                                Mã khuyến mãi
                            </div>
                            <div style="position:absolute;left:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="position:absolute;right:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="padding:24px 0 18px 0;text-align:center;min-height:110px;">
                                <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" alt="voucher empty" style="width:70px;opacity:0.6;" />
                                <div class="text-muted mt-2" style="font-size:1.05rem;">Chưa có thông tin chi tiết</div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Trạng thái đã điền -->
                <div id="summaryFilled" style="display:none;">
                    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height:270px;">
                        <div style="position:relative;width:90%;max-width:320px;background:#fff;border-radius:18px;border:2px dashed #b6b6b6;box-shadow:0 2px 8px #0001;overflow:hidden;">
                            <div style="background:#f5f5f5;border-bottom:1.5px dashed #b6b6b6;padding:10px 0 8px 0;text-align:center;font-weight:600;font-size:1.15rem;letter-spacing:1px;">
                                <span id="summaryCode"></span>
                            </div>
                            <div style="position:absolute;left:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="position:absolute;right:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="padding:18px 18px 12px 18px;text-align:left;min-height:110px;">
                                <ul class="mb-2 ps-2" style="font-size:1.05rem;">
                                    <li><b>Loại:</b> <span id="summaryType"></span></li>
                                    <li><b>Giá trị khuyến mãi:</b> <span id="summaryValue"></span></li>
                                    <li id="maxDiscountRow" style="display:none;">
                                        <b>Giá trị giảm tối đa:</b> <span id="summaryMaxDiscount">Chưa cập nhật</span>
                                    </li>
                                    <li><b>Áp dụng cho:</b> <span id="summaryApply"></span></li>
                                    <li><b>Điều kiện áp dụng:</b> <span id="summaryCondition"></span></li>
                                    <li><b>Giới hạn sử dụng:</b> <span id="summaryUsageLimit"></span></li>
                                    <li><b>Kết hợp khuyến mãi:</b> <span id="summaryCombine"></span></li>
                                    <li><b>Thời gian:</b> <span id="summaryTime"></span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning mt-2 mb-0 p-2" style="font-size:0.95em;">
                        <i class="fas fa-exclamation-triangle me-1"></i> Chương trình chưa được kích hoạt
                </div>
            </div>
        </div>
        <!-- Card Hướng dẫn -->
        <div class="card mb-3">
            <div class="card-header fw-bold bg-info bg-opacity-10">Hướng dẫn sử dụng mã giảm giá sản phẩm</div>
            <div class="card-body" style="font-size:1.04rem;">
                <ul class="mb-2 ps-3">
                    <li><b>Giá trị khuyến mãi</b>:<br>
                        - Nếu chọn <b>%</b>: Số tiền giảm = Sản phẩm × (Giá trị khuyến mãi / 100). Nếu có "Giá trị giảm tối đa", số tiền giảm không vượt quá giá trị này.<br>
                        - Nếu chọn <b>Số tiền</b>: Số tiền giảm = Giá trị khuyến mãi (giảm trực tiếp số tiền này trên sản phẩm).
                    </li>
                    <li class="mt-2"><b>Áp dụng cho</b>:<br>
                        - Chọn "Sản phẩm" để áp dụng cho các sản phẩm cụ thể.<br>
                        - Chọn "Danh mục sản phẩm" để áp dụng cho toàn bộ sản phẩm thuộc danh mục đã chọn.
                    </li>
                    <li class="mt-2"><b>Điều kiện áp dụng</b>:<br>
                        - <b>Không có</b>: Sản phẩm nào cũng áp dụng được.<br>
                        - <b>Tổng giá trị đơn hàng tối thiểu</b>: Đơn hàng phải đạt từ số tiền này trở lên.<br>
                        - <b>Tổng giá trị sản phẩm được khuyến mãi tối thiểu</b>: Tổng giá trị các sản phẩm thuộc nhóm khuyến mãi phải đạt từ số tiền này trở lên.<br>
                        - <b>Tổng số lượng sản phẩm được khuyến mãi tối thiểu</b>: Tổng số lượng sản phẩm thuộc nhóm khuyến mãi phải đạt từ số lượng này trở lên.
                    </li>
                    <li class="mt-2"><b>Giới hạn sử dụng</b>:<br>
                        - <b>Giới hạn sử dụng</b>: Số lần mã được dùng tổng cộng.<br>
                        - <b>Giới hạn mỗi khách hàng</b>: Mỗi khách chỉ dùng được 1 lần.
                    </li>
                    <li class="mt-2"><b>Kết hợp khuyến mãi</b>:<br>
                        - Nếu tick các ô này, mã có thể dùng chung với các loại khuyến mãi khác (giảm giá đơn hàng, sản phẩm, miễn phí ship).
                    </li>
                    <li class="mt-2"><b>Thời gian áp dụng</b>:<br>
                        - Chỉ áp dụng cho đơn hàng trong khoảng thời gian đã chọn.
                    </li>
                </ul>
                <div class="alert alert-info mt-2 mb-0 p-2" style="font-size:0.98em;">
                    <b>Ví dụ:</b> Nếu bạn tạo mã <b>SALE10</b> giảm <b>10%</b> cho sản phẩm thuộc danh mục <b>Hoa tươi</b>, khách mua sản phẩm đó sẽ được giảm <b>10%</b> (nếu không có giới hạn tối đa).<br>
                    Nếu bạn chọn giảm <b>50.000đ</b> cho sản phẩm <b>Hoa hồng đỏ</b>, khách mua sản phẩm này sẽ được giảm đúng <b>50.000đ</b>.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Chi tiết Áp dụng cho -->
<div class="modal fade" id="applyDetailModal" tabindex="-1" aria-labelledby="applyDetailModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applyDetailModalTitle">Danh sách áp dụng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="applyDetailModalBody" style="max-height:500px;">
                <!-- Nội dung sẽ được thêm bằng JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// --- Hàm tiện ích ---
function safeGet(id) {
    const el = document.getElementById(id);
    if (!el) console.error(`Element with ID '${id}' not found`);
    return el;
}

// Biến toàn cục
let savedMoneyValue = ''; // Lưu giá trị Số tiền
let savedPercentValue = ''; // Lưu giá trị %

// --- Random code ---
const randomCode = (length = 8) => {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
};

// --- Đổi loại giảm giá (tiền / %) ---
const setDiscountType = (isPercent) => {
    const btnMoney = safeGet('btnMoney');
    const btnPercent = safeGet('btnPercent');
    const typeHidden = safeGet('IsPercentHidden');
    const unitLabel = safeGet('unitLabel');
    const valueBox = safeGet('ValueInput');

    // Lưu giá trị hiện tại trước khi chuyển
    const currentValue = valueBox.value;
    const currentIsPercent = typeHidden.value === 'true';
    
    if (currentValue) {
        if (currentIsPercent) {
            savedPercentValue = currentValue; // Lưu giá trị %
        } else {
            savedMoneyValue = currentValue; // Lưu giá trị Số tiền
        }
    }

    typeHidden.value = isPercent ? 'true' : 'false';
    btnMoney.classList.toggle('active', !isPercent);
    btnMoney.classList.toggle('btn-primary', !isPercent);
    btnMoney.classList.toggle('btn-outline-primary', isPercent);
    btnPercent.classList.toggle('active', isPercent);
    btnPercent.classList.toggle('btn-primary', isPercent);
    btnPercent.classList.toggle('btn-outline-primary', !isPercent);

    unitLabel.innerText = isPercent ? '%' : 'đ';
    valueBox.placeholder = isPercent ? 'Nhập %' : 'Nhập số tiền';
    
    // Khôi phục giá trị đã lưu (nếu có)
    if (isPercent && savedPercentValue) {
        valueBox.value = savedPercentValue;
    } else if (!isPercent && savedMoneyValue) {
        valueBox.value = savedMoneyValue;
    } else {
        valueBox.value = ''; // Clear nếu chưa có giá trị đã lưu
    }
    
    updateSummary();
};

// --- Toggle Sản phẩm / Danh mục ---
const updateApplyType = () => {
    const applyType = document.querySelector('input[name="ApplyType"]:checked')?.value;
    safeGet('productSelectBox').style.display = applyType === 'product' ? '' : 'none';
    safeGet('categorySelectBox').style.display = applyType === 'category' ? '' : 'none';
    updateSummary();
};

// --- Tìm kiếm + Chọn nhiều: SẢN PHẨM ---
const productSearch = safeGet('productSearch');
const productList = safeGet('productList');
const productSearchSuggestions = safeGet('productSearchSuggestions');
const productMultiSelected = safeGet('productMultiSelected');
const btnSelectMulti = safeGet('btnSelectMulti');
const productMultiModal = new bootstrap.Modal(safeGet('productMultiModal'));
const btnProductMultiDone = safeGet('btnProductMultiDone');
const modalProductSearch = safeGet('modalProductSearch');
const modalProductList = safeGet('modalProductList');

function updateSelectedProductList() {
    const checked = Array.from(productList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class="selected-product-list border rounded-3 p-2 bg-white mt-2">`;
        checked.forEach(id => {
            const opt = productList.querySelector(`option[value="${id}"]`);
            const label = document.querySelector(`#productMultiModal label input[value="${id}"]`)?.closest('label');
            let img = '';
            if (label) {
                const imgEl = label.querySelector('img');
                if (imgEl) img = `<img src="${imgEl.src}" style="width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;">`;
            }
            if (opt) {
                html += `
                <label class="d-flex align-items-center mb-1 selected-product-item">
                    <input type="checkbox" class="form-check-input me-2 selected-product-checkbox" checked value="${id}">
                    ${img}<span class="flex-grow-1">${opt.text}</span>
                </label>`;
            }
        });
        html += `</div>`;
    }
    productMultiSelected.innerHTML = html;

    // Gắn sự kiện bỏ chọn
    document.querySelectorAll('.selected-product-checkbox').forEach(cb => {
        cb.addEventListener('change', function () {
            if (!this.checked) {
                const id = this.value;
                productList.querySelector(`option[value="${id}"]`).selected = false;
                updateSelectedProductList();
                updateSummary();
            }
        });
    });
}

// Tìm kiếm ngoài modal
productSearch.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    let found = 0;
    productSearchSuggestions.innerHTML = '';
    Array.from(productList.options).forEach(opt => {
        const match = opt.text.toLowerCase().includes(val);
        if (val && match && found < 8) {
            const div = document.createElement('div');
            div.className = 'list-group-item list-group-item-action d-flex align-items-center py-2';
            const label = document.querySelector(`#productMultiModal label input[value="${opt.value}"]`)?.closest('label');
            let img = '';
            if (label) {
                const imgEl = label.querySelector('img');
                if (imgEl) img = `<img src="${imgEl.src}" style="width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;">`;
            }
            div.innerHTML = `${img}<span>${opt.text}</span>`;
            div.onclick = () => {
                opt.selected = true;
                updateSelectedProductList();
                productSearch.value = '';
                productSearchSuggestions.style.display = 'none';
                updateSummary();
            };
            productSearchSuggestions.appendChild(div);
            found++;
        }
    });
    productSearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
});

// Blur/Focus + Phím
productSearch.addEventListener('blur', () => setTimeout(() => productSearchSuggestions.style.display = 'none', 150));
productSearch.addEventListener('focus', () => { if (productSearchSuggestions.children.length > 0) productSearchSuggestions.style.display = ''; });
productSearch.addEventListener('keydown', function (e) {
    if (productSearchSuggestions.style.display === 'none') return;
    const items = Array.from(productSearchSuggestions.children);
    let idx = items.findIndex(i => i.classList.contains('active'));
    if (e.key === 'ArrowDown') { idx = (idx + 1) % items.length; e.preventDefault(); }
    else if (e.key === 'ArrowUp') { idx = (idx - 1 + items.length) % items.length; e.preventDefault(); }
    else if (e.key === 'Enter' && idx >= 0) { items[idx].click(); e.preventDefault(); return; }
    items.forEach(i => i.classList.remove('active'));
    if (idx >= 0) items[idx].classList.add('active');
});

// Mở modal chọn nhiều
btnSelectMulti.onclick = function () {
    const selected = Array.from(productList.selectedOptions).map(o => o.value);
    document.querySelectorAll('.product-multi-checkbox').forEach(cb => {
        cb.checked = selected.includes(cb.value);
    });
    modalProductSearch.value = '';
    modalProductList.querySelectorAll('.product-list-item').forEach(item => item.style.display = '');
    productMultiModal.show();
};

// Tìm kiếm trong modal
modalProductSearch.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    modalProductList.querySelectorAll('.product-list-item').forEach(item => {
        const name = (item.getAttribute('data-name') || '').toLowerCase();
        item.style.display = name.includes(val) ? '' : 'none';
    });
});

// Áp dụng trong modal
btnProductMultiDone.onclick = function () {
    const checked = Array.from(document.querySelectorAll('.product-multi-checkbox'))
        .filter(cb => cb.checked).map(cb => cb.value);
    Array.from(productList.options).forEach(opt => {
        opt.selected = checked.includes(opt.value);
    });
    updateSelectedProductList();
    updateSummary();
    productMultiModal.hide();
};

// --- Tìm kiếm + Chọn nhiều: DANH MỤC ---
const categorySearchInput = safeGet('categorySearchInput');
const categoryList = safeGet('categoryList');
const categorySearchSuggestions = safeGet('categorySearchSuggestions');
const categoryMultiSelected = safeGet('categoryMultiSelected');
const btnSelectMultiCategory = safeGet('btnSelectMultiCategory');
const categoryMultiModal = new bootstrap.Modal(safeGet('categoryMultiModal'));
const btnCategoryMultiDone = safeGet('btnCategoryMultiDone');
const modalCategorySearch = safeGet('modalCategorySearch');
const modalCategoryList = safeGet('modalCategoryList');

function updateSelectedCategoryList() {
    const checked = Array.from(categoryList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class="selected-category-list border rounded-3 p-2 bg-white mt-2">`;
        checked.forEach(id => {
            const opt = categoryList.querySelector(`option[value="${id}"]`);
            if (opt) {
                html += `
                <label class="d-flex align-items-center mb-1 selected-category-item">
                    <input type="checkbox" class="form-check-input me-2 selected-category-checkbox" checked value="${id}">
                    <span class="flex-grow-1">${opt.text}</span>
                </label>`;
            }
        });
        html += `</div>`;
    }
    categoryMultiSelected.innerHTML = html;

    document.querySelectorAll('.selected-category-checkbox').forEach(cb => {
        cb.addEventListener('change', function () {
            if (!this.checked) {
                const id = this.value;
                categoryList.querySelector(`option[value="${id}"]`).selected = false;
                updateSelectedCategoryList();
                updateSummary();
            }
        });
    });
}

// Tìm kiếm ngoài modal
categorySearchInput.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    let found = 0;
    categorySearchSuggestions.innerHTML = '';
    Array.from(categoryList.options).forEach(opt => {
        const match = opt.text.toLowerCase().includes(val);
        if (val && match && found < 8) {
            const div = document.createElement('div');
            div.className = 'list-group-item list-group-item-action py-2';
            div.textContent = opt.text;
            div.onclick = () => {
                opt.selected = true;
                updateSelectedCategoryList();
                categorySearchInput.value = '';
                categorySearchSuggestions.style.display = 'none';
                updateSummary();
            };
            categorySearchSuggestions.appendChild(div);
            found++;
        }
    });
    categorySearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
});

categorySearchInput.addEventListener('blur', () => setTimeout(() => categorySearchSuggestions.style.display = 'none', 150));
categorySearchInput.addEventListener('focus', () => { if (categorySearchSuggestions.children.length > 0) categorySearchSuggestions.style.display = ''; });
categorySearchInput.addEventListener('keydown', function (e) {
    if (categorySearchSuggestions.style.display === 'none') return;
    const items = Array.from(categorySearchSuggestions.children);
    let idx = items.findIndex(i => i.classList.contains('active'));
    if (e.key === 'ArrowDown') { idx = (idx + 1) % items.length; e.preventDefault(); }
    else if (e.key === 'ArrowUp') { idx = (idx - 1 + items.length) % items.length; e.preventDefault(); }
    else if (e.key === 'Enter' && idx >= 0) { items[idx].click(); e.preventDefault(); return; }
    items.forEach(i => i.classList.remove('active'));
    if (idx >= 0) items[idx].classList.add('active');
});

// Mở modal danh mục
btnSelectMultiCategory.onclick = function () {
    const selected = Array.from(categoryList.selectedOptions).map(o => o.value);
    document.querySelectorAll('.category-multi-checkbox').forEach(cb => {
        cb.checked = selected.includes(cb.value);
    });
    modalCategorySearch.value = '';
    modalCategoryList.querySelectorAll('.category-list-item').forEach(item => item.style.display = '');
    categoryMultiModal.show();
};

modalCategorySearch.addEventListener('input', function () {
    const val = this.value.toLowerCase();
    modalCategoryList.querySelectorAll('.category-list-item').forEach(item => {
        const name = (item.getAttribute('data-name') || '').toLowerCase();
        item.style.display = name.includes(val) ? '' : 'none';
    });
});

btnCategoryMultiDone.onclick = function () {
    const checked = Array.from(document.querySelectorAll('.category-multi-checkbox'))
        .filter(cb => cb.checked).map(cb => cb.value);
    Array.from(categoryList.options).forEach(opt => {
        opt.selected = checked.includes(opt.value);
    });
    updateSelectedCategoryList();
    updateSummary();
    categoryMultiModal.hide();
};

// --- Kiểm tra form đã điền chưa ---
function isFormFilled() {
    const code = safeGet('Code')?.value.trim();
    const value = safeGet('ValueInput')?.value;
    const maxDiscount = safeGet('MaxDiscount')?.value;
    const condType = document.querySelector('input[name="ConditionType"]:checked')?.value;
    const minOrder = safeGet('inputMinOrderValue')?.value;
    const minProduct = safeGet('inputMinProductValue')?.value;
    const minQty = safeGet('inputMinProductQuantity')?.value;
    const limitUsage = safeGet('limitUsageCheckbox')?.checked;
    const usageLimit = safeGet('UsageLimit')?.value;
    const limitPerCustomer = safeGet('LimitPerCustomer')?.checked;
    const allowCombineOrder = safeGet('AllowCombineOrder')?.checked;
    const allowCombineProduct = safeGet('AllowCombineProduct')?.checked;
    const allowCombineShipping = safeGet('AllowCombineShipping')?.checked;
    const start = safeGet('StartDate')?.value;
    const end = safeGet('endDateInput')?.value;
    const noEndDate = safeGet('noEndDate')?.checked;

    // Kiểm tra có sản phẩm hoặc danh mục đã chọn
    const selectedProducts = Array.from(productList.options).filter(opt => opt.selected);
    const selectedCategories = Array.from(categoryList.options).filter(opt => opt.selected);
    const hasProductOrCategory = selectedProducts.length > 0 || selectedCategories.length > 0;

    // Loại trừ các giá trị mặc định: noEndDate, condType === 'None'
    return (
        code ||
        value ||
        maxDiscount ||
        (condType && condType !== 'None') ||
        minOrder || minProduct || minQty ||
        limitUsage || usageLimit ||
        limitPerCustomer ||
        allowCombineOrder || allowCombineProduct || allowCombineShipping ||
        start || (!noEndDate && end) ||
        hasProductOrCategory // Thêm điều kiện kiểm tra sản phẩm/danh mục
    );
}

// --- Cập nhật Tổng quan ---
function updateSummary() {
    const summaryEmpty = safeGet('summaryEmpty');
    const summaryFilled = safeGet('summaryFilled');

    if (!isFormFilled()) {
        if (summaryEmpty) summaryEmpty.style.display = '';
        if (summaryFilled) summaryFilled.style.display = 'none';
        return;
    }

    if (summaryEmpty) summaryEmpty.style.display = 'none';
    if (summaryFilled) summaryFilled.style.display = '';

    // Mã
    const code = safeGet('Code')?.value.trim() || 'Mã khuyến mãi';
    safeGet('summaryCode').innerText = code;

    // Loại
    safeGet('summaryType').innerText = 'Giảm giá sản phẩm';

    // Giá trị khuyến mãi
    const value = safeGet('ValueInput')?.value;
    const isPercent = safeGet('IsPercentHidden')?.value === 'true';
    let valueText = 'Chưa cập nhật';

    if (value && value !== '0') {
        if (isPercent) {
            valueText = `${value}%`;
        } else {
            valueText = `${Number(value).toLocaleString()}đ`;
        }
    } else if (value === '0') {
        valueText = '0đ';
    }
    safeGet('summaryValue').innerText = valueText;

    // Giá trị giảm tối đa
    const maxDiscountInput = safeGet('MaxDiscount')?.value.trim();
    const maxDiscountRow = safeGet('maxDiscountRow');
    const summaryMaxDiscount = safeGet('summaryMaxDiscount');

    if (maxDiscountInput && maxDiscountInput !== '' && maxDiscountInput !== '0') {
        summaryMaxDiscount.innerText = `${Number(maxDiscountInput).toLocaleString()}đ`;
        maxDiscountRow.style.display = '';
    } else {
        summaryMaxDiscount.innerText = 'Chưa cập nhật';
        maxDiscountRow.style.display = 'none';
    }

    // Áp dụng cho
    const applyType = document.querySelector('input[name="ApplyType"]:checked')?.value;
    let applyText = 'Chưa cập nhật';
    if (applyType === 'product') {
        const products = Array.from(safeGet('productList').selectedOptions).map(opt => ({id: opt.value, text: opt.text})).filter(Boolean);
        if (products.length > 0) {
            const displayProducts = products.slice(0, 5).map(p => p.text).join(', ');
            if (products.length > 5) {
                const remaining = products.length - 5;
                applyText = `<br>&nbsp;&nbsp;&nbsp;&nbsp;Sản phẩm: ${displayProducts} và <a href="#" onclick="showApplyDetailModal(event)" style="color:#0d6efd;text-decoration:underline;">${remaining} sản phẩm khác</a>`;
            } else {
                applyText = `<br>&nbsp;&nbsp;&nbsp;&nbsp;Sản phẩm: ${displayProducts}`;
            }
        } else {
            applyText = '<br>&nbsp;&nbsp;&nbsp;&nbsp;Chưa chọn sản phẩm';
        }
    } else if (applyType === 'category') {
        const categories = Array.from(safeGet('categoryList').selectedOptions).map(opt => ({id: opt.value, text: opt.text})).filter(Boolean);
        if (categories.length > 0) {
            const displayCategories = categories.slice(0, 5).map(c => c.text).join(', ');
            if (categories.length > 5) {
                const remaining = categories.length - 5;
                applyText = `<br>&nbsp;&nbsp;&nbsp;&nbsp;Danh mục: ${displayCategories} và <a href="#" onclick="showApplyDetailModal(event)" style="color:#0d6efd;text-decoration:underline;">${remaining} danh mục khác</a>`;
            } else {
                applyText = `<br>&nbsp;&nbsp;&nbsp;&nbsp;Danh mục: ${displayCategories}`;
            }
        } else {
            applyText = '<br>&nbsp;&nbsp;&nbsp;&nbsp;Chưa chọn danh mục';
        }
    }
    safeGet('summaryApply').innerHTML = applyText;

    // Điều kiện áp dụng
    let condText = 'Chưa cập nhật';
    const condType = document.querySelector('input[name="ConditionType"]:checked')?.value;
    if (condType === 'None') {
        condText = 'Không có';
    } else if (condType === 'MinOrderValue') {
        const val = safeGet('inputMinOrderValue')?.value;
        condText = val ? `Đơn hàng từ ${Number(val).toLocaleString()}đ` : 'Chưa nhập giá trị đơn hàng';
    } else if (condType === 'MinProductValue') {
        const val = safeGet('inputMinProductValue')?.value;
        condText = val ? `Sản phẩm khuyến mãi từ ${Number(val).toLocaleString()}đ` : 'Chưa nhập giá trị sản phẩm';
    } else if (condType === 'MinProductQuantity') {
        const val = safeGet('inputMinProductQuantity')?.value;
        condText = val ? `Tối thiểu ${val} sản phẩm` : 'Chưa nhập số lượng';
    }
    safeGet('summaryCondition').innerText = condText;

    // Giới hạn sử dụng
    const limitChecked = safeGet('limitUsageCheckbox')?.checked;
    const usageLimit = safeGet('UsageLimit')?.value;
    const limitPerCustomer = safeGet('LimitPerCustomer')?.checked;
    
    let usageLimitText = 'Chưa cập nhật';
    const limitParts = [];
    
    // Thêm số lần sử dụng
    if (limitChecked && usageLimit) {
        limitParts.push(`${usageLimit} lần sử dụng`);
    } else if (limitChecked) {
        limitParts.push('Có giới hạn');
    }
    
    // Thêm giới hạn mỗi khách hàng
    if (limitPerCustomer) {
        limitParts.push('Mỗi khách hàng chỉ được dùng 1 lần');
    }
    
    if (limitParts.length > 0) {
        usageLimitText = limitParts.join(', ');
    }
    
    safeGet('summaryUsageLimit').innerText = usageLimitText;

    // Kết hợp khuyến mãi
    const combine = [];
    if (safeGet('AllowCombineOrder')?.checked) combine.push('Đơn hàng');
    if (safeGet('AllowCombineProduct')?.checked) combine.push('Sản phẩm');
    if (safeGet('AllowCombineShipping')?.checked) combine.push('Miễn phí ship');
    const combineText = combine.length ? combine.join(', ') : 'Không có';
    safeGet('summaryCombine').innerText = combineText;

    // Thời gian
    let timeText = 'Chưa cập nhật';
    const start = safeGet('StartDate')?.value;
    const end = safeGet('EndDate')?.value;
    const noEndDate = safeGet('noEndDate')?.checked;
    
    if (start) {
        const [date, time] = start.split('T');
        const [y, m, d] = date.split('-');
        timeText = `${d}/${m}/${y} ${time || ''}`;
        
        if (noEndDate) {
            timeText += ' → Không có ngày kết thúc';
        } else if (end) {
            const [dateE, timeE] = end.split('T');
            const [yE, mE, dE] = dateE.split('-');
            timeText += ` → ${dE}/${mE}/${yE} ${timeE || ''}`;
        }
    }
    
    safeGet('summaryTime').innerText = timeText;
}

// --- Cập nhật điều kiện ---
const updateConditionInputs = () => {
    const condType = document.querySelector('input[name="ConditionType"]:checked')?.value;
    safeGet('groupMinOrderValue').style.display = condType === 'MinOrderValue' ? '' : 'none';
    safeGet('groupMinProductValue').style.display = condType === 'MinProductValue' ? '' : 'none';
    safeGet('groupMinProductQuantity').style.display = condType === 'MinProductQuantity' ? '' : 'none';
    updateSummary();
};

// --- Fix placeholder khi focus ---
const setupPlaceholderFix = (input) => {
    input.addEventListener('focus', function () {
        this.dataset.oldPlaceholder = this.placeholder;
        this.placeholder = '';
    });
    input.addEventListener('blur', function () {
        this.placeholder = this.dataset.oldPlaceholder || '';
    });
};

// === KHỞI CHẠY KHI DOM SẴN SÀNG ===
document.addEventListener('DOMContentLoaded', function () {
    const limitUsageCheckbox = safeGet('limitUsageCheckbox');
    const usageLimitInputWrapper = safeGet('usageLimitInputWrapper');
    const btnMoney = safeGet('btnMoney');
    const btnPercent = safeGet('btnPercent');
    const valueBox = safeGet('ValueInput');
    const noEndDate = safeGet('noEndDate');
    const endDateInput = safeGet('endDateInput');

    // 1. Khởi tạo danh sách sản phẩm/danh mục
    updateSelectedProductList();
    updateSelectedCategoryList();

    // 2. Giới hạn sử dụng
    if (limitUsageCheckbox && usageLimitInputWrapper) {
        limitUsageCheckbox.addEventListener('change', function () {
            usageLimitInputWrapper.style.display = this.checked ? '' : 'none';
            updateSummary();
        });
    }

    // 3. Loại giảm giá
    if (btnMoney && btnPercent && valueBox) {
        btnMoney.onclick = () => { setDiscountType(false); };
        btnPercent.onclick = () => { setDiscountType(true); };
        setupPlaceholderFix(valueBox);
    }

    // 4. Áp dụng cho (Sản phẩm / Danh mục)
    document.querySelectorAll('input[name="ApplyType"]').forEach(radio => {
        radio.addEventListener('change', () => { updateApplyType(); });
    });
    updateApplyType();

    // 5. Điều kiện áp dụng
    document.querySelectorAll('input[name="ConditionType"]').forEach(radio => {
        radio.addEventListener('change', () => { updateConditionInputs(); });
    });
    updateConditionInputs();

    // 6. Không có ngày kết thúc
    if (noEndDate && endDateInput) {
        noEndDate.addEventListener('change', function () {
            endDateInput.disabled = this.checked;
            if (this.checked) endDateInput.value = '';
            updateSummary();
        });
        if (noEndDate.checked) endDateInput.disabled = true;
    }

    // 7. Tạo mã ngẫu nhiên
    safeGet('btnRandomCode').onclick = function () {
        const code = randomCode();
        safeGet('Code').value = code;
        safeGet('previewCode').innerText = code;
        updateSummary();
    };

    // 8. Cập nhật khi nhập mã
    safeGet('Code').oninput = function () {
        safeGet('previewCode').innerText = this.value || 'Mã khuyến mãi';
        updateSummary();
    };

    // 9. Theo dõi TẤT CẢ các trường thay đổi
    const watchedSelectors = [
        '#Code', '#ValueInput', '#MaxDiscount',
        '#inputMinOrderValue', '#inputMinProductValue', '#inputMinProductQuantity',
        '#UsageLimit', '#StartDate', '#EndDate', '#noEndDate',
        '#limitUsageCheckbox', '#LimitPerCustomer',
        '#AllowCombineOrder', '#AllowCombineProduct', '#AllowCombineShipping',
        'input[name="ConditionType"]', 'input[name="ApplyType"]'
    ];
    watchedSelectors.forEach(selector => {
        document.querySelectorAll(selector).forEach(el => {
            if (el.type === 'radio' || el.type === 'checkbox') {
                el.addEventListener('change', updateSummary);
            } else {
                el.addEventListener('input', updateSummary);
                el.addEventListener('change', updateSummary);
            }
        });
    });

    // 10. Cập nhật ban đầu
    setDiscountType(true); // Mặc định %
    updateSummary();
});

// --- Hiển thị modal chi tiết Áp dụng cho ---
function showApplyDetailModal(event) {
    event.preventDefault();
    const applyType = document.querySelector('input[name="ApplyType"]:checked')?.value;
    const modalTitle = safeGet('applyDetailModalTitle');
    const modalBody = safeGet('applyDetailModalBody');
    
    let html = '';
    if (applyType === 'product') {
        const products = Array.from(safeGet('productList').selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
        modalTitle.innerText = `Danh sách sản phẩm áp dụng (${products.length})`;
        html = '<div class="list-group list-group-flush">';
        products.forEach((p, index) => {
            const label = document.querySelector(`#productMultiModal label input[value="${p.id}"]`)?.closest('label');
            let img = '/wwwroot/profiles/default.png';
            if (label) {
                const imgEl = label.querySelector('img');
                if (imgEl) img = imgEl.src;
            }
            html += `
                <div class="list-group-item d-flex align-items-center py-2">
                    <span class="me-3 text-muted" style="min-width:30px;">${index + 1}.</span>
                    <img src="${img}" alt="${p.text}" style="width:40px;height:40px;object-fit:cover;border-radius:6px;" class="me-3 border" />
                    <span class="flex-grow-1">${p.text}</span>
                </div>`;
        });
        html += '</div>';
    } else if (applyType === 'category') {
        const categories = Array.from(safeGet('categoryList').selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
        modalTitle.innerText = `Danh sách danh mục áp dụng (${categories.length})`;
        html = '<div class="list-group list-group-flush">';
        categories.forEach((c, index) => {
            html += `
                <div class="list-group-item d-flex align-items-center py-2">
                    <span class="me-3 text-muted" style="min-width:30px;">${index + 1}.</span>
                    <i class="fas fa-folder me-3" style="font-size:1.5rem;color:#ffc107;"></i>
                    <span class="flex-grow-1">${c.text}</span>
                </div>`;
        });
        html += '</div>';
    }
    modalBody.innerHTML = html;
    const modal = new bootstrap.Modal(safeGet('applyDetailModal'));
    modal.show();
}
</script>
<style>
/* Autocomplete dropdown style fix: nền trắng đục, viền rõ, text dễ nhìn */
#productSearchSuggestions, #categorySearchSuggestions {
    background: #fff !important;
    border: 1px solid #bdbdbd !important;
    border-radius: 0 0 8px 8px !important;
    box-shadow: 0 6px 24px rgba(0,0,0,0.16) !important;
    max-height: 260px;
    overflow-y: auto;
    padding: 0;
    color: #222 !important;
    opacity: 1 !important;
}
#productSearchSuggestions .list-group-item,
#categorySearchSuggestions .list-group-item {
    background: #fff !important;
    border: none;
    color: #222 !important;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    font-size: 1.05rem;
}
#productSearchSuggestions .list-group-item.active,
#categorySearchSuggestions .list-group-item.active,
#productSearchSuggestions .list-group-item:hover,
#categorySearchSuggestions .list-group-item:hover {
    background: #e3f0ff !important;
    color: #1976d2 !important;
}
.product-list-item:hover {
    background: #f0f4ff;
    cursor: pointer;
}
.product-list-item span.flex-grow-1 {
    color: #222 !important;
    font-weight: 500;
    font-size: 1.08rem;
    letter-spacing: 0.01em;
}
.selected-product-list {
  margin-top: 8px;
  background: #fff;
}
.selected-product-item {
  padding: 4px 0 4px 2px;
  border-radius: 6px;
  transition: background 0.15s;
}
.selected-product-item:hover {
  background: #f6f6f6;
}
.selected-category-list {
  margin-top: 8px;
  background: #fff;
}
.selected-category-item {
  padding: 4px 0 4px 2px;
  border-radius: 6px;
  transition: background 0.15s;
}
.selected-category-item:hover {
  background: #f6f6f6;
}
.category-list-item:hover {
  background: #f0f4ff;
  cursor: pointer;
}
.category-list-item span.flex-grow-1 {
  color: #222 !important;
  font-weight: 500;
  font-size: 1.08rem;
  letter-spacing: 0.01em;
}
</style>
</div>
</div>
</div>

<style>
    :root {
        --primary-color: #0e7490;
        --secondary-color: #06b6d4;
        --text-dark: #1e293b;
        --text-light: #ffffff;
        --background-light: #f0fdfa;
    }
    
    h2 { 
        font-family: 'Inter', sans-serif; 
        font-size: 1.75rem; 
        font-weight: 600; 
        color: var(--text-dark); 
    }
    
    .container-fluid { 
        padding: 0 !important; 
        margin: 0 !important; 
        width: 100% !important; 
    }
    
    .card { 
        border-radius: 8px; 
        background-color: #ffffff; 
    }
    
    .card-body { 
        padding: 20px; 
    }

    .card-header {
        border-radius: 8px 8px 0 0 !important;
        padding: 12px 20px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }

    .btn-primary, .btn-secondary {
        border-radius: 6px; 
        padding: 8px 16px; 
        font-size: 0.9rem; 
        transition: all 0.2s ease;
    }
    
    .btn-primary { 
        background-color: var(--primary-color); 
        border-color: var(--primary-color); 
    }
    
    .btn-primary:hover { 
        background-color: #0891b2; 
        border-color: #0891b2; 
        transform: translateY(-1px); 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
    }

    .btn-secondary { 
        background-color: #6b7280; 
        border-color: #6b7280; 
    }
    
    .btn-secondary:hover { 
        background-color: #4b5563; 
        transform: translateY(-1px); 
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
        outline: none;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-dark);
        margin-bottom: 6px;
        font-weight: 500;
    }
</style>