@{
    ViewData["Title"] = "Th√™m ph·∫ßn qu√† m·ªõi";
    Layout = "~/Areas/Manager/Views/Shared/_ManagerLayout.cshtml";
    var promotionCodes = ViewBag.PromotionCodes as List<Bloomie.Models.Entities.PromotionCode>;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-plus-circle"></i> Th√™m ph·∫ßn qu√† m·ªõi</h2>
        <a asp-action="ManagePointRewards" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Quay l·∫°i
        </a>
    </div>

    <div class="card shadow">
        <div class="card-body">
            <form asp-action="CreatePointReward" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()

                <div class="row">
                    <!-- C·ªôt tr√°i -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-tag"></i> T√™n ph·∫ßn qu√† <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="name" required 
                                   placeholder="VD: Voucher gi·∫£m 50.000ƒë">
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-align-left"></i> M√¥ t·∫£</label>
                            <textarea class="form-control" name="description" rows="3" 
                                      placeholder="M√¥ t·∫£ chi ti·∫øt v·ªÅ ph·∫ßn qu√†"></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-coins"></i> S·ªë ƒëi·ªÉm c·∫ßn thi·∫øt <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="pointsCost" required min="1" value="100"
                                   placeholder="Nh·∫≠p s·ªë ƒëi·ªÉm">
                            <small class="text-muted">User c·∫ßn bao nhi√™u ƒëi·ªÉm ƒë·ªÉ ƒë·ªïi ph·∫ßn qu√† n√†y</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-list"></i> Lo·∫°i voucher <span class="text-danger">*</span></label>
                            <select class="form-select" id="promotionTypeFilter" required>
                                <option value="">-- Ch·ªçn lo·∫°i voucher --</option>
                                <option value="0">üì¶ Gi·∫£m gi√° ƒë∆°n h√†ng</option>
                                <option value="1">üè∑Ô∏è Gi·∫£m gi√° s·∫£n ph·∫©m</option>
                                <option value="2">üöö Mi·ªÖn ph√≠ v·∫≠n chuy·ªÉn</option>
                                <option value="3">üéÅ Mua X t·∫∑ng Y</option>
                            </select>
                            <small class="text-muted">Ch·ªçn lo·∫°i voucher ƒë·ªÉ l·ªçc danh s√°ch m√£ khuy·∫øn m√£i</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-ticket-alt"></i> Ch·ªçn Promotion Code <span class="text-danger">*</span></label>
                            <select class="form-select" name="promotionCodeId" id="promotionCodeId" required disabled>
                                <option value="">-- Vui l√≤ng ch·ªçn lo·∫°i voucher tr∆∞·ªõc --</option>
                            </select>
                            <small class="text-muted">Ch·ªçn m√£ khuy·∫øn m√£i c·ª• th·ªÉ</small>
                            
                            @if (promotionCodes != null && promotionCodes.Any())
                            {
                                <!-- Hidden data for JavaScript -->
                                <div id="promotionCodesData" style="display: none;">
                                    @foreach (var code in promotionCodes)
                                    {
                                        var typeValue = (int)(code.Promotion?.Type ?? 0);
                                        var displayText = $"{code.Code} - ";
                                        if (code.IsPercent)
                                        {
                                            displayText += $"Gi·∫£m {code.Value}%";
                                        }
                                        else
                                        {
                                            displayText += $"Gi·∫£m {code.Value:N0}‚Ç´";
                                        }
                                        if (code.Promotion != null)
                                        {
                                            displayText += $" ({code.Promotion.Name})";
                                        }
                                        <div class="promo-code-item" 
                                             data-id="@code.Id" 
                                             data-type="@typeValue" 
                                             data-text="@displayText">
                                        </div>
                                    }
                                </div>
                            }
                        </div>
                    </div>

                    <!-- C·ªôt ph·∫£i -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-box"></i> T·ªìn kho</label>
                            <input type="number" class="form-control" name="stock" min="0" 
                                   placeholder="ƒê·ªÉ tr·ªëng = kh√¥ng gi·ªõi h·∫°n">
                            <small class="text-muted">S·ªë l∆∞·ª£ng ph·∫ßn qu√† c√≥ th·ªÉ ƒë·ªïi (ƒë·ªÉ tr·ªëng n·∫øu kh√¥ng gi·ªõi h·∫°n)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-calendar-alt"></i> H·∫°n s·ª≠ d·ª•ng (ng√†y) <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" name="validDays" required min="1" value="30"
                                   placeholder="30">
                            <small class="text-muted">Voucher c√≥ hi·ªáu l·ª±c bao nhi√™u ng√†y sau khi ƒë·ªïi</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label"><i class="fas fa-image"></i> ·∫¢nh ph·∫ßn qu√†</label>
                            <input type="file" class="form-control" name="imageFile" accept="image/*" id="imageInput"
                                   onchange="previewImage(event)">
                            <small class="text-muted">·∫¢nh minh h·ªça cho ph·∫ßn qu√† (jpg, png, gif)</small>
                            
                            <div class="mt-3" id="imagePreview" style="display: none;">
                                <img id="preview" src="" alt="Preview" class="img-thumbnail" 
                                     style="max-width: 100%; max-height: 300px;">
                            </div>
                        </div>
                    </div>
                </div>

                <hr>

                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <span class="text-danger">*</span> <small class="text-muted">Tr∆∞·ªùng b·∫Øt bu·ªôc</small>
                    </div>
                    <div>
                        <a asp-action="ManagePointRewards" class="btn btn-secondary">
                            <i class="fas fa-times"></i> H·ªßy
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> T·∫°o ph·∫ßn qu√†
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="mt-3">
        <div class="alert alert-info">
            <i class="fas fa-lightbulb"></i> <strong>G·ª£i √Ω:</strong>
            <ul class="mb-0 mt-2">
                <li><strong>Voucher:</strong> C·∫ßn ch·ªçn Promotion Code ƒë·ªÉ user c√≥ th·ªÉ s·ª≠ d·ª•ng khi checkout</li>
                <li><strong>ƒêi·ªÉm c·∫ßn thi·∫øt:</strong> N√™n c√¢n ƒë·ªëi v·ªõi gi√° tr·ªã ph·∫ßn qu√† (VD: Voucher 50k = 500 ƒëi·ªÉm)</li>
                <li><strong>T·ªìn kho:</strong> ƒê·ªÉ tr·ªëng n·∫øu mu·ªën kh√¥ng gi·ªõi h·∫°n s·ªë l∆∞·ª£ng ƒë·ªïi</li>
                <li><strong>H·∫°n s·ª≠ d·ª•ng:</strong> Th·ªùi gian voucher c√≥ hi·ªáu l·ª±c sau khi user ƒë·ªïi</li>
            </ul>
        </div>
    </div>
</div>

<script>
    function previewImage(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview').src = e.target.result;
                document.getElementById('imagePreview').style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    // Filter promotion codes based on selected type
    document.getElementById('promotionTypeFilter').addEventListener('change', function() {
        const selectedType = this.value;
        const promotionCodeSelect = document.getElementById('promotionCodeId');
        const promoCodesData = document.querySelectorAll('#promotionCodesData .promo-code-item');
        
        // Clear current options
        promotionCodeSelect.innerHTML = '<option value="">-- Ch·ªçn m√£ khuy·∫øn m√£i --</option>';
        
        if (selectedType === '') {
            promotionCodeSelect.disabled = true;
            promotionCodeSelect.innerHTML = '<option value="">-- Vui l√≤ng ch·ªçn lo·∫°i voucher tr∆∞·ªõc --</option>';
            return;
        }
        
        // Enable and populate options
        promotionCodeSelect.disabled = false;
        let hasOptions = false;
        
        promoCodesData.forEach(function(item) {
            if (item.dataset.type === selectedType) {
                const option = document.createElement('option');
                option.value = item.dataset.id;
                option.textContent = item.dataset.text;
                promotionCodeSelect.appendChild(option);
                hasOptions = true;
            }
        });
        
        if (!hasOptions) {
            promotionCodeSelect.innerHTML = '<option value="">-- Kh√¥ng c√≥ m√£ khuy·∫øn m√£i n√†o cho lo·∫°i n√†y --</option>';
            promotionCodeSelect.disabled = true;
        }
    });
</script>

<style>
    :root {
        --primary-color: #0e7490;
        --secondary-color: #06b6d4;
        --text-dark: #1e293b;
        --text-light: #ffffff;
        --background-light: #f0fdfa;
    }
    
    h2 { 
        font-family: 'Inter', sans-serif; 
        font-size: 1.75rem; 
        font-weight: 600; 
        color: var(--text-dark); 
    }
    
    .container-fluid { 
        padding: 1rem !important; 
        margin: 0 !important; 
        width: 100% !important; 
    }
    
    .card { 
        border-radius: 8px; 
        background-color: #ffffff; 
    }
    
    .card-body { 
        padding: 20px; 
    }

    .btn-primary, .btn-secondary {
        border-radius: 6px; 
        padding: 8px 16px; 
        font-size: 0.9rem; 
        transition: all 0.2s ease;
    }
    
    .btn-primary { 
        background-color: var(--primary-color); 
        border-color: var(--primary-color); 
    }
    
    .btn-primary:hover { 
        background-color: #0891b2; 
        border-color: #0891b2; 
        transform: translateY(-1px); 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
    }

    .btn-secondary { 
        background-color: #6b7280; 
        border-color: #6b7280; 
    }
    
    .btn-secondary:hover { 
        background-color: #4b5563; 
        transform: translateY(-1px); 
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(14, 116, 144, 0.1);
        outline: none;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-dark);
        margin-bottom: 6px;
        font-weight: 500;
    }

    .alert-info {
        border-radius: 8px;
        border-left: 4px solid var(--primary-color);
        background-color: var(--background-light);
        color: #164e63;
    }

    .img-thumbnail {
        border-radius: 8px;
        border: 2px solid #e5e7eb;
    }
</style>
