@model Bloomie.Models.Entities.Order
@{
    ViewData["Title"] = $"Chi ti·∫øt ƒë∆°n h√†ng #{Model.OrderId}";
}

<div class="container-fluid">
    <!-- Alerts -->
    @if (TempData["success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            <i class="fas fa-check-circle me-1"></i> @TempData["success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }
    @if (TempData["error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            <i class="fas fa-exclamation-circle me-1"></i> @TempData["error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Th√¥ng tin ƒë∆°n h√†ng -->
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i> Th√¥ng tin ƒë∆°n h√†ng #@Model.OrderId</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">M√£ ƒë∆°n h√†ng</label>
                            <div class="fw-bold">#@Model.OrderId</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Ng√†y ƒë·∫∑t h√†ng</label>
                            <div class="fw-bold">@Model.OrderDate.ToString("dd/MM/yyyy HH:mm")</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Tr·∫°ng th√°i ƒë∆°n h√†ng</label>
                            <div id="orderStatusBadge">
                                @if (Model.Status == "ƒê√£ x√°c nh·∫≠n")
                                {
                                    <span class="badge bg-success"><i class="fas fa-check"></i> @Model.Status</span>
                                }
                                else if (Model.Status == "ƒêang giao")
                                {
                                    <span class="badge bg-primary"><i class="fas fa-shipping-fast"></i> @Model.Status</span>
                                }
                                else if (Model.Status == "ƒê√£ giao")
                                {
                                    <span class="badge bg-success"><i class="fas fa-truck"></i> @Model.Status</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@Model.Status</span>
                                }
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Tr·∫°ng th√°i thanh to√°n</label>
                            <div id="paymentStatusBadge">
                                @if (Model.PaymentStatus == "Ch·ªù thanh to√°n")
                                {
                                    <span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> @Model.PaymentStatus</span>
                                }
                                else if (Model.PaymentStatus == "ƒê√£ thanh to√°n")
                                {
                                    <span class="badge bg-success"><i class="fas fa-check-circle"></i> @Model.PaymentStatus</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary">@Model.PaymentStatus</span>
                                }
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="text-muted small">Ph∆∞∆°ng th·ª©c thanh to√°n</label>
                            <div>
                                <span class="badge @(Model.PaymentMethod == "COD" ? "bg-warning text-dark" : "bg-info")">
                                    @Model.PaymentMethod
                                </span>
                            </div>
                        </div>
                        <div class="col-md-12 mb-3">
                            <label class="text-muted small">T·ªïng ti·ªÅn</label>
                            <div class="fw-bold text-danger" style="font-size: 1.3rem;">
                                @Model.TotalAmount.ToString("N0")ƒë
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- S·∫£n ph·∫©m -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-box-open me-2"></i> S·∫£n ph·∫©m trong ƒë∆°n h√†ng</h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="bg-light">
                                <tr>
                                    <th>STT</th>
                                    <th>T√™n s·∫£n ph·∫©m</th>
                                    <th class="text-center">S·ªë l∆∞·ª£ng</th>
                                    <th class="text-end">ƒê∆°n gi√°</th>
                                    <th class="text-end">Th√†nh ti·ªÅn</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int index = 1; }
                                @foreach (var detail in Model.OrderDetails)
                                {
                                    <tr>
                                        <td>@index</td>
                                        <td>@detail.Product?.Name</td>
                                        <td class="text-center">@detail.Quantity</td>
                                        <td class="text-end">@detail.UnitPrice.ToString("N0")ƒë</td>
                                        <td class="text-end fw-bold">@((detail.UnitPrice * detail.Quantity).ToString("N0"))ƒë</td>
                                    </tr>
                                    index++;
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tasks me-2"></i> Thao t√°c giao h√†ng</h5>
                </div>
                <div class="card-body">
                    @* B∆∞·ªõc 1: X√°c nh·∫≠n nh·∫≠n hoa (n·∫øu ShipperStatus = Assigned) *@
                    @if (Model.ShipperStatus == "ƒê√£ ph√¢n c√¥ng" && Model.Status == "ƒê√£ x√°c nh·∫≠n")
                    {
                        var assignedTime = Model.AssignedAt ?? DateTime.Now;
                        var deadline = assignedTime.AddMinutes(3);
                        var remainingSeconds = (int)(deadline - DateTime.Now).TotalSeconds;
                        var displayRemaining = remainingSeconds > 0 ? remainingSeconds : 0;
                        
                        <div class="alert alert-warning border-warning">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="fas fa-clock me-2"></i>
                                    <strong>ƒê∆°n h√†ng m·ªõi ƒë∆∞·ª£c ph√¢n c√¥ng!</strong>
                                </div>
                                <div class="fs-4 fw-bold text-danger" id="countdown">
                                    <span id="minutes">--</span>:<span id="seconds">--</span>
                                </div>
                            </div>
                            <hr class="my-2">
                            <small class="text-muted">
                                Vui l√≤ng x√°c nh·∫≠n trong v√≤ng 3 ph√∫t, n·∫øu kh√¥ng ƒë∆°n s·∫Ω ƒë∆∞·ª£c chuy·ªÉn cho shipper kh√°c.
                            </small>
                        </div>
                        
                        <form asp-action="ConfirmPickup" asp-route-id="@Model.Id" method="post" class="mb-3">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-success btn-lg w-100 shadow-sm">
                                <i class="fas fa-check-double me-2"></i> X√°c nh·∫≠n nh·∫≠n ƒë∆°n h√†ng
                            </button>
                        </form>
                        
                        <script>
                            // Countdown timer
                            let remainingSeconds = @displayRemaining;
                            const countdownEl = document.getElementById('countdown');
                            const minutesEl = document.getElementById('minutes');
                            const secondsEl = document.getElementById('seconds');
                            
                            function updateCountdown() {
                                if (remainingSeconds <= 0) {
                                    countdownEl.innerHTML = '<span class="text-danger">H·∫øt th·ªùi gian!</span>';
                                    setTimeout(() => location.reload(), 2000);
                                    return;
                                }
                                
                                const mins = Math.floor(remainingSeconds / 60);
                                const secs = remainingSeconds % 60;
                                minutesEl.textContent = mins.toString().padStart(2, '0');
                                secondsEl.textContent = secs.toString().padStart(2, '0');
                                
                                // ƒê·ªïi m√†u khi c√≤n < 1 ph√∫t
                                if (remainingSeconds < 60) {
                                    countdownEl.classList.add('text-danger');
                                    countdownEl.classList.remove('text-warning');
                                }
                                
                                remainingSeconds--;
                                setTimeout(updateCountdown, 1000);
                            }
                            
                            updateCountdown();
                        </script>
                    }
                    @* B∆∞·ªõc 2: B·∫Øt ƒë·∫ßu giao h√†ng (n·∫øu ƒë√£ Confirmed) *@
                    else if (Model.ShipperStatus == "ƒê√£ x√°c nh·∫≠n" && Model.Status == "ƒê√£ x√°c nh·∫≠n")
                    {
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i> B·∫°n ƒë√£ x√°c nh·∫≠n nh·∫≠n ƒë∆°n. H√£y ƒë·∫øn c·ª≠a h√†ng l·∫•y hoa v√† nh·∫•n n√∫t b√™n d∆∞·ªõi ƒë·ªÉ b·∫Øt ƒë·∫ßu giao h√†ng.
                        </div>
                        <form asp-action="StartDelivery" asp-route-id="@Model.Id" method="post">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-primary btn-lg" onclick="return confirm('B·∫Øt ƒë·∫ßu giao ƒë∆°n h√†ng n√†y?')">
                                <i class="fas fa-truck me-1"></i> B·∫Øt ƒë·∫ßu giao h√†ng
                            </button>
                        </form>
                    }
                    else if (Model.Status == "ƒêang giao")
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-shipping-fast me-1"></i> ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c giao. Vui l√≤ng x√°c nh·∫≠n sau khi giao h√†ng th√†nh c√¥ng.
                        </div>

                        <!-- Form giao h√†ng th√†nh c√¥ng -->
                        <div class="mb-3">
                            <button type="button" class="btn btn-success btn-lg me-2" data-bs-toggle="modal" data-bs-target="#completeModal">
                                <i class="fas fa-check-circle me-1"></i> Giao h√†ng th√†nh c√¥ng
                            </button>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#failModal">
                                <i class="fas fa-times-circle me-1"></i> Giao h√†ng th·∫•t b·∫°i
                            </button>
                        </div>
                    }
                    
                    <a asp-action="Index" class="btn btn-secondary">
                        <i class="fas fa-arrow-left me-1"></i> Quay l·∫°i danh s√°ch
                    </a>
                </div>
            </div>
        </div>

        <!-- Th√¥ng tin giao h√†ng -->
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-map-marker-alt me-2"></i> Th√¥ng tin giao h√†ng</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="text-muted small">Ng∆∞·ªùi nh·∫≠n</label>
                        <div class="fw-bold">@(Model.ReceiverName ?? "Ch∆∞a c√≥ th√¥ng tin")</div>
                    </div>
                    <div class="mb-3">
                        <label class="text-muted small">S·ªë ƒëi·ªán tho·∫°i</label>
                        <div class="fw-bold">
                            <a href="tel:@Model.Phone" class="text-decoration-none">
                                <i class="fas fa-phone text-success me-1"></i>@Model.Phone
                            </a>
                        </div>
                    </div>
                    <div class="mb-0">
                        <label class="text-muted small">ƒê·ªãa ch·ªâ giao h√†ng</label>
                        <div>@Model.ShippingAddress</div>
                        <a href="https://www.google.com/maps/dir/?api=1&destination=@Uri.EscapeDataString(Model.ShippingAddress ?? "")" 
                           target="_blank" class="btn btn-sm btn-outline-primary mt-2">
                            <i class="fas fa-map-marked-alt me-1"></i> Xem b·∫£n ƒë·ªì
                        </a>
                    </div>
                </div>
            </div>

            @if (!string.IsNullOrEmpty(Model.Note))
            {
                <div class="card">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i> Ghi ch√∫</h6>
                    </div>
                    <div class="card-body">
                        <p class="mb-0 small">@Model.Note</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal giao h√†ng th√†nh c√¥ng -->
<div class="modal fade" id="completeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-check-circle me-2"></i> X√°c nh·∫≠n giao h√†ng th√†nh c√¥ng</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="CompleteDelivery" asp-route-id="@Model.Id" method="post" enctype="multipart/form-data">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <!-- Ch·ª•p ·∫£nh giao h√†ng (b·∫Øt bu·ªôc) -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">
                            <i class="fas fa-camera me-1"></i> Ch·ª•p ·∫£nh ch·ª©ng minh giao h√†ng <span class="text-danger">*</span>
                        </label>
                        <input type="file" class="form-control" name="deliveryImage" id="deliveryImage" 
                               accept="image/*" capture="environment" required 
                               onchange="previewImage(event)">
                        <small class="text-muted d-block mt-1">
                            <i class="fas fa-info-circle"></i> Vui l√≤ng ch·ª•p ·∫£nh h√†ng ƒë√£ giao cho kh√°ch h√†ng.
                        </small>
                        
                        <!-- Preview ·∫£nh -->
                        <div id="imagePreview" class="mt-3" style="display: none;">
                            <img id="preview" src="" alt="Preview" class="img-thumbnail" style="max-width: 100%; max-height: 300px;">
                        </div>
                    </div>

                    @if (Model.PaymentMethod == "COD")
                    {
                        <div class="alert alert-warning">
                            <i class="fas fa-money-bill-wave me-1"></i> ƒê∆°n h√†ng thanh to√°n COD
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tr·∫°ng th√°i thu ti·ªÅn <span class="text-danger">*</span></label>
                            <select name="paymentStatus" class="form-select" required>
                                <option value="">-- Ch·ªçn tr·∫°ng th√°i --</option>
                                <option value="ƒê√£ thanh to√°n">ƒê√£ thu ti·ªÅn th√†nh c√¥ng</option>
                                <option value="Ch∆∞a thanh to√°n">Ch∆∞a thu ti·ªÅn (Thu sau)</option>
                            </select>
                        </div>
                    }
                    else
                    {
                        <input type="hidden" name="paymentStatus" value="ƒê√£ thanh to√°n" />
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-1"></i> ƒê∆°n h√†ng ƒë√£ thanh to√°n online.
                        </div>
                    }
                    <p>X√°c nh·∫≠n ƒë∆°n h√†ng <strong>#@Model.OrderId</strong> ƒë√£ ƒë∆∞·ª£c giao th√†nh c√¥ng?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-success">X√°c nh·∫≠n giao th√†nh c√¥ng</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal giao h√†ng th·∫•t b·∫°i -->
<div class="modal fade" id="failModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i> Giao h√†ng th·∫•t b·∫°i</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form asp-action="FailDelivery" asp-route-id="@Model.Id" method="post">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-1"></i> ƒê∆°n h√†ng s·∫Ω quay v·ªÅ tr·∫°ng th√°i "ƒê√£ x√°c nh·∫≠n" ƒë·ªÉ giao l·∫°i.
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">L√Ω do giao h√†ng th·∫•t b·∫°i <span class="text-danger">*</span></label>
                        <select class="form-select mb-2" id="failReasonSelect" onchange="updateFailReason()">
                            <option value="">-- Ch·ªçn l√Ω do --</option>
                            <option value="Kh√°ch kh√¥ng nghe m√°y">Kh√°ch kh√¥ng nghe m√°y</option>
                            <option value="Kh√°ch t·ª´ ch·ªëi nh·∫≠n h√†ng">Kh√°ch t·ª´ ch·ªëi nh·∫≠n h√†ng</option>
                            <option value="ƒê·ªãa ch·ªâ kh√¥ng ch√≠nh x√°c">ƒê·ªãa ch·ªâ kh√¥ng ch√≠nh x√°c</option>
                            <option value="Kh√°ch h·∫πn giao l·∫°i">Kh√°ch h·∫πn giao l·∫°i</option>
                            <option value="Kh√°c">Kh√°c (Nh·∫≠p l√Ω do b√™n d∆∞·ªõi)</option>
                        </select>
                        <textarea class="form-control" name="failReason" id="failReasonText" rows="3" required
                                  placeholder="Nh·∫≠p l√Ω do chi ti·∫øt..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-danger">X√°c nh·∫≠n th·∫•t b·∫°i</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.min.js"></script>
    <script>
        function updateFailReason() {
            const select = document.getElementById('failReasonSelect');
            const textarea = document.getElementById('failReasonText');
            if (select.value && select.value !== 'Kh√°c') {
                textarea.value = select.value;
            } else {
                textarea.value = '';
            }
        }

        function previewImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('preview').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';
                }
                reader.readAsDataURL(file);
            }
        }

        // üîî SignalR - Realtime Order Status Update
        const currentOrderId = @Model.Id;
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/notificationHub")
            .withAutomaticReconnect()
            .build();

        connection.on("ReceiveOrderStatusUpdate", function (orderId, statusInfo) {
            if (orderId !== currentOrderId) return;

            updateOrderStatus(statusInfo.orderStatus, statusInfo.paymentStatus);
        });

        connection.start()
            .then(() => {
                const currentStatus = '@Html.Raw(Model.Status)';
                
                if (currentStatus === 'ƒêang giao') {
                    startLocationTracking();
                }
            })
            .catch(err => console.error('‚ùå SignalR Error:', err));

        // üìç H√†m theo d√µi v√† g·ª≠i v·ªã tr√≠ GPS realtime
        let locationWatchId = null;
        
        function startLocationTracking() {
            if (!navigator.geolocation) {
                updateGPSStatus('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS', 'danger');
                return;
            }

            updateGPSStatus('üîÑ ƒêang y√™u c·∫ßu quy·ªÅn GPS...', 'warning');

            locationWatchId = navigator.geolocation.watchPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    
                    updateGPSStatus(`‚úÖ ƒêang theo d√µi (ƒê·ªô ch√≠nh x√°c: ${Math.round(accuracy)}m)`, 'success');
                    
                    connection.invoke("SendShipperLocation", currentOrderId, lat, lng)
                        .catch(err => console.error('‚ùå Error sending location:', err));
                },
                (error) => {
                    console.error('‚ùå Geolocation error:', error.message);
                    updateGPSStatus('‚ùå L·ªói GPS: ' + error.message, 'danger');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 5000,
                    maximumAge: 0
                }
            );
        }

        function stopLocationTracking() {
            if (locationWatchId !== null) {
                navigator.geolocation.clearWatch(locationWatchId);
                locationWatchId = null;
                updateGPSStatus('üõë ƒê√£ d·ª´ng theo d√µi GPS', 'secondary');
            }
        }

        function updateGPSStatus(message, type) {
            const statusElement = document.getElementById('gpsStatusText');
            const alertBox = document.getElementById('gpsStatus');
            if (statusElement) {
                statusElement.textContent = message;
            }
            if (alertBox) {
                alertBox.className = `alert alert-${type} mb-3`;
            }
        }

        function testGPS() {
            if (!navigator.geolocation) {
                alert('‚ùå Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ GPS');
                return;
            }
            
            updateGPSStatus('üîÑ ƒêang ki·ªÉm tra GPS...', 'warning');
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    const accuracy = position.coords.accuracy;
                    alert(`‚úÖ GPS ho·∫°t ƒë·ªông!\n\nVƒ© ƒë·ªô: ${lat}\nKinh ƒë·ªô: ${lng}\nƒê·ªô ch√≠nh x√°c: ${Math.round(accuracy)}m`);
                    updateGPSStatus(`‚úÖ GPS ho·∫°t ƒë·ªông t·ªët (${Math.round(accuracy)}m)`, 'success');
                },
                (error) => {
                    alert(`‚ùå L·ªói GPS: ${error.message}\n\nH√£y cho ph√©p truy c·∫≠p v·ªã tr√≠ trong c√†i ƒë·∫∑t tr√¨nh duy·ªát.`);
                    updateGPSStatus('‚ùå L·ªói: ' + error.message, 'danger');
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        }

        // H√†m c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng v√† thanh to√°n realtime
        function updateOrderStatus(orderStatus, paymentStatus) {
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng
            const orderStatusElement = document.getElementById('orderStatusBadge');
            if (orderStatusElement && orderStatus) {
                let statusBadgeHtml = '';
                
                if (orderStatus === "ƒê√£ x√°c nh·∫≠n") {
                    statusBadgeHtml = '<span class="badge bg-success"><i class="fas fa-check"></i> ' + orderStatus + '</span>';
                } else if (orderStatus === "ƒêang giao") {
                    statusBadgeHtml = '<span class="badge bg-primary"><i class="fas fa-shipping-fast"></i> ' + orderStatus + '</span>';
                } else if (orderStatus === "ƒê√£ giao") {
                    statusBadgeHtml = '<span class="badge bg-success"><i class="fas fa-truck"></i> ' + orderStatus + '</span>';
                } else if (orderStatus === "Ho√†n th√†nh") {
                    statusBadgeHtml = '<span class="badge bg-success"><i class="fas fa-check-double"></i> ' + orderStatus + '</span>';
                } else if (orderStatus === "ƒê√£ h·ªßy") {
                    statusBadgeHtml = '<span class="badge bg-secondary"><i class="fas fa-ban"></i> ' + orderStatus + '</span>';
                } else {
                    statusBadgeHtml = '<span class="badge bg-secondary">' + orderStatus + '</span>';
                }
                
                orderStatusElement.innerHTML = statusBadgeHtml;
                
                // Hi·ªáu ·ª©ng highlight
                orderStatusElement.style.animation = 'pulse 0.5s ease-in-out';
                setTimeout(() => {
                    orderStatusElement.style.animation = '';
                }, 500);

                // Reload trang n·∫øu ƒë∆°n h√†ng b·ªã h·ªßy
                if (orderStatus === "ƒê√£ h·ªßy") {
                    stopLocationTracking(); // D·ª´ng tracking khi ƒë∆°n b·ªã h·ªßy
                    setTimeout(() => {
                        alert('‚ö†Ô∏è ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy b·ªüi Admin. Trang s·∫Ω t·ª± ƒë·ªông t·∫£i l·∫°i.');
                        location.reload();
                    }, 1000);
                }
                
                // B·∫Øt ƒë·∫ßu tracking n·∫øu chuy·ªÉn sang "ƒêang giao"
                if (orderStatus === "ƒêang giao") {
                    startLocationTracking();
                }
                
                // D·ª´ng tracking n·∫øu ƒë√£ giao ho·∫∑c ho√†n th√†nh
                if (orderStatus === "ƒê√£ giao" || orderStatus === "Ho√†n th√†nh") {
                    stopLocationTracking();
                }
            }

            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n
            const paymentStatusElement = document.getElementById('paymentStatusBadge');
            if (paymentStatusElement && paymentStatus) {
                let paymentBadgeHtml = '';
                
                if (paymentStatus === "Ch·ªù thanh to√°n") {
                    paymentBadgeHtml = '<span class="badge bg-warning text-dark"><i class="fas fa-clock"></i> ' + paymentStatus + '</span>';
                } else if (paymentStatus === "ƒê√£ thanh to√°n") {
                    paymentBadgeHtml = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> ' + paymentStatus + '</span>';
                } else {
                    paymentBadgeHtml = '<span class="badge bg-secondary">' + paymentStatus + '</span>';
                }
                
                paymentStatusElement.innerHTML = paymentBadgeHtml;
                
                // Hi·ªáu ·ª©ng highlight
                paymentStatusElement.style.animation = 'pulse 0.5s ease-in-out';
                setTimeout(() => {
                    paymentStatusElement.style.animation = '';
                }, 500);
            }

            console.log('‚úÖ Shipper view updated - Order status:', orderStatus, '| Payment status:', paymentStatus);
        }
    </script>

    <style>
        @@keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 0 rgba(37, 99, 235, 0.2);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 10px rgba(37, 99, 235, 0.5);
            }
        }
    </style>
}
