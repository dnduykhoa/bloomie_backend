@model Bloomie.Models.ViewModels.PromotionGiftVM
@{
    ViewData["Title"] = "Tạo chương trình mua X tặng Y";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    var products = ViewBag.Products as List<Bloomie.Models.Entities.Product>;
    var categories = ViewBag.Categories as List<Bloomie.Models.Entities.Category>;
}

<div class="container-fluid mt-2 p-0">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-dark">
                    <i class="fas fa-gift text-primary me-2"></i> Thêm mới chương trình mua X tặng Y
                </h2>
            </div>

@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger" role="alert">
        <ul class="mb-0">
            @foreach (var error in ViewData.ModelState.Values.SelectMany(v => v.Errors))
            {
                <li>@error.ErrorMessage</li>
            }
        </ul>
    </div>
}
<div class="row justify-content-center">
    <div class="col-lg-7">
        <form asp-action="CreateGift" method="post" id="promoForm">
            <!-- Card: Mã chương trình -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Mã khuyến mãi</div>
                <div class="card-body row g-2 align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <input asp-for="Code" class="form-control" placeholder="VD: MUA1TANG1" required id="Code" />
                            <button type="button" class="btn btn-outline-secondary" id="btnRandomCode">Tạo mã ngẫu nhiên</button>
                        </div>
                        <span asp-validation-for="Code" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <div class="border rounded p-2 text-center bg-light">
                            <b id="previewCode">Mã khuyến mãi</b>
                            <div class="small text-muted">Chưa có thông tin chi tiết</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Card: Mua X tặng Y -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Mua X tặng Y</div>
                <div class="card-body">
                    <!-- Mua X -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">Mua X (Sản phẩm mua)</label>
                        <div class="form-check mb-1">
                            <input class="form-check-input" type="radio" name="BuyConditionType" id="buyMinQty" value="MinQuantity" checked />
                            <label class="form-check-label" for="buyMinQty">Số lượng sản phẩm tối thiểu</label>
                        </div>
                        <div class="ms-4 mb-2" id="minQtyInputWrapper">
                            <input type="number" class="form-control" id="BuyConditionValue" name="BuyConditionValue" min="1" value="" placeholder="Nhập số lượng" style="max-width:120px; display:inline-block;" />
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" name="BuyConditionType" id="buyMinValue" value="MinValue" />
                            <label class="form-check-label" for="buyMinValue">Giá trị sản phẩm trong đơn tối thiểu</label>
                        </div>
                        <div class="ms-4 mt-2" id="minValueInputWrapper" style="display:none;">
                            <input type="number" class="form-control" id="BuyConditionValueMoney" name="BuyConditionValueMoney" min="1000" step="1000" value="" placeholder="Nhập giá trị (VNĐ)" style="max-width:160px; display:inline-block;" />
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-bold">Áp dụng cho</label>
                        <div class="d-flex align-items-center mb-2">
                            <div class="form-check me-4">
                                <input class="form-check-input" type="radio" name="BuyApplyType" id="buyApplyProduct" value="product" checked />
                                <label class="form-check-label" for="buyApplyProduct">Sản phẩm</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="BuyApplyType" id="buyApplyCategory" value="category" />
                                <label class="form-check-label" for="buyApplyCategory">Danh mục sản phẩm</label>
                            </div>
                        </div>
                        <!-- Sản phẩm -->
                        <div id="buyProductSelectBox" class="mt-2">
                    <!-- Modal chọn nhiều sản phẩm (Mua X) -->
                    <div class="modal fade" id="buyProductMultiModal" tabindex="-1" aria-labelledby="buyProductMultiModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-lg">
                            <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                <div class="modal-header border-0 pb-0">
                                    <h5 class="modal-title fw-bold" id="buyProductMultiModalLabel">Chọn sản phẩm áp dụng</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body pt-2">
                                    <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalBuyProductSearch" placeholder="Tìm kiếm theo tên, mã SKU, Barcode sản phẩm" autocomplete="off" style="background:#f6f6f6;" />
                                    <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalBuyProductList" style="max-height:400px;">
                                        @if (products != null)
                                        {
                                            foreach (var p in products)
                                            {
                                                <label class="list-group-item d-flex align-items-center py-2 px-3 product-list-item" data-name="@p.Name?.ToLower()">
                                                    <input type="checkbox" class="form-check-input me-3 buy-product-multi-checkbox" value="@p.Id" id="multiBuyProduct_@p.Id">
                                                    <img src="@(p.ImageUrl ?? "/wwwroot/profiles/default.png")" alt="@p.Name" style="width:32px;height:32px;object-fit:cover;border-radius:6px;" class="me-3 border" />
                                                    <span class="flex-grow-1">@p.Name</span>
                                                </label>
                                            }
                                        }
                                    </div>
                                </div>
                                <div class="modal-footer border-0 pt-0 justify-content-end">
                                    <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Huỷ</button>
                                    <button type="button" class="btn btn-primary px-4" id="btnBuyProductMultiDone">Áp dụng</button>
                                </div>
                            </div>
                        </div>
                    </div>
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="buyProductSearch" placeholder="Tìm kiếm sản phẩm" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMultiBuy">Chọn nhiều</button>
                                <div id="buyProductSearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="buyProductMultiSelected" class="mb-2"></div>
                            <select class="form-select d-none" name="BuyProductIds" id="buyProductList" multiple>
                                @if (products != null)
                                {
                                    foreach (var p in products)
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                }
                            </select>
                        </div>
                        <!-- Danh mục -->
                        <div id="buyCategorySelectBox" style="display:none;" class="mt-2">
                            <!-- Modal chọn nhiều danh mục (Mua X) -->
                            <div class="modal fade" id="buyCategoryMultiModal" tabindex="-1" aria-labelledby="buyCategoryMultiModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                        <div class="modal-header border-0 pb-0">
                                            <h5 class="modal-title fw-bold" id="buyCategoryMultiModalLabel">Chọn danh mục áp dụng</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body pt-2">
                                            <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalBuyCategorySearch" placeholder="Tìm kiếm danh mục..." autocomplete="off" style="background:#f6f6f6;" />
                                            <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalBuyCategoryList" style="max-height:400px;">
                                                @if (categories != null)
                                                {
                                                    foreach (var c in categories)
                                                    {
                                                        <label class="list-group-item d-flex align-items-center py-2 px-3 category-list-item" data-name="@c.Name?.ToLower()">
                                                            <input type="checkbox" class="form-check-input me-3 category-multi-checkbox" value="@c.Id" id="multiBuyCategory_@c.Id">
                                                            <span class="flex-grow-1">@c.Name</span>
                                                        </label>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Đóng</button>
                                            <button type="button" class="btn btn-primary px-4" id="btnBuyCategoryMultiDone">Xong</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="buyCategorySearchInput" placeholder="Tìm kiếm danh mục" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMultiBuyCategory">Chọn nhiều</button>
                                <div id="buyCategorySearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="buyCategoryMultiSelected" class="mb-2"></div>
                            <select class="form-select d-none" name="BuyCategoryIds" id="buyCategoryList" multiple>
                                @if (categories != null)
                                {
                                    foreach (var c in categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </select>
                            <!-- Modal chọn nhiều danh mục (nếu cần) -->
                        </div>
                    </div>
                    <hr />
                    <!-- Tặng Y -->
                    <div class="mb-3 mt-4">
                        <label class="form-label fw-bold">Tặng Y (Sản phẩm được khuyến mãi)</label>
                        <label class="form-label d-block">Số lượng sản phẩm</label>
                        <input type="number" class="form-control mt-2" id="GiftQuantity" name="GiftQuantity" min="1" value="" placeholder="Nhập số lượng" />
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-bold">Áp dụng cho</label>
                        <div class="d-flex align-items-center mb-2">
                            <div class="form-check me-4">
                                <input class="form-check-input" type="radio" name="GiftApplyType" id="giftApplyProduct" value="product" checked />
                                <label class="form-check-label" for="giftApplyProduct">Sản phẩm</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="GiftApplyType" id="giftApplyCategory" value="category" />
                                <label class="form-check-label" for="giftApplyCategory">Danh mục sản phẩm</label>
                            </div>
                        </div>
                        <!-- Sản phẩm -->
                        <div id="giftProductSelectBox" class="mt-2">
                            <!-- Modal chọn nhiều sản phẩm (Tặng Y) -->
                            <div class="modal fade" id="giftProductMultiModal" tabindex="-1" aria-labelledby="giftProductMultiModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                        <div class="modal-header border-0 pb-0">
                                            <h5 class="modal-title fw-bold" id="giftProductMultiModalLabel">Chọn sản phẩm khuyến mãi</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body pt-2">
                                            <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalGiftProductSearch" placeholder="Tìm kiếm theo tên, mã SKU, Barcode sản phẩm" autocomplete="off" style="background:#f6f6f6;" />
                                            <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalGiftProductList" style="max-height:400px;">
                                                @if (products != null)
                                                {
                                                    foreach (var p in products)
                                                    {
                                                        <label class="list-group-item d-flex align-items-center py-2 px-3 product-list-item" data-name="@p.Name?.ToLower()">
                                                            <input type="checkbox" class="form-check-input me-3 gift-product-multi-checkbox" value="@p.Id" id="multiGiftProduct_@p.Id">
                                                            <img src="@(p.ImageUrl ?? "/wwwroot/profiles/default.png")" alt="@p.Name" style="width:32px;height:32px;object-fit:cover;border-radius:6px;" class="me-3 border" />
                                                            <span class="flex-grow-1">@p.Name</span>
                                                        </label>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Huỷ</button>
                                            <button type="button" class="btn btn-primary px-4" id="btnGiftProductMultiDone">Áp dụng</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="giftProductSearch" placeholder="Tìm kiếm sản phẩm" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMultiGift">Chọn nhiều</button>
                                <div id="giftProductSearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="giftProductMultiSelected" class="mb-2"></div>
                            <select class="form-select d-none" name="GiftProductIds" id="giftProductList" multiple>
                                @if (products != null)
                                {
                                    foreach (var p in products)
                                    {
                                        <option value="@p.Id">@p.Name</option>
                                    }
                                }
                            </select>
                            <!-- Modal chọn nhiều sản phẩm (nếu cần) -->
                        </div>
                        <!-- Danh mục -->
                        <div id="giftCategorySelectBox" style="display:none;" class="mt-2">
                            <!-- Modal chọn nhiều danh mục (Tặng Y) -->
                            <div class="modal fade" id="giftCategoryMultiModal" tabindex="-1" aria-labelledby="giftCategoryMultiModalLabel" aria-hidden="true">
                                <div class="modal-dialog modal-lg">
                                    <div class="modal-content rounded-4 shadow-sm" style="background:#fff;">
                                        <div class="modal-header border-0 pb-0">
                                            <h5 class="modal-title fw-bold" id="giftCategoryMultiModalLabel">Chọn danh mục khuyến mãi</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>
                                        <div class="modal-body pt-2">
                                            <input type="text" class="form-control mb-3 rounded-pill px-3" id="modalGiftCategorySearch" placeholder="Tìm kiếm danh mục..." autocomplete="off" style="background:#f6f6f6;" />
                                            <div class="list-group list-group-flush border rounded-3 overflow-auto" id="modalGiftCategoryList" style="max-height:400px;">
                                                @if (categories != null)
                                                {
                                                    foreach (var c in categories)
                                                    {
                                                        <label class="list-group-item d-flex align-items-center py-2 px-3 category-list-item" data-name="@c.Name?.ToLower()">
                                                            <input type="checkbox" class="form-check-input me-3 category-multi-checkbox" value="@c.Id" id="multiGiftCategory_@c.Id">
                                                            <span class="flex-grow-1">@c.Name</span>
                                                        </label>
                                                    }
                                                }
                                            </div>
                                        </div>
                                        <div class="modal-footer border-0 pt-0 justify-content-end">
                                            <button type="button" class="btn btn-outline-secondary px-4 me-2" data-bs-dismiss="modal">Đóng</button>
                                            <button type="button" class="btn btn-primary px-4" id="btnGiftCategoryMultiDone">Xong</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="input-group mb-2 position-relative">
                                <span class="input-group-text"><i class="fas fa-search"></i></span>
                                <input type="text" class="form-control" id="giftCategorySearchInput" placeholder="Tìm kiếm danh mục" autocomplete="off" />
                                <button type="button" class="btn btn-outline-secondary" id="btnSelectMultiGiftCategory">Chọn nhiều</button>
                                <div id="giftCategorySearchSuggestions" class="list-group position-absolute w-100 shadow-sm" style="z-index:1000; top:100%; left:0; display:none;"></div>
                            </div>
                            <div id="giftCategoryMultiSelected" class="mb-2"></div>
                            <select class="form-select d-none" name="GiftCategoryIds" id="giftCategoryList" multiple>
                                @if (categories != null)
                                {
                                    foreach (var c in categories)
                                    {
                                        <option value="@c.Id">@c.Name</option>
                                    }
                                }
                            </select>
                            <!-- Modal chọn nhiều danh mục (nếu cần) -->
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label fw-bold">Loại giảm giá</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="GiftDiscountType" id="giftDiscountPercent" value="percent" checked />
                            <label class="form-check-label" for="giftDiscountPercent">Phần trăm</label>
                        </div>
                        <div class="input-group mb-2" id="giftDiscountPercentInput">
                            <input type="number" class="form-control" name="GiftDiscountValue" id="GiftDiscountValue" min="0" max="100" value="0" />
                            <span class="input-group-text">%</span>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="GiftDiscountType" id="giftDiscountMoney" value="money" />
                            <label class="form-check-label" for="giftDiscountMoney">Giá trị giảm cho mỗi sản phẩm</label>
                        </div>
                        <div class="input-group mb-2" id="giftDiscountMoneyInput" style="display:none;">
                            <input type="number" class="form-control" name="GiftDiscountMoneyValue" id="GiftDiscountMoneyValue" min="0" value="0" />
                            <span class="input-group-text">đ</span>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="GiftDiscountType" id="giftDiscountFree" value="free" />
                            <label class="form-check-label" for="giftDiscountFree">Miễn phí</label>
                        </div>
                    </div>
                    <div class="form-check mt-3">
                        <input class="form-check-input" type="checkbox" id="LimitPerOrder" name="LimitPerOrder" />
                        <label class="form-check-label" for="LimitPerOrder">Giới hạn số lần áp dụng tối đa trong đơn</label>
                    </div>
                </div>
            </div>
            <!-- Card: Giới hạn sử dụng -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Giới hạn sử dụng</div>
                <div class="card-body">
                    <div class="form-check mb-2">
                        <input type="checkbox" class="form-check-input" id="limitUsageCheckbox" />
                        <label class="form-check-label" for="limitUsageCheckbox">Giới hạn sử dụng</label>
                    </div>
                    <div class="mb-2" id="usageLimitInputWrapper" style="display:none;">
                        <label class="form-label">Số lần sử dụng tối đa</label>
                        <div class="input-group" style="max-width:200px;">
                            <input asp-for="UsageLimit" class="form-control text-center" min="1" />
                            <span class="input-group-text">lần</span>
                        </div>
                        <span asp-validation-for="UsageLimit" class="text-danger"></span>
                    </div>
                    <div class="form-check mb-2">
                        <input asp-for="LimitPerCustomer" class="form-check-input" type="checkbox" id="LimitPerCustomer" />
                        <label class="form-check-label" for="LimitPerCustomer">Mỗi khách hàng chỉ được sử dụng mã giảm giá này 1 lần</label>
                    </div>
                </div>
            </div>
            <!-- Card: Kết hợp khuyến mãi -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Kết hợp khuyến mãi</div>
                <div class="card-body">
                    <div class="form-check">
                        <input asp-for="AllowCombineOrder" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Giảm giá đơn hàng</label>
                    </div>
                    <div class="form-check">
                        <input asp-for="AllowCombineProduct" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Giảm giá sản phẩm</label>
                    </div>
                    <div class="form-check">
                        <input asp-for="AllowCombineShipping" class="form-check-input" type="checkbox" />
                        <label class="form-check-label">Miễn phí vận chuyển</label>
                    </div>
                </div>
            </div>
            <!-- Card: Thời gian -->
            <div class="card mb-3">
                <div class="card-header fw-bold">Thời gian</div>
                <div class="card-body row g-2 align-items-center">
                    <div class="col">
                        <label class="form-label">Ngày bắt đầu</label>
                        <input asp-for="StartDate" class="form-control" type="datetime-local" required />
                    </div>
                    <div class="col">
                        <label class="form-label">Ngày kết thúc</label>
                        <input asp-for="EndDate" class="form-control" type="datetime-local" id="endDateInput" disabled />
                    </div>
                    <div class="col-auto align-self-end">
                        <input type="checkbox" id="noEndDate" class="form-check-input" checked />
                        <label for="noEndDate" class="form-check-label">Không có ngày kết thúc</label>
                    </div>
                </div>
            </div>

            <!-- Card: Công khai -->
            <div class="card mb-3 border-primary">
                <div class="card-header bg-light">
                    <i class="bi bi-globe text-primary me-2"></i>
                    <span class="fw-bold">Công khai - Hiển thị trên trang Vouchers để users tự thu thập</span>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch">
                        <input type="checkbox" name="IsPublic" value="true" class="form-check-input" id="isPublicCheck" role="switch" style="width: 3rem; height: 1.5rem; cursor: pointer;" />
                        <input type="hidden" name="IsPublic" value="false" />
                        <label class="form-check-label ms-2" for="isPublicCheck" style="cursor: pointer;">
                            <span class="fw-semibold">Cho phép hiển thị công khai</span>
                        </label>
                    </div>
                    <div class="alert alert-info mt-3 mb-0" style="border-left: 4px solid #0dcaf0;">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>
                            <strong>Lưu ý:</strong> Nếu chọn, mã này sẽ xuất hiện trên trang Vouchers công khai để users tự lưu vào ví của họ.
                        </small>
                    </div>
                </div>
            </div>
            <div class="d-flex justify-content-between mt-4 pt-3 border-top">
                <a asp-action="CreateTypeSelect" asp-route-tab="code" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i> Quay lại
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i> Tạo mã khuyến mãi
                </button>
            </div>
        </form>
    </div>
    <div class="col-lg-5">
        <div class="card mb-3">
            <div class="card-header fw-bold">Tổng quan khuyến mãi</div>
            <div class="card-body" id="promoSummary">
                <div id="summaryEmpty" style="display:none;">
                    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height:270px;">
                        <!-- Voucher style card with illustration -->
                        <div style="position:relative;width:90%;max-width:320px;background:#fff;border-radius:18px;border:2px dashed #b6b6b6;box-shadow:0 2px 8px #0001;overflow:hidden;">
                            <!-- Top label -->
                            <div style="background:#f5f5f5;border-bottom:1.5px dashed #b6b6b6;padding:10px 0 8px 0;text-align:center;font-weight:600;font-size:1.15rem;letter-spacing:1px;">
                                Mã khuyến mãi
                            </div>
                            <!-- Notch effect -->
                            <div style="position:absolute;left:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="position:absolute;right:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <!-- Main content with illustration -->
                            <div style="padding:24px 0 18px 0;text-align:center;min-height:110px;">
                                <img src="https://cdn-icons-png.flaticon.com/512/4076/4076549.png" alt="voucher empty" style="width:70px;opacity:0.6;" />
                                <div class="text-muted mt-2" style="font-size:1.05rem;">Chưa có thông tin chi tiết</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="summaryFilled" style="display:none;">
                    <div class="d-flex flex-column align-items-center justify-content-center" style="min-height:270px;">
                        <!-- Voucher style card with info -->
                        <div style="position:relative;width:90%;max-width:320px;background:#fff;border-radius:18px;border:2px dashed #b6b6b6;box-shadow:0 2px 8px #0001;overflow:hidden;">
                            <!-- Top label -->
                            <div style="background:#f5f5f5;border-bottom:1.5px dashed #b6b6b6;padding:10px 0 8px 0;text-align:center;font-weight:600;font-size:1.15rem;letter-spacing:1px;">
                                <span id="summaryCode"></span>
                            </div>
                            <!-- Notch effect -->
                            <div style="position:absolute;left:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <div style="position:absolute;right:-12px;top:38px;width:24px;height:24px;background:#fff;border-radius:50%;border:2px dashed #b6b6b6;"></div>
                            <!-- Main content with info -->
                            <div style="padding:18px 18px 12px 18px;text-align:left;min-height:110px;">
                                <ul class="mb-2 ps-2" style="font-size:1.05rem;">
                                    <li><b>Loại:</b> <span id="summaryType"></span></li>
                                    <li><b>Giá trị khuyến mãi:</b> <span id="summaryValue"></span></li>
                                    <li><b>Điều kiện áp dụng:</b> <span id="summaryCondition"></span></li>
                                    <li><b>Giới hạn sử dụng:</b> <span id="summaryUsageLimit">Chưa cập nhật</span></li>
                                    <li><b>Kết hợp khuyến mãi:</b> <span id="summaryCombine"></span></li>
                                    <li><b>Thời gian:</b> <span id="summaryTime"></span></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-warning mt-2 mb-0 p-2" style="font-size:0.95em;">
                    <i class="fas fa-exclamation-triangle me-1"></i> Chương trình chưa được kích hoạt
                </div>
            </div>
        </div>
        <!-- Card Hướng dẫn -->
        <div class="card mb-3">
            <div class="card-header fw-bold bg-info bg-opacity-10">Cách tính chương trình mua X tặng Y</div>
            <div class="card-body" style="font-size:1.04rem;">
                <ul class="mb-2 ps-3">
                    <li><b>Điều kiện mua (X):</b><br>
                        - Khách phải mua đủ <b>số lượng</b> hoặc <b>giá trị tối thiểu</b> các sản phẩm/danh mục bạn chọn.<br>
                        - Hệ thống sẽ kiểm tra tổng số lượng hoặc tổng tiền các sản phẩm thuộc nhóm "Mua X" trong giỏ hàng.<br>
                        - Nếu khách mua vượt nhiều lần điều kiện (ví dụ mua 4 sản phẩm với điều kiện mua 2), số quà tặng sẽ được nhân lên tương ứng (nếu không giới hạn).
                    </li>
                    <li class="mt-2"><b>Quà tặng (Y):</b><br>
                        - Số lượng quà tặng mỗi lần đạt điều kiện sẽ đúng theo cấu hình.<br>
                        - Có 3 kiểu giá trị tặng:
                        <ul>
                            <li><b>Miễn phí</b>: Sản phẩm tặng có giá 0đ.</li>
                            <li><b>Giảm %</b>: Sản phẩm tặng được giảm theo % bạn nhập (ví dụ giảm 50%).</li>
                            <li><b>Giảm số tiền</b>: Sản phẩm tặng được giảm số tiền cố định (ví dụ giảm 20.000đ/sp tặng).</li>
                        </ul>
                        - Nếu khách chọn nhiều sản phẩm/danh mục tặng, hệ thống sẽ tự động áp dụng cho sản phẩm phù hợp trong giỏ hàng.
                    </li>
                    <li class="mt-2"><b>Cách tính tổng quà tặng:</b><br>
                        - Tổng số quà tặng = Số lần đạt điều kiện X × Số lượng Y.<br>
                        - Nếu có giới hạn tổng số lần hoặc mỗi khách, hệ thống sẽ không vượt quá giới hạn này.
                    </li>
                </ul>
                <div class="alert alert-info mt-2 mb-0 p-2" style="font-size:0.98em;">
                    <b>Ví dụ:</b> Nếu cấu hình <b>Mua 2 sản phẩm bất kỳ tặng 1 sản phẩm miễn phí</b>:<br>
                    - Khách mua 2 sản phẩm sẽ được tặng 1 sản phẩm miễn phí.<br>
                    - Khách mua 4 sản phẩm sẽ được tặng 2 sản phẩm miễn phí (nếu không giới hạn).<br>
                    Nếu chọn "Tặng Y giảm 50%" thì sản phẩm tặng sẽ được giảm nửa giá.<br>
                    Nếu chọn "Tặng Y giảm 20.000đ" thì sản phẩm tặng sẽ được giảm đúng số tiền này.
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Chi tiết danh sách sản phẩm/danh mục -->
<div class="modal fade" id="applyDetailModal" tabindex="-1" aria-labelledby="applyDetailModalTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applyDetailModalTitle">Danh sách áp dụng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="applyDetailModalBody" style="max-height:500px;">
                <!-- Danh sách sẽ được load bởi JavaScript -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

<!-- Scripts đồng bộ logic chọn nhiều, tổng quan, toggle, ... -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
console.log('DOMContentLoaded fired!');

function safeGet(id) {
    const element = document.getElementById(id);
    if (!element) console.error(`Element with ID '${id}' not found`);
    return element;
}

// Random code generator
function randomCode(length = 8) {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let result = '';
    for (let i = 0; i < length; i++) {
        result += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return result;
}

// Format datetime-local to dd/mm/yyyy hh:mm
function formatDateTime(datetimeLocal) {
    if (!datetimeLocal) return '';
    // datetimeLocal format: "2025-11-02T10:20"
    const [datePart, timePart] = datetimeLocal.split('T');
    const [year, month, day] = datePart.split('-');
    return `${day}/${month}/${year} ${timePart}`;
}

// Helper functions for getting selected items
function getSelectedBuyProductsText() {
    const buyProductList = safeGet('buyProductList');
    return buyProductList ? Array.from(buyProductList.selectedOptions).map(o => o.text).filter(Boolean) : [];
}

function getSelectedBuyCategoriesText() {
    const buyCategoryList = safeGet('buyCategoryList');
    return buyCategoryList ? Array.from(buyCategoryList.selectedOptions).map(o => o.text).filter(Boolean) : [];
}

function getSelectedGiftProductsText() {
    const giftProductList = safeGet('giftProductList');
    return giftProductList ? Array.from(giftProductList.selectedOptions).map(o => o.text).filter(Boolean) : [];
}

function getSelectedGiftCategoriesText() {
    const giftCategoryList = safeGet('giftCategoryList');
    return giftCategoryList ? Array.from(giftCategoryList.selectedOptions).map(o => o.text).filter(Boolean) : [];
}

// Update summary function
function updateSummary() {
    const summaryEmpty = safeGet('summaryEmpty');
    const summaryFilled = safeGet('summaryFilled');
    const code = (safeGet('Code')?.value || '').trim();
    const buyConditionValue = safeGet('BuyConditionValue')?.value;
    const buyConditionValueMoney = safeGet('BuyConditionValueMoney')?.value;
    const giftQuantity = safeGet('GiftQuantity')?.value;
    const start = safeGet('StartDate')?.value;
    const allowCombineOrder = safeGet('AllowCombineOrder')?.checked;
    const allowCombineProduct = safeGet('AllowCombineProduct')?.checked;
    const allowCombineShipping = safeGet('AllowCombineShipping')?.checked;
    const limitUsageCheckbox = safeGet('limitUsageCheckbox')?.checked;
    const limitPerCustomer = safeGet('LimitPerCustomer')?.checked;
    const limitPerOrder = safeGet('LimitPerOrder')?.checked;

    // Nếu tất cả đều rỗng và không có checkbox nào được chọn thì hiện summaryEmpty
    if (!code && !buyConditionValue && !buyConditionValueMoney && !giftQuantity && !start && !allowCombineOrder && !allowCombineProduct && !allowCombineShipping && !limitUsageCheckbox && !limitPerCustomer && !limitPerOrder) {
        if (summaryEmpty) summaryEmpty.style.display = 'block';
        if (summaryFilled) summaryFilled.style.display = 'none';
        return;
    }

    // Nếu có bất kỳ trường nào được nhập hoặc checkbox được chọn thì hiện summaryFilled
    if (summaryEmpty) summaryEmpty.style.display = 'none';
    if (summaryFilled) summaryFilled.style.display = 'block';

    // Giá trị mặc định nếu chưa chọn
    const buyConditionType = document.querySelector('input[name="BuyConditionType"]:checked')?.value || 'MinQuantity';
    const giftDiscountType = document.querySelector('input[name="GiftDiscountType"]:checked')?.value || 'percent';
    const giftDiscountValue = safeGet('GiftDiscountValue')?.value ?? '0';
    const giftDiscountMoneyValue = safeGet('GiftDiscountMoneyValue')?.value ?? '0';
    const buyApplyType = document.querySelector('input[name="BuyApplyType"]:checked')?.value || 'product';
    const giftApplyType = document.querySelector('input[name="GiftApplyType"]:checked')?.value || 'product';

    // Điều kiện mua
    let buyText = '';
    let buyVal = buyConditionType === 'MinQuantity' ? buyConditionValue : buyConditionValueMoney;
    if (buyConditionType === 'MinQuantity') {
        buyText = buyVal ? `Mua tối thiểu ${buyVal} sản phẩm` : 'Chưa nhập số lượng sản phẩm';
    } else if (buyConditionType === 'MinValue') {
        buyText = buyVal ? `Mua tối thiểu ${Number(buyVal).toLocaleString('vi-VN')}đ giá trị sản phẩm` : 'Chưa nhập giá trị sản phẩm';
    }
    
    // Hiển thị danh sách sản phẩm/danh mục đẹp hơn
    if (buyApplyType === 'product') {
        const products = getSelectedBuyProductsText();
        if (products.length > 0) {
            buyText += '<br>';
            if (products.length <= 3) {
                // Hiển thị tất cả nếu <= 3 sản phẩm
                buyText += '<small style="font-size:0.95rem;">✓ ' + products.join('<br>✓ ') + '</small>';
            } else {
                // Hiển thị 3 sản phẩm đầu + link xem thêm
                buyText += '<small style="font-size:0.95rem;">✓ ' + products.slice(0, 3).join('<br>✓ ') + '<br>✓ và ' + (products.length - 3) + ' sản phẩm khác</small>';
                buyText += ' <a href="#" onclick="showBuyProductModal(event)" style="color:#0d6efd;text-decoration:underline;font-size:0.9rem;">Xem thêm</a>';
            }
        } else {
            buyText += '<br><small class="text-muted">Chưa chọn sản phẩm</small>';
        }
    } else if (buyApplyType === 'category') {
        const categories = getSelectedBuyCategoriesText();
        if (categories.length > 0) {
            buyText += '<br>';
            if (categories.length <= 3) {
                // Hiển thị tất cả nếu <= 3 danh mục
                buyText += '<small style="font-size:0.95rem;">✓ ' + categories.join('<br>✓ ') + '</small>';
            } else {
                // Hiển thị 3 danh mục đầu + link xem thêm
                buyText += '<small style="font-size:0.95rem;">✓ ' + categories.slice(0, 3).join('<br>✓ ') + '<br>✓ và ' + (categories.length - 3) + ' danh mục khác</small>';
                buyText += ' <a href="#" onclick="showBuyCategoryModal(event)" style="color:#0d6efd;text-decoration:underline;font-size:0.9rem;">Xem thêm</a>';
            }
        } else {
            buyText += '<br><small class="text-muted">Chưa chọn danh mục</small>';
        }
    }

    // Giá trị tặng
    let giftText = giftQuantity ? `Tặng ${giftQuantity} sản phẩm` : 'Chưa nhập số lượng sản phẩm tặng';
    if (giftDiscountType === 'percent') {
        giftText += ` (Giảm ${giftDiscountValue || 0}% mỗi sản phẩm tặng)`;
    } else if (giftDiscountType === 'money') {
        giftText += ` (Giảm ${Number(giftDiscountMoneyValue || 0).toLocaleString('vi-VN')}đ mỗi sản phẩm tặng)`;
    } else if (giftDiscountType === 'free') {
        giftText += ` (Miễn phí)`;
    }
    
    // Hiển thị danh sách sản phẩm/danh mục đẹp hơn
    if (giftApplyType === 'product') {
        const products = getSelectedGiftProductsText();
        if (products.length > 0) {
            giftText += '<br>';
            if (products.length <= 3) {
                // Hiển thị tất cả nếu <= 3 sản phẩm
                giftText += '<small style="font-size:0.95rem;">✓ ' + products.join('<br>✓ ') + '</small>';
            } else {
                // Hiển thị 3 sản phẩm đầu + link xem thêm
                giftText += '<small style="font-size:0.95rem;">✓ ' + products.slice(0, 3).join('<br>✓ ') + '<br>✓ và ' + (products.length - 3) + ' sản phẩm khác</small>';
                giftText += ' <a href="#" onclick="showGiftProductModal(event)" style="color:#0d6efd;text-decoration:underline;font-size:0.9rem;">Xem thêm</a>';
            }
        } else {
            giftText += '<br><small class="text-muted">Chưa chọn sản phẩm</small>';
        }
    } else if (giftApplyType === 'category') {
        const categories = getSelectedGiftCategoriesText();
        if (categories.length > 0) {
            giftText += '<br>';
            if (categories.length <= 3) {
                // Hiển thị tất cả nếu <= 3 danh mục
                giftText += '<small style="font-size:0.95rem;">✓ ' + categories.join('<br>✓ ') + '</small>';
            } else {
                // Hiển thị 3 danh mục đầu + link xem thêm
                giftText += '<small style="font-size:0.95rem;">✓ ' + categories.slice(0, 3).join('<br>✓ ') + '<br>✓ và ' + (categories.length - 3) + ' danh mục khác</small>';
                giftText += ' <a href="#" onclick="showGiftCategoryModal(event)" style="color:#0d6efd;text-decoration:underline;font-size:0.9rem;">Xem thêm</a>';
            }
        } else {
            giftText += '<br><small class="text-muted">Chưa chọn danh mục</small>';
        }
    }
    
    // Thêm thông tin giới hạn số lần áp dụng trong đơn (xuống dòng để đẹp hơn)
    if (limitPerOrder) {
        giftText += '<br><small class="text-muted">⚠️ Chỉ áp dụng tối đa 1 lần/đơn</small>';
    }

    // Kết hợp khuyến mãi
    let combineText = [];
    if (allowCombineOrder) combineText.push('Giảm giá đơn hàng');
    if (allowCombineProduct) combineText.push('Giảm giá sản phẩm');
    if (allowCombineShipping) combineText.push('Miễn phí vận chuyển');
    combineText = combineText.length > 0 ? combineText.join(', ') : 'Không có';

    // Giới hạn sử dụng
    const limitChecked = safeGet('limitUsageCheckbox')?.checked;
    const usageLimit = safeGet('UsageLimit')?.value;
    
    let usageLimitText = 'Chưa cập nhật';
    const limitParts = [];
    
    // Thêm số lần sử dụng
    if (limitChecked && usageLimit) {
        limitParts.push(`${usageLimit} lần sử dụng`);
    } else if (limitChecked) {
        limitParts.push('Có giới hạn');
    }
    
    // Thêm giới hạn mỗi khách hàng
    if (limitPerCustomer) {
        limitParts.push('Mỗi khách hàng chỉ được dùng 1 lần');
    }
    
    if (limitParts.length > 0) {
        usageLimitText = limitParts.join(', ');
    }

    // Thời gian
    let timeText = 'Chưa cập nhật';
    const end = safeGet('endDateInput')?.value;
    const noEndDate = safeGet('noEndDate')?.checked;
    
    if (start) {
        const formattedStart = formatDateTime(start);
        if (noEndDate) {
            // Checkbox được chọn: hiển thị "→ Không có ngày kết thúc"
            timeText = `${formattedStart} → Không có ngày kết thúc`;
        } else if (end) {
            // Có ngày kết thúc: hiển thị "→ ngày kết thúc"
            const formattedEnd = formatDateTime(end);
            timeText = `${formattedStart} → ${formattedEnd}`;
        } else {
            // Bỏ checkbox nhưng chưa chọn ngày kết thúc: chỉ hiển thị ngày bắt đầu
            timeText = formattedStart;
        }
    }

    // Cập nhật tổng quan
    if (safeGet('summaryCode')) safeGet('summaryCode').innerText = code || 'Mã khuyến mãi';
    if (safeGet('summaryType')) safeGet('summaryType').innerText = 'Mua X tặng Y';
    if (safeGet('summaryValue')) safeGet('summaryValue').innerHTML = giftText; // Sử dụng innerHTML để hỗ trợ HTML tags
    if (safeGet('summaryCondition')) safeGet('summaryCondition').innerHTML = buyText; // Sử dụng innerHTML để hỗ trợ HTML tags
    if (safeGet('summaryUsageLimit')) safeGet('summaryUsageLimit').innerText = usageLimitText;
    if (safeGet('summaryTime')) safeGet('summaryTime').innerText = timeText;
    if (safeGet('summaryCombine')) safeGet('summaryCombine').innerText = combineText;
}

const btnRandomCode = safeGet('btnRandomCode');
if (btnRandomCode) {
    btnRandomCode.onclick = function() {
        const code = randomCode();
        safeGet('Code').value = code;
        safeGet('previewCode').innerText = code;
        updateSummary();
    };
}
const codeInput = safeGet('Code');
if (codeInput) {
    codeInput.oninput = function() {
        safeGet('previewCode').innerText = this.value || 'Mã chương trình';
        updateSummary();
    };
}

// --- Multi-select and search for Buy Product ---
const buyProductList = safeGet('buyProductList');
const buyProductMultiSelected = safeGet('buyProductMultiSelected');
const btnSelectMultiBuy = safeGet('btnSelectMultiBuy');
const buyProductMultiModal = new bootstrap.Modal(safeGet('buyProductMultiModal') || document.createElement('div'));
const btnBuyProductMultiDone = safeGet('btnBuyProductMultiDone');
const buyProductMultiCheckboxes = () => document.querySelectorAll('.buy-product-multi-checkbox');
const modalBuyProductSearch = safeGet('modalBuyProductSearch');
const modalBuyProductList = safeGet('modalBuyProductList');
function updateSelectedBuyProductList() {
    if (!buyProductList || !buyProductMultiSelected) return;
    const checked = Array.from(buyProductList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class='selected-product-list border rounded-3 p-2 bg-white'>`;
        checked.forEach(id => {
            const opt = Array.from(buyProductList.options).find(o => o.value === id);
            const label = document.querySelector(`label.product-list-item input[value='${id}']`)?.closest('label');
            let img = '';
            if (label) {
                const imgEl = label.querySelector('img');
                if (imgEl) img = `<img src='${imgEl.src}' style='width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;'>`;
            }
            if (opt) {
                html += `<label class='selected-product-item d-flex align-items-center'><input type='checkbox' class='form-check-input me-2 selected-product-checkbox' checked value='${id}'><span>${img}${opt.text}</span></label>`;
            }
        });
        html += `</div>`;
    }
    buyProductMultiSelected.innerHTML = html;
    document.querySelectorAll('.selected-product-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            if (!this.checked) {
                const id = this.value;
                Array.from(buyProductList.options).forEach(opt => { if (opt.value === id) opt.selected = false; });
                updateSelectedBuyProductList();
                updateSummary();
            }
        });
    });
}
if (btnSelectMultiBuy) {
    btnSelectMultiBuy.addEventListener('click', function() {
        const selected = Array.from(buyProductList.selectedOptions).map(o => o.value);
        buyProductMultiCheckboxes().forEach(cb => {
            cb.checked = selected.includes(cb.value);
        });
        modalBuyProductSearch.value = '';
        Array.from(modalBuyProductList.children).forEach(item => item.style.display = '');
        buyProductMultiModal.show();
    });
}
if (modalBuyProductSearch) {
    modalBuyProductSearch.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        Array.from(modalBuyProductList.children).forEach(item => {
            const name = item.getAttribute('data-name') || '';
            item.style.display = name.includes(val) ? '' : 'none';
        });
    });
}
if (btnBuyProductMultiDone) {
    btnBuyProductMultiDone.addEventListener('click', function() {
        const checked = Array.from(buyProductMultiCheckboxes()).filter(cb => cb.checked).map(cb => cb.value);
        Array.from(buyProductList.options).forEach(opt => {
            opt.selected = checked.includes(opt.value);
        });
        updateSelectedBuyProductList();
        updateSummary();
        buyProductMultiModal.hide();
    });
}

// --- Search outside modal for Buy Product ---
const buyProductSearch = safeGet('buyProductSearch');
const buyProductSearchSuggestions = safeGet('buyProductSearchSuggestions');
if (buyProductSearch && buyProductList && buyProductSearchSuggestions) {
    buyProductSearch.addEventListener('input', function(e) {
        const val = this.value.toLowerCase();
        let found = 0;
        buyProductSearchSuggestions.innerHTML = '';
        Array.from(buyProductList.options).forEach(opt => {
            const match = opt.text.toLowerCase().includes(val);
            opt.style.display = match ? '' : 'none';
            if (val && match && found < 8) {
                const div = document.createElement('div');
                div.className = 'list-group-item list-group-item-action d-flex align-items-center';
                const label = document.querySelector(`label.product-list-item input[value='${opt.value}']`)?.closest('label');
                let img = '';
                if (label) {
                    const imgEl = label.querySelector('img');
                    if (imgEl) img = `<img src='${imgEl.src}' style='width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;'>`;
                }
                div.innerHTML = img + `<span>${opt.text}</span>`;
                div.setAttribute('data-value', opt.value);
                div.onclick = function() {
                    opt.selected = true;
                    updateSelectedBuyProductList();
                    buyProductSearch.value = '';
                    buyProductSearchSuggestions.style.display = 'none';
                    updateSummary();
                };
                buyProductSearchSuggestions.appendChild(div);
                found++;
            }
        });
        buyProductSearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
    });
    buyProductSearch.addEventListener('blur', function() {
        setTimeout(() => buyProductSearchSuggestions.style.display = 'none', 150);
    });
    buyProductSearch.addEventListener('focus', function() {
        if (buyProductSearchSuggestions.children.length > 0) buyProductSearchSuggestions.style.display = '';
    });
    buyProductSearch.addEventListener('keydown', function(e) {
        if (buyProductSearchSuggestions.style.display === 'none') return;
        const items = Array.from(buyProductSearchSuggestions.children);
        let idx = items.findIndex(i => i.classList.contains('active'));
        if (e.key === 'ArrowDown') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx + 1) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx - 1 + items.length) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'Enter' && idx >= 0) {
            items[idx].click();
            e.preventDefault();
        }
    });
}

// --- Multi-select and search for Buy Category ---
const buyCategoryList = safeGet('buyCategoryList');
const buyCategoryMultiSelected = safeGet('buyCategoryMultiSelected');
const btnSelectMultiBuyCategory = safeGet('btnSelectMultiBuyCategory');
const buyCategoryMultiModal = new bootstrap.Modal(safeGet('buyCategoryMultiModal') || document.createElement('div'));
const btnBuyCategoryMultiDone = safeGet('btnBuyCategoryMultiDone');
const buyCategoryMultiCheckboxes = () => document.querySelectorAll('#buyCategoryMultiModal .category-multi-checkbox');
const modalBuyCategorySearch = safeGet('modalBuyCategorySearch');
const modalBuyCategoryList = safeGet('modalBuyCategoryList');
function updateSelectedBuyCategoryList() {
    if (!buyCategoryList || !buyCategoryMultiSelected) return;
    const checked = Array.from(buyCategoryList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class='selected-category-list border rounded-3 p-2 bg-white'>`;
        checked.forEach(id => {
            const opt = Array.from(buyCategoryList.options).find(o => o.value === id);
            if (opt) {
                html += `<label class='selected-category-item d-flex align-items-center'><input type='checkbox' class='form-check-input me-2 selected-category-checkbox' checked value='${id}'><span>${opt.text}</span></label>`;
            }
        });
        html += `</div>`;
    }
    buyCategoryMultiSelected.innerHTML = html;
    document.querySelectorAll('.selected-category-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            if (!this.checked) {
                const id = this.value;
                Array.from(buyCategoryList.options).forEach(opt => { if (opt.value === id) opt.selected = false; });
                updateSelectedBuyCategoryList();
                updateSummary();
            }
        });
    });
}
if (btnSelectMultiBuyCategory) {
    btnSelectMultiBuyCategory.addEventListener('click', function() {
        const selected = Array.from(buyCategoryList.selectedOptions).map(o => o.value);
        buyCategoryMultiCheckboxes().forEach(cb => {
            cb.checked = selected.includes(cb.value);
        });
        modalBuyCategorySearch.value = '';
        Array.from(modalBuyCategoryList.children).forEach(item => item.style.display = '');
        buyCategoryMultiModal.show();
    });
}
if (modalBuyCategorySearch) {
    modalBuyCategorySearch.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        Array.from(modalBuyCategoryList.children).forEach(item => {
            const name = item.getAttribute('data-name') || '';
            item.style.display = name.includes(val) ? '' : 'none';
        });
    });
}
if (btnBuyCategoryMultiDone) {
    btnBuyCategoryMultiDone.addEventListener('click', function() {
        const checked = Array.from(buyCategoryMultiCheckboxes()).filter(cb => cb.checked).map(cb => cb.value);
        Array.from(buyCategoryList.options).forEach(opt => {
            opt.selected = checked.includes(opt.value);
        });
        updateSelectedBuyCategoryList();
        updateSummary();
        buyCategoryMultiModal.hide();
    });
}

// --- Search outside modal for Buy Category ---
const buyCategorySearchInput = safeGet('buyCategorySearchInput');
const buyCategorySearchSuggestions = safeGet('buyCategorySearchSuggestions');
if (buyCategorySearchInput && buyCategoryList && buyCategorySearchSuggestions) {
    buyCategorySearchInput.addEventListener('input', function(e) {
        console.log('Input event triggered for buyCategorySearchInput:', this.value);
        const val = this.value.toLowerCase();
        let found = 0;
        buyCategorySearchSuggestions.innerHTML = '';
        console.log('buyCategoryList options:', buyCategoryList.options.length);
        Array.from(buyCategoryList.options).forEach(opt => {
            const match = opt.text.toLowerCase().includes(val);
            console.log('Option:', opt.text, 'Match:', match);
            opt.style.display = match ? '' : 'none';
            if (val && match && found < 8) {
                const div = document.createElement('div');
                div.className = 'list-group-item list-group-item-action';
                div.textContent = opt.text;
                div.setAttribute('data-value', opt.value);
                div.onclick = function() {
                    opt.selected = true;
                    updateSelectedBuyCategoryList();
                    buyCategorySearchInput.value = '';
                    buyCategorySearchSuggestions.style.display = 'none';
                    updateSummary();
                };
                buyCategorySearchSuggestions.appendChild(div);
                found++;
            }
        });
        buyCategorySearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
    });
    buyCategorySearchInput.addEventListener('blur', function() {
        setTimeout(() => buyCategorySearchSuggestions.style.display = 'none', 150);
    });
    buyCategorySearchInput.addEventListener('focus', function() {
        if (buyCategorySearchSuggestions.children.length > 0) buyCategorySearchSuggestions.style.display = '';
    });
    buyCategorySearchInput.addEventListener('keydown', function(e) {
        if (buyCategorySearchSuggestions.style.display === 'none') return;
        const items = Array.from(buyCategorySearchSuggestions.children);
        let idx = items.findIndex(i => i.classList.contains('active'));
        if (e.key === 'ArrowDown') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx + 1) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx - 1 + items.length) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'Enter' && idx >= 0) {
            items[idx].click();
            e.preventDefault();
        }
    });
}

// --- Multi-select and search for Gift Product ---
const giftProductList = safeGet('giftProductList');
const giftProductMultiSelected = safeGet('giftProductMultiSelected');
const btnSelectMultiGift = safeGet('btnSelectMultiGift');
const giftProductMultiModal = new bootstrap.Modal(safeGet('giftProductMultiModal') || document.createElement('div'));
const btnGiftProductMultiDone = safeGet('btnGiftProductMultiDone');
const giftProductMultiCheckboxes = () => document.querySelectorAll('.gift-product-multi-checkbox');
const modalGiftProductSearch = safeGet('modalGiftProductSearch');
const modalGiftProductList = safeGet('modalGiftProductList');
function updateSelectedGiftProductList() {
    if (!giftProductList || !giftProductMultiSelected) return;
    const checked = Array.from(giftProductList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class='selected-product-list border rounded-3 p-2 bg-white'>`;
        checked.forEach(id => {
            const opt = Array.from(giftProductList.options).find(o => o.value === id);
            const label = document.querySelector(`#giftProductMultiModal label.product-list-item input[value='${id}']`)?.closest('label');
            let img = '';
            if (label) {
                const imgEl = label.querySelector('img');
                if (imgEl) img = `<img src='${imgEl.src}' style='width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;'>`;
            }
            if (opt) {
                html += `<label class='selected-product-item d-flex align-items-center'><input type='checkbox' class='form-check-input me-2 selected-gift-product-checkbox' checked value='${id}'><span>${img}${opt.text}</span></label>`;
            }
        });
        html += `</div>`;
    }
    giftProductMultiSelected.innerHTML = html;
    document.querySelectorAll('.selected-gift-product-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            if (!this.checked) {
                const id = this.value;
                Array.from(giftProductList.options).forEach(opt => { if (opt.value === id) opt.selected = false; });
                updateSelectedGiftProductList();
                updateSummary();
            }
        });
    });
}
if (btnSelectMultiGift) {
    btnSelectMultiGift.addEventListener('click', function() {
        const selected = Array.from(giftProductList.selectedOptions).map(o => o.value);
        giftProductMultiCheckboxes().forEach(cb => {
            cb.checked = selected.includes(cb.value);
        });
        modalGiftProductSearch.value = '';
        Array.from(modalGiftProductList.children).forEach(item => item.style.display = '');
        giftProductMultiModal.show();
    });
}
if (modalGiftProductSearch) {
    modalGiftProductSearch.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        Array.from(modalGiftProductList.children).forEach(item => {
            const name = item.getAttribute('data-name') || '';
            item.style.display = name.includes(val) ? '' : 'none';
        });
    });
}
if (btnGiftProductMultiDone) {
    btnGiftProductMultiDone.addEventListener('click', function() {
        const checked = Array.from(giftProductMultiCheckboxes()).filter(cb => cb.checked).map(cb => cb.value);
        Array.from(giftProductList.options).forEach(opt => {
            opt.selected = checked.includes(opt.value);
        });
        updateSelectedGiftProductList();
        updateSummary();
        giftProductMultiModal.hide();
    });
}

// --- Search outside modal for Gift Product ---
const giftProductSearch = safeGet('giftProductSearch');
const giftProductSearchSuggestions = safeGet('giftProductSearchSuggestions');
if (giftProductSearch && giftProductList && giftProductSearchSuggestions) {
    giftProductSearch.addEventListener('input', function(e) {
        const val = this.value.toLowerCase();
        let found = 0;
        giftProductSearchSuggestions.innerHTML = '';
        Array.from(giftProductList.options).forEach(opt => {
            const match = opt.text.toLowerCase().includes(val);
            opt.style.display = match ? '' : 'none';
            if (val && match && found < 8) {
                const div = document.createElement('div');
                div.className = 'list-group-item list-group-item-action d-flex align-items-center';
                const label = document.querySelector(`#giftProductMultiModal label.product-list-item input[value='${opt.value}']`)?.closest('label');
                let img = '';
                if (label) {
                    const imgEl = label.querySelector('img');
                    if (imgEl) img = `<img src='${imgEl.src}' style='width:28px;height:28px;object-fit:cover;border-radius:6px;margin-right:8px;'>`;
                }
                div.innerHTML = img + `<span>${opt.text}</span>`;
                div.setAttribute('data-value', opt.value);
                div.onclick = function() {
                    opt.selected = true;
                    updateSelectedGiftProductList();
                    giftProductSearch.value = '';
                    giftProductSearchSuggestions.style.display = 'none';
                    updateSummary();
                };
                giftProductSearchSuggestions.appendChild(div);
                found++;
            }
        });
        giftProductSearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
    });
    giftProductSearch.addEventListener('blur', function() {
        setTimeout(() => giftProductSearchSuggestions.style.display = 'none', 150);
    });
    giftProductSearch.addEventListener('focus', function() {
        if (giftProductSearchSuggestions.children.length > 0) giftProductSearchSuggestions.style.display = '';
    });
    giftProductSearch.addEventListener('keydown', function(e) {
        if (giftProductSearchSuggestions.style.display === 'none') return;
        const items = Array.from(giftProductSearchSuggestions.children);
        let idx = items.findIndex(i => i.classList.contains('active'));
        if (e.key === 'ArrowDown') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx + 1) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx - 1 + items.length) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'Enter' && idx >= 0) {
            items[idx].click();
            e.preventDefault();
        }
    });
}

// --- Multi-select and search for Gift Category ---
const giftCategoryList = safeGet('giftCategoryList');
const giftCategoryMultiSelected = safeGet('giftCategoryMultiSelected');
const btnSelectMultiGiftCategory = safeGet('btnSelectMultiGiftCategory');
const giftCategoryMultiModal = new bootstrap.Modal(safeGet('giftCategoryMultiModal') || document.createElement('div'));
const btnGiftCategoryMultiDone = safeGet('btnGiftCategoryMultiDone');
const giftCategoryMultiCheckboxes = () => document.querySelectorAll('#giftCategoryMultiModal .category-multi-checkbox');
const modalGiftCategorySearch = safeGet('modalGiftCategorySearch');
const modalGiftCategoryList = safeGet('modalGiftCategoryList');
function updateSelectedGiftCategoryList() {
    if (!giftCategoryList || !giftCategoryMultiSelected) return;
    const checked = Array.from(giftCategoryList.options).filter(opt => opt.selected).map(opt => opt.value);
    let html = '';
    if (checked.length > 0) {
        html += `<div class='selected-category-list border rounded-3 p-2 bg-white'>`;
        checked.forEach(id => {
            const opt = Array.from(giftCategoryList.options).find(o => o.value === id);
            if (opt) {
                html += `<label class='selected-category-item d-flex align-items-center'><input type='checkbox' class='form-check-input me-2 selected-gift-category-checkbox' checked value='${id}'><span>${opt.text}</span></label>`;
            }
        });
        html += `</div>`;
    }
    giftCategoryMultiSelected.innerHTML = html;
    document.querySelectorAll('.selected-gift-category-checkbox').forEach(cb => {
        cb.addEventListener('change', function() {
            if (!this.checked) {
                const id = this.value;
                Array.from(giftCategoryList.options).forEach(opt => { if (opt.value === id) opt.selected = false; });
                updateSelectedGiftCategoryList();
                updateSummary();
            }
        });
    });
}
if (btnSelectMultiGiftCategory) {
    btnSelectMultiGiftCategory.addEventListener('click', function() {
        const selected = Array.from(giftCategoryList.selectedOptions).map(o => o.value);
        giftCategoryMultiCheckboxes().forEach(cb => {
            cb.checked = selected.includes(cb.value);
        });
        modalGiftCategorySearch.value = '';
        Array.from(modalGiftCategoryList.children).forEach(item => item.style.display = '');
        giftCategoryMultiModal.show();
    });
}
if (modalGiftCategorySearch) {
    modalGiftCategorySearch.addEventListener('input', function() {
        const val = this.value.toLowerCase();
        Array.from(modalGiftCategoryList.children).forEach(item => {
            const name = item.getAttribute('data-name') || '';
            item.style.display = name.includes(val) ? '' : 'none';
        });
    });
}
if (btnGiftCategoryMultiDone) {
    btnGiftCategoryMultiDone.addEventListener('click', function() {
        const checked = Array.from(giftCategoryMultiCheckboxes()).filter(cb => cb.checked).map(cb => cb.value);
        Array.from(giftCategoryList.options).forEach(opt => {
            opt.selected = checked.includes(opt.value);
        });
        updateSelectedGiftCategoryList();
        updateSummary();
        giftCategoryMultiModal.hide();
    });
}

// --- Search outside modal for Gift Category ---
const giftCategorySearchInput = safeGet('giftCategorySearchInput');
const giftCategorySearchSuggestions = safeGet('giftCategorySearchSuggestions');
if (giftCategorySearchInput && giftCategoryList && giftCategorySearchSuggestions) {
    giftCategorySearchInput.addEventListener('input', function(e) {
        console.log('Input event triggered for giftCategorySearchInput:', this.value);
        const val = this.value.toLowerCase();
        let found = 0;
        giftCategorySearchSuggestions.innerHTML = '';
        console.log('giftCategoryList options:', giftCategoryList.options.length);
        Array.from(giftCategoryList.options).forEach(opt => {
            const match = opt.text.toLowerCase().includes(val);
            console.log('Option:', opt.text, 'Match:', match);
            opt.style.display = match ? '' : 'none';
            if (val && match && found < 8) {
                const div = document.createElement('div');
                div.className = 'list-group-item list-group-item-action';
                div.textContent = opt.text;
                div.setAttribute('data-value', opt.value);
                div.onclick = function() {
                    opt.selected = true;
                    updateSelectedGiftCategoryList();
                    giftCategorySearchInput.value = '';
                    giftCategorySearchSuggestions.style.display = 'none';
                    updateSummary();
                };
                giftCategorySearchSuggestions.appendChild(div);
                found++;
            }
        });
        giftCategorySearchSuggestions.style.display = (val && found > 0) ? '' : 'none';
    });
    giftCategorySearchInput.addEventListener('blur', function() {
        setTimeout(() => giftCategorySearchSuggestions.style.display = 'none', 150);
    });
    giftCategorySearchInput.addEventListener('focus', function() {
        if (giftCategorySearchSuggestions.children.length > 0) giftCategorySearchSuggestions.style.display = '';
    });
    giftCategorySearchInput.addEventListener('keydown', function(e) {
        if (giftCategorySearchSuggestions.style.display === 'none') return;
        const items = Array.from(giftCategorySearchSuggestions.children);
        let idx = items.findIndex(i => i.classList.contains('active'));
        if (e.key === 'ArrowDown') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx + 1) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'ArrowUp') {
            if (idx >= 0) items[idx].classList.remove('active');
            idx = (idx - 1 + items.length) % items.length;
            items[idx].classList.add('active');
            e.preventDefault();
        } else if (e.key === 'Enter' && idx >= 0) {
            items[idx].click();
            e.preventDefault();
        }
    });
}

// === KHỞI TẠO KHI DOM SẴN SÀNG ===
    updateSelectedBuyProductList();
    updateSelectedBuyCategoryList();
    updateSelectedGiftProductList();
    updateSelectedGiftCategoryList();
    updateSummary();

    // Xử lý toggle input khi chọn radio BuyConditionType
    const minQtyInputWrapper = safeGet('minQtyInputWrapper');
    const minValueInputWrapper = safeGet('minValueInputWrapper');
    document.querySelectorAll('input[name="BuyConditionType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'MinQuantity') {
                if (minQtyInputWrapper) minQtyInputWrapper.style.display = '';
                if (minValueInputWrapper) minValueInputWrapper.style.display = 'none';
            } else if (this.value === 'MinValue') {
                if (minQtyInputWrapper) minQtyInputWrapper.style.display = 'none';
                if (minValueInputWrapper) minValueInputWrapper.style.display = '';
            }
            updateSummary();
        });
    });

    // Cập nhật tổng quan khi nhập giá trị vào BuyConditionValueMoney
    const buyConditionValueMoney = safeGet('BuyConditionValueMoney');
    if (buyConditionValueMoney) {
        buyConditionValueMoney.addEventListener('input', updateSummary);
    }

    // Xử lý các checkbox Kết hợp khuyến mãi
    const combineCheckboxes = [
        safeGet('AllowCombineOrder'),
        safeGet('AllowCombineProduct'),
        safeGet('AllowCombineShipping')
    ].filter(Boolean); // Loại bỏ các phần tử null/undefined
    combineCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', updateSummary);
    });

    // Xử lý checkbox giới hạn sử dụng
    const limitUsageCheckbox = safeGet('limitUsageCheckbox');
    const usageLimitInputWrapper = safeGet('usageLimitInputWrapper');
    if (limitUsageCheckbox && usageLimitInputWrapper) {
        limitUsageCheckbox.addEventListener('change', function() {
            usageLimitInputWrapper.style.display = this.checked ? '' : 'none';
            updateSummary();
        });
    }

    // Xử lý checkbox LimitPerOrder
    const limitPerOrderCheckbox = safeGet('LimitPerOrder');
    if (limitPerOrderCheckbox) {
        limitPerOrderCheckbox.addEventListener('change', updateSummary);
    }

    // Xử lý checkbox LimitPerCustomer
    const limitPerCustomerCheckbox = safeGet('LimitPerCustomer');
    if (limitPerCustomerCheckbox) {
        limitPerCustomerCheckbox.addEventListener('change', updateSummary);
    }

    // Xử lý checkbox noEndDate
    const noEndDateCheckbox = safeGet('noEndDate');
    const endDateInput = safeGet('endDateInput');
    if (noEndDateCheckbox && endDateInput) {
        noEndDateCheckbox.addEventListener('change', function () {
            endDateInput.disabled = this.checked; // Vô hiệu hóa EndDate khi noEndDate được chọn
            if (this.checked) {
                endDateInput.value = ''; // Xóa giá trị EndDate
            }
            updateSummary();
        });
    }

    const promoForm = safeGet('promoForm');
    if (promoForm) {
        promoForm.addEventListener('input', updateSummary);
    }

    if (promoForm) {
        promoForm.addEventListener('change', function(e) {
            if (e.target.name === 'BuyApplyType') {
                const buyProductSelectBox = safeGet('buyProductSelectBox');
                const buyCategorySelectBox = safeGet('buyCategorySelectBox');
                if (e.target.value === 'product') {
                    if (buyProductSelectBox) buyProductSelectBox.style.display = '';
                    if (buyCategorySelectBox) buyCategorySelectBox.style.display = 'none';
                } else {
                    if (buyProductSelectBox) buyProductSelectBox.style.display = 'none';
                    if (buyCategorySelectBox) buyCategorySelectBox.style.display = '';
                }
            }
            if (e.target.name === 'GiftApplyType') {
                const giftProductSelectBox = safeGet('giftProductSelectBox');
                const giftCategorySelectBox = safeGet('giftCategorySelectBox');
                if (e.target.value === 'product') {
                    if (giftProductSelectBox) giftProductSelectBox.style.display = '';
                    if (giftCategorySelectBox) giftCategorySelectBox.style.display = 'none';
                } else {
                    if (giftProductSelectBox) giftProductSelectBox.style.display = 'none';
                    if (giftCategorySelectBox) giftCategorySelectBox.style.display = '';
                }
            }
            updateSummary();
        });
        promoForm.addEventListener('input', updateSummary);
    }

    const giftDiscountPercentInput = safeGet('giftDiscountPercentInput');
    const giftDiscountMoneyInput = safeGet('giftDiscountMoneyInput');
    document.querySelectorAll('input[name="GiftDiscountType"]').forEach(radio => {
        radio.addEventListener('change', function() {
            if (this.value === 'percent') {
                giftDiscountPercentInput.style.display = '';
                giftDiscountMoneyInput.style.display = 'none';
            } else if (this.value === 'money') {
                giftDiscountPercentInput.style.display = 'none';
                giftDiscountMoneyInput.style.display = '';
            } else {
                giftDiscountPercentInput.style.display = 'none';
                giftDiscountMoneyInput.style.display = 'none';
            }
            updateSummary();
        });
    });

    btnBuyProductMultiDone?.addEventListener('click', updateSummary);
    btnBuyCategoryMultiDone?.addEventListener('click', updateSummary);
    btnGiftProductMultiDone?.addEventListener('click', updateSummary);
    btnGiftCategoryMultiDone?.addEventListener('click', updateSummary);
});

// --- Functions to show modal for Buy Products ---
function showBuyProductModal(event) {
    event.preventDefault();
    const buyProductList = document.getElementById('buyProductList');
    const products = Array.from(buyProductList.selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
    
    const modalTitle = document.getElementById('applyDetailModalTitle');
    const modalBody = document.getElementById('applyDetailModalBody');
    
    modalTitle.innerText = `Danh sách sản phẩm mua (${products.length})`;
    
    let html = '<div class="list-group list-group-flush">';
    products.forEach((p, index) => {
        const label = document.querySelector(`#buyProductMultiModal label input[value="${p.id}"]`)?.closest('label');
        let img = '/wwwroot/profiles/default.png';
        if (label) {
            const imgEl = label.querySelector('img');
            if (imgEl) img = imgEl.src;
        }
        html += `
            <div class="list-group-item d-flex align-items-center py-2">
                <img src="${img}" alt="${p.text}" class="me-3 rounded" style="width:50px;height:50px;object-fit:cover;">
                <span class="flex-grow-1">${index + 1}. ${p.text}</span>
            </div>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('applyDetailModal'));
    modal.show();
}

// --- Functions to show modal for Buy Categories ---
function showBuyCategoryModal(event) {
    event.preventDefault();
    const buyCategoryList = document.getElementById('buyCategoryList');
    const categories = Array.from(buyCategoryList.selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
    
    const modalTitle = document.getElementById('applyDetailModalTitle');
    const modalBody = document.getElementById('applyDetailModalBody');
    
    modalTitle.innerText = `Danh sách danh mục mua (${categories.length})`;
    
    let html = '<div class="list-group list-group-flush">';
    categories.forEach((c, index) => {
        html += `
            <div class="list-group-item py-2">
                <span>${index + 1}. ${c.text}</span>
            </div>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('applyDetailModal'));
    modal.show();
}

// --- Functions to show modal for Gift Products ---
function showGiftProductModal(event) {
    event.preventDefault();
    const giftProductList = document.getElementById('giftProductList');
    const products = Array.from(giftProductList.selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
    
    const modalTitle = document.getElementById('applyDetailModalTitle');
    const modalBody = document.getElementById('applyDetailModalBody');
    
    modalTitle.innerText = `Danh sách sản phẩm tặng (${products.length})`;
    
    let html = '<div class="list-group list-group-flush">';
    products.forEach((p, index) => {
        const label = document.querySelector(`#giftProductMultiModal label input[value="${p.id}"]`)?.closest('label');
        let img = '/wwwroot/profiles/default.png';
        if (label) {
            const imgEl = label.querySelector('img');
            if (imgEl) img = imgEl.src;
        }
        html += `
            <div class="list-group-item d-flex align-items-center py-2">
                <img src="${img}" alt="${p.text}" class="me-3 rounded" style="width:50px;height:50px;object-fit:cover;">
                <span class="flex-grow-1">${index + 1}. ${p.text}</span>
            </div>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('applyDetailModal'));
    modal.show();
}

// --- Functions to show modal for Gift Categories ---
function showGiftCategoryModal(event) {
    event.preventDefault();
    const giftCategoryList = document.getElementById('giftCategoryList');
    const categories = Array.from(giftCategoryList.selectedOptions).map(opt => ({id: opt.value, text: opt.text}));
    
    const modalTitle = document.getElementById('applyDetailModalTitle');
    const modalBody = document.getElementById('applyDetailModalBody');
    
    modalTitle.innerText = `Danh sách danh mục tặng (${categories.length})`;
    
    let html = '<div class="list-group list-group-flush">';
    categories.forEach((c, index) => {
        html += `
            <div class="list-group-item py-2">
                <span>${index + 1}. ${c.text}</span>
            </div>
        `;
    });
    html += '</div>';
    modalBody.innerHTML = html;
    
    const modal = new bootstrap.Modal(document.getElementById('applyDetailModal'));
    modal.show();
}
</script>

<style>
#buyProductSearchSuggestions, #buyCategorySearchSuggestions, #giftProductSearchSuggestions, #giftCategorySearchSuggestions {
    background: #ffffff !important;
    border: 1px solid #bdbdbd !important;
    border-radius: 0 0 8px 8px !important;
    box-shadow: 0 6px 24px rgba(0,0,0,0.16) !important;
    max-height: 260px;
    overflow-y: auto;
    padding: 0;
    color: #222222 !important;
    opacity: 1 !important;
    z-index: 1000;
}
#buyProductSearchSuggestions .list-group-item,
#buyCategorySearchSuggestions .list-group-item,
#giftProductSearchSuggestions .list-group-item,
#giftCategorySearchSuggestions .list-group-item {
    background: #ffffff !important;
    border: none;
    color: #222222 !important;
    cursor: pointer;
    transition: background 0.15s, color 0.15s;
    font-size: 1.05rem;
    padding: 8px 12px;
}
#buyProductSearchSuggestions .list-group-item.active,
#buyCategorySearchSuggestions .list-group-item.active,
#giftProductSearchSuggestions .list-group-item.active,
#giftCategorySearchSuggestions .list-group-item.active,
#buyProductSearchSuggestions .list-group-item:hover,
#buyCategorySearchSuggestions .list-group-item:hover,
#giftProductSearchSuggestions .list-group-item:hover,
#giftCategorySearchSuggestions .list-group-item:hover {
    background: #e3f0ff !important;
    color: #1976d2 !important;
}
.product-list-item:hover {
    background: #f0f4ff;
    cursor: pointer;
}
.product-list-item span.flex-grow-1 {
    color: #222222 !important;
    font-weight: 500;
    font-size: 1.08rem;
    letter-spacing: 0.01em;
}
.selected-product-list {
    margin-top: 8px;
    background: #ffffff;
}
.selected-product-item {
    padding: 4px 0 4px 2px;
    border-radius: 6px;
    transition: background 0.15s;
}
.selected-product-item:hover {
    background: #f6f6f6;
}
.selected-category-list {
    margin-top: 8px;
    background: #ffffff;
}
.selected-category-item {
    padding: 4px 0 4px 2px;
    border-radius: 6px;
    transition: background 0.15s;
}
.selected-category-item:hover {
    background: #f6f6f6;
}
.category-list-item:hover {
    background: #f0f4ff;
    cursor: pointer;
}
.category-list-item span.flex-grow-1 {
    color: #222222 !important;
    font-weight: 500;
    font-size: 1.08rem;
    letter-spacing: 0.01em;
}
#endDateInput:disabled {
    opacity: 0.6;
}

/* Modal styling - Fix text color */
#applyDetailModal .modal-body {
    color: #222222 !important;
}
#applyDetailModal .list-group-item {
    background: #ffffff !important;
    color: #222222 !important;
}
#applyDetailModal .list-group-item span {
    color: #222222 !important;
    font-weight: 500;
    font-size: 1.05rem;
}
#applyDetailModal .modal-title {
    color: #222222 !important;
    font-weight: 600;
}
</style>
</div>
</div>
</div>

<style>
    :root {
        --primary-color: #2563eb;
        --secondary-color: #60a5fa;
        --text-dark: #1e293b;
        --text-light: #ffffff;
        --background-light: #f8fafc;
    }
    
    h2 { 
        font-family: 'Inter', sans-serif; 
        font-size: 1.75rem; 
        font-weight: 600; 
        color: var(--text-dark); 
    }
    
    .container-fluid { 
        padding: 0 !important; 
        margin: 0 !important; 
        width: 100% !important; 
    }
    
    .card { 
        border-radius: 8px; 
        background-color: #ffffff; 
    }
    
    .card-body { 
        padding: 20px; 
    }

    .card-header {
        border-radius: 8px 8px 0 0 !important;
        padding: 12px 20px;
        background-color: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }

    .btn-primary, .btn-secondary {
        border-radius: 6px; 
        padding: 8px 16px; 
        font-size: 0.9rem; 
        transition: all 0.2s ease;
    }
    
    .btn-primary { 
        background-color: var(--primary-color); 
        border-color: var(--primary-color); 
    }
    
    .btn-primary:hover { 
        background-color: #1d4ed8; 
        border-color: #1d4ed8; 
        transform: translateY(-1px); 
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
    }

    .btn-secondary { 
        background-color: #6b7280; 
        border-color: #6b7280; 
    }
    
    .btn-secondary:hover { 
        background-color: #4b5563; 
        transform: translateY(-1px); 
    }

    .form-control, .form-select {
        border-radius: 6px;
        border: 1px solid #d1d5db;
        padding: 8px 12px;
        font-size: 0.9rem;
        transition: all 0.2s ease;
    }

    .form-control:focus, .form-select:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        outline: none;
    }

    .form-label {
        font-size: 0.9rem;
        color: var(--text-dark);
        margin-bottom: 6px;
        font-weight: 500;
    }
</style>