@model Bloomie.Models.ViewModels.UserStatisticsViewModel
@{
    ViewData["Title"] = "Th·ªëng K√™ Ng∆∞·ªùi D√πng Chi Ti·∫øt";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-chart-pie"></i> Th·ªëng K√™ Ng∆∞·ªùi D√πng Chi Ti·∫øt</h2>
        <div>
            <a asp-action="Index" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay l·∫°i Dashboard
            </a>
            <button class="btn btn-outline-primary" onclick="exportStatistics()">
                <i class="fas fa-download"></i> Xu·∫•t Excel
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-left-primary shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">
                                T·ªïng ƒêƒÉng K√Ω
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TotalRegistrations</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-user-plus fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-success shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">
                                Email ƒê√£ X√°c Th·ª±c
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.EmailConfirmedUsers</div>
                            <div class="text-xs text-muted">
                                @{
                                    var emailConfirmRate = Model.TotalRegistrations > 0 ? (double)Model.EmailConfirmedUsers / Model.TotalRegistrations * 100 : 0;
                                }
                                (@emailConfirmRate.ToString("F1")% t·ª∑ l·ªá x√°c th·ª±c)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-envelope-check fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-info shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">
                                B·∫≠t 2FA
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">@Model.TwoFactorEnabledUsers</div>
                            <div class="text-xs text-muted">
                                @{
                                    var twoFactorRate = Model.TotalRegistrations > 0 ? (double)Model.TwoFactorEnabledUsers / Model.TotalRegistrations * 100 : 0;
                                }
                                (@twoFactorRate.ToString("F1")% t·ª∑ l·ªá b·∫£o m·∫≠t)
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-shield-alt fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-xl-3 col-md-6">
            <div class="card border-left-warning shadow h-100 py-2">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">
                                TƒÉng Tr∆∞·ªüng Th√°ng
                            </div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">
                                @{
                                    var currentMonth = Model.UserGrowthChart.LastOrDefault();
                                    var previousMonth = Model.UserGrowthChart.Count > 1 ? Model.UserGrowthChart[Model.UserGrowthChart.Count - 2] : null;
                                    var growthRate = 0.0;
                                    if (currentMonth != null && previousMonth != null && previousMonth.NewUsers > 0)
                                    {
                                        growthRate = ((double)(currentMonth.NewUsers - previousMonth.NewUsers) / previousMonth.NewUsers) * 100;
                                    }
                                }
                                @growthRate.ToString("F1")%
                            </div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-chart-line fa-2x text-gray-300"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- User Growth Chart -->
        <div class="col-xl-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Bi·ªÉu ƒê·ªì TƒÉng Tr∆∞·ªüng Ng∆∞·ªùi D√πng (12 th√°ng g·∫ßn nh·∫•t)</h6>
                    <div class="dropdown no-arrow">
                        <a class="dropdown-toggle" href="#" role="button" id="dropdownMenuLink" data-toggle="dropdown">
                            <i class="fas fa-ellipsis-v fa-sm fa-fw text-gray-400"></i>
                        </a>
                        <div class="dropdown-menu dropdown-menu-right shadow">
                            <a class="dropdown-item" href="#" onclick="exportChart('userGrowthChart')">Xu·∫•t bi·ªÉu ƒë·ªì</a>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="chart-area">
                        <canvas id="userGrowthChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Role Distribution Pie Chart -->
        <div class="col-xl-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3 d-flex flex-row align-items-center justify-content-between">
                    <h6 class="m-0 font-weight-bold text-primary">Ph√¢n B·ªë Vai Tr√≤</h6>
                </div>
                <div class="card-body">
                    <div class="chart-pie pt-4 pb-2">
                        <canvas id="roleDistributionChart"></canvas>
                    </div>
                    <div class="mt-4 text-center small">
                        @if (Model.RoleDistribution.Any())
                        {
                            @foreach (var role in Model.RoleDistribution)
                            {
                                <span class="mr-2">
                                    <i class="fas fa-circle" style="color: @GetRoleColor(role.RoleName)"></i> @role.RoleName (@role.Percentage.ToString("F1")%)
                                </span>
                            }
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Active Users Table -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Top Ng∆∞·ªùi D√πng Ho·∫°t ƒê·ªông Nhi·ªÅu Nh·∫•t</h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-bordered" id="topUsersTable" width="100%" cellspacing="0">
                            <thead>
                                <tr>
                                    <th>T√™n ƒêƒÉng Nh·∫≠p</th>
                                    <th>ƒê·ªãa Ch·ªâ Email</th>
                                    <th>S·ªë L·∫ßn ƒêƒÉng Nh·∫≠p</th>
                                    <th>ƒêƒÉng Nh·∫≠p Cu·ªëi</th>
                                    <th>S·ªë Trang ƒê√£ Xem</th>
                                    <th>H√†nh ƒê·ªông</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (Model.TopActiveUsers.Any())
                                {
                                    @foreach (var user in Model.TopActiveUsers)
                                    {
                                        <tr>
                                            <td>@user.UserName</td>
                                            <td>@user.Email</td>
                                            <td>
                                                <span class="badge badge-success">@user.LoginCount</span>
                                            </td>
                                            <td>@user.LastLogin.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>
                                                <span class="badge badge-info">@user.PageViews</span>
                                            </td>
                                            <td>
                                                <a asp-controller="AdminUser" asp-action="Details" asp-route-id="@user.UserName" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-eye"></i> Chi ti·∫øt
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr>
                                        <td colspan="6" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Statistics Cards -->
    <div class="row">
        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Th·ªëng K√™ Theo Th√°ng</h6>
                </div>
                <div class="card-body">
                    @if (Model.UserGrowthChart.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        <th>Th√°ng</th>
                                        <th>Ng∆∞·ªùi D√πng M·ªõi</th>
                                        <th>T·ªïng Ng∆∞·ªùi D√πng</th>
                                        <th>TƒÉng Tr∆∞·ªüng</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = Model.UserGrowthChart.Count - 1; i >= Math.Max(0, Model.UserGrowthChart.Count - 6); i--)
                                    {
                                        var month = Model.UserGrowthChart[i];
                                        var prevMonth = i > 0 ? Model.UserGrowthChart[i - 1] : null;
                                        var growth = prevMonth != null && prevMonth.NewUsers > 0 
                                            ? ((double)(month.NewUsers - prevMonth.NewUsers) / prevMonth.NewUsers) * 100 
                                            : 0;
                                        
                                        <tr>
                                            <td>@month.Month</td>
                                            <td>@month.NewUsers</td>
                                            <td>@month.TotalUsers</td>
                                            <td>
                                                @if (growth > 0)
                                                {
                                                    <span class="text-success">
                                                        <i class="fas fa-arrow-up"></i> @growth.ToString("F1")%
                                                    </span>
                                                }
                                                else if (growth < 0)
                                                {
                                                    <span class="text-danger">
                                                        <i class="fas fa-arrow-down"></i> @Math.Abs(growth).ToString("F1")%
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">0%</span>
                                                }
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <p class="text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu th·ªëng k√™</p>
                    }
                </div>
            </div>
        </div>

        <div class="col-xl-6">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Ph√¢n T√≠ch Nhanh</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-primary">üìà Xu H∆∞·ªõng TƒÉng Tr∆∞·ªüng</h6>
                        <p class="text-sm text-muted">
                            @{
                                var recentGrowth = Model.UserGrowthChart.TakeLast(3).ToList();
                                if (recentGrowth.Count >= 2)
                                {
                                    var avgGrowth = recentGrowth.Skip(1).Select((month, index) => 
                                        recentGrowth[index].NewUsers > 0 ? 
                                        ((double)(month.NewUsers - recentGrowth[index].NewUsers) / recentGrowth[index].NewUsers) * 100 : 0
                                    ).Average();
                                    
                                    if (avgGrowth > 5)
                                    {
                                        <span class="text-success">TƒÉng tr∆∞·ªüng m·∫°nh (@avgGrowth.ToString("F1")% trung b√¨nh)</span>
                                    }
                                    else if (avgGrowth > 0)
                                    {
                                        <span class="text-info">TƒÉng tr∆∞·ªüng ·ªïn ƒë·ªãnh (@avgGrowth.ToString("F1")% trung b√¨nh)</span>
                                    }
                                    else
                                    {
                                        <span class="text-warning">TƒÉng tr∆∞·ªüng ch·∫≠m l·∫°i</span>
                                    }
                                }
                                else
                                {
                                    <span class="text-muted">Ch∆∞a ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ ph√¢n t√≠ch</span>
                                }
                            }
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary">üîí T√¨nh Tr·∫°ng B·∫£o M·∫≠t</h6>
                        <p class="text-sm text-muted">
                            @{
                                var securityScore = 0;
                                if (emailConfirmRate > 80) securityScore += 40;
                                else if (emailConfirmRate > 60) securityScore += 30;
                                else if (emailConfirmRate > 40) securityScore += 20;
                                
                                if (twoFactorRate > 50) securityScore += 40;
                                else if (twoFactorRate > 30) securityScore += 30;
                                else if (twoFactorRate > 10) securityScore += 20;
                                
                                securityScore += 20; // Base score
                            }
                            
                            @if (securityScore >= 80)
                            {
                                <span class="text-success">T·ªët (@securityScore/100 ƒëi·ªÉm)</span>
                            }
                            else if (securityScore >= 60)
                            {
                                <span class="text-warning">Trung b√¨nh (@securityScore/100 ƒëi·ªÉm)</span>
                            }
                            else
                            {
                                <span class="text-danger">C·∫ßn c·∫£i thi·ªán (@securityScore/100 ƒëi·ªÉm)</span>
                            }
                        </p>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-primary">üí° Khuy·∫øn Ngh·ªã</h6>
                        <ul class="text-sm text-muted">
                            @if (emailConfirmRate < 70)
                            {
                                <li>C·∫£i thi·ªán quy tr√¨nh x√°c th·ª±c email</li>
                            }
                            @if (twoFactorRate < 30)
                            {
                                <li>Khuy·∫øn kh√≠ch ng∆∞·ªùi d√πng b·∫≠t x√°c th·ª±c 2 y·∫øu t·ªë</li>
                            }
                            @if (Model.UserGrowthChart.Any() && Model.UserGrowthChart.Last().NewUsers < 10)
                            {
                                <li>TƒÉng c∆∞·ªùng marketing ƒë·ªÉ thu h√∫t ng∆∞·ªùi d√πng m·ªõi</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // User Growth Chart
    const userGrowthCtx = document.getElementById('userGrowthChart').getContext('2d');
    const userGrowthChart = new Chart(userGrowthCtx, {
        type: 'line',
        data: {
            labels: @Html.Raw(Json.Serialize(Model.UserGrowthChart.Select(x => x.Month))),
            datasets: [{
                label: 'Ng∆∞·ªùi D√πng M·ªõi',
                data: @Html.Raw(Json.Serialize(Model.UserGrowthChart.Select(x => x.NewUsers))),
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1
            }, {
                label: 'T·ªïng Ng∆∞·ªùi D√πng',
                data: @Html.Raw(Json.Serialize(Model.UserGrowthChart.Select(x => x.TotalUsers))),
                borderColor: 'rgb(255, 99, 132)',
                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                tension: 0.1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });

    // Role Distribution Chart
    const roleCtx = document.getElementById('roleDistributionChart').getContext('2d');
    const roleChart = new Chart(roleCtx, {
        type: 'doughnut',
        data: {
            labels: @Html.Raw(Json.Serialize(Model.RoleDistribution.Select(x => x.RoleName))),
            datasets: [{
                data: @Html.Raw(Json.Serialize(Model.RoleDistribution.Select(x => x.UserCount))),
                backgroundColor: [
                    '#FF6384',
                    '#36A2EB',
                    '#FFCE56',
                    '#4BC0C0',
                    '#9966FF',
                    '#FF9F40'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false
        }
    });

    // Export functions
    function exportStatistics() {
        // Implementation for exporting statistics to Excel
        alert('T√≠nh nƒÉng xu·∫•t Excel s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai');
    }

    function exportChart(chartId) {
        // Implementation for exporting chart
        alert('T√≠nh nƒÉng xu·∫•t bi·ªÉu ƒë·ªì s·∫Ω ƒë∆∞·ª£c tri·ªÉn khai');
    }
</script>
}

@functions {
    string GetRoleColor(string roleName)
    {
        return roleName switch
        {
            "Admin" => "#FF6384",
            "Staff" => "#36A2EB", 
            "User" => "#FFCE56",
            _ => "#4BC0C0"
        };
    }
}