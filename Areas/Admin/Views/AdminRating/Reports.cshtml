@model List<Bloomie.Models.Entities.Report>

@{
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
    ViewBag.Title = "Báo cáo vi phạm";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var pageSize = ViewBag.PageSize ?? 10;
    var totalItems = ViewBag.TotalItems ?? 0;
}

@Html.AntiForgeryToken()

<div class="container-fluid mt-2 p-0">
    <div class="card shadow-sm border-0">
        <div class="card-body">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="fw-bold text-dark mb-0">
                    <i class="fas fa-flag text-danger me-2"></i> Quản lý Đánh giá & Phản hồi
                </h2>
            </div>

            <!-- Thống kê tổng quan -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4 col-md-6">
            <div class="stat-card stat-card-danger">
                <div class="stat-icon">
                    <i class="fas fa-flag"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Tổng báo cáo</div>
                    <div class="stat-value">@ViewBag.TotalReports</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="stat-card stat-card-warning">
                <div class="stat-icon">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Chờ xử lý</div>
                    <div class="stat-value">@ViewBag.TotalPending</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-6">
            <div class="stat-card stat-card-success">
                <div class="stat-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Đã xử lý</div>
                    <div class="stat-value">@ViewBag.TotalResolved</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Tabs -->
    <ul class="nav nav-tabs mb-4" id="ratingTabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link" asp-action="Index">
                <i class="fas fa-star"></i> Đánh giá
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link active" asp-action="Reports">
                <i class="fas fa-flag"></i> Báo cáo vi phạm
            </a>
        </li>
    </ul>

    <!-- Bộ lọc và tìm kiếm -->
    <div class="filter-section mb-4">
        <form asp-action="Reports" method="get" class="filter-form">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label">Trạng thái</label>
                    <select name="status" class="form-select">
                        <option value="">Tất cả trạng thái</option>
                        <option value="pending" selected="@(ViewBag.Status == "pending")">Chờ xử lý</option>
                        <option value="resolved" selected="@(ViewBag.Status == "resolved")">Đã xử lý</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">Tìm kiếm</label>
                    <input type="text" name="search" class="form-control" placeholder="Người báo cáo, lý do..." value="@ViewBag.Search" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Từ ngày</label>
                    <input type="date" name="fromDate" class="form-control" value="@ViewBag.FromDate" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">Đến ngày</label>
                    <input type="date" name="toDate" class="form-control" value="@ViewBag.ToDate" />
                </div>
                <div class="col-md-2 d-flex align-items-end gap-2">
                    <button type="submit" class="btn btn-primary flex-fill">
                        <i class="fas fa-filter me-1"></i> Lọc
                    </button>
                    <a asp-action="Reports" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-title="Đặt lại">
                        <i class="fas fa-redo"></i>
                    </a>
                </div>
            </div>
        </form>
    </div>

            <!-- Bảng báo cáo -->
            <div class="table-responsive mt-4">
                @if (Model != null && Model.Any())
                {
                    <table class="table table-hover table-bordered mb-0">
                        <thead class="bg-primary text-white">
                            <tr>
                                <th class="col-reporter">Người báo cáo</th>
                                <th class="col-content">Nội dung đánh giá bị báo cáo</th>
                                <th class="col-reason">Lý do báo cáo</th>
                                <th class="col-time">Thời gian</th>
                                <th class="col-status text-center">Trạng thái</th>
                                <th class="col-actions text-center">Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var report in Model)
                            {
                                <tr>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <i class="fas fa-user-circle fs-4 text-primary me-2"></i>
                                            <div>
                                                <div class="fw-bold">@report.Reporter?.FullName</div>
                                                <small class="text-muted">@report.Reporter?.Email</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <div class="mb-2">
                                                <strong>Sản phẩm:</strong> 
                                                <span class="text-primary">@report.Rating?.Product?.Name</span>
                                            </div>
                                            <div class="mb-2">
                                                <strong>Người đánh giá:</strong> 
                                                @report.Rating?.User?.FullName
                                            </div>
                                            <div class="mb-2">
                                                <strong>Số sao:</strong>
                                                @for (int i = 1; i <= 5; i++)
                                                {
                                                    <i class="fas fa-star @(i <= (report.Rating?.Star ?? 0) ? "text-warning" : "text-muted")"></i>
                                                }
                                            </div>
                                            <div>
                                                <strong>Nội dung:</strong>
                                                <p class="mb-0 text-muted" style="max-width: 400px; overflow: hidden; text-overflow: ellipsis;">
                                                    @report.Rating?.Comment
                                                </p>
                                            </div>
                                            @if (report.Rating?.Replies != null && report.Rating.Replies.Any())
                                            {
                                                <div class="mt-2">
                                                    <span class="badge bg-info">
                                                        <i class="fas fa-reply"></i> Có @report.Rating.Replies.Count phản hồi
                                                    </span>
                                                </div>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="alert alert-warning mb-0" style="font-size: 0.9rem;">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            @report.Reason
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-muted small">
                                            <i class="far fa-clock me-1"></i>
                                            @report.ReportDate.ToString("dd/MM/yyyy HH:mm")
                                        </div>
                                        @if (report.IsResolved && report.ResolvedDate.HasValue)
                                        {
                                            <div class="text-success small mt-1">
                                                <i class="fas fa-check me-1"></i>
                                                Xử lý: @report.ResolvedDate.Value.ToString("dd/MM/yyyy HH:mm")
                                            </div>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (report.IsResolved)
                                        {
                                            <span class="badge bg-success">
                                                <i class="fas fa-check-circle"></i> Đã xử lý
                                            </span>
                                            @if (!string.IsNullOrEmpty(report.ResolvedBy))
                                            {
                                                <div class="small text-muted mt-1">
                                                    Bởi: @report.ResolvedBy
                                                </div>
                                            }
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning text-dark">
                                                <i class="fas fa-clock"></i> Chờ xử lý
                                            </span>
                                        }
                                    </td>
                                    <td class="text-center">
                                        @if (!report.IsResolved)
                                        {
                                            <div class="btn-group-vertical" role="group">
                                                <button type="button" class="btn btn-success btn-sm mb-1 resolve-report" 
                                                        data-report-id="@report.Id" data-approve="true">
                                                    <i class="fas fa-check"></i> Chấp nhận & Ẩn đánh giá
                                                </button>
                                                <button type="button" class="btn btn-secondary btn-sm reject-report" 
                                                        data-report-id="@report.Id" data-approve="false">
                                                    <i class="fas fa-times"></i> Từ chối
                                                </button>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-muted">
                                                <i class="fas fa-check-circle"></i> Đã xử lý
                                            </span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <div class="text-center py-5">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Không có báo cáo vi phạm nào.</p>
                    </div>
                }
            </div>

            @if (totalItems > pageSize)
            {
                <div class="pagination-section mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="pagination-info">
                            Hiển thị @((currentPage - 1) * pageSize + 1) - @Math.Min(currentPage * pageSize, totalItems) trong tổng số @totalItems báo cáo
                        </div>
                        <ul class="pagination mb-0">
                            @if (currentPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Reports" asp-route-page="@(currentPage - 1)" 
                                       asp-route-status="@ViewBag.Status" 
                                       asp-route-search="@ViewBag.Search"
                                       asp-route-fromDate="@ViewBag.FromDate"
                                       asp-route-toDate="@ViewBag.ToDate">Trước</a>
                                </li>
                            }

                            @for (int i = Math.Max(1, currentPage - 2); i <= Math.Min(currentPage + 2, (int)Math.Ceiling((double)totalItems / pageSize)); i++)
                            {
                                <li class="page-item @(i == currentPage ? "active" : "")">
                                    <a class="page-link" asp-action="Reports" asp-route-page="@i" 
                                       asp-route-status="@ViewBag.Status" 
                                       asp-route-search="@ViewBag.Search"
                                       asp-route-fromDate="@ViewBag.FromDate"
                                       asp-route-toDate="@ViewBag.ToDate">@i</a>
                                </li>
                            }

                            @if (currentPage < Math.Ceiling((double)totalItems / pageSize))
                            {
                                <li class="page-item">
                                    <a class="page-link" asp-action="Reports" asp-route-page="@(currentPage + 1)" 
                                       asp-route-status="@ViewBag.Status" 
                                       asp-route-search="@ViewBag.Search"
                                       asp-route-fromDate="@ViewBag.FromDate"
                                       asp-route-toDate="@ViewBag.ToDate">Tiếp</a>
                                </li>
                            }
                        </ul>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Initialize tooltips
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl));
        });

        // Xử lý chấp nhận/từ chối báo cáo
        document.querySelectorAll('.resolve-report, .reject-report').forEach(button => {
            button.addEventListener('click', function () {
                const reportId = this.getAttribute('data-report-id');
                const isApproved = this.getAttribute('data-approve') === 'true';
                const actionButton = this;

                const message = isApproved
                    ? 'Bạn có chắc chắn muốn chấp nhận báo cáo này và ẩn đánh giá không?'
                    : 'Bạn có chắc chắn muốn từ chối báo cáo này không?';

                if (!confirm(message)) {
                    return;
                }

                actionButton.disabled = true;
                actionButton.textContent = 'Đang xử lý...';

                const formData = new FormData();
                formData.append('reportId', reportId);
                formData.append('isApproved', isApproved);
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                fetch(`/Admin/AdminRating/ResolveReport`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        alert(data.message);
                        location.reload();
                    } else {
                        alert(data.message || 'Có lỗi xảy ra');
                        actionButton.disabled = false;
                        actionButton.innerHTML = isApproved 
                            ? '<i class="fas fa-check"></i> Chấp nhận & Ẩn đánh giá'
                            : '<i class="fas fa-times"></i> Từ chối';
                    }
                })
                .catch(err => {
                    console.error('Error:', err);
                    alert('Có lỗi xảy ra: ' + err.message);
                    actionButton.disabled = false;
                    actionButton.innerHTML = isApproved 
                        ? '<i class="fas fa-check"></i> Chấp nhận & Ẩn đánh giá'
                        : '<i class="fas fa-times"></i> Từ chối';
                });
            });
        });
    </script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #60a5fa;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-dark: #1e293b;
            --text-light: #ffffff;
            --background-light: #f8fafc;
            --border-color: #e2e8f0;
        }
        
        h2 { 
            font-family: 'Inter', sans-serif; 
            font-size: 1.75rem; 
            font-weight: 600; 
            color: var(--text-dark); 
        }
        
        .container-fluid { 
            padding: 0 !important; 
            margin: 0 !important; 
            width: 100% !important; 
        }
        
        .card { 
            width: 100% !important; 
            border-radius: 12px; 
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1); 
            background-color: #ffffff;
            border: none;
        }
        
        .card-body { 
            padding: 1.5rem; 
        }

        /* Filter Section */
        .filter-section {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
        }
        .filter-form .form-label {
            font-weight: 500;
            color: #495057;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        .filter-form .form-control,
        .filter-form .form-select {
            border-radius: 6px;
            border: 1px solid #d1d5db;
            font-size: 0.9rem;
        }

        /* Stat Cards */
        .stat-card {
            display: flex;
            align-items: center;
            padding: 1.5rem;
            border-radius: 12px;
            background: white;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .stat-card-danger { border-left-color: var(--danger-color); }
        .stat-card-warning { border-left-color: var(--warning-color); }
        .stat-card-success { border-left-color: var(--success-color); }

        .stat-icon {
            width: 56px;
            height: 56px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-size: 1.75rem;
            margin-right: 1rem;
        }

        .stat-card-danger .stat-icon {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: var(--danger-color);
        }

        .stat-card-warning .stat-icon {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: var(--warning-color);
        }

        .stat-card-success .stat-icon {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: var(--success-color);
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 0.875rem;
            color: #64748b;
            font-weight: 500;
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.875rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Navigation Tabs */
        .nav-tabs .nav-link {
            color: var(--text-dark);
            border-radius: 6px 6px 0 0;
            padding: 12px 20px;
            font-weight: 500;
        }

        .nav-tabs .nav-link.active {
            color: var(--primary-color);
            font-weight: 600;
            border-bottom: 3px solid var(--primary-color);
            background: none;
        }

        .nav-tabs .nav-link:hover {
            color: var(--primary-color);
        }

        /* Form Controls */
        .form-label {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-label i {
            color: var(--primary-color);
        }

        .btn-primary, .btn-success, .btn-secondary {
            border-radius: 6px; 
            padding: 6px 12px; 
            font-size: 0.9rem; 
            transition: all 0.2s ease;
        }
        
        .btn-primary { 
            background-color: var(--primary-color); 
            border-color: var(--primary-color); 
        }
        
        .btn-primary:hover { 
            background-color: #1d4ed8; 
            border-color: #1d4ed8; 
            transform: translateY(-1px); 
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1); 
        }
        
        .btn-success { 
            background-color: #10b981; 
            border-color: #10b981; 
        }
        
        .btn-success:hover { 
            background-color: #059669; 
            border-color: #059669; 
            transform: translateY(-1px); 
        }
        
        .btn-secondary { 
            background-color: #6b7280; 
            border-color: #6b7280; 
        }
        
        .btn-secondary:hover { 
            background-color: #4b5563; 
            border-color: #4b5563; 
            transform: translateY(-1px); 
        }

        .form-control, .form-select {
            border-radius: 6px; 
            border: 1px solid #d1d5db; 
            padding: 8px; 
            font-size: 0.9rem; 
            transition: all 0.2s ease;
        }
        
        .form-control:focus, .form-select:focus { 
            border-color: var(--primary-color); 
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); 
            outline: none; 
        }

        .table { 
            background-color: #ffffff; 
            border-radius: 8px; 
            table-layout: fixed; 
            width: 100%; 
            font-size: 0.9rem; 
        }
        
        .table th, .table td { 
            border-color: #e5e7eb; 
            vertical-align: middle; 
            padding: 12px; 
        }
        
        .table th { 
            background-color: var(--primary-color); 
            color: var(--text-light); 
            font-weight: 500; 
            text-transform: uppercase; 
            font-size: 0.85rem; 
        }
        
        .table-hover tbody tr:hover { 
            background-color: #f1f5f9; 
        }

        .col-reporter { width: 15%; min-width: 150px; }
        .col-content { width: 35%; min-width: 300px; }
        .col-reason { width: 20%; min-width: 200px; }
        .col-time { width: 12%; min-width: 120px; }
        .col-status { width: 10%; min-width: 100px; }
        .col-actions { width: 8%; min-width: 150px; }

        .badge {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 12px;
        }

        .pagination-section { 
            padding: 12px 0; 
            background-color: #f8fafc; 
            border-top: 1px solid #e5e7eb; 
        }
        
        .pagination-info { 
            font-size: 0.85rem; 
            color: #6b7280; 
        }

        .pagination .page-link {
            color: var(--primary-color);
            border-radius: 6px;
            margin: 0 2px;
        }

        .pagination .page-item.active .page-link {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-group-vertical .btn {
            margin-bottom: 4px;
        }

        .btn-group-vertical .btn:last-child {
            margin-bottom: 0;
        }
    </style>
}
