@model Bloomie.Models.Entities.OrderReturn

@{
    ViewData["Title"] = $"Chi tiết yêu cầu đổi trả #{Model.Id}";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="container-fluid">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="@Url.Action("Index", "AdminOrder")">Đơn hàng</a></li>
            <li class="breadcrumb-item"><a href="@Url.Action("ReturnRequests", "AdminOrder")">Yêu cầu đổi trả</a></li>
            <li class="breadcrumb-item active">Chi tiết #@Model.Id</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="bi bi-file-earmark-text"></i> Chi tiết yêu cầu đổi trả #@Model.Id</h2>
        <a href="@Url.Action("ReturnRequests", "AdminOrder")" class="btn btn-secondary">
            <i class="bi bi-arrow-left"></i> Quay lại danh sách
        </a>
    </div>

    @if (TempData["success"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show">
            @TempData["success"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["error"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show">
            @TempData["error"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- Thông tin yêu cầu -->
        <div class="col-md-8">
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">Thông tin yêu cầu</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Loại yêu cầu:</strong>
                                @if (Model.ReturnType == "Hoàn tiền")
                                {
                                    <span class="badge bg-success"><i class="bi bi-cash-coin"></i> @Model.ReturnType</span>
                                }
                                else
                                {
                                    <span class="badge bg-primary"><i class="bi bi-arrow-repeat"></i> @Model.ReturnType</span>
                                }
                            </p>
                            <p><strong>Trạng thái:</strong>
                                <span class="badge fs-6 @(
                                    Model.Status == "Chờ xử lý" ? "bg-warning text-dark" :
                                    Model.Status == "Chấp nhận" ? "bg-success" :
                                    Model.Status == "Từ chối" ? "bg-danger" : "bg-info")">
                                    @Model.Status
                                </span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Ngày yêu cầu:</strong> @Model.RequestDate.ToString("dd/MM/yyyy HH:mm")</p>
                            @if (Model.ResponseDate.HasValue)
                            {
                                <p><strong>Ngày xử lý:</strong> @Model.ResponseDate.Value.ToString("dd/MM/yyyy HH:mm")</p>
                            }
                        </div>
                    </div>

                    <div class="mb-3">
                        <strong>Lý do đổi trả:</strong>
                        <div class="alert alert-light mt-2">
                            @Model.Reason
                        </div>
                    </div>

                    @if (!string.IsNullOrEmpty(Model.Images))
                    {
                        <div class="mb-3">
                            <strong>Hình ảnh minh chứng:</strong>
                            <div class="d-flex flex-wrap gap-2 mt-2">
                                @foreach (var img in Model.Images.Split(';'))
                                {
                                    <a href="@img" target="_blank">
                                        <img src="@img" alt="Ảnh minh chứng" style="width: 120px; height: 120px; object-fit: cover; border-radius: 8px; border: 2px solid #dee2e6;" />
                                    </a>
                                }
                            </div>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(Model.AdminNote))
                    {
                        <div class="mb-3">
                            <strong>Ghi chú từ Admin:</strong>
                            <div class="alert alert-info mt-2">
                                @Model.AdminNote
                            </div>
                        </div>
                    }

                    @if (Model.RefundAmount.HasValue)
                    {
                        <div class="mb-3">
                            <strong>Số tiền hoàn:</strong> 
                            <span class="text-success fs-5">@Model.RefundAmount.Value.ToString("#,##0") đ</span>
                        </div>
                    }
                </div>
            </div>

            <!-- Thông tin đơn hàng gốc -->
            <div class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Thông tin đơn hàng #@Model.Order?.OrderId</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Ngày đặt:</strong> @Model.Order?.OrderDate.ToString("dd/MM/yyyy HH:mm")</p>
                            <p><strong>Trạng thái:</strong>
                                <span class="badge bg-success">@Model.Order?.Status</span>
                                @* Nếu trạng thái đơn hàng là Đã hoàn trả, không hiển thị thêm badge hoàn tiền *@
                            </p>
                            <p><strong>Địa chỉ:</strong> @Model.Order?.ShippingAddress</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Số điện thoại:</strong> @Model.Order?.Phone</p>
                            <p><strong>Tổng tiền:</strong> @Model.Order?.TotalAmount.ToString("#,##0") đ</p>
                            <p><strong>Thanh toán:</strong> @Model.Order?.PaymentMethod</p>
                        </div>
                    </div>

                    <h6 class="mt-3">Sản phẩm:</h6>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Sản phẩm</th>
                                    <th>SL</th>
                                    <th>Đơn giá</th>
                                    <th>Thành tiền</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detail in Model.Order!.OrderDetails!)
                                {
                                    <tr>
                                        <td>@detail.Product?.Name</td>
                                        <td>@detail.Quantity</td>
                                        <td>@detail.UnitPrice.ToString("#,##0") đ</td>
                                        <td>@((detail.UnitPrice * detail.Quantity).ToString("#,##0")) đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hành động -->
        <div class="col-md-4">
            @if (Model.Status == "Chờ xử lý")
            {
                <div class="card mb-3">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">Chấp nhận đổi trả</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="@Url.Action("ApproveReturn", "AdminOrder", new { id = Model.Id })">
                            @Html.AntiForgeryToken()
                            
                            <div class="mb-3">
                                <label class="form-label">Số tiền hoàn</label>
                                <input type="number" name="refundAmount" class="form-control" 
                                       value="@Model.Order?.TotalAmount" step="1000" required />
                                <small class="text-muted">Mặc định: toàn bộ giá trị đơn hàng</small>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Ghi chú cho khách hàng</label>
                                <textarea name="adminNote" class="form-control" rows="3" 
                                          placeholder="Nhập ghi chú (tùy chọn)"></textarea>
                            </div>

                            <button type="submit" class="btn btn-success w-100" 
                                    onclick="return confirm('Xác nhận chấp nhận yêu cầu đổi trả này?')">
                                <i class="bi bi-check-circle"></i> Chấp nhận
                            </button>
                        </form>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header bg-danger text-white">
                        <h5 class="mb-0">Từ chối đổi trả</h5>
                    </div>
                    <div class="card-body">
                        <form method="post" action="@Url.Action("RejectReturn", "AdminOrder", new { id = Model.Id })">
                            @Html.AntiForgeryToken()
                            
                            <div class="mb-3">
                                <label class="form-label">Lý do từ chối <span class="text-danger">*</span></label>
                                <textarea name="adminNote" class="form-control" rows="3" required
                                          placeholder="Nhập lý do từ chối (bắt buộc)"></textarea>
                            </div>

                            <button type="submit" class="btn btn-danger w-100"
                                    onclick="return confirm('Xác nhận từ chối yêu cầu đổi trả này?')">
                                <i class="bi bi-x-circle"></i> Từ chối
                            </button>
                        </form>
                    </div>
                </div>
            }
            else if (Model.Status == "Chấp nhận")
            {
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">Hoàn tất hoàn tiền</h5>
                    </div>
                    <div class="card-body">
                        <p>Sau khi chuyển tiền cho khách hàng, click nút bên dưới để xác nhận.</p>
                        <form method="post" action="@Url.Action("CompleteRefund", "AdminOrder", new { id = Model.Id })">
                            @Html.AntiForgeryToken()
                            <button type="submit" class="btn btn-info w-100"
                                    onclick="return confirm('Xác nhận đã hoàn tiền cho khách hàng?')">
                                <i class="bi bi-cash-stack"></i> Xác nhận đã hoàn tiền
                            </button>
                        </form>
                    </div>
                </div>
            }
            else
            {
                <div class="card">
                    <div class="card-body text-center">
                        <i class="bi bi-check-circle text-success" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Yêu cầu đã được xử lý</h5>
                        <p class="text-muted">Trạng thái: @Model.Status</p>
                    </div>
                </div>
            }
        </div>
    </div>
</div>

<style>
    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }
</style>
