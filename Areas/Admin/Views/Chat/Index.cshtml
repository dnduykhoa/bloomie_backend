@{
    ViewData["Title"] = "Qu·∫£n L√Ω Chat H·ªó Tr·ª£";
    Layout = "~/Areas/Admin/Views/Shared/_ChatLayout.cshtml";
}

<div class="container-fluid">
    @* <div class="row">
        <div class="col-12">
            <div class="page-header">
                <div class="d-flex align-items-center justify-content-between">
                    <div>
                        <h2 class="mb-1">
                            <i class="fas fa-comments text-primary"></i> Qu·∫£n L√Ω Chat H·ªó Tr·ª£ Kh√°ch H√†ng
                        </h2>
                        <p class="text-muted mb-0">T∆∞∆°ng t√°c v√† h·ªó tr·ª£ kh√°ch h√†ng real-time</p>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <!-- Working Hours Info -->
                        <div class="working-hours-admin-badge" id="admin-working-hours">
                            <i class="fas fa-clock"></i>
                            <span id="admin-working-hours-text">ƒêang t·∫£i...</span>
                        </div>
                        <span class="badge bg-success pulse-badge">
                            <i class="fas fa-circle"></i> Online
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div> *@

    <div class="row mt-4">
        <!-- Conversation List -->
        <div class="col-md-4">
            <div class="card shadow-lg border-0 conversation-card">
                <div class="card-header conversation-list-header">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h5 class="mb-0"><i class="fas fa-inbox"></i> H·ªôi Tho·∫°i</h5>
                        </div>
                        <div class="d-flex gap-2 align-items-center">
                            <a href="@Url.Action("Analytics", "Chat", new { area = "Admin" })" class="btn btn-sm" title="Xem b√°o c√°o th·ªëng k√™" style="background: rgba(255,255,255,0.2); color: white; border: 1px solid rgba(255,255,255,0.3); text-decoration: none;">
                                <i class="fas fa-chart-line"></i>
                            </a>
                            <span class="badge badge-counter" id="total-conversations">0</span>
                        </div>
                    </div>

                    <!-- Search & Filter Section -->
                    <div class="search-filter-section mb-3">
                        <!-- Search Input -->
                        <div class="input-group input-group-sm mb-2">
                            <span class="input-group-text bg-white">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" 
                                   class="form-control" 
                                   id="search-conversations" 
                                   placeholder="T√¨m ki·∫øm theo t√™n KH ho·∫∑c n·ªôi dung..."
                                   autocomplete="off">
                            <button class="btn btn-outline-secondary" type="button" id="clear-search-btn" style="display: none;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <!-- Advanced Filters -->
                        <div class="d-flex gap-1">
                            <!-- Filter by Tag -->
                            <select class="form-select form-select-sm" id="filter-tag" style="flex: 1;">
                                <option value="">üè∑Ô∏è Tag</option>
                                <option value="T∆∞ v·∫•n">T∆∞ v·∫•n</option>
                                <option value="Khi·∫øu n·∫°i">Khi·∫øu n·∫°i</option>
                                <option value="VIP">VIP</option>
                                <option value="ƒê·∫∑t h√†ng">ƒê·∫∑t h√†ng</option>
                                <option value="Thanh to√°n">Thanh to√°n</option>
                            </select>

                            <!-- Filter by Priority -->
                            <select class="form-select form-select-sm" id="filter-priority" style="flex: 1;">
                                <option value="">‚ö° ƒê·ªô ∆∞u ti√™n</option>
                                <option value="0">B√¨nh th∆∞·ªùng</option>
                                <option value="1">Cao</option>
                                <option value="2">Kh·∫©n c·∫•p</option>
                            </select>

                            <!-- Filter by Staff -->
                            <select class="form-select form-select-sm" id="filter-staff" style="flex: 1;">
                                <option value="">üë§ Qu·∫£n l√Ω</option>
                                <option value="unassigned">Ch∆∞a nh·∫≠n</option>
                                <!-- Staff list will be populated dynamically -->
                            </select>

                            <!-- Clear all filters -->
                            <button class="btn btn-sm btn-outline-danger" id="clear-filters-btn" type="button" title="X√≥a b·ªô l·ªçc">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>

                        <!-- Active filters display -->
                        <div id="active-filters" class="mt-2" style="display: none;">
                            <small class="text-muted">B·ªô l·ªçc: </small>
                            <span id="active-filters-badges"></span>
                        </div>
                    </div>
                    
                    <div class="btn-group w-100" role="group">
                        <button type="button" class="btn btn-sm btn-filter active" data-filter="all">
                            <i class="fas fa-list"></i> T·∫•t c·∫£
                        </button>
                        <button type="button" class="btn btn-sm btn-filter" data-filter="unread">
                            <i class="fas fa-envelope"></i> Ch∆∞a ƒë·ªçc
                        </button>
                        <button type="button" class="btn btn-sm btn-filter" data-filter="closed">
                            <i class="fas fa-check-circle"></i> ƒê√£ ƒë√≥ng
                        </button>
                    </div>
                </div>
                <div class="card-body p-0" style="max-height: 800px; overflow-y: auto;">
                    <div class="list-group list-group-flush" id="conversation-list">
                        <div class="text-center p-4 text-muted">
                            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                            <p>ƒêang t·∫£i...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Chat Window -->
        <div class="col-md-8">
            <div class="card shadow-lg border-0 chat-window-card" style="height: 900px; display: flex; flex-direction: column;">
                <!-- Chat Header -->
                <div class="chat-window-header" id="chat-header" style="display: none;">
                    <div class="d-flex align-items-center">
                        <div class="chat-avatar-wrapper me-3">
                            <div class="chat-avatar" id="chat-customer-avatar">
                                <i class="fas fa-user-circle fa-2x"></i>
                            </div>
                            <span class="customer-status-dot"></span>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="mb-0" id="chat-customer-name">-</h5>
                            <small id="chat-customer-status">-</small>
                            <div class="mt-2">
                                <span class="badge bg-info me-2" id="current-tag-badge" style="display: none;">
                                    <i class="fas fa-tag"></i> <span id="current-tag-text"></span>
                                </span>
                                <span class="badge bg-warning" id="current-priority-badge" style="display: none;">
                                    <i class="fas fa-exclamation-circle"></i> <span id="current-priority-text"></span>
                                </span>
                            </div>
                        </div>
                        <div class="d-flex flex-wrap align-items-center gap-2">
                            <!-- Tools -->
                            <button class="btn btn-sm btn-light" id="search-in-chat-btn" title="T√¨m ki·∫øm tin nh·∫Øn">
                                <i class="fas fa-search"></i> T√¨m
                            </button>
                            <div class="dropdown d-inline">
                                <button class="btn btn-sm btn-light dropdown-toggle" type="button" id="tagDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Ph√¢n lo·∫°i">
                                    <i class="fas fa-tag"></i> Tag
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="tagDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag(null, 0); return false;"><i class="fas fa-times"></i> X√≥a tag</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag('T∆∞ v·∫•n', 0); return false;"><i class="fas fa-comments" style="color: #3b82f6;"></i> T∆∞ v·∫•n</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag('Khi·∫øu n·∫°i', 2); return false;"><i class="fas fa-exclamation-triangle" style="color: #ef4444;"></i> Khi·∫øu n·∫°i</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag('VIP', 1); return false;"><i class="fas fa-crown" style="color: #f59e0b;"></i> VIP</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag('ƒê·∫∑t h√†ng', 0); return false;"><i class="fas fa-shopping-cart" style="color: #10b981;"></i> ƒê·∫∑t h√†ng</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="setConversationTag('Thanh to√°n', 1); return false;"><i class="fas fa-credit-card" style="color: #8b5cf6;"></i> Thanh to√°n</a></li>
                                </ul>
                            </div>
                            <button class="btn btn-sm btn-warning" id="block-user-btn" title="Ch·∫∑n ng∆∞·ªùi d√πng" style="display: none;">
                                <i class="fas fa-ban"></i>
                            </button>
                            
                            <!-- Divider -->
                            <div style="height: 24px; width: 1px; background: #dee2e6; margin: 0 8px;"></div>
                            
                            <!-- Actions -->
                            <button class="btn btn-sm btn-success" id="assign-to-me-btn" title="Nh·∫≠n h·ªó tr·ª£">
                                <i class="fas fa-hand-paper"></i> Nh·∫≠n
                            </button>
                            <button class="btn btn-sm btn-info" id="transfer-chat-btn" title="Chuy·ªÉn chat cho staff kh√°c">
                                <i class="fas fa-exchange-alt"></i> Chuy·ªÉn
                            </button>
                            <button class="btn btn-sm btn-light" id="fullscreen-btn" title="To√†n m√†n h√¨nh">
                                <i class="fas fa-expand"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" id="close-conversation-btn" title="ƒê√≥ng h·ªôi tho·∫°i">
                                <i class="fas fa-times-circle"></i> ƒê√≥ng
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search in chat toolbar -->
                    <div id="search-in-chat-toolbar" style="display: none; background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; padding: 12px 20px; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                        <div class="d-flex align-items-center gap-2">
                            <i class="fas fa-search"></i>
                            <input type="text" 
                                   class="form-control form-control-sm" 
                                   id="search-in-chat-input" 
                                   placeholder="T√¨m ki·∫øm tin nh·∫Øn..."
                                   style="flex: 1; border: none; box-shadow: none;"
                                   autocomplete="off">
                            <span id="search-results-count" style="font-size: 13px; white-space: nowrap;">0/0</span>
                            <button class="btn btn-sm btn-light" id="search-prev-btn" title="K·∫øt qu·∫£ tr∆∞·ªõc">
                                <i class="fas fa-chevron-up"></i>
                            </button>
                            <button class="btn btn-sm btn-light" id="search-next-btn" title="K·∫øt qu·∫£ sau">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                            <button class="btn btn-sm btn-light" id="close-search-btn" title="ƒê√≥ng">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Multi-select toolbar -->
                    <div id="multi-select-toolbar" style="display: none; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 24px; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                        <div class="d-flex justify-content-between align-items-center">
                            <div style="font-size: 15px; font-weight: 500;">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="selected-count" style="font-weight: 700; font-size: 18px;">0</span> 
                                <span style="opacity: 0.95;">tin nh·∫Øn ƒë√£ ch·ªçn</span>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-light me-2" id="cancel-multi-select-btn" style="border-radius: 8px; padding: 8px 16px; font-weight: 500; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                    <i class="fas fa-times"></i> H·ªßy
                                </button>
                                <button class="btn btn-sm btn-danger" id="delete-selected-btn" style="border-radius: 8px; padding: 8px 16px; font-weight: 500; border: none; box-shadow: 0 2px 4px rgba(220, 38, 38, 0.3);">
                                    <i class="fas fa-trash-alt"></i> X√≥a ƒë√£ ch·ªçn
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="card-body" style="flex: 1; overflow-y: auto; background: #f8f9fa;" id="chat-messages">
                    <div class="text-center p-5" style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 20px;">
                        <div style="position: relative; animation: float 3s ease-in-out infinite;">
                            <div style="width: 120px; height: 120px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 10px 40px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-comments" style="font-size: 60px; color: white;"></i>
                            </div>
                            <div style="position: absolute; top: 0; right: 0; width: 35px; height: 35px; background: #10b981; border-radius: 50%; border: 4px solid #f8f9fa; display: flex; align-items: center; justify-content: center;">
                                <i class="fas fa-check" style="font-size: 16px; color: white;"></i>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            <h4 style="color: #1f2937; font-weight: 600; margin-bottom: 10px; font-size: 1.5rem;">H·ªó tr·ª£ kh√°ch h√†ng 24/7</h4>
                            <p style="color: #6b7280; font-size: 1rem; margin-bottom: 8px;">Ch·ªçn m·ªôt h·ªôi tho·∫°i b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu</p>
                            <p style="color: #9ca3af; font-size: 0.9rem;">
                                <i class="fas fa-lightbulb" style="color: #f59e0b;"></i> 
                                S·ª≠ d·ª•ng Quick Replies ƒë·ªÉ tr·∫£ l·ªùi nhanh h∆°n
                            </p>
                        </div>
                        <div style="display: flex; gap: 15px; margin-top: 10px;">
                            <div style="text-align: center; padding: 15px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <i class="fas fa-bolt" style="font-size: 24px; color: #667eea; margin-bottom: 8px;"></i>
                                <p style="font-size: 0.85rem; color: #4b5563; margin: 0; font-weight: 500;">Ph·∫£n h·ªìi nhanh</p>
                            </div>
                            <div style="text-align: center; padding: 15px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <i class="fas fa-link" style="font-size: 24px; color: #10b981; margin-bottom: 8px;"></i>
                                <p style="font-size: 0.85rem; color: #4b5563; margin: 0; font-weight: 500;">G·ª≠i ƒë√≠nh k√®m</p>
                            </div>
                            <div style="text-align: center; padding: 15px 20px; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                                <i class="fas fa-tags" style="font-size: 24px; color: #f59e0b; margin-bottom: 8px;"></i>
                                <p style="font-size: 0.85rem; color: #4b5563; margin: 0; font-weight: 500;">Ph√¢n lo·∫°i chat</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="px-3 py-2 bg-light" id="typing-indicator" style="display: none;">
                    <small class="text-muted">
                        <i class="fas fa-circle-notch fa-spin"></i> Kh√°ch h√†ng ƒëang g√µ...
                    </small>
                </div>

                <!-- Chat Input -->
                <div class="card-footer bg-white" id="chat-input-area" style="display: none;">
                    <!-- Quick Replies -->
                    <div id="quick-replies-section" class="mb-2" style="display: none;">
                        <div class="d-flex flex-wrap gap-2">
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="Xin ch√†o b·∫°n! üå∏ C·∫£m ∆°n b·∫°n ƒë√£ li√™n h·ªá v·ªõi Bloomie. M√¨nh l√† nh√¢n vi√™n t∆∞ v·∫•n, r·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ b·∫°n h√¥m nay. B·∫°n ƒëang quan t√¢m ƒë·∫øn s·∫£n ph·∫©m n√†o ho·∫∑c c·∫ßn t∆∞ v·∫•n g√¨ v·ªÅ hoa c·ªßa ch√∫ng m√¨nh ·∫°?">
                                üëã Ch√†o h·ªèi
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="D·∫°, c·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu ƒë√£ tin t∆∞·ªüng v√† l·ª±a ch·ªçn Bloomie! üåπ Ch√∫ng m√¨nh lu√¥n c·ªë g·∫Øng mang ƒë·∫øn nh·ªØng s·∫£n ph·∫©m hoa t∆∞∆°i ƒë·∫πp nh·∫•t v√† d·ªãch v·ª• t·ªët nh·∫•t cho kh√°ch h√†ng. N·∫øu c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc g√¨, ƒë·ª´ng ng·∫°i nh·∫Øn tin cho m√¨nh b·∫•t c·ª© l√∫c n√†o nh√©! üíê">
                                üôè C·∫£m ∆°n
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="M√¨nh ƒë√£ nh·∫≠n ƒë∆∞·ª£c ƒë∆°n h√†ng c·ªßa b·∫°n r·ªìi ·∫°! üì¶ Hi·ªán t·∫°i ƒë∆°n h√†ng ƒëang trong qu√° tr√¨nh ƒë∆∞·ª£c chu·∫©n b·ªã c·∫©n th·∫≠n b·ªüi florist chuy√™n nghi·ªáp c·ªßa ch√∫ng m√¨nh. Ch√∫ng m√¨nh s·∫Ω ch·ªçn nh·ªØng b√¥ng hoa t∆∞∆°i ƒë·∫πp nh·∫•t v√† c·∫Øm theo ƒë√∫ng m·∫´u b·∫°n ƒë√£ ch·ªçn. D·ª± ki·∫øn trong v√≤ng 2-4 gi·ªù n·ªØa ƒë∆°n h√†ng s·∫Ω s·∫µn s√†ng ƒë·ªÉ giao ƒë·∫øn tay b·∫°n nh√©! üå∏">
                                üì¶ ƒêang x·ª≠ l√Ω ƒë∆°n
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="Tin vui cho b·∫°n nh√©! üöö ƒê∆°n h√†ng c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c ch√∫ng m√¨nh giao cho ƒë∆°n v·ªã v·∫≠n chuy·ªÉn v√† ƒëang tr√™n ƒë∆∞·ªùng ƒë·∫øn ƒë·ªãa ch·ªâ b·∫°n ƒë√£ cung c·∫•p r·ªìi ·∫°. B·∫°n vui l√≤ng ƒë·ªÉ √Ω ƒëi·ªán tho·∫°i ƒë·ªÉ nh·∫≠n cu·ªôc g·ªçi t·ª´ shipper nh√©. N·∫øu c√≥ b·∫•t k·ª≥ v·∫•n ƒë·ªÅ g√¨ v·ªÅ giao h√†ng, b·∫°n nh·∫Øn tin cho m√¨nh ngay ƒë·ªÉ ƒë∆∞·ª£c h·ªó tr·ª£ k·ªãp th·ªùi! üìû">
                                üöö ƒê√£ giao v·∫≠n chuy·ªÉn
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="M√¨nh th√†nh th·∫≠t xin l·ªói b·∫°n v·ªÅ s·ª± b·∫•t ti·ªán n√†y! üòî ƒê√¢y l√† l·ªói t·ª´ ph√≠a ch√∫ng m√¨nh v√† m√¨nh ho√†n to√†n hi·ªÉu ƒë∆∞·ª£c c·∫£m x√∫c c·ªßa b·∫°n. M√¨nh s·∫Ω ki·ªÉm tra k·ªπ t√¨nh hu·ªëng n√†y v√† b√°o c√°o l√™n qu·∫£n l√Ω ƒë·ªÉ t√¨m ph∆∞∆°ng √°n gi·∫£i quy·∫øt t·ªët nh·∫•t cho b·∫°n ngay. Bloomie s·∫Ω ch·ªãu tr√°ch nhi·ªám v√† ƒë·∫£m b·∫£o quy·ªÅn l·ª£i c·ªßa b·∫°n ƒë∆∞·ª£c ƒë·∫£m b·∫£o. Xin b·∫°n cho ch√∫ng m√¨nh m·ªôt c∆° h·ªôi ƒë·ªÉ kh·∫Øc ph·ª•c nh√©! üôè">
                                üòî Xin l·ªói
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="D·∫°, s·∫£n ph·∫©m n√†y hi·ªán ƒëang c√≤n h√†ng ·∫°! ‚úÖ V√† hoa c·ªßa ch√∫ng m√¨nh ƒë·ªÅu l√† hoa t∆∞∆°i m·ªõi nh·∫≠p trong ng√†y n√™n ch·∫•t l∆∞·ª£ng r·∫•t ƒë·∫£m b·∫£o lu√¥n. B·∫°n c√≥ th·ªÉ y√™n t√¢m ƒë·∫∑t h√†ng ngay tr√™n website ho·∫∑c ƒë·ªÉ m√¨nh h·ªó tr·ª£ b·∫°n ƒë·∫∑t h√†ng qua chat n√†y c≈©ng ƒë∆∞·ª£c nh√©! üåπ N·∫øu c·∫ßn t∆∞ v·∫•n th√™m v·ªÅ m√†u s·∫Øc, k√≠ch th∆∞·ªõc hay l·ªùi nh·∫Øn k√®m theo, c·ª© h·ªèi m√¨nh nh√©!">
                                ‚úÖ C√≤n h√†ng
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="R·∫•t ti·∫øc l√† s·∫£n ph·∫©m n√†y hi·ªán t·∫°i ƒë√£ h·∫øt h√†ng r·ªìi ·∫° üò¢ Do s·∫£n ph·∫©m r·∫•t ƒë∆∞·ª£c ∆∞a chu·ªông n√™n ƒë√£ b√°n h·∫øt trong ƒë·ª£t v·ª´a r·ªìi. Tuy nhi√™n, ch√∫ng m√¨nh s·∫Ω nh·∫≠p h√†ng l·∫°i s·ªõm nh·∫•t c√≥ th·ªÉ (d·ª± ki·∫øn 1-2 ng√†y n·ªØa). Ho·∫∑c b·∫°n c√≥ th·ªÉ xem qua m·ªôt s·ªë m·∫´u hoa t∆∞∆°ng t·ª± c≈©ng r·∫•t ƒë·∫πp m√† m√¨nh mu·ªën gi·ªõi thi·ªáu cho b·∫°n. M√¨nh g·ª≠i link cho b·∫°n xem nh√©! üå∏ B·∫°n th√≠ch m·∫´u n√†o c·ª© nh·∫Øn m√¨nh!">
                                ‚ùå H·∫øt h√†ng
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="V·ªÅ ph∆∞∆°ng th·ª©c thanh to√°n, Bloomie h·ªó tr·ª£ r·∫•t linh ho·∫°t cho b·∫°n ·∫°: üí≥

1Ô∏è‚É£ Ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng (COD) - B·∫°n thanh to√°n tr·ª±c ti·∫øp cho shipper
2Ô∏è‚É£ Chuy·ªÉn kho·∫£n ng√¢n h√†ng - M√¨nh s·∫Ω g·ª≠i th√¥ng tin t√†i kho·∫£n ƒë·ªÉ b·∫°n chuy·ªÉn kho·∫£n
3Ô∏è‚É£ V√≠ ƒëi·ªán t·ª≠ VNPay - Thanh to√°n nhanh ch√≥ng qua c·ªïng VNPay ngay tr√™n website

B·∫°n ch·ªçn h√¨nh th·ª©c n√†o ti·ªán nh·∫•t cho m√¨nh nh√©! N·∫øu c·∫ßn h∆∞·ªõng d·∫´n chi ti·∫øt, c·ª© nh·∫Øn m√¨nh! üòä">
                                üí≥ Thanh to√°n
                            </button>
                            <button class="btn btn-sm btn-outline-primary quick-reply-btn" data-message="C·∫£m ∆°n b·∫°n r·∫•t nhi·ªÅu ƒë√£ d√†nh th·ªùi gian trao ƒë·ªïi v·ªõi m√¨nh! üå∏ M√¨nh r·∫•t vui ƒë∆∞·ª£c h·ªó tr·ª£ b·∫°n h√¥m nay. N·∫øu c√≥ b·∫•t k·ª≥ th·∫Øc m·∫Øc n√†o v·ªÅ s·∫£n ph·∫©m, ƒë∆°n h√†ng hay c·∫ßn t∆∞ v·∫•n th√™m, b·∫°n c·ª© tho·∫£i m√°i nh·∫Øn tin cho Bloomie b·∫•t c·ª© l√∫c n√†o nh√©! Ch√∫c b·∫°n m·ªôt ng√†y th·∫≠t tuy·ªát v·ªùi! üíê‚ú®">
                                ‚ú® K·∫øt th√∫c
                            </button>
                            <button class="btn btn-sm btn-outline-info quick-reply-btn" data-message="V·ªÅ v·∫•n ƒë·ªÅ n√†y, m√¨nh xin ph√©p ƒë∆∞·ª£c ki·ªÉm tra k·ªπ v√† trao ƒë·ªïi v·ªõi b·ªô ph·∫≠n li√™n quan ƒë·ªÉ ƒë∆∞a ra c√¢u tr·∫£ l·ªùi ch√≠nh x√°c nh·∫•t cho b·∫°n nh√©! ‚è±Ô∏è B·∫°n vui l√≤ng cho m√¨nh kho·∫£ng 5-10 ph√∫t ƒë·ªÉ x√°c nh·∫≠n. M√¨nh s·∫Ω ph·∫£n h·ªìi l·∫°i ngay cho b·∫°n. C·∫£m ∆°n b·∫°n ƒë√£ ki√™n nh·∫´n! üôè">
                                ‚è±Ô∏è C·∫ßn ki·ªÉm tra
                            </button>
                            <button class="btn btn-sm btn-outline-warning quick-reply-btn" data-message="V·ªÅ ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i hi·ªán t·∫°i c·ªßa Bloomie: üéÅ

‚ú® Gi·∫£m 10% cho ƒë∆°n h√†ng t·ª´ 500.000ƒë
‚ú® Mi·ªÖn ph√≠ giao h√†ng trong b√°n k√≠nh 5km
‚ú® T·∫∑ng thi·ªáp ch√∫c m·ª´ng ƒë·∫πp ho√†n to√†n mi·ªÖn ph√≠
‚ú® T√≠ch ƒëi·ªÉm ƒë·ªïi qu√† cho kh√°ch h√†ng th√¢n thi·∫øt

Ngo√†i ra c√≤n nhi·ªÅu ∆∞u ƒë√£i kh√°c n·ªØa ·∫°! B·∫°n c√≥ th·ªÉ xem chi ti·∫øt t·∫°i m·ª•c Khuy·∫øn M√£i tr√™n website nh√©! üåü">
                                üéÅ Khuy·∫øn m√£i
                            </button>
                            <button class="btn btn-sm btn-outline-danger quick-reply-btn" data-message="V·ªÅ ch√≠nh s√°ch ƒë·ªïi tr·∫£ h√†ng c·ªßa Bloomie, m√¨nh xin t√≥m t·∫Øt cho b·∫°n nh∆∞ sau: üîÑ

üìã ƒêi·ªÅu ki·ªán ƒë·ªïi/tr·∫£:
‚úÖ S·∫£n ph·∫©m b·ªã l·ªói, h∆∞ h·ªèng do v·∫≠n chuy·ªÉn
‚úÖ S·∫£n ph·∫©m kh√¥ng ƒë√∫ng m√¥ t·∫£ (m√†u s·∫Øc, k√≠ch th∆∞·ªõc, lo·∫°i hoa)
‚úÖ Hoa kh√¥ng t∆∞∆°i khi nh·∫≠n h√†ng

‚è∞ Th·ªùi gian ƒë·ªïi/tr·∫£:
‚Ä¢ B√°o ngay trong v√≤ng 2 gi·ªù sau khi nh·∫≠n h√†ng
‚Ä¢ G·ª≠i h√¨nh ·∫£nh s·∫£n ph·∫©m l·ªói cho ch√∫ng m√¨nh

üîÑ Quy tr√¨nh:
1Ô∏è‚É£ Li√™n h·ªá qua chat n√†y ho·∫∑c hotline
2Ô∏è‚É£ Cung c·∫•p m√£ ƒë∆°n h√†ng + h√¨nh ·∫£nh s·∫£n ph·∫©m
3Ô∏è‚É£ Ch√∫ng m√¨nh s·∫Ω ƒë·ªïi hoa m·ªõi MI·ªÑN PH√ç ho·∫∑c ho√†n ti·ªÅn 100%

L∆∞u √Ω: Do hoa l√† s·∫£n ph·∫©m t∆∞∆°i s·ªëng n√™n ch√∫ng m√¨nh kh√¥ng nh·∫≠n ƒë·ªïi/tr·∫£ n·∫øu l√Ω do ch·ªß quan (kh√¥ng th√≠ch, ƒë·ªïi √Ω...) ·∫°. N·∫øu b·∫°n c√≥ v·∫•n ƒë·ªÅ g√¨ v·ªÅ ƒë∆°n h√†ng, c·ª© li√™n h·ªá m√¨nh ngay nh√©! üíê">
                                üîÑ ƒê·ªïi/Tr·∫£ h√†ng
                            </button>
                            <button class="btn btn-sm btn-outline-secondary quick-reply-btn" data-message="Ch√†o b·∫°n! üå∏ M√¨nh r·∫•t vui ƒë∆∞·ª£c t∆∞ v·∫•n cho b·∫°n h√¥m nay!

ƒê·ªÉ h·ªó tr·ª£ b·∫°n t·ªët nh·∫•t, b·∫°n c√≥ th·ªÉ cho m√¨nh bi·∫øt b·∫°n ƒëang quan t√¢m ƒë·∫øn:

[QUICK_ACTIONS]
üå∫ S·∫£n ph·∫©m hoa|T√¥i mu·ªën xem s·∫£n ph·∫©m hoa
üíê D·ªãch v·ª• ƒë·∫∑t hoa|T√¥i mu·ªën t∆∞ v·∫•n v·ªÅ d·ªãch v·ª• ƒë·∫∑t hoa
üéÅ Khuy·∫øn m√£i|Cho t√¥i xem c√°c ch∆∞∆°ng tr√¨nh khuy·∫øn m√£i
üì¶ ƒê∆°n h√†ng|T√¥i mu·ªën ki·ªÉm tra ƒë∆°n h√†ng c·ªßa m√¨nh
üí≥ Thanh to√°n|H∆∞·ªõng d·∫´n t√¥i c√°ch thanh to√°n
[/QUICK_ACTIONS]

B·∫°n c·ª© tho·∫£i m√°i chia s·∫ª nhu c·∫ßu c·ªßa m√¨nh, m√¨nh s·∫Ω h·ªó tr·ª£ b·∫°n ngay nh√©! üòä">
                                üí¨ T∆∞ v·∫•n
                            </button>
                        </div>
                    </div>

                    <div class="input-group">
                        <button class="btn btn-outline-secondary rounded-0 border-end-0" id="quick-replies-toggle-btn" title="C√¢u tr·∫£ l·ªùi nhanh">
                            <i class="fas fa-bolt"></i>
                        </button>
                        
                        <!-- Dropdown cho ·∫£nh -->
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary rounded-0 border-end-0 dropdown-toggle" type="button" id="imageDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="G·ª≠i ·∫£nh">
                                <i class="fas fa-image"></i>
                            </button>
                            <ul class="dropdown-menu shadow-sm" aria-labelledby="imageDropdown" style="min-width: 200px;">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center py-2" href="#" id="choose-image-btn">
                                        <i class="fas fa-folder-open me-2" style="color: #6c757d; width: 20px;"></i>
                                        <span>Ch·ªçn t·ª´ th∆∞ vi·ªán</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider my-1"></li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center py-2" href="#" id="capture-image-btn">
                                        <i class="fas fa-camera me-2" style="color: #007bff; width: 20px;"></i>
                                        <span>Ch·ª•p ·∫£nh</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <input type="file" id="admin-image-input" accept="image/*" style="display: none;">
                        
                        <!-- Dropdown cho attachments -->
                        <div class="btn-group">
                            <button class="btn btn-outline-secondary rounded-0 dropdown-toggle" type="button" id="attachmentDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="G·ª≠i k√®m">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="attachmentDropdown" style="min-width: 200px;">
                                <li>
                                    <a class="dropdown-item d-flex align-items-center py-2" href="#" id="send-product-btn">
                                        <i class="fas fa-box me-2" style="color: #28a745; width: 20px;"></i>
                                        <span>G·ª≠i s·∫£n ph·∫©m</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider my-1"></li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center py-2" href="#" id="send-order-btn">
                                        <i class="fas fa-shopping-bag me-2" style="color: #17a2b8; width: 20px;"></i>
                                        <span>G·ª≠i ƒë∆°n h√†ng</span>
                                    </a>
                                </li>
                                <li><hr class="dropdown-divider my-1"></li>
                                <li>
                                    <a class="dropdown-item d-flex align-items-center py-2" href="#" id="send-blog-btn">
                                        <i class="fas fa-newspaper me-2" style="color: #ffc107; width: 20px;"></i>
                                        <span>G·ª≠i b√†i vi·∫øt</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                        <textarea 
                               class="form-control" 
                               id="message-input" 
                               placeholder="Nh·∫≠p tin nh·∫Øn..."
                               maxlength="1000"
                               rows="1"
                               style="resize: none; overflow-y: hidden; min-height: 38px; max-height: 150px;"></textarea>
                        <button class="btn btn-primary" id="send-message-btn">
                            <i class="fas fa-paper-plane"></i> G·ª≠i
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Lightbox Modal -->
        <div id="admin-image-lightbox" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 10000; align-items: center; justify-content: center;">
            <button onclick="document.getElementById('admin-image-lightbox').style.display='none'" style="position: absolute; top: 20px; right: 20px; background: rgba(255,255,255,0.2); color: white; border: none; font-size: 30px; width: 50px; height: 50px; border-radius: 50%; cursor: pointer; transition: all 0.3s;">
                &times;
            </button>
            <img id="admin-lightbox-image" src="" alt="Preview" style="max-width: 90vw; max-height: 90vh; border-radius: 8px; object-fit: contain; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
        </div>

        <!-- Preview Modal -->
        <div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10001; backdrop-filter: blur(4px);">
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 1200px; height: 90vh; background: white; border-radius: 16px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); display: flex; flex-direction: column;">
                <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                    <h5 style="margin: 0; font-weight: 600;">
                        <i class="fas fa-external-link-alt text-primary"></i> Chi Ti·∫øt
                    </h5>
                    <div>
                        <button class="btn btn-sm btn-outline-primary me-2" id="open-new-tab-btn">
                            <i class="fas fa-external-link-alt"></i> M·ªü tab m·ªõi
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" id="close-modal-btn">
                            <i class="fas fa-times"></i> ƒê√≥ng
                        </button>
                    </div>
                </div>
                <div style="flex: 1; overflow: hidden;">
                    <iframe id="preview-frame" style="width: 100%; height: 100%; border: none;"></iframe>
                </div>
            </div>
        </div>

        <!-- Camera Modal -->
        <div class="modal fade" id="cameraModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" style="background: #1a1a1a; border: none; border-radius: 16px; overflow: hidden;">
                    <div class="modal-header border-0" style="background: #1a1a1a; padding: 15px 20px;">
                        <h5 class="modal-title text-white" style="font-size: 16px;"><i class="fas fa-camera me-2"></i> Ch·ª•p ·∫£nh</h5>
                        <button type="button" class="btn-close btn-close-white" id="close-camera-btn"></button>
                    </div>
                    <div class="modal-body text-center p-0" style="background: #000; position: relative;">
                        <video id="camera-video" autoplay playsinline style="width: 100%; height: 450px; object-fit: cover;"></video>
                        <canvas id="camera-canvas" style="display: none;"></canvas>
                        <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 10;">
                            <button type="button" class="btn btn-light" id="capture-photo-btn" 
                                style="width: 65px; height: 65px; border-radius: 50%; border: 3px solid #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.5); transition: all 0.2s;">
                                <i class="fas fa-circle" style="font-size: 32px; color: #dc3545;"></i>
                            </button>
                        </div>
                    </div>
                    <div class="modal-footer border-0 justify-content-center" style="background: #1a1a1a; padding: 12px 20px;">
                        <button type="button" class="btn btn-outline-light btn-sm" id="cancel-camera-btn">
                            <i class="fas fa-times me-1"></i> H·ªßy
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Image Preview Modal -->
        <div class="modal fade" id="imagePreviewModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Xem tr∆∞·ªõc ·∫£nh</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <img id="preview-image" src="" alt="Preview" class="img-fluid rounded" style="max-height: 500px;">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times"></i> H·ªßy
                        </button>
                        <button type="button" class="btn btn-primary" id="confirm-send-image-btn">
                            <i class="fas fa-paper-plane"></i> G·ª≠i ·∫£nh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Search Modal -->
        <div class="modal fade" id="productSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-gradient-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-search"></i> T√¨m S·∫£n Ph·∫©m ƒê·ªÉ G·ª≠i</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="product-search-input" placeholder="Nh·∫≠p t√™n s·∫£n ph·∫©m...">
                        </div>
                        <div id="product-search-results" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Nh·∫≠p t√™n s·∫£n ph·∫©m ƒë·ªÉ t√¨m ki·∫øm</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Search Modal -->
        <div class="modal fade" id="orderSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-gradient-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-search"></i> T√¨m ƒê∆°n H√†ng ƒê·ªÉ G·ª≠i</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="order-search-input" placeholder="Nh·∫≠p m√£ ƒë∆°n h√†ng ho·∫∑c t√™n kh√°ch...">
                        </div>
                        <div id="order-search-results" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Nh·∫≠p m√£ ƒë∆°n h√†ng ƒë·ªÉ t√¨m ki·∫øm</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Blog Search Modal -->
        <div class="modal fade" id="blogSearchModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-gradient-primary text-white">
                        <h5 class="modal-title"><i class="fas fa-search"></i> T√¨m B√†i Vi·∫øt ƒê·ªÉ G·ª≠i</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <input type="text" class="form-control" id="blog-search-input" placeholder="Nh·∫≠p ti√™u ƒë·ªÅ b√†i vi·∫øt...">
                        </div>
                        <div id="blog-search-results" style="max-height: 400px; overflow-y: auto;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-search fa-2x mb-2"></i>
                                <p>Nh·∫≠p ti√™u ƒë·ªÅ ƒë·ªÉ t√¨m ki·∫øm</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transfer Chat Modal -->
        <div class="modal fade" id="transferChatModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h5 class="modal-title"><i class="fas fa-exchange-alt"></i> Chuy·ªÉn Chat Cho Staff Kh√°c</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i> Chuy·ªÉn conversation n√†y cho staff kh√°c x·ª≠ l√Ω
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ch·ªçn Staff <span class="text-danger">*</span></label>
                            <select class="form-select" id="transfer-staff-select">
                                <option value="">-- Ch·ªçn staff --</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">L√Ω do chuy·ªÉn</label>
                            <textarea class="form-control" id="transfer-reason" rows="3" placeholder="VD: Kh√°ch h√†ng c·∫ßn t∆∞ v·∫•n chuy√™n s√¢u v·ªÅ hoa c∆∞·ªõi..."></textarea>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="transfer-notify" checked>
                            <label class="form-check-label" for="transfer-notify">
                                G·ª≠i th√¥ng b√°o cho staff nh·∫≠n
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                        <button type="button" class="btn btn-primary" id="confirm-transfer-btn">
                            <i class="fas fa-paper-plane"></i> X√°c Nh·∫≠n Chuy·ªÉn
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics moved to separate page: /Admin/Chat/Analytics -->
    </div>
</div>

<style>

    /* Cards */
    .conversation-card, .chat-window-card {
        border-radius: 16px;
        overflow: hidden;
    }

    .conversation-list-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border: none;
    }

    .conversation-list-header h5 {
        font-weight: 600;
    }

    .btn-filter {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        font-size: 12px;
        padding: 6px 12px;
        transition: all 0.3s;
    }

    .btn-filter:hover {
        background: rgba(255, 255, 255, 0.3);
        color: white;
    }

    .btn-filter.active {
        background: white;
        color: #667eea;
        font-weight: 600;
    }

    .badge-counter {
        background: rgba(255, 255, 255, 0.3);
        color: white;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
        backdrop-filter: blur(10px);
    }

    .chat-window-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border: none;
    }

    .chat-window-header h5 {
        color: white !important;
        font-weight: 600;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .chat-window-header small {
        color: rgba(255, 255, 255, 0.95) !important;
        font-size: 13px;
    }

    .chat-window-header .text-success {
        color: #86efac !important;
        font-weight: 500;
    }

    .chat-window-header .text-warning {
        color: #fde047 !important;
        font-weight: 500;
    }

    .chat-window-header .text-info {
        color: #bae6fd !important;
        font-weight: 500;
    }

    .bg-gradient-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .conversation-item-wrapper {
        position: relative;
        overflow: hidden;
        border-bottom: 1px solid #f0f0f0;
    }

    .conversation-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border-left: 4px solid transparent;
        padding: 18px !important;
        border-bottom: none !important;
        position: relative;
        z-index: 2;
        background: white !important;
        width: 100%;
    }

    .conversation-item:hover {
        background: linear-gradient(to right, #f0f4ff, #ffffff) !important;
        border-left-color: #667eea;
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
    }

    .conversation-delete-btn {
        position: absolute;
        right: -80px;
        top: 0;
        width: 80px;
        height: 100%;
        background: #ef4444;
        color: white;
        border: none;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        cursor: pointer;
        z-index: 1;
        transition: right 0.3s ease;
    }

    .conversation-delete-btn:hover {
        background: #dc2626;
    }

    .conversation-item-wrapper.swiped .conversation-item {
        transform: translateX(-80px);
    }

    .conversation-item-wrapper.swiped .conversation-delete-btn {
        right: 0;
    }

    .conversation-item.active {
        background: linear-gradient(135deg, #e7f1ff 0%, #f0f4ff 100%) !important;
        border-left-color: #667eea;
        border-left-width: 5px;
        box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        transform: translateX(6px);
    }

    .conversation-item .flex-grow-1 {
        min-width: 0;
        flex: 1;
        overflow: hidden;
        padding-right: 8px;
    }

    .conversation-item h6 {
        color: #1f2937 !important;
        font-weight: 600;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .conversation-item .mb-1.small {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: block;
        color: #4b5563;
        font-size: 14px;
        max-width: 100%;
    }

    .conversation-item .text-muted {
        color: #9ca3af !important;
        font-size: 12px;
    }

    .conversation-item.unread {
        background: linear-gradient(135deg, #fffbeb 0%, #ffffff 100%) !important;
        border-left-color: #f59e0b;
        border-left-width: 5px;
    }
    
    .conversation-item.unread:hover {
        background: linear-gradient(135deg, #fef3c7 0%, #ffffff 100%) !important;
        border-left-color: #f59e0b;
    }

    .unread-badge {
        background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        color: white;
        border-radius: 20px;
        padding: 4px 10px;
        font-size: 11px;
        font-weight: 700;
        box-shadow: 0 2px 6px rgba(239, 68, 68, 0.3);
        animation: pulse 2s infinite;
    }
    
    @@keyframes pulse {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.05); }
    }

    .chat-avatar-wrapper {
        position: relative;
        display: inline-block;
    }

    .chat-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255, 255, 255, 0.2);
        overflow: hidden;
    }

    .chat-avatar img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .chat-avatar-wrapper .customer-status-dot {
        position: absolute;
        bottom: 2px;
        right: 2px;
        width: 12px;
        height: 12px;
        background-color: #10b981;
        border-radius: 50%;
        border: 2px solid #667eea;
        display: block;
    }

    @@keyframes pulse-green {
        0%, 100% {
            opacity: 1;
            transform: scale(1);
        }
        50% {
            opacity: 0.7;
            transform: scale(1.1);
        }
    }

    .message-bubble {
        max-width: 70%;
        padding: 12px 16px;
        border-radius: 18px;
        margin-bottom: 10px;
        word-wrap: break-word;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .message-from-customer {
        background: white;
        margin-right: auto;
        border-bottom-left-radius: 4px;
        border: 1px solid #f3f4f6;
    }

    .message-from-staff {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 4px;
    }

    .message-time {
        font-size: 11px;
        color: rgba(255, 255, 255, 0.75);
        margin-top: 4px;
    }

    .message-bubble .message-time {
        color: rgba(255, 255, 255, 0.75);
    }

    .message-from-customer .message-time {
        color: #6c757d;
    }

    .message-status {
        font-size: 12px;
        margin-left: 8px;
        white-space: nowrap;
        font-weight: 500;
    }

    .message-status.sent {
        color: rgba(255, 255, 255, 0.75);
    }

    .message-status.delivered {
        color: #6b7280;
        font-weight: 600;
    }

    .message-status.read {
        color: #3b82f6;;
        font-weight: 700;
    }

    .message-status i {
        font-size: 13px;
        margin-right: 4px;
    }

    /* Status for attachment messages (visible on light background) */
    .message-status.attachment-status.sent {
        color: #9ca3af;
    }

    .message-status.attachment-status.delivered {
        color: #6b7280;
    }

    .message-status.attachment-status.read {
        color: #3b82f6;
        font-weight: 600;
    }

    /* Message Options Menu */
    .message-options {
        position: relative;
        display: inline-flex;
        align-items: center;
    }

    .message-options-btn {
        background: #f3f4f6;
        border: none;
        color: #6b7280;
        font-size: 14px;
        cursor: pointer;
        padding: 6px 10px;
        border-radius: 6px;
        opacity: 0;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
    }

    .d-flex:hover .message-options-btn {
        opacity: 1;
    }

    .message-options-btn:hover {
        background: #e5e7eb;
        color: #374151;
        transform: scale(1.05);
    }

    .message-options-btn:active {
        transform: scale(0.95);
    }

    .message-options-menu {
        position: absolute;
        top: calc(100% + 4px);
        right: 0;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.1), 0 4px 10px rgba(0,0,0,0.05);
        min-width: 200px;
        z-index: 1000;
        display: none;
        overflow: hidden;
        animation: slideDown 0.2s ease;
    }

    /* Menu cho tin nh·∫Øn customer (b√™n ph·∫£i m√†n h√¨nh) - m·ªü v·ªÅ ph√≠a tr√°i ƒë·ªÉ kh√¥ng b·ªã che */
    .message-options.customer-message .message-options-menu {
        left: auto;
        right: calc(100% + 4px);
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-options-menu.show {
        display: block;
    }

    .message-options-menu button.menu-item {
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
        padding: 12px 16px;
        border: none;
        background: transparent;
        color: #374151;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        text-align: left;
        transition: all 0.15s ease;
        border-bottom: 1px solid #f3f4f6;
    }

    .message-options-menu button.menu-item:last-child {
        border-bottom: none;
    }

    .message-options-menu button.menu-item i {
        width: 18px;
        font-size: 14px;
        color: #6b7280;
        transition: color 0.15s ease;
    }

    .message-options-menu button.menu-item:hover {
        background: #f9fafb;
    }

    .message-options-menu button.menu-item:hover i {
        color: #374151;
    }

    .message-options-menu button.delete-btn:hover {
        background: #fef2f2;
        color: #dc2626;
    }

    .message-options-menu button.delete-btn:hover i {
        color: #dc2626;
    }

    .message-options-menu button i {
        width: 16px;
        text-align: center;
    }

    /* Multi-select mode */
    .message-checkbox {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        width: 22px;
        height: 22px;
        cursor: pointer;
        opacity: 0;
        transition: all 0.3s ease;
        appearance: none;
        -webkit-appearance: none;
        border: 2px solid #d1d5db;
        border-radius: 6px;
        background: white;
    }

    /* Checkbox cho tin nh·∫Øn b√™n tr√°i (customer) - ƒë·∫∑t b√™n ph·∫£i */
    .message-checkbox-left {
        right: -45px;
        left: auto;
    }

    /* Checkbox cho tin nh·∫Øn b√™n ph·∫£i (staff) - ƒë·∫∑t b√™n ph·∫£i */
    .message-checkbox-right {
        right: -45px;
        left: auto;
    }

    /* Khi ·ªü multi-select mode, ƒë∆∞a checkbox v√†o g·∫ßn h∆°n */
    .multi-select-mode .message-checkbox-left,
    .multi-select-mode .message-checkbox-right {
        right: 10px;
    }

    .message-checkbox:checked {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-color: #667eea;
    }

    .message-checkbox:checked::after {
        content: '\f00c';
        font-family: 'Font Awesome 5 Free';
        font-weight: 900;
        color: white;
        font-size: 12px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }

    .multi-select-mode .message-checkbox {
        opacity: 1;
    }

    /* Th√™m padding cho container khi ·ªü multi-select mode */
    #chat-messages.multi-select-mode {
        padding-right: 50px !important;
        transition: padding-right 0.3s ease;
    }

    .multi-select-mode .d-flex.mb-3 {
        padding-right: 0;
        position: relative;
        transition: padding-right 0.3s ease;
    }

    #chat-messages::-webkit-scrollbar {
        width: 8px;
    }

    #chat-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    #chat-messages::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 4px;
    }

    #chat-messages::-webkit-scrollbar-thumb:hover {
        background: #555;
    }

    /* Quick Replies */
    #quick-replies-section {
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        animation: slideDown 0.3s ease;
    }

    @@keyframes slideDown {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .quick-reply-btn {
        font-size: 13px;
        padding: 8px 16px;
        border-radius: 24px;
        transition: all 0.3s;
        white-space: nowrap;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        font-weight: 500;
    }

    .quick-reply-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.3);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .gap-2 {
        gap: 8px;
    }

    /* Fullscreen mode */
    .chat-window-card.fullscreen {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw !important;
        height: 100vh !important;
        z-index: 9999;
        margin: 0;
        border-radius: 0;
        max-width: none;
    }

    .chat-window-card.fullscreen .card-body {
        height: calc(100vh - 160px) !important;
    }

    /* ƒê·∫£m b·∫£o Bootstrap modals hi·ªÉn th·ªã tr√™n fullscreen */
    .modal {
        z-index: 10002 !important;
    }

    .modal-backdrop {
        z-index: 10001 !important;
    }

    /* Attachment & Image Dropdown Styling */
    #attachmentDropdown, #imageDropdown {
        transition: all 0.3s ease;
    }

    #attachmentDropdown:hover, #imageDropdown:hover {
        background-color: #f8f9fa;
        border-color: #6c757d;
        transform: translateY(-2px);
    }
    
    /* Camera Modal */
    #cameraModal .modal-lg {
        max-width: 700px;
    }
    
    #cameraModal .modal-content {
        overflow: hidden;
    }
    
    #cameraModal .modal-body {
        transition: opacity 0.1s ease;
    }
    
    #camera-video {
        display: block;
        margin: 0 auto;
        background: #000;
    }
    
    /* Responsive Camera Modal */
    @@media (max-width: 768px) {
        #cameraModal .modal-lg {
            max-width: 95%;
            margin: 0.5rem;
        }
        
        #camera-video {
            height: 350px !important;
        }
        
        #capture-photo-btn {
            width: 55px !important;
            height: 55px !important;
        }
        
        #capture-photo-btn i {
            font-size: 26px !important;
        }
    }
    
    #capture-photo-btn {
        transition: all 0.2s ease;
        position: relative;
    }
    
    #capture-photo-btn:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 30px rgba(255,255,255,0.4) !important;
    }
    
    #capture-photo-btn:active {
        transform: scale(0.95);
    }
    
    #capture-photo-btn i {
        color: #dc3545;
    }
    
    /* Image Preview Modal */
    #imagePreviewModal .modal-body {
        background: #f8f9fa;
        padding: 20px;
    }
    
    #imagePreviewModal img {
        border: 3px solid #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .dropdown-menu {
        border: none;
        border-radius: 12px;
        padding: 8px;
        animation: dropdownSlide 0.2s ease-out;
    }

    @@keyframes dropdownSlide {
        from {
            opacity: 0;
            transform: translateY(-10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .dropdown-item {
        border-radius: 8px;
        transition: all 0.2s ease;
        font-size: 14px;
        font-weight: 500;
    }

    .dropdown-item:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transform: translateX(5px);
        padding-left: 16px;
    }

    .dropdown-item i {
        transition: transform 0.2s ease;
    }

    .dropdown-item:hover i {
        transform: scale(1.2);
    }

    .dropdown-divider {
        border-color: #e9ecef;
    }

    /* Toast Animations */
    @@keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(100px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    @@keyframes slideOutRight {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(100px);
        }
    }

    /* Tag Badge Styles */
    .conversation-tag-badge {
        font-size: 10px;
        padding: 3px 6px;
        border-radius: 4px;
    }

    /* Working Hours Badge for Admin */
    .working-hours-admin-badge {
        background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
        border: 2px solid #0ea5e9;
        border-radius: 20px;
        padding: 8px 16px;
        font-size: 13px;
        font-weight: 600;
        color: #0c4a6e;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
    }

    .working-hours-admin-badge:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .working-hours-admin-badge i {
        font-size: 16px;
        color: #0ea5e9;
    }

    .working-hours-admin-badge.closed {
        background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
        border-color: #ef4444;
        color: #991b1b;
    }

    .working-hours-admin-badge.closed i {
        color: #ef4444;
    }

    /* Empty State Animation */
    @@keyframes float {
        0%, 100% {
            transform: translateY(0px);
        }
        50% {
            transform: translateY(-15px);
        }
    }

    /* Search Highlight */
    .search-highlight {
        background-color: #fbbf24 !important;
        color: #000000 !important;
        font-weight: 700 !important;
        padding: 3px 6px !important;
        border-radius: 4px !important;
        box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.6) !important;
        display: inline !important;
        position: relative !important;
        z-index: 10 !important;
    }

    .search-highlight.current {
        background-color: #f59e0b !important;
        color: #ffffff !important;
        box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.8) !important;
        animation: pulse 1s ease-in-out infinite;
        z-index: 20 !important;
    }

    @@keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.5);
        }
        50% {
            box-shadow: 0 0 0 6px rgba(245, 158, 11, 0.3);
        }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.0/signalr.min.js"></script>
<script>
    let chatConnection = null;
    let currentConversationId = null;
    let currentUserId = null; // User ID c·ªßa conversation hi·ªán t·∫°i
    let typingTimeout = null;

    document.addEventListener('DOMContentLoaded', function() {
        initAdminChat();
    });

    async function initAdminChat() {
        console.log('üöÄ B·∫Øt ƒë·∫ßu initAdminChat()');
        // Connect to SignalR
        await connectSignalR();
        console.log('üöÄ Sau khi connectSignalR - chatConnection:', chatConnection);

        // Load conversations
        await loadConversations();

        // Setup event listeners
        setupEventListeners();

        // Check if conversationId is in URL and open it
        const urlParams = new URLSearchParams(window.location.search);
        const conversationIdParam = urlParams.get('conversationId');
        if (conversationIdParam) {
            const conversationId = parseInt(conversationIdParam);
            // Wait a bit for conversations to load, then open
            setTimeout(() => {
                const conversationElement = document.querySelector(`[data-conversation-id="${conversationId}"]`);
                if (conversationElement) {
                    conversationElement.click();
                } else {
                    console.warn('Conversation not found:', conversationId);
                }
            }, 500);
        }

        // Load working hours
        loadAdminWorkingHours();
        setInterval(loadAdminWorkingHours, 60000); // Update every minute

        // Refresh conversations every 30 seconds
        setInterval(loadConversations, 30000);
    }

    async function loadAdminWorkingHours() {
        try {
            const response = await fetch('/api/supportchat/working-hours');
            if (!response.ok) throw new Error('Failed to load working hours');

            const data = await response.json();
            
            const badge = document.getElementById('admin-working-hours');
            const text = document.getElementById('admin-working-hours-text');
            
            if (data.isOpen) {
                text.textContent = `${data.workingHours} ‚Ä¢ ${data.nextAvailable}`;
                badge.classList.remove('closed');
            } else {
                text.textContent = `Ngo√†i gi·ªù ‚Ä¢ ${data.nextAvailable}`;
                badge.classList.add('closed');
            }
            
        } catch (error) {
            console.error('Error loading working hours:', error);
        }
    }

    async function connectSignalR() {
        console.log('üîå ƒêang k·∫øt n·ªëi ChatHub...');
        chatConnection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .withAutomaticReconnect()
            .build();
        console.log('üîå ChatConnection ƒë√£ kh·ªüi t·∫°o:', chatConnection);

        // Receive message
        chatConnection.on("ReceiveMessage", function(data) {
            if (data.conversationId === currentConversationId) {
                displayMessage(data);
                scrollToBottom();
                
                // Mark as read
                chatConnection.invoke('MarkAsRead', currentConversationId).catch(err => console.error(err));
                
                // C·∫≠p nh·∫≠t last message trong conversation list
                updateConversationLastMessage(currentConversationId, data.message, data.imageUrl, data.senderName, data.isFromStaff);
            } else {
                // Tin nh·∫Øn t·ª´ conversation kh√°c
                // Reload to√†n b·ªô conversation list ƒë·ªÉ ƒë·∫£m b·∫£o lu√¥n c·∫≠p nh·∫≠t
                loadConversations();
            }
        });

        // Typing indicator
        chatConnection.on("UserTyping", function(data) {
            if (data.conversationId === currentConversationId && !data.isStaff) {
                document.getElementById('typing-indicator').style.display = 'block';
            }
        });

        chatConnection.on("UserStoppedTyping", function(data) {
            if (data.conversationId === currentConversationId) {
                document.getElementById('typing-indicator').style.display = 'none';
            }
        });

        // Handle errors from server
        chatConnection.on("Error", function(message) {
            alert(message);
        });

        // Messages read - Update status icons
        chatConnection.on("MessagesRead", function(data) {
            if (data.conversationId === currentConversationId && data.readBy === 'customer') {
                // Update all staff messages to show "read" status
                const staffMessages = document.querySelectorAll('#chat-messages .justify-content-end');
                staffMessages.forEach(msgDiv => {
                    const statusSpan = msgDiv.querySelector('.message-status');
                    if (statusSpan) {
                        statusSpan.className = 'message-status read';
                        statusSpan.innerHTML = '<i class="fas fa-check-double"></i> ƒê√£ xem';
                    }
                });
            }
        });

        // User online/offline status changed
        chatConnection.on("UserStatusChanged", function(userId, isOnline, lastSeenAt) {
            // N·∫øu ƒëang xem conversation c·ªßa user n√†y, c·∫≠p nh·∫≠t status
            if (currentConversationId) {
                const response = fetch(`/api/supportchat/conversation/${currentConversationId}`)
                    .then(res => res.json())
                    .then(conv => {
                        if (conv.customerId === userId) {
                            // C·∫≠p nh·∫≠t status text
                            const onlineStatusHtml = getOnlineStatusHtml(isOnline, lastSeenAt);
                            const statusElement = document.getElementById('chat-customer-status');
                            const currentHtml = statusElement.innerHTML;
                            
                            // Gi·ªØ nguy√™n ph·∫ßn sau d·∫•u ‚Ä¢ v√† ch·ªâ thay ƒë·ªïi ph·∫ßn status
                            const parts = currentHtml.split('‚Ä¢');
                            if (parts.length > 1) {
                                statusElement.innerHTML = `${onlineStatusHtml} ‚Ä¢${parts[1]}`;
                            }
                            
                            // C·∫≠p nh·∫≠t hi·ªÉn th·ªã ch·∫•m xanh
                            const statusDot = document.querySelector('.chat-avatar-wrapper .customer-status-dot');
                            if (statusDot) {
                                statusDot.style.display = isOnline ? 'block' : 'none';
                            }
                        }
                    });
            }
        });

        // Listen for message recall events
        // Spam block notification for admin
        chatConnection.on("SpamBlockNotification", function(data) {
            console.log('User auto-blocked for spam:', data);
            
            // Show notification toast
            showSpamBlockNotification(data);
            
            // Refresh conversation list to update UI
            loadConversations();
        });

        chatConnection.on("MessageRecalled", function(data) {
            console.log('Message recalled:', data);
            
            // T√¨m v√† c·∫≠p nh·∫≠t tin nh·∫Øn trong UI
            const messageElements = document.querySelectorAll('.message');
            messageElements.forEach(msgEl => {
                if (msgEl.dataset.messageId == data.messageId) {
                    const contentDiv = msgEl.querySelector('.message-content');
                    if (contentDiv) {
                        const bubbleOrContent = contentDiv.querySelector('.message-bubble') || contentDiv;
                        bubbleOrContent.innerHTML = `
                            <div style="font-style: italic; color: #9ca3af;">
                                <i class="fas fa-ban"></i> Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi
                            </div>
                        `;
                        
                        // Remove status if exists
                        const statusSpan = msgEl.querySelector('.message-status');
                        if (statusSpan) {
                            statusSpan.remove();
                        }
                    }
                }
            });
            
            // C·∫≠p nh·∫≠t last message trong conversation list
            const convItems = document.querySelectorAll('.conversation-item');
            convItems.forEach(item => {
                if (parseInt(item.dataset.conversationId) === data.conversationId) {
                    const lastMessageP = item.querySelector('p.mb-1.small');
                    if (lastMessageP) {
                        lastMessageP.innerHTML = '<i class="fas fa-ban"></i> Tin nh·∫Øn ƒë√£ ƒë∆∞·ª£c thu h·ªìi';
                        lastMessageP.style.color = '#9ca3af';
                        lastMessageP.style.fontStyle = 'italic';
                    }
                }
            });
        });

        try {
            await chatConnection.start();
            console.log('‚úÖ Admin chat connected - chatConnection:', chatConnection);
        } catch (error) {
            console.error('‚ùå SignalR connection error:', error);
            chatConnection = null;
        }
    }

    let currentFilter = 'all';

    function setupEventListeners() {
        const sendBtn = document.getElementById('send-message-btn');
        const messageInput = document.getElementById('message-input');
        const assignBtn = document.getElementById('assign-to-me-btn');
        const closeBtn = document.getElementById('close-conversation-btn');

        // Filter buttons
        document.querySelectorAll('.btn-filter').forEach(btn => {
            btn.addEventListener('click', function() {
                document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFilter = this.dataset.filter;
                loadConversations();
            });
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Quick replies toggle
        const quickRepliesToggle = document.getElementById('quick-replies-toggle-btn');
        const quickRepliesSection = document.getElementById('quick-replies-section');
        
        quickRepliesToggle.addEventListener('click', function() {
            if (quickRepliesSection.style.display === 'none') {
                quickRepliesSection.style.display = 'block';
            } else {
                quickRepliesSection.style.display = 'none';
            }
        });

        // Quick reply buttons
        document.addEventListener('click', function(e) {
            if (e.target.closest('.quick-reply-btn')) {
                const btn = e.target.closest('.quick-reply-btn');
                let message = btn.getAttribute('data-message');
                
                // L∆∞u message g·ªëc ƒë·ªÉ g·ª≠i sau n√†y
                messageInput.setAttribute('data-original-message', message);
                
                // N·∫øu c√≥ QUICK_ACTIONS, format ƒë·∫πp ƒë·ªÉ hi·ªÉn th·ªã
                if (message.includes('[QUICK_ACTIONS]') && message.includes('[/QUICK_ACTIONS]')) {
                    const startIndex = message.indexOf('[QUICK_ACTIONS]') + 15;
                    const endIndex = message.indexOf('[/QUICK_ACTIONS]');
                    const mainMessage = message.substring(0, message.indexOf('[QUICK_ACTIONS]')).trim();
                    const actionsText = message.substring(startIndex, endIndex).trim();
                    const actions = actionsText.split('\n').filter(line => line.trim() && line.includes('|'));
                    
                    // T·∫°o message hi·ªÉn th·ªã ƒë·∫πp
                    let displayMessage = mainMessage + '\n\n';
                    actions.forEach(action => {
                        const [label] = action.split('|').map(s => s.trim());
                        displayMessage += label + '\n';
                    });
                    
                    messageInput.value = displayMessage.trim();
                } else {
                    messageInput.value = message;
                }
                
                // Trigger auto-resize
                messageInput.style.height = 'auto';
                messageInput.style.height = Math.min(messageInput.scrollHeight, 150) + 'px';
                
                messageInput.focus();
                quickRepliesSection.style.display = 'none';
            }
        });

        // Image upload handlers
        let currentImageFile = null;
        let imagePreviewModal = null;

        // Choose image from library
        const chooseImageBtn = document.getElementById('choose-image-btn');
        const imageInput = document.getElementById('admin-image-input');
        
        chooseImageBtn.addEventListener('click', function(e) {
            e.preventDefault();
            imageInput.click();
        });

        // Camera functionality
        let cameraStream = null;
        let cameraModal = null;
        const captureImageBtn = document.getElementById('capture-image-btn');
        const cameraVideo = document.getElementById('camera-video');
        const cameraCanvas = document.getElementById('camera-canvas');
        const capturePhotoBtn = document.getElementById('capture-photo-btn');
        const closeCameraBtn = document.getElementById('close-camera-btn');
        const cancelCameraBtn = document.getElementById('cancel-camera-btn');
        
        // Open camera
        captureImageBtn.addEventListener('click', async function(e) {
            e.preventDefault();
            
            try {
                // Request camera access
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } // Use back camera on mobile
                });
                
                cameraVideo.srcObject = cameraStream;
                
                if (!cameraModal) {
                    cameraModal = new bootstrap.Modal(document.getElementById('cameraModal'));
                }
                cameraModal.show();
            } catch (error) {
                console.error('Error accessing camera:', error);
                alert('Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ki·ªÉm tra quy·ªÅn truy c·∫≠p camera c·ªßa tr√¨nh duy·ªát.');
            }
        });
        
        // Stop camera function
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
                cameraVideo.srcObject = null;
            }
        }
        
        // Close camera
        closeCameraBtn.addEventListener('click', function() {
            stopCamera();
            if (cameraModal) {
                cameraModal.hide();
            }
        });
        
        cancelCameraBtn.addEventListener('click', function() {
            stopCamera();
            if (cameraModal) {
                cameraModal.hide();
            }
        });
        
        // Capture photo
        capturePhotoBtn.addEventListener('click', function() {
            // Flash effect
            const modalBody = document.querySelector('#cameraModal .modal-body');
            modalBody.style.opacity = '0.3';
            setTimeout(() => { modalBody.style.opacity = '1'; }, 100);
            
            // Play camera shutter sound (optional)
            // const audio = new Audio('/sounds/camera-shutter.mp3');
            // audio.play().catch(e => console.log('Audio play failed:', e));
            
            // Set canvas size to match video
            cameraCanvas.width = cameraVideo.videoWidth;
            cameraCanvas.height = cameraVideo.videoHeight;
            
            // Draw video frame to canvas
            const context = cameraCanvas.getContext('2d');
            context.drawImage(cameraVideo, 0, 0);
            
            // Convert to blob
            cameraCanvas.toBlob(function(blob) {
                if (!blob) {
                    alert('L·ªói khi ch·ª•p ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
                    return;
                }
                
                // Create file from blob
                const file = new File([blob], 'camera-photo-' + Date.now() + '.jpg', { type: 'image/jpeg' });
                
                // Stop camera
                stopCamera();
                if (cameraModal) {
                    cameraModal.hide();
                }
                
                // Show preview
                handleImageSelection(file);
            }, 'image/jpeg', 0.9);
        });

        // Handle image selection (from library or camera)
        function handleImageSelection(file) {
            if (!file || !file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh h·ª£p l·ªá');
                return;
            }

            currentImageFile = file;
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('preview-image').src = e.target.result;
                if (!imagePreviewModal) {
                    imagePreviewModal = new bootstrap.Modal(document.getElementById('imagePreviewModal'));
                }
                imagePreviewModal.show();
            };
            reader.readAsDataURL(file);
        }

        imageInput.addEventListener('change', function(e) {
            if (this.files && this.files[0]) {
                handleImageSelection(this.files[0]);
            }
            this.value = ''; // Reset input
        });

        // Confirm send image
        document.getElementById('confirm-send-image-btn').addEventListener('click', async function() {
            if (!currentImageFile) {
                alert('Kh√¥ng c√≥ ·∫£nh ƒë·ªÉ g·ª≠i');
                return;
            }
            
            if (!currentConversationId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt cu·ªôc h·ªôi tho·∫°i tr∆∞·ªõc');
                return;
            }

            // Disable button while sending
            const sendBtn = this;
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';

            const formData = new FormData();
            formData.append('image', currentImageFile);
            formData.append('conversationId', currentConversationId);

            try {
                const response = await fetch('/api/supportchat/upload-image', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const result = await response.json();
                    
                    // Send message with image via SignalR
                    await chatConnection.invoke("SendMessage", 
                        currentConversationId, 
                        '[ƒê√£ g·ª≠i ·∫£nh]', // Message text for image
                        result.imageUrl // Attachment URL
                    );

                    // Close modal and reset
                    imagePreviewModal.hide();
                    currentImageFile = null;
                    
                    // Show success (optional)
                    console.log('Image sent successfully');
                } else {
                    const errorData = await response.text();
                    console.error('Upload failed:', errorData);
                    alert('L·ªói khi t·∫£i ·∫£nh l√™n: ' + (errorData || 'Vui l√≤ng th·ª≠ l·∫°i'));
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('L·ªói khi g·ª≠i ·∫£nh: ' + error.message);
            } finally {
                // Re-enable button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> G·ª≠i ·∫£nh';
            }
        });

        // Send product button (dropdown item)
        const sendProductBtn = document.getElementById('send-product-btn');
        sendProductBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!currentConversationId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt cu·ªôc h·ªôi tho·∫°i tr∆∞·ªõc');
                return;
            }
            openProductSearchModal();
        });

        // Send order button (dropdown item)
        const sendOrderBtn = document.getElementById('send-order-btn');
        sendOrderBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!currentConversationId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt cu·ªôc h·ªôi tho·∫°i tr∆∞·ªõc');
                return;
            }
            openOrderSearchModal();
        });

        // Send blog button (dropdown item)
        const sendBlogBtn = document.getElementById('send-blog-btn');
        sendBlogBtn.addEventListener('click', function(e) {
            e.preventDefault();
            if (!currentConversationId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt cu·ªôc h·ªôi tho·∫°i tr∆∞·ªõc');
                return;
            }
            openBlogSearchModal();
        });

        imageInput.addEventListener('change', async function(e) {
            const file = e.target.files[0];
            if (!file) return;

            if (!file.type.startsWith('image/')) {
                alert('Vui l√≤ng ch·ªçn file ·∫£nh');
                return;
            }

            if (file.size > 5 * 1024 * 1024) {
                alert('K√≠ch th∆∞·ªõc ·∫£nh kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB');
                return;
            }

            try {
                const formData = new FormData();
                formData.append('image', file);

                const uploadResponse = await fetch('/api/supportchat/upload-image', {
                    method: 'POST',
                    body: formData
                });

                if (!uploadResponse.ok) throw new Error('Upload failed');

                const uploadResult = await uploadResponse.json();
                const imageUrl = uploadResult.imageUrl;

                const message = `[IMAGE:${imageUrl}]`;
                await chatConnection.invoke('SendMessage', currentConversationId, message, null);

                imageInput.value = '';
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Kh√¥ng th·ªÉ g·ª≠i ·∫£nh. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        });

        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            // Reset height to auto to get the correct scrollHeight
            this.style.height = 'auto';
            // Set height to scrollHeight (content height)
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
            
            // Typing indicator - CH·ªà g·ªçi khi c√≥ n·ªôi dung
            if (chatConnection && currentConversationId && this.value.trim().length > 0) {
                chatConnection.invoke('Typing', currentConversationId).catch(err => console.error(err));
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    chatConnection.invoke('StopTyping', currentConversationId).catch(err => console.error(err));
                }, 1000);
            } else if (chatConnection && currentConversationId) {
                // N·∫øu x√≥a h·∫øt text th√¨ stop typing ngay
                chatConnection.invoke('StopTyping', currentConversationId).catch(err => console.error(err));
            }
        });

        assignBtn.addEventListener('click', assignToMe);
        closeBtn.addEventListener('click', closeConversation);

        // Block/Unblock user
        const blockBtn = document.getElementById('block-user-btn');
        blockBtn.addEventListener('click', handleBlockUser);

        // Fullscreen toggle
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        fullscreenBtn.addEventListener('click', toggleFullscreen);

        // Search in chat
        setupSearchInChat();
    }

    // Global filter state
    let currentSearchText = '';
    let currentTagFilter = '';
    let currentPriorityFilter = '';
    let currentStaffFilter = '';

    // Search in chat state
    let searchInChatResults = [];
    let currentSearchIndex = -1;

    async function loadConversations() {
        try {
            // Build query parameters
            const params = new URLSearchParams();
            if (currentSearchText) params.append('searchText', currentSearchText);
            if (currentTagFilter) params.append('tag', currentTagFilter);
            if (currentPriorityFilter) params.append('priority', currentPriorityFilter);
            if (currentStaffFilter && currentStaffFilter !== 'unassigned') {
                params.append('staffId', currentStaffFilter);
            }

            const url = '/api/supportchat/conversations' + (params.toString() ? '?' + params.toString() : '');
            const response = await fetch(url);
            if (!response.ok) throw new Error('Failed to load conversations');

            let conversations = await response.json();

            // Client-side filter for "unassigned"
            if (currentStaffFilter === 'unassigned') {
                conversations = conversations.filter(c => !c.staffId);
            }

            displayConversations(conversations);
            updateActiveFiltersDisplay();
        } catch (error) {
            console.error('Error loading conversations:', error);
        }
    }

    function displayConversations(conversations) {
        const listContainer = document.getElementById('conversation-list');
        const totalBadge = document.getElementById('total-conversations');

        // Filter conversations based on current filter
        let filteredConversations = conversations;
        if (currentFilter === 'unread') {
            filteredConversations = conversations.filter(conv => conv.unreadByStaff > 0);
        } else if (currentFilter === 'closed') {
            filteredConversations = conversations.filter(conv => conv.isClosed);
        }

        if (filteredConversations.length === 0) {
            listContainer.innerHTML = `
                <div class="text-center p-4 text-muted">
                    <i class="fas fa-inbox fa-2x mb-2"></i>
                    <p>${conversations.length === 0 ? 'Ch∆∞a c√≥ h·ªôi tho·∫°i n√†o' : 'Kh√¥ng c√≥ h·ªôi tho·∫°i ph√π h·ª£p'}</p>
                </div>`;
            totalBadge.textContent = conversations.length;
            return;
        }

        totalBadge.textContent = conversations.length;

        listContainer.innerHTML = filteredConversations.map(conv => {
            // Determine message prefix
            const currentUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
            let messagePrefix = '';
            
            if (conv.lastMessage && conv.lastMessageSenderId) {
                if (conv.lastMessageSenderId === currentUserId) {
                    // Current admin is sender - m√†u xanh
                    messagePrefix = '<span style="color: #6366f1; font-weight: 500;">B·∫°n: </span>';
                } else {
                    // Customer is sender - m√†u x√°m ƒë·∫≠m
                    messagePrefix = '<span style="color: #374151; font-weight: 500;">' + conv.customerName + ': </span>';
                }
            }
            
            // Parse last message ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp h∆°n
            let lastMessageDisplay = conv.lastMessage || 'Ch∆∞a c√≥ tin nh·∫Øn';
            
            if (conv.lastMessage && conv.lastMessage.startsWith('[IMAGE:')) {
                lastMessageDisplay = messagePrefix + 'ƒê√£ g·ª≠i ·∫£nh';
            } else if (conv.lastMessage && conv.lastMessage.startsWith('[ƒê√£ g·ª≠i ·∫£nh]')) {
                lastMessageDisplay = messagePrefix + 'ƒê√£ g·ª≠i ·∫£nh';
            } else if (conv.lastMessage && conv.lastMessage.startsWith('[ATTACHMENT:')) {
                try {
                    // T√¨m v·ªã tr√≠ ƒë√≥ng ngo·∫∑c cu·ªëi c√πng
                    const lastBracket = conv.lastMessage.lastIndexOf(']');
                    let jsonStr;
                    
                    if (lastBracket === -1) {
                        // Message b·ªã c·∫Øt - c·∫ßn x·ª≠ l√Ω c·∫©n th·∫≠n
                        jsonStr = conv.lastMessage.substring(12);
                        
                        // ƒê·∫øm s·ªë l∆∞·ª£ng d·∫•u " ƒë·ªÉ xem c√≥ string ƒëang m·ªü kh√¥ng
                        const quoteCount = (jsonStr.match(/"/g) || []).length;
                        const isStringOpen = quoteCount % 2 === 1; // L·∫ª = c√≥ string ch∆∞a ƒë√≥ng
                        
                        if (isStringOpen) {
                            // C√≥ string ƒëang m·ªü - c·∫Øt t·ª´ d·∫•u : cu·ªëi c√πng tr∆∞·ªõc v·ªã tr√≠ hi·ªán t·∫°i
                            const lastColon = jsonStr.lastIndexOf(':');
                            if (lastColon > 0) {
                                // C·∫Øt ƒë·∫øn tr∆∞·ªõc field b·ªã l·ªói
                                const beforeColon = jsonStr.substring(0, lastColon);
                                const lastComma = beforeColon.lastIndexOf(',');
                                if (lastComma > 0) {
                                    jsonStr = jsonStr.substring(0, lastComma);
                                } else {
                                    // Kh√¥ng c√≥ comma n√†o, ch·ªâ c√≥ 1 field ho√†n ch·ªânh
                                    const firstColon = jsonStr.indexOf(':');
                                    const firstComma = jsonStr.indexOf(',');
                                    if (firstComma > firstColon && firstComma > 0) {
                                        jsonStr = jsonStr.substring(0, firstComma);
                                    }
                                }
                            }
                        }
                        
                        // ƒê·∫£m b·∫£o ƒë√≥ng ngo·∫∑c nh·ªçn
                        if (!jsonStr.endsWith('}')) jsonStr += '}';
                    } else {
                        jsonStr = conv.lastMessage.substring(12, lastBracket);
                    }
                    
                    const attachment = JSON.parse(jsonStr);
                    
                    if (attachment.type === 'product') {
                        let productName = attachment.productName || 'S·∫£n ph·∫©m';
                        // Trim v√† ƒë·∫£m b·∫£o c√≥ n·ªôi dung
                        productName = productName.trim();
                        if (!productName || productName.length === 0) {
                            productName = 'S·∫£n ph·∫©m';
                        }
                        productName = productName.substring(0, 30);
                        lastMessageDisplay = messagePrefix + 'üå∏ ' + productName;
                    } else if (attachment.type === 'order') {
                        lastMessageDisplay = messagePrefix + 'üì¶ ƒê∆°n h√†ng #' + (attachment.orderId || '');
                    } else if (attachment.type === 'blog') {
                        const blogTitle = (attachment.title || 'B√†i vi·∫øt').substring(0, 35);
                        lastMessageDisplay = messagePrefix + 'üì∞ ' + blogTitle;
                    } else {
                        // Fallback cho type kh√¥ng x√°c ƒë·ªãnh
                        lastMessageDisplay = messagePrefix + 'üìé ƒê√≠nh k√®m';
                    }
                } catch (e) {
                    // N·∫øu parse fail ho√†n to√†n, fallback
                    lastMessageDisplay = messagePrefix + 'üìé ƒê√≠nh k√®m';
                }
            } else if (conv.lastMessage) {
                // Normal text message
                lastMessageDisplay = messagePrefix + lastMessageDisplay;
            }
            
            return `
                <div class="conversation-item-wrapper">
                    <button class="conversation-delete-btn" data-delete-id="${conv.id}" title="X√≥a h·ªôi tho·∫°i">
                        <i class="fas fa-trash"></i>
                    </button>
                    <a href="#" class="list-group-item list-group-item-action conversation-item ${conv.unreadByStaff > 0 ? 'unread' : ''} ${conv.id === currentConversationId ? 'active' : ''}" 
                       data-conversation-id="${conv.id}">
                        <div class="d-flex w-100 align-items-start gap-2">
                            <div style="flex-shrink: 0; width: 40px; height: 40px;">
                                ${conv.customerAvatar ? 
                                    `<img src="${conv.customerAvatar}" alt="${conv.customerName}" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #667eea;">` : 
                                    `<i class="fas fa-user-circle text-primary" style="font-size: 40px;"></i>`
                                }
                            </div>
                            <div style="flex: 1; min-width: 0; overflow: hidden;">
                                <h6 class="mb-1 fw-bold" style="color: #111827; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${conv.customerName}
                                </h6>
                                <p class="mb-1 small" style="color: ${lastMessageDisplay.includes('üì¶') || lastMessageDisplay.includes('üå∏') || lastMessageDisplay.includes('üìé') ? '#667eea' : '#6c757d'}; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    ${lastMessageDisplay}
                                </p>
                                <div class="d-flex justify-content-between align-items-center" style="gap: 8px;">
                                    <small class="text-muted" style="flex-shrink: 0;">
                                        <i class="far fa-clock"></i> ${conv.lastMessageAt ? formatTime(conv.lastMessageAt) : ''}
                                    </small>
                                    ${conv.staffName ? `<small class="text-success" style="overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><i class="fas fa-user-check"></i> ${conv.staffName}</small>` : ''}
                                </div>
                            </div>
                            <div style="flex-shrink: 0; text-align: right; min-width: 50px;">
                                ${conv.unreadByStaff > 0 ? `<span class="unread-badge">${conv.unreadByStaff}</span>` : ''}
                                ${conv.isClosed ? `<br><span class="badge bg-secondary" style="font-size: 10px;">ƒê√£ ƒë√≥ng</span>` : ''}
                            </div>
                        </div>
                    </a>
                </div>
            `;
        }).join('');

        // Add click listeners for conversation items
        document.querySelectorAll('.conversation-item').forEach(item => {
            const wrapper = item.closest('.conversation-item-wrapper');
            let startX = 0;
            let isDragging = false;
            let hasDragged = false;

            // Click to open conversation (only if not dragged)
            item.addEventListener('click', function(e) {
                if (!hasDragged) {
                    e.preventDefault();
                    const convId = parseInt(this.dataset.conversationId);
                    openConversation(convId);
                }
                hasDragged = false;
            });

            // Touch events (mobile)
            item.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                isDragging = true;
                hasDragged = false;
            });

            item.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                const currentX = e.touches[0].clientX;
                const diff = startX - currentX;
                
                if (Math.abs(diff) > 10) {
                    hasDragged = true;
                }
                
                if (diff > 50) { // Swipe left
                    wrapper.classList.add('swiped');
                } else if (diff < -20) { // Swipe right
                    wrapper.classList.remove('swiped');
                }
            });

            item.addEventListener('touchend', function() {
                isDragging = false;
            });

            // Mouse events (desktop drag)
            item.addEventListener('mousedown', function(e) {
                startX = e.clientX;
                isDragging = true;
                hasDragged = false;
                e.preventDefault(); // Prevent text selection
            });

            document.addEventListener('mousemove', function(e) {
                if (!isDragging) return;
                
                const currentX = e.clientX;
                const diff = startX - currentX;
                
                if (Math.abs(diff) > 10) {
                    hasDragged = true;
                }
                
                if (diff > 50) { // Drag left
                    wrapper.classList.add('swiped');
                } else if (diff < -20) { // Drag right
                    wrapper.classList.remove('swiped');
                }
            });

            document.addEventListener('mouseup', function() {
                if (isDragging) {
                    isDragging = false;
                    setTimeout(() => {
                        hasDragged = false;
                    }, 100);
                }
            });
        });

        // Add click listeners for delete buttons
        document.querySelectorAll('.conversation-delete-btn').forEach(btn => {
            btn.addEventListener('click', async function(e) {
                e.stopPropagation();
                const convId = parseInt(this.dataset.deleteId);
                await deleteConversation(convId);
            });
        });
    }

    async function deleteConversation(conversationId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA Vƒ®NH VI·ªÑN h·ªôi tho·∫°i n√†y?\n\nTo√†n b·ªô tin nh·∫Øn s·∫Ω b·ªã x√≥a v√† kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) {
            return;
        }

        try {
            const response = await fetch(`/api/supportchat/conversation/${conversationId}`, {
                method: 'DELETE'
            });

            if (!response.ok) throw new Error('Failed to delete');

            const result = await response.json();
            alert(result.message || 'ƒê√£ x√≥a h·ªôi tho·∫°i th√†nh c√¥ng');

            // Close chat if current conversation was deleted
            if (currentConversationId === conversationId) {
                currentConversationId = null;
                document.getElementById('chat-header').style.display = 'none';
                document.getElementById('chat-input-area').style.display = 'none';
                document.getElementById('chat-messages').innerHTML = `
                    <div class="text-center p-5 text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p>
                    </div>`;
            }

            loadConversations();
        } catch (error) {
            console.error('Error deleting conversation:', error);
            alert('Kh√¥ng th·ªÉ x√≥a h·ªôi tho·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    async function openConversation(conversationId) {
        currentConversationId = conversationId;

        // Update UI
        document.querySelectorAll('.conversation-item').forEach(item => {
            item.classList.remove('active');
            if (parseInt(item.dataset.conversationId) === conversationId) {
                item.classList.add('active');
            }
        });

        // Show chat UI
        document.getElementById('chat-header').style.display = 'block';

        // Load conversation details
        try {
            const response = await fetch(`/api/supportchat/conversation/${conversationId}`);
            if (!response.ok) throw new Error('Failed to load conversation');

            const conv = await response.json();
            
            // L∆ØU USER ID c·ªßa conversation hi·ªán t·∫°i (API tr·∫£ v·ªÅ customerId)
            currentUserId = conv.customerId;
            
            // L·∫•y ID c·ªßa user ƒëang ƒëƒÉng nh·∫≠p
            const loggedInUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
            
            document.getElementById('chat-customer-name').textContent = conv.customerName;
            
            // C·∫≠p nh·∫≠t avatar ng∆∞·ªùi d√πng ·ªü header
            const avatarElement = document.getElementById('chat-customer-avatar');
            if (conv.customerAvatar) {
                avatarElement.innerHTML = `<img src="${conv.customerAvatar}" alt="${conv.customerName}" style="width: 100%; height: 100%; object-fit: cover;">`;
            } else {
                avatarElement.innerHTML = '<i class="fas fa-user-circle fa-2x"></i>';
            }
            
            // Hi·ªÉn th·ªã/·∫©n ch·∫•m xanh d·ª±a v√†o online status
            const statusDot = document.querySelector('.chat-avatar-wrapper .customer-status-dot');
            if (statusDot) {
                statusDot.style.display = conv.isCustomerOnline ? 'block' : 'none';
            }
            
            const assignBtn = document.getElementById('assign-to-me-btn');
            const inputArea = document.getElementById('chat-input-area');
            const statusElement = document.getElementById('chat-customer-status');
            
            // Hi·ªÉn th·ªã tr·∫°ng th√°i online/offline
            const onlineStatusHtml = getOnlineStatusHtml(conv.isCustomerOnline, conv.customerLastSeenAt);
            
            // Ki·ªÉm tra role c·ªßa user hi·ªán t·∫°i
            const isAdmin = '@User.IsInRole("Admin")' === 'True';
            
            // Ki·ªÉm tra quy·ªÅn g·ª≠i tin nh·∫Øn
            if (!conv.staffId) {
                // Ch∆∞a c√≥ staff - hi·ªán n√∫t Nh·∫≠n
                statusElement.innerHTML = `${onlineStatusHtml} ‚Ä¢ <span class="text-warning"><i class="fas fa-exclamation-circle"></i> Ch∆∞a c√≥ nh√¢n vi√™n h·ªó tr·ª£ - Nh·∫•n "Nh·∫≠n" ƒë·ªÉ t∆∞ v·∫•n</span>`;
                assignBtn.style.display = 'inline-block';
                // Admin v·∫´n c√≥ th·ªÉ chat ngay c·∫£ khi ch∆∞a c√≥ staff
                inputArea.style.display = isAdmin ? 'block' : 'none';
            } else if (conv.staffId === loggedInUserId) {
                // Staff hi·ªán t·∫°i ƒëang ph·ª• tr√°ch - cho ph√©p chat
                statusElement.innerHTML = `${onlineStatusHtml} ‚Ä¢ <span class="text-success"><i class="fas fa-check-circle"></i> B·∫°n ƒëang h·ªó tr·ª£ kh√°ch h√†ng n√†y</span>`;
                assignBtn.style.display = 'none';
                inputArea.style.display = 'block';
            } else {
                // Staff kh√°c ƒëang ph·ª• tr√°ch
                statusElement.innerHTML = `${onlineStatusHtml} ‚Ä¢ <span class="text-info"><i class="fas fa-user-check"></i> ${conv.staffName} ƒëang h·ªó tr·ª£</span>`;
                assignBtn.style.display = 'none';
                // Admin c√≥ th·ªÉ can thi·ªáp, Manager/Staff kh√¥ng ƒë∆∞·ª£c
                inputArea.style.display = isAdmin ? 'block' : 'none';
            }

            // Update tag display
            updateTagDisplay(conv.tag, conv.priority);

            // Show/hide block button based on user role and blocked status
            const blockBtn = document.getElementById('block-user-btn');
            if (isAdmin || '@User.IsInRole("Manager")' === 'True') {
                blockBtn.style.display = 'inline-block';
                if (conv.isBlockedFromChat) {
                    blockBtn.className = 'btn btn-sm btn-success';
                    blockBtn.innerHTML = '<i class="fas fa-check-circle"></i>';
                    blockBtn.title = 'M·ªü ch·∫∑n ng∆∞·ªùi d√πng';
                } else {
                    blockBtn.className = 'btn btn-sm btn-warning';
                    blockBtn.innerHTML = '<i class="fas fa-ban"></i>';
                    blockBtn.title = 'Ch·∫∑n ng∆∞·ªùi d√πng';
                }
            } else {
                blockBtn.style.display = 'none';
            }

            // Join conversation
            if (chatConnection) {
                await chatConnection.invoke('JoinConversation', conversationId);
            }

            // Load messages
            await loadMessages(conversationId);

            // Mark as read
            if (chatConnection) {
                await chatConnection.invoke('MarkAsRead', conversationId);
            }

            // Refresh conversation list to update unread count
            setTimeout(loadConversations, 500);
            
            // Update badge count on notification icon (in layout)
            setTimeout(async () => {
                try {
                    const response = await fetch('/api/supportchat/unread-count');
                    if (response.ok) {
                        const data = await response.json();
                        const badge = window.parent.document.getElementById('messageCount') || document.getElementById('messageCount');
                        if (badge) {
                            if (data.unreadCount > 0) {
                                badge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
                                badge.style.display = 'inline-block';
                            } else {
                                badge.style.display = 'none';
                            }
                        }
                    }
                } catch (e) {
                    console.error('Error updating badge:', e);
                }
            }, 600);

        } catch (error) {
            console.error('Error opening conversation:', error);
        }
    }

    async function loadMessages(conversationId) {
        try {
            const response = await fetch(`/api/supportchat/conversation/${conversationId}/messages?pageSize=100`);
            if (!response.ok) throw new Error('Failed to load messages');

            const messages = await response.json();
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';

            if (messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="text-center p-5 text-muted">
                        <i class="fas fa-comments fa-3x mb-3"></i>
                        <p>Ch∆∞a c√≥ tin nh·∫Øn. H√£y b·∫Øt ƒë·∫ßu tr√≤ chuy·ªán!</p>
                    </div>`;
            } else {
                messages.forEach(msg => displayMessage(msg));
            }

            scrollToBottom();
        } catch (error) {
            console.error('Error loading messages:', error);
        }
    }

    function displayMessage(data) {
        const messagesContainer = document.getElementById('chat-messages');
        const emptyMsg = messagesContainer.querySelector('.text-center');
        if (emptyMsg) emptyMsg.remove();

        const messageDiv = document.createElement('div');
        messageDiv.className = `d-flex ${data.isFromStaff ? 'justify-content-end' : 'justify-content-start'} mb-3`;

        const time = new Date(data.sentAt).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

        let messageContent = '';
        
        // Check if message has attachment (image)
        if (data.attachmentUrl) {
            messageContent = `
                <div style="max-width: 250px;">
                    <img src="${data.attachmentUrl}" alt="Sent image" onclick="openAdminImageLightbox('${data.attachmentUrl}')" 
                         style="width: 100%; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>`;
        }
        // Check if message is image (old format)
        else if (data.message.startsWith('[IMAGE:')) {
            const imageUrl = data.message.substring(7, data.message.length - 1);
            messageContent = `
                <div style="max-width: 250px;">
                    <img src="${imageUrl}" alt="Sent image" onclick="openAdminImageLightbox('${imageUrl}')" 
                         style="width: 100%; border-radius: 12px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                </div>`;
        } else if (data.message.startsWith('[ATTACHMENT:')) {
            try {
                const jsonStr = data.message.substring(12, data.message.length - 1);
                const attachment = JSON.parse(jsonStr);
                
                if (attachment.type === 'product') {
                    // Chuy·ªÉn URL sang admin product details
                    const productId = attachment.productId || attachment.id;
                    const adminUrl = `/Admin/AdminProduct/Details/${productId}`;
                    const headerText = data.isFromStaff ? 'B·∫°n ƒë√£ gi·ªõi thi·ªáu s·∫£n ph·∫©m' : 'Kh√°ch h√†ng ƒëang h·ªèi v·ªÅ s·∫£n ph·∫©m';
                    messageContent = `
                        <div class="attachment-card" data-preview-url="${adminUrl}" style="cursor: pointer; max-width: 320px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div style="background: #f9fafb; padding: 10px 15px; font-size: 13px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                                ${headerText}
                            </div>
                            <div style="display: flex; gap: 12px; padding: 15px;">
                                <img src="${attachment.imageUrl}" alt="${attachment.productName}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">
                                <div style="flex: 1; min-width: 0;">
                                    <h6 style="font-size: 14px; font-weight: 600; color: #111827; margin: 0 0 6px  0; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${attachment.productName}</h6>
                                    <div style="display: flex; flex-direction: column; gap: 2px;">
                                        <span style="font-size: 16px; font-weight: 700; color: #ef4444;">${attachment.discountPrice && attachment.discountPrice < attachment.price ? attachment.discountPrice.toLocaleString('vi-VN') : attachment.price.toLocaleString('vi-VN')}ƒë</span>
                                        ${attachment.discountPrice && attachment.discountPrice < attachment.price ? `<span style="font-size: 12px; color: #9ca3af; text-decoration: line-through;">${attachment.price.toLocaleString('vi-VN')}ƒë</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="background: #f9fafb; padding: 8px 15px; font-size: 11px; color: #6b7280; border-top: 1px solid #e5e7eb;">
                                <i class="fas fa-external-link-alt"></i> Click ƒë·ªÉ xem chi ti·∫øt trong Admin
                            </div>
                        </div>`;
                } else if (attachment.type === 'order') {
                    // Chuy·ªÉn URL sang admin order details
                    const orderId = attachment.id;
                    const adminUrl = `/Admin/AdminOrder/Details/${orderId}`;
                    const statusColors = {
                        'Ch·ªù x√°c nh·∫≠n': '#fbbf24',
                        'ƒê√£ x√°c nh·∫≠n': '#3b82f6',
                        'ƒêang giao': '#8b5cf6',
                        'ƒê√£ giao': '#10b981',
                        'Ho√†n th√†nh': '#10b981',
                        'ƒê√£ h·ªßy': '#ef4444'
                    };
                    const statusColor = statusColors[attachment.status] || '#6b7280';
                    const headerText = data.isFromStaff ? 'B·∫°n ƒë√£ g·ª≠i th√¥ng tin ƒë∆°n h√†ng' : 'Kh√°ch h√†ng ƒëang h·ªèi v·ªÅ ƒë∆°n h√†ng';
                    
                    messageContent = `
                        <div class="attachment-card" data-preview-url="${adminUrl}" style="cursor: pointer; max-width: 320px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div style="background: #f9fafb; padding: 10px 15px; font-size: 13px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                                ${headerText}
                            </div>
                            <div style="display: flex; gap: 12px; padding: 15px;">
                                <img src="${attachment.imageUrl}" alt="Order" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">
                                <div style="flex: 1; min-width: 0;">
                                    <h6 style="font-size: 14px; font-weight: 600; color: #111827; margin: 0 0 4px 0;">${attachment.orderId}</h6>
                                    <p style="font-size: 12px; color: #6b7280; margin: 0 0 8px 0;">T·ªïng: ${attachment.totalAmount.toLocaleString('vi-VN')}ƒë</p>
                                    <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; background-color: ${statusColor}20; color: ${statusColor};">${attachment.status}</span>
                                </div>
                            </div>
                            <div style="background: #f9fafb; padding: 8px 15px; font-size: 11px; color: #6b7280; border-top: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                                <span>M√£: ${attachment.orderId}</span>
                                <i class="fas fa-external-link-alt"></i>
                            </div>
                        </div>`;
                } else if (attachment.type === 'blog') {
                    const blogUrl = attachment.url || `/Blog/Details/${attachment.blogId}`;
                    const headerText = data.isFromStaff ? '<i class="fas fa-newspaper"></i> B·∫°n ƒë√£ g·ª≠i b√†i vi·∫øt h·ªØu √≠ch' : '<i class="fas fa-newspaper"></i> Kh√°ch h√†ng chia s·∫ª b√†i vi·∫øt';
                    messageContent = `
                        <div class="attachment-card" data-preview-url="${blogUrl}" style="cursor: pointer; max-width: 320px; background: white; border: 1px solid #e5e7eb; border-radius: 12px; overflow: hidden;">
                            <div style="background: #f9fafb; padding: 10px 15px; font-size: 13px; font-weight: 600; color: #6b7280; border-bottom: 1px solid #e5e7eb;">
                                ${headerText}
                            </div>
                            <div style="display: flex; gap: 12px; padding: 15px;">
                                <img src="${attachment.imageUrl || '/images/blog-placeholder.png'}" alt="${attachment.title}" style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; flex-shrink: 0;">
                                <div style="flex: 1; min-width: 0;">
                                    <h6 style="font-size: 14px; font-weight: 600; color: #111827; margin: 0 0 6px 0; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${attachment.title}</h6>
                                    <p style="font-size: 12px; color: #6b7280; margin: 0; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">${attachment.summary || ''}</p>
                                </div>
                            </div>
                            <div style="background: #f9fafb; padding: 8px 15px; font-size: 11px; color: #6b7280; border-top: 1px solid #e5e7eb;">
                                <i class="fas fa-external-link-alt"></i> Click ƒë·ªÉ ƒë·ªçc b√†i vi·∫øt
                            </div>
                        </div>`;
                }
            } catch (e) {
                messageContent = `<div>${escapeHtml(data.message)}</div>`;
            }
        } else {
            // Ki·ªÉm tra xem c√≥ quick actions kh√¥ng
            if (data.message.includes('[QUICK_ACTIONS]') && data.message.includes('[/QUICK_ACTIONS]')) {
                // Parse message v√† actions
                const startIndex = data.message.indexOf('[QUICK_ACTIONS]') + 15;
                const endIndex = data.message.indexOf('[/QUICK_ACTIONS]');
                const mainMessage = data.message.substring(0, data.message.indexOf('[QUICK_ACTIONS]')).trim();
                const actionsText = data.message.substring(startIndex, endIndex).trim();
                const actions = actionsText.split('\n').filter(line => line.trim() && line.includes('|'));
                
                // Format message ch√≠nh
                let formattedMessage = escapeHtml(mainMessage).replace(/\n/g, '<br>');
                
                // Th√™m c√°c options d∆∞·ªõi d·∫°ng list ƒë·∫πp
                formattedMessage += '<br><br>';
                actions.forEach(action => {
                    const [label] = action.split('|').map(s => s.trim());
                    formattedMessage += `${label}<br>`;
                });
                
                messageContent = `<div>${formattedMessage}</div>`;
            } else {
                // Format line breaks for normal text messages
                const formattedMessage = escapeHtml(data.message).replace(/\n/g, '<br>');
                messageContent = `<div>${formattedMessage}</div>`;
            }
        }

        // Determine message status text and icon
        let statusText = '';
        if (data.isFromStaff) {
            // Only show status for staff messages
            if (data.readAt) {
                // ƒê√£ xem (c√≥ ReadAt timestamp)
                statusText = '<span class="message-status read"><i class="fas fa-check-double"></i> ƒê√£ xem</span>';
            } else if (data.isRead) {
                // ƒê√£ nh·∫≠n (IsRead = true nh∆∞ng ch∆∞a c√≥ ReadAt)
                statusText = '<span class="message-status delivered"><i class="fas fa-check-double"></i> ƒê√£ nh·∫≠n</span>';
            } else if (data.id) {
                // ƒê√£ g·ª≠i (c√≥ ID nghƒ©a l√† ƒë√£ l∆∞u v√†o DB)
                statusText = '<span class="message-status sent"><i class="fas fa-check"></i> ƒê√£ g·ª≠i</span>';
            }
        }

        // N·∫øu l√† attachment card ho·∫∑c image, kh√¥ng b·ªçc trong message-bubble
        if (data.attachmentUrl || data.message.startsWith('[ATTACHMENT:')) {
            // For attachments, override status color to be visible on light background
            const attachmentStatusText = statusText.replace('message-status', 'message-status attachment-status');
            
            messageDiv.innerHTML = `
                ${!data.isFromStaff ? `
                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; margin-right: 12px;">
                        ${data.senderAvatar ? `<img src="${data.senderAvatar}" alt="${data.senderName}" style="width: 100%; height: 100%; object-fit: cover;">` : '<i class="fas fa-user-circle" style="font-size: 40px; color: #667eea;"></i>'}
                    </div>
                ` : ''}
                <div style="max-width: 70%;">
                    ${messageContent}
                    <div class="message-time" style="font-size: 11px; color: #6c757d; margin-top: 4px; text-align: ${data.isFromStaff ? 'right' : 'left'}; display: flex; align-items: center; gap: 6px; ${data.isFromStaff ? 'justify-content: flex-end;' : ''}">
                        <span>${time}</span>
                        ${attachmentStatusText}
                    </div>
                </div>
                ${!data.isFromStaff ? `
                    <div class="message-options customer-message" style="margin-left: 8px;">
                        <button class="message-options-btn" data-message-id="${data.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="message-options-menu">
                            <button class="menu-item" onclick="enterMultiSelectMode()">
                                <i class="fas fa-check-square"></i> Ch·ªçn nhi·ªÅu
                            </button>
                            <button class="menu-item delete-btn" onclick="deleteSingleMessage(${data.id})">
                                <i class="fas fa-trash"></i> X√≥a tin nh·∫Øn
                            </button>
                        </div>
                    </div>
                ` : ''}
                ${data.isFromStaff ? `
                    <div class="message-options" style="margin-left: 8px;">
                        <button class="message-options-btn" data-message-id="${data.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="message-options-menu">
                            <button class="menu-item" onclick="enterMultiSelectMode()">
                                <i class="fas fa-check-square"></i> Ch·ªçn nhi·ªÅu
                            </button>
                            <button class="menu-item delete-btn" onclick="deleteSingleMessage(${data.id})">
                                <i class="fas fa-trash"></i> X√≥a tin nh·∫Øn
                            </button>
                        </div>
                    </div>
                    <input type="checkbox" class="message-checkbox message-checkbox-right" data-message-id="${data.id}">
                ` : `
                    <input type="checkbox" class="message-checkbox message-checkbox-left" data-message-id="${data.id}">
                `}
            `;
        } else {
            // Tin nh·∫Øn text b√¨nh th∆∞·ªùng - d√πng bubble v·ªõi avatar
            messageDiv.innerHTML = `
                ${!data.isFromStaff ? `
                    <div style="width: 40px; height: 40px; border-radius: 50%; overflow: hidden; flex-shrink: 0; margin-right: 12px;">
                        ${data.senderAvatar ? `<img src="${data.senderAvatar}" alt="${data.senderName}" style="width: 100%; height: 100%; object-fit: cover;">` : '<i class="fas fa-user-circle" style="font-size: 40px; color: #667eea;"></i>'}
                    </div>
                ` : ''}
                <div class="message-bubble ${data.isFromStaff ? 'message-from-staff' : 'message-from-customer'}">
                    ${messageContent}
                    <div class="message-time text-end">${time} ${statusText}</div>
                </div>
                ${!data.isFromStaff ? `
                    <div class="message-options customer-message" style="margin-left: 8px;">
                        <button class="message-options-btn" data-message-id="${data.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="message-options-menu">
                            <button class="menu-item" onclick="enterMultiSelectMode()">
                                <i class="fas fa-check-square"></i> Ch·ªçn nhi·ªÅu
                            </button>
                            <button class="menu-item delete-btn" onclick="deleteSingleMessage(${data.id})">
                                <i class="fas fa-trash"></i> X√≥a tin nh·∫Øn
                            </button>
                        </div>
                    </div>
                ` : ''}
                ${data.isFromStaff ? `
                    <div class="message-options" style="margin-left: 8px;">
                        <button class="message-options-btn" data-message-id="${data.id}">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <div class="message-options-menu">
                            <button class="menu-item" onclick="enterMultiSelectMode()">
                                <i class="fas fa-check-square"></i> Ch·ªçn nhi·ªÅu
                            </button>
                            <button class="menu-item delete-btn" onclick="deleteSingleMessage(${data.id})">
                                <i class="fas fa-trash"></i> X√≥a tin nh·∫Øn
                            </button>
                        </div>
                    </div>
                    <input type="checkbox" class="message-checkbox message-checkbox-right" data-message-id="${data.id}">
                ` : `
                    <input type="checkbox" class="message-checkbox message-checkbox-left" data-message-id="${data.id}">
                `}
            `;
        }

        messagesContainer.appendChild(messageDiv);
        
        // Add click listener for attachment cards to open in sidebar
        const attachmentCards = messageDiv.querySelectorAll('.attachment-card');
        attachmentCards.forEach(card => {
            card.addEventListener('click', function() {
                const url = this.getAttribute('data-preview-url');
                if (url) {
                    openPreviewSidebar(url);
                }
            });
        });
    }

    async function sendMessage() {
        const input = document.getElementById('message-input');
        let message = input.value.trim();

        if (!message || !chatConnection || !currentConversationId) return;

        try {
            // Ki·ªÉm tra xem c√≥ message g·ªëc (c√≥ QUICK_ACTIONS) kh√¥ng
            const originalMessage = input.getAttribute('data-original-message');
            if (originalMessage) {
                // G·ª≠i message g·ªëc (c√≥ tag) ƒë·ªÉ customer th·∫•y n√∫t
                await chatConnection.invoke('SendMessage', currentConversationId, originalMessage, null);
                // X√≥a attribute sau khi g·ª≠i
                input.removeAttribute('data-original-message');
            } else {
                // G·ª≠i message b√¨nh th∆∞·ªùng
                await chatConnection.invoke('SendMessage', currentConversationId, message, null);
            }
            
            input.value = '';
            
            // Reset textarea height v·ªÅ k√≠ch th∆∞·ªõc ban ƒë·∫ßu
            input.style.height = 'auto';
            
            // Stop typing
            await chatConnection.invoke('StopTyping', currentConversationId);
        } catch (error) {
            console.error('Error sending message:', error);
            alert('Kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    function updateConversationLastMessage(conversationId, message, imageUrl, senderName, isFromStaff) {
        const conversationItem = document.querySelector(`[data-conversation-id="${conversationId}"]`);
        if (!conversationItem) return;
        
        const lastMessageP = conversationItem.querySelector('p.mb-1.small');
        if (!lastMessageP) return;
        
        let displayMessage = '';
        const currentUserId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
        
        // X√°c ƒë·ªãnh prefix d·ª±a v√†o ng∆∞·ªùi g·ª≠i
        let messagePrefix;
        if (isFromStaff) {
            // Staff/Admin g·ª≠i - m√†u xanh
            messagePrefix = '<span style="color: #6366f1; font-weight: 500;">B·∫°n: </span>';
        } else {
            // Customer g·ª≠i - m√†u x√°m v·ªõi t√™n
            messagePrefix = '<span style="color: #374151; font-weight: 500;">' + (senderName || 'Kh√°ch') + ': </span>';
        }
        
        // Parse message ƒë·ªÉ hi·ªÉn th·ªã ƒë·∫πp
        if (message.startsWith('[IMAGE:')) {
            displayMessage = messagePrefix + 'üì∑ ƒê√£ g·ª≠i ·∫£nh';
        } else if (message.startsWith('[ƒê√£ g·ª≠i ·∫£nh]')) {
            displayMessage = messagePrefix + 'üì∑ ƒê√£ g·ª≠i ·∫£nh';
        } else if (message.startsWith('[ATTACHMENT:')) {
            try {
                const lastBracket = message.lastIndexOf(']');
                const jsonStr = message.substring(12, lastBracket);
                const attachment = JSON.parse(jsonStr);
                
                if (attachment.type === 'product') {
                    displayMessage = messagePrefix + 'üå∏ ' + (attachment.productName || 'S·∫£n ph·∫©m').substring(0, 30);
                } else if (attachment.type === 'order') {
                    displayMessage = messagePrefix + 'üì¶ ƒê∆°n h√†ng #' + (attachment.orderId || '');
                } else if (attachment.type === 'blog') {
                    displayMessage = messagePrefix + 'üì∞ ' + (attachment.title || 'B√†i vi·∫øt').substring(0, 35);
                } else {
                    displayMessage = messagePrefix + 'üìé ƒê√≠nh k√®m';
                }
            } catch (e) {
                displayMessage = messagePrefix + 'üìé ƒê√≠nh k√®m';
            }
        } else {
            displayMessage = messagePrefix + message.substring(0, 50);
        }
        
        lastMessageP.innerHTML = displayMessage;
        
        // Move conversation to top
        const conversationsList = document.getElementById('conversations-list');
        conversationsList.prepend(conversationItem);
    }

    async function assignToMe() {
        if (!currentConversationId) return;

        try {
            const userId = '@User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value';
            const response = await fetch(`/api/supportchat/conversation/${currentConversationId}/assign`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ staffId: userId })
            });

            if (!response.ok) throw new Error('Failed to assign');

            // Reload conversation to update UI with new assignment
            await openConversation(currentConversationId);
            loadConversations();
        } catch (error) {
            console.error('Error assigning conversation:', error);
            alert('Kh√¥ng th·ªÉ nh·∫≠n h·ªó tr·ª£. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    async function closeConversation() {
        if (!currentConversationId) return;

        if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒë√≥ng h·ªôi tho·∫°i n√†y?')) return;

        try {
            const response = await fetch(`/api/supportchat/conversation/${currentConversationId}/close`, {
                method: 'PUT'
            });

            if (!response.ok) throw new Error('Failed to close');

            alert('ƒê√£ ƒë√≥ng h·ªôi tho·∫°i');
            currentConversationId = null;
            document.getElementById('chat-header').style.display = 'none';
            document.getElementById('chat-input-area').style.display = 'none';
            document.getElementById('chat-messages').innerHTML = `
                <div class="text-center p-5 text-muted">
                    <i class="fas fa-comments fa-3x mb-3"></i>
                    <p>Ch·ªçn m·ªôt h·ªôi tho·∫°i ƒë·ªÉ b·∫Øt ƒë·∫ßu chat</p>
                </div>`;
            loadConversations();
        } catch (error) {
            console.error('Error closing conversation:', error);
            alert('Kh√¥ng th·ªÉ ƒë√≥ng h·ªôi tho·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    async function handleBlockUser() {
        if (!currentConversationId || !currentUserId) return;

        const blockBtn = document.getElementById('block-user-btn');
        const isCurrentlyBlocked = blockBtn.className.includes('btn-success');

        if (isCurrentlyBlocked) {
            // Unblock user
            if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën m·ªü kh√≥a ng∆∞·ªùi d√πng n√†y?')) return;

            try {
                const response = await fetch('/api/supportchat/unblock-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ userId: currentUserId })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to unblock user');
                }

                // Update UI immediately
                blockBtn.className = 'btn btn-sm btn-warning';
                blockBtn.innerHTML = '<i class="fas fa-ban"></i>';
                blockBtn.title = 'Ch·∫∑n ng∆∞·ªùi d√πng';
                
                // Show success toast
                showSuccessToast('‚úÖ ƒê√£ m·ªü kh√≥a ng∆∞·ªùi d√πng. H·ªç c√≥ th·ªÉ g·ª≠i tin nh·∫Øn tr·ªü l·∫°i.');
            } catch (error) {
                console.error('Error unblocking user:', error);
                alert(error.message || 'Kh√¥ng th·ªÉ m·ªü kh√≥a ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } else {
            // Block user
            const reason = prompt('Nh·∫≠p l√Ω do ch·∫∑n ng∆∞·ªùi d√πng n√†y (t√πy ch·ªçn):');
            if (reason === null) return; // User cancelled

            try {
                const response = await fetch('/api/supportchat/block-user', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId: currentUserId,
                        reason: reason || 'Spam ho·∫∑c vi ph·∫°m quy ƒë·ªãnh'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Failed to block user');
                }

                // Update UI immediately
                blockBtn.className = 'btn btn-sm btn-success';
                blockBtn.innerHTML = '<i class="fas fa-check-circle"></i>';
                blockBtn.title = 'M·ªü ch·∫∑n ng∆∞·ªùi d√πng';
                
                // Show success toast
                showSuccessToast('üö´ ƒê√£ ch·∫∑n ng∆∞·ªùi d√πng. H·ªç kh√¥ng th·ªÉ g·ª≠i tin nh·∫Øn cho ƒë·∫øn khi ƒë∆∞·ª£c m·ªü kh√≥a.');
            } catch (error) {
                console.error('Error blocking user:', error);
                alert(error.message || 'Kh√¥ng th·ªÉ ch·∫∑n ng∆∞·ªùi d√πng. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        }
    }

    function scrollToBottom() {
        const container = document.getElementById('chat-messages');
        container.scrollTop = container.scrollHeight;
    }

    function formatTime(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // seconds

        if (diff < 60) return 'V·ª´a xong';
        if (diff < 3600) return Math.floor(diff / 60) + ' ph√∫t tr∆∞·ªõc';
        if (diff < 86400) return Math.floor(diff / 3600) + ' gi·ªù tr∆∞·ªõc';
        return date.toLocaleDateString('vi-VN');
    }

    function showSpamBlockNotification(data) {
        // Create notification element
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            border: 2px solid #ef4444;
            border-radius: 12px;
            padding: 20px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(239, 68, 68, 0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
        `;
        
        notification.innerHTML = `
            <div style="display: flex; align-items: start; gap: 15px;">
                <i class="fas fa-shield-alt" style="font-size: 32px; color: #ef4444; flex-shrink: 0;"></i>
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 16px; color: #7f1d1d; margin-bottom: 8px;">
                        üö® User b·ªã ch·∫∑n t·ª± ƒë·ªông
                    </div>
                    <div style="font-size: 14px; color: #991b1b; margin-bottom: 8px;">
                        <strong>${data.userName}</strong> ƒë√£ b·ªã h·ªá th·ªëng ch·∫∑n do spam
                    </div>
                    <div style="font-size: 13px; color: #7f1d1d; margin-bottom: 12px;">
                        L√Ω do: ${data.reason}
                    </div>
                    <button onclick="window.openConversation(${data.conversationId}); this.closest('div[style*=\"position: fixed\"]').remove();" 
                            style="width: 100%; padding: 8px 12px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                        <i class="fas fa-eye"></i> Xem cu·ªôc h·ªôi tho·∫°i
                    </button>
                </div>
                <button onclick="this.closest('div[style*=\"position: fixed\"]').remove();" 
                        style="background: none; border: none; color: #7f1d1d; font-size: 20px; cursor: pointer; padding: 0; line-height: 1;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 15 seconds
        setTimeout(() => {
            notification.remove();
        }, 15000);
    }

    function showSuccessToast(message) {
        // Create toast notification
        const toast = document.createElement('div');
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 16px 20px;
            max-width: 400px;
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.3);
            z-index: 9999;
            animation: slideInRight 0.3s ease-out;
            font-size: 14px;
            font-weight: 600;
            color: #064e3b;
        `;
        
        toast.innerHTML = `
            <div style="display: flex; align-items: center; gap: 12px;">
                <i class="fas fa-check-circle" style="font-size: 24px; color: #10b981;"></i>
                <div style="flex: 1;">${message}</div>
                <button onclick="this.closest('div').remove();" 
                        style="background: none; border: none; color: #064e3b; font-size: 18px; cursor: pointer; padding: 0;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
        
        document.body.appendChild(toast);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            toast.style.transition = 'all 0.3s ease-out';
            setTimeout(() => toast.remove(), 300);
        }, 5000);
    }

    function getOnlineStatusHtml(isOnline, lastSeenAt) {
        if (isOnline) {
            return '<span style="color: #10b981;">ƒêang ho·∫°t ƒë·ªông</span>';
        }
        
        if (!lastSeenAt) {
            return '<span style="opacity: 0.7;">Kh√¥ng r√µ</span>';
        }
        
        const date = new Date(lastSeenAt);
        const now = new Date();
        const diffMinutes = Math.floor((now - date) / 1000 / 60);
        
        if (diffMinutes < 1) return '<span style="opacity: 0.7;">Ho·∫°t ƒë·ªông v·ª´a xong</span>';
        if (diffMinutes < 60) return `<span style="opacity: 0.7;">Ho·∫°t ƒë·ªông ${diffMinutes} ph√∫t tr∆∞·ªõc</span>`;
        
        const diffHours = Math.floor(diffMinutes / 60);
        if (diffHours < 24) return `<span style="opacity: 0.7;">Ho·∫°t ƒë·ªông ${diffHours} gi·ªù tr∆∞·ªõc</span>`;
        
        const diffDays = Math.floor(diffHours / 24);
        return `<span style="opacity: 0.7;">Ho·∫°t ƒë·ªông ${diffDays} ng√†y tr∆∞·ªõc</span>`;
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Tag & Priority Functions
    async function setConversationTag(tag, priority) {
        if (!currentConversationId) {
            alert('Vui l√≤ng ch·ªçn m·ªôt h·ªôi tho·∫°i tr∆∞·ªõc');
            return;
        }

        try {
            const response = await fetch(`/api/supportchat/conversation/${currentConversationId}/tag`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ tag, priority })
            });

            if (!response.ok) throw new Error('Failed to update tag');

            const result = await response.json();
            
            // Update UI
            updateTagDisplay(result.tag, result.priority);
            
            // Update conversation list item
            const conversationItem = document.querySelector(`[data-conversation-id="${currentConversationId}"]`);
            if (conversationItem) {
                updateConversationTagBadge(conversationItem, result.tag, result.priority);
            }

            // Show success message
            showToast('‚úÖ ƒê√£ c·∫≠p nh·∫≠t ph√¢n lo·∫°i', 'success');
        } catch (error) {
            console.error('Error updating tag:', error);
            alert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph√¢n lo·∫°i. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    function updateTagDisplay(tag, priority) {
        const tagBadge = document.getElementById('current-tag-badge');
        const tagText = document.getElementById('current-tag-text');
        const priorityBadge = document.getElementById('current-priority-badge');
        const priorityText = document.getElementById('current-priority-text');

        if (tag) {
            tagText.textContent = tag;
            tagBadge.style.display = 'inline-block';
            
            // Set badge color based on tag
            tagBadge.className = 'badge me-2';
            if (tag === 'VIP') tagBadge.classList.add('bg-warning');
            else if (tag === 'Khi·∫øu n·∫°i') tagBadge.classList.add('bg-danger');
            else if (tag === 'T∆∞ v·∫•n') tagBadge.classList.add('bg-info');
            else if (tag === 'ƒê·∫∑t h√†ng') tagBadge.classList.add('bg-success');
            else tagBadge.classList.add('bg-secondary');
        } else {
            tagBadge.style.display = 'none';
        }

        if (priority > 0) {
            const priorityNames = ['Normal', 'Cao', 'Kh·∫©n c·∫•p'];
            priorityText.textContent = priorityNames[priority] || 'Normal';
            priorityBadge.style.display = 'inline-block';
        } else {
            priorityBadge.style.display = 'none';
        }
    }

    function updateConversationTagBadge(conversationItem, tag, priority) {
        let tagBadge = conversationItem.querySelector('.conversation-tag-badge');
        
        if (!tagBadge) {
            tagBadge = document.createElement('span');
            tagBadge.className = 'conversation-tag-badge badge ms-2';
            const nameElement = conversationItem.querySelector('h6');
            if (nameElement) {
                nameElement.appendChild(tagBadge);
            }
        }

        if (tag) {
            tagBadge.textContent = tag;
            tagBadge.style.display = 'inline-block';
            
            // Set color
            tagBadge.className = 'conversation-tag-badge badge ms-2';
            if (tag === 'VIP') tagBadge.classList.add('bg-warning');
            else if (tag === 'Khi·∫øu n·∫°i') tagBadge.classList.add('bg-danger');
            else if (tag === 'T∆∞ v·∫•n') tagBadge.classList.add('bg-info');
            else if (tag === 'ƒê·∫∑t h√†ng') tagBadge.classList.add('bg-success');
            else tagBadge.classList.add('bg-secondary');
        } else {
            tagBadge.style.display = 'none';
        }
    }

    function showToast(message, type = 'info') {
        // Simple toast notification
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 99999; min-width: 250px; animation: slideInRight 0.3s;';
        toast.innerHTML = message;
        document.body.appendChild(toast);
        
        setTimeout(() => {
            toast.style.animation = 'slideOutRight 0.3s';
            setTimeout(() => toast.remove(), 300);
        }, 3000);
    }

    // Preview Modal Functions
    let currentPreviewUrl = '';
    
    function openPreviewSidebar(url) {
        // Th√™m ?modal=true v√†o URL ƒë·ªÉ load view kh√¥ng c√≥ layout
        const modalUrl = url + (url.includes('?') ? '&' : '?') + 'modal=true';
        currentPreviewUrl = url; // Gi·ªØ URL g·ªëc cho n√∫t "M·ªü tab m·ªõi"
        
        const modal = document.getElementById('preview-modal');
        const frame = document.getElementById('preview-frame');
        
        frame.src = modalUrl;
        modal.style.display = 'block';
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }

    function closePreviewModal() {
        const modal = document.getElementById('preview-modal');
        const frame = document.getElementById('preview-frame');
        
        modal.style.display = 'none';
        frame.src = '';
        currentPreviewUrl = '';
        document.body.style.overflow = 'auto';
    }

    function openInNewTab() {
        if (currentPreviewUrl) {
            window.open(currentPreviewUrl, '_blank');
        }
    }

    function openAdminImageLightbox(imageUrl) {
        const lightbox = document.getElementById('admin-image-lightbox');
        const lightboxImage = document.getElementById('admin-lightbox-image');
        lightboxImage.src = imageUrl;
        lightbox.style.display = 'flex';
    }

    function toggleFullscreen() {
        const chatWindow = document.querySelector('.chat-window-card');
        const conversationList = document.querySelector('.col-md-4');
        const fullscreenBtn = document.getElementById('fullscreen-btn');
        const icon = fullscreenBtn.querySelector('i');
        
        if (chatWindow.classList.contains('fullscreen')) {
            // Exit fullscreen
            chatWindow.classList.remove('fullscreen');
            conversationList.style.display = 'block';
            icon.className = 'fas fa-expand';
            fullscreenBtn.title = 'M·ªü r·ªông';
        } else {
            // Enter fullscreen
            chatWindow.classList.add('fullscreen');
            conversationList.style.display = 'none';
            icon.className = 'fas fa-compress';
            fullscreenBtn.title = 'Thu nh·ªè';
        }
    }

    // Setup modal buttons and click outside to close
    document.addEventListener('DOMContentLoaded', function() {
        const closeBtn = document.getElementById('close-modal-btn');
        const openTabBtn = document.getElementById('open-new-tab-btn');
        const modal = document.getElementById('preview-modal');
        
        if (closeBtn) closeBtn.addEventListener('click', closePreviewModal);
        if (openTabBtn) openTabBtn.addEventListener('click', openInNewTab);
        
        // Close on click outside
        if (modal) {
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closePreviewModal();
                }
            });
        }
        
        // Close on ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && modal.style.display === 'block') {
                closePreviewModal();
            }
        });

        // ===== SETUP SEARCH & FILTER LISTENERS =====
        setupSearchAndFilters();
        loadStaffList();
    });

    // Search & Filter Functions
    function setupSearchAndFilters() {
        const searchInput = document.getElementById('search-conversations');
        const clearSearchBtn = document.getElementById('clear-search-btn');
        const filterTag = document.getElementById('filter-tag');
        const filterPriority = document.getElementById('filter-priority');
        const filterStaff = document.getElementById('filter-staff');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');

        let searchTimeout;

        // Search with debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const value = this.value.trim();
            
            clearSearchBtn.style.display = value ? 'block' : 'none';
            
            searchTimeout = setTimeout(() => {
                currentSearchText = value;
                loadConversations();
            }, 500);
        });

        // Clear search
        clearSearchBtn.addEventListener('click', function() {
            searchInput.value = '';
            currentSearchText = '';
            this.style.display = 'none';
            loadConversations();
        });

        // Tag filter
        filterTag.addEventListener('change', function() {
            currentTagFilter = this.value;
            loadConversations();
        });

        // Priority filter
        filterPriority.addEventListener('change', function() {
            currentPriorityFilter = this.value;
            loadConversations();
        });

        // Staff filter
        filterStaff.addEventListener('change', function() {
            currentStaffFilter = this.value;
            loadConversations();
        });

        // Clear all filters
        clearFiltersBtn.addEventListener('click', function() {
            searchInput.value = '';
            clearSearchBtn.style.display = 'none';
            filterTag.value = '';
            filterPriority.value = '';
            filterStaff.value = '';
            
            currentSearchText = '';
            currentTagFilter = '';
            currentPriorityFilter = '';
            currentStaffFilter = '';
            
            loadConversations();
        });
    }

    function updateActiveFiltersDisplay() {
        const activeFiltersDiv = document.getElementById('active-filters');
        const badgesDiv = document.getElementById('active-filters-badges');
        const badges = [];

        if (currentSearchText) {
            badges.push(`<span class="badge bg-primary me-1"><i class="fas fa-search"></i> "${currentSearchText}"</span>`);
        }
        if (currentTagFilter) {
            badges.push(`<span class="badge bg-info me-1"><i class="fas fa-tag"></i> ${currentTagFilter}</span>`);
        }
        if (currentPriorityFilter) {
            const priorityText = currentPriorityFilter === '0' ? 'B√¨nh th∆∞·ªùng' : (currentPriorityFilter === '1' ? 'Cao' : 'Kh·∫©n c·∫•p');
            badges.push(`<span class="badge bg-warning me-1"><i class="fas fa-exclamation-circle"></i> ${priorityText}</span>`);
        }
        if (currentStaffFilter) {
            const staffText = currentStaffFilter === 'unassigned' ? 'Ch∆∞a nh·∫≠n' : 'ƒê√£ l·ªçc staff';
            badges.push(`<span class="badge bg-secondary me-1"><i class="fas fa-user"></i> ${staffText}</span>`);
        }

        if (badges.length > 0) {
            badgesDiv.innerHTML = badges.join('');
            activeFiltersDiv.style.display = 'block';
        } else {
            activeFiltersDiv.style.display = 'none';
        }
    }

    async function loadStaffList() {
        try {
            // Get all conversations to extract staff who are actually handling chats
            const convResponse = await fetch('/api/supportchat/conversations');
            if (!convResponse.ok) return;
            const conversations = await convResponse.json();
            
            // Get unique staff from conversations
            const staffMap = new Map();
            conversations.forEach(conv => {
                if (conv.staffId && conv.staffName) {
                    staffMap.set(conv.staffId, conv.staffName);
                }
            });

            // Also get all available staff (Admin/Manager/Staff) for complete list
            const staffResponse = await fetch('/api/supportchat/staff-list');
            let allStaff = [];
            if (staffResponse.ok) {
                allStaff = await staffResponse.json();
            }

            const filterStaff = document.getElementById('filter-staff');
            const currentValue = filterStaff.value;
            
            // Keep existing options (empty and unassigned)
            const existingOptions = filterStaff.querySelectorAll('option:not([value="unassigned"]):not([value=""])');
            existingOptions.forEach(opt => opt.remove());

            // Add all staff options with name and role
            allStaff.forEach(staff => {
                const option = document.createElement('option');
                option.value = staff.id;
                
                // Format: "Nguy·ªÖn VƒÉn A (Admin)"
                option.textContent = `${staff.name} (${staff.role})`;
                filterStaff.appendChild(option);
            });

            filterStaff.value = currentValue;
        } catch (error) {
            console.error('Error loading staff list:', error);
        }
    }

    // ===== SEARCH IN CHAT FUNCTIONS =====
    function setupSearchInChat() {
        const searchBtn = document.getElementById('search-in-chat-btn');
        const searchToolbar = document.getElementById('search-in-chat-toolbar');
        const searchInput = document.getElementById('search-in-chat-input');
        const closeSearchBtn = document.getElementById('close-search-btn');
        const searchPrevBtn = document.getElementById('search-prev-btn');
        const searchNextBtn = document.getElementById('search-next-btn');

        searchBtn.addEventListener('click', () => {
            searchToolbar.style.display = 'block';
            searchInput.focus();
        });

        closeSearchBtn.addEventListener('click', () => {
            searchToolbar.style.display = 'none';
            clearSearchHighlights();
        });

        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const searchText = this.value.trim();
            
            // If empty, clear immediately
            if (!searchText) {
                clearSearchHighlights();
                return;
            }
            
            // Otherwise debounce the search
            searchTimeout = setTimeout(() => {
                performSearchInChat(searchText);
            }, 300);
        });

        searchPrevBtn.addEventListener('click', () => navigateSearchResults('prev'));
        searchNextBtn.addEventListener('click', () => navigateSearchResults('next'));

        // ESC to close
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                searchToolbar.style.display = 'none';
                clearSearchHighlights();
            }
        });
    }

    function performSearchInChat(searchText) {
        searchInChatResults = [];
        currentSearchIndex = -1;

        if (!searchText || searchText.length < 2) {
            updateSearchResultsCount();
            return;
        }

        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        const messageElements = chatMessages.querySelectorAll('.message-bubble');
        if (messageElements.length === 0) return;

        messageElements.forEach((element) => {
            const originalText = element.textContent || '';
            
            if (originalText.toLowerCase().includes(searchText.toLowerCase())) {
                const html = element.innerHTML;
                const regex = new RegExp(`(${escapeRegex(searchText)})`, 'gi');
                const newHTML = html.replace(regex, '<mark class="search-highlight" style="background-color: yellow !important; color: black !important; padding: 2px; font-weight: bold;">$1</mark>');
                
                if (newHTML !== html) {
                    element.innerHTML = newHTML;
                    const highlights = element.querySelectorAll('mark.search-highlight');
                    highlights.forEach(h => searchInChatResults.push(h));
                }
            }
        });

        if (searchInChatResults.length > 0) {
            currentSearchIndex = 0;
            navigateToSearchResult(0);
        }

        updateSearchResultsCount();
    }

    function navigateSearchResults(direction) {
        if (searchInChatResults.length === 0) return;

        if (direction === 'next') {
            currentSearchIndex = (currentSearchIndex + 1) % searchInChatResults.length;
        } else {
            currentSearchIndex = (currentSearchIndex - 1 + searchInChatResults.length) % searchInChatResults.length;
        }

        navigateToSearchResult(currentSearchIndex);
    }

    function navigateToSearchResult(index) {
        // Remove current class from all
        searchInChatResults.forEach(el => el.classList.remove('current'));

        // Add current class to selected
        const currentElement = searchInChatResults[index];
        currentElement.classList.add('current');

        // Scroll into view
        currentElement.scrollIntoView({ behavior: 'smooth', block: 'center' });

        updateSearchResultsCount();
    }

    function updateSearchResultsCount() {
        const countElement = document.getElementById('search-results-count');
        if (searchInChatResults.length === 0) {
            countElement.textContent = '0/0';
        } else {
            countElement.textContent = `${currentSearchIndex + 1}/${searchInChatResults.length}`;
        }
    }

    function highlightTextInNode(node, searchText) {
        const regex = new RegExp(`(${escapeRegex(searchText)})`, 'gi');
        
        function walk(node) {
            if (node.nodeType === 3) { // Text node
                const text = node.nodeValue;
                if (regex.test(text)) {
                    const span = document.createElement('span');
                    const highlightedHTML = text.replace(regex, '<span class="search-highlight">$1</span>');
                    span.innerHTML = highlightedHTML;
                    node.parentNode.replaceChild(span, node);
                }
            } else if (node.nodeType === 1 && node.nodeName !== 'SCRIPT' && node.nodeName !== 'STYLE') {
                for (let i = 0; i < node.childNodes.length; i++) {
                    walk(node.childNodes[i]);
                }
            }
        }
        
        walk(node);
    }

    function clearSearchHighlights() {
        const chatMessages = document.getElementById('chat-messages');
        if (!chatMessages) return;

        const marks = chatMessages.querySelectorAll('mark.search-highlight');
        marks.forEach(mark => {
            const parent = mark.parentNode;
            const textNode = document.createTextNode(mark.textContent);
            parent.replaceChild(textNode, mark);
        });

        const messageBubbles = chatMessages.querySelectorAll('.message-bubble');
        messageBubbles.forEach(bubble => bubble.normalize());

        searchInChatResults = [];
        currentSearchIndex = -1;
        updateSearchResultsCount();
    }

    function escapeRegex(string) {
        return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    }

    // ===== PRODUCT SEARCH MODAL =====
    let productSearchTimeout = null;
    let cachedProducts = []; // Cache ƒë·ªÉ tr√°nh g·ªçi API l·∫°i

    function openProductSearchModal() {
        // CLEAR k·∫øt qu·∫£ c≈© tr∆∞·ªõc khi m·ªü
        const resultsDiv = document.getElementById('product-search-results');
        resultsDiv.innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('productSearchModal'));
        modal.show();
        
        const searchInput = document.getElementById('product-search-input');
        searchInput.value = '';
        
        // Load all products initially
        searchProducts('');
        
        searchInput.focus();
        
        // Remove old listener ƒë·ªÉ tr√°nh duplicate
        const newInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newInput, searchInput);
        
        // Search on input
        newInput.addEventListener('input', function() {
            clearTimeout(productSearchTimeout);
            const query = this.value.trim();
            
            productSearchTimeout = setTimeout(() => searchProducts(query), 300);
        });
    }

    async function searchProducts(query) {
        const resultsDiv = document.getElementById('product-search-results');
        resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
        try {
            // D√πng C√ôNG API v·ªõi customer widget
            const response = await fetch(`/api/productapi/products?${query ? 'search=' + encodeURIComponent(query) + '&' : ''}pageSize=20`);
            const result = await response.json();
            const products = result.data || result || [];
            cachedProducts = products; // Cache l·∫°i ƒë·ªÉ d√πng khi select
            
            if (products.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m n√†o</p>
                    </div>`;
                return;
            }
            
            resultsDiv.innerHTML = products.map((p, index) => {
                const productImage = p.imageUrl || (p.images && p.images[0]) || '/images/no-image.png';
                const discountPrice = p.discountedPrice || p.discountPrice || null;
                const hasDiscount = discountPrice && discountPrice < p.price && p.hasDiscount;
                
                return `
                <div class="card mb-2 product-search-item" style="cursor: pointer;" onclick="selectProductFromCache(${index})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-3">
                                <img src="${productImage}" alt="${p.name}" onerror="this.src='/images/no-image.png'" class="img-fluid rounded" style="width: 100%; height: 80px; object-fit: cover;">
                            </div>
                            <div class="col-9">
                                <h6 class="mb-1">${p.name}</h6>
                                <p class="text-muted mb-1 small">${p.categoryName || ''}</p>
                                <div style="display: flex; flex-direction: column; gap: 2px;">
                                    ${hasDiscount ? `
                                        <span class="fw-bold" style="color: #ef4444; font-size: 16px;">${discountPrice.toLocaleString('vi-VN')}ƒë</span>
                                        <span class="text-muted" style="font-size: 12px; text-decoration: line-through;">${p.price.toLocaleString('vi-VN')}ƒë</span>
                                    ` : `
                                        <span class="fw-bold" style="color: #ef4444; font-size: 16px;">${p.price.toLocaleString('vi-VN')}ƒë</span>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `}).join('');
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m</p>
                </div>`;
        }
    }

    async function selectProductFromCache(index) {
        try {
            console.log('üîç Debug - chatConnection:', chatConnection);
            console.log('üîç Debug - currentConversationId:', currentConversationId);
            
            const product = cachedProducts[index];
            if (!product) {
                alert('Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m');
                return;
            }
            
            if (!chatConnection) {
                alert('Ch∆∞a k·∫øt n·ªëi chat. Vui l√≤ng th·ª≠ l·∫°i!');
                return;
            }
            
            if (!currentConversationId) {
                alert('Vui l√≤ng ch·ªçn m·ªôt cu·ªôc h·ªôi tho·∫°i tr∆∞·ªõc!');
                return;
            }
            
            const productImage = product.imageUrl || (product.images && product.images[0]) || '/images/no-image.png';
            const discountPrice = product.discountedPrice || product.discountPrice || null;
            // Ch·ªâ g·ª≠i discountPrice n·∫øu th·ª±c s·ª± c√≥ gi·∫£m gi√°
            const finalDiscountPrice = (discountPrice && discountPrice < product.price) ? discountPrice : null;
            
            const attachment = {
                type: 'product',
                productId: product.id,
                productName: product.name,
                price: product.price,
                discountPrice: finalDiscountPrice,
                imageUrl: productImage,
                url: `/Product/Details/${product.id}`
            };
            
            const message = `[ATTACHMENT:${JSON.stringify(attachment)}]`;
            await chatConnection.invoke('SendMessage', currentConversationId, message, null);
            
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('productSearchModal')).hide();
        } catch (error) {
            console.error('L·ªói g·ª≠i s·∫£n ph·∫©m:', error);
            alert('L·ªói khi g·ª≠i s·∫£n ph·∫©m: ' + (error.message || error));
        }
    }

    // ===== ORDER SEARCH MODAL =====
    let orderSearchTimeout = null;

    function openOrderSearchModal() {
        // CLEAR k·∫øt qu·∫£ c≈© tr∆∞·ªõc khi m·ªü
        const resultsDiv = document.getElementById('order-search-results');
        resultsDiv.innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('orderSearchModal'));
        modal.show();
        
        const searchInput = document.getElementById('order-search-input');
        searchInput.value = '';
        
        // QUAN TR·ªåNG: Load l·∫°i orders c·ªßa user HI·ªÜN T·∫†I
        searchOrders('');
        
        searchInput.focus();
        
        // Remove old listener ƒë·ªÉ tr√°nh duplicate
        const newInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newInput, searchInput);
        
        newInput.addEventListener('input', function() {
            clearTimeout(orderSearchTimeout);
            const query = this.value.trim();
            
            orderSearchTimeout = setTimeout(() => searchOrders(query), 300);
        });
    }

    async function searchOrders(query) {
        const resultsDiv = document.getElementById('order-search-results');
        resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
        try {
            // QUAN TR·ªåNG: Truy·ªÅn userId ƒë·ªÉ ch·ªâ hi·ªÉn th·ªã ƒë∆°n h√†ng c·ªßa user hi·ªán t·∫°i
            const url = `/api/OrderApi/search?q=${encodeURIComponent(query)}${currentUserId ? `&userId=${encodeURIComponent(currentUserId)}` : ''}`;
            const response = await fetch(url);
            const orders = await response.json();
            
            if (orders.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng n√†o</p>
                    </div>`;
                return;
            }
            
            resultsDiv.innerHTML = orders.map(o => `
                <div class="card mb-2 order-search-item" style="cursor: pointer;" data-order-id="${o.id}" data-order-display-id="${o.orderId}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">ƒê∆°n h√†ng #${o.orderId}</h6>
                                <p class="text-muted mb-1 small"><i class="fas fa-user"></i> ${o.customerName}</p>
                                <p class="text-muted mb-1 small"><i class="fas fa-clock"></i> ${new Date(o.orderDate).toLocaleDateString('vi-VN')}</p>
                            </div>
                            <div class="text-end">
                                <p class="text-primary fw-bold mb-1">${o.totalAmount.toLocaleString('vi-VN')}ƒë</p>
                                <span class="badge bg-${getOrderStatusColor(o.orderStatus)}">${o.orderStatus}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Add click handlers - d√πng ID (int) ƒë·ªÉ g·ªçi API
            document.querySelectorAll('.order-search-item').forEach(item => {
                item.addEventListener('click', function() {
                    const orderId = parseInt(this.dataset.orderId);  // ID th·ª±c (int)
                    selectOrder(orderId);
                });
            });
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>L·ªói khi t√¨m ki·∫øm ƒë∆°n h√†ng</p>
                </div>`;
        }
    }

    function getOrderStatusColor(status) {
        const colors = {
            'Ch·ªù x√°c nh·∫≠n': 'warning',
            'ƒê√£ x√°c nh·∫≠n': 'info',
            'ƒêang giao': 'primary',
            'ƒê√£ giao': 'success',
            'ƒê√£ h·ªßy': 'danger'
        };
        return colors[status] || 'secondary';
    }

    async function selectOrder(orderId) {
        try {
            const response = await fetch(`/api/OrderApi/chat/${orderId}`);
            const order = await response.json();
            
            const attachment = {
                type: 'order',
                id: orderId,  // ID (int) ƒë·ªÉ admin xem trong admin panel
                orderId: order.orderId,  // OrderId (string) ƒë·ªÉ hi·ªÉn th·ªã
                orderDate: order.orderDate,
                totalAmount: order.totalAmount,
                status: order.orderStatus,
                imageUrl: order.imageUrl || 'https://via.placeholder.com/80x80/8B5CF6/FFFFFF?text=üì¶',
                url: `/Order/Details/${orderId}`  // URL cho customer xem
            };
            
            const message = `[ATTACHMENT:${JSON.stringify(attachment)}]`;
            await chatConnection.invoke('SendMessage', currentConversationId, message, null);
            
            bootstrap.Modal.getInstance(document.getElementById('orderSearchModal')).hide();
        } catch (error) {
            console.error('L·ªói g·ª≠i ƒë∆°n h√†ng:', error);
            alert('L·ªói khi g·ª≠i ƒë∆°n h√†ng: ' + (error.message || error));
        }
    }

    // ===== BLOG SEARCH MODAL =====
    let blogSearchTimeout = null;

    function openBlogSearchModal() {
        // CLEAR k·∫øt qu·∫£ c≈© tr∆∞·ªõc khi m·ªü
        const resultsDiv = document.getElementById('blog-search-results');
        resultsDiv.innerHTML = '';
        
        const modal = new bootstrap.Modal(document.getElementById('blogSearchModal'));
        modal.show();
        
        const searchInput = document.getElementById('blog-search-input');
        searchInput.value = '';
        
        // Load all blogs initially
        searchBlogs('');
        
        searchInput.focus();
        
        // Remove old listener ƒë·ªÉ tr√°nh duplicate
        const newInput = searchInput.cloneNode(true);
        searchInput.parentNode.replaceChild(newInput, searchInput);
        
        newInput.addEventListener('input', function() {
            clearTimeout(blogSearchTimeout);
            const query = this.value.trim();
            
            blogSearchTimeout = setTimeout(() => searchBlogs(query), 300);
        });
    }

    async function searchBlogs(query) {
        const resultsDiv = document.getElementById('blog-search-results');
        resultsDiv.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x"></i></div>';
        
        try {
            const response = await fetch(`/api/BlogApi/search?q=${encodeURIComponent(query)}`);
            const blogs = await response.json();
            
            if (blogs.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-2x mb-2"></i>
                        <p>Kh√¥ng t√¨m th·∫•y b√†i vi·∫øt n√†o</p>
                    </div>`;
                return;
            }
            
            resultsDiv.innerHTML = blogs.map(b => `
                <div class="card mb-2 blog-search-item" style="cursor: pointer;" onclick="selectBlog(${b.blogId})">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-3">
                                <img src="${b.imageUrl || '/images/blog-placeholder.png'}" class="img-fluid rounded" alt="${b.title}">
                            </div>
                            <div class="col-9">
                                <h6 class="mb-1">${b.title}</h6>
                                <p class="text-muted mb-1 small">${b.summary || ''}</p>
                                <p class="text-muted mb-0 small"><i class="fas fa-calendar"></i> ${new Date(b.publishDate).toLocaleDateString('vi-VN')}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            resultsDiv.innerHTML = `
                <div class="text-center text-danger py-4">
                    <i class="fas fa-exclamation-circle fa-2x mb-2"></i>
                    <p>L·ªói khi t√¨m ki·∫øm b√†i vi·∫øt</p>
                </div>`;
        }
    }

    async function selectBlog(blogId) {
        try {
            const response = await fetch(`/api/BlogApi/${blogId}`);
            const blog = await response.json();
            
            const attachment = {
                type: 'blog',
                blogId: blog.blogId,
                title: blog.title,
                summary: blog.summary,
                imageUrl: blog.imageUrl,
                url: `/Blog/Details/${blog.blogId}`
            };
            
            const message = `[ATTACHMENT:${JSON.stringify(attachment)}]`;
            await chatConnection.invoke('SendMessage', currentConversationId, message, null);
            
            bootstrap.Modal.getInstance(document.getElementById('blogSearchModal')).hide();
        } catch (error) {
            console.error('L·ªói g·ª≠i b√†i vi·∫øt:', error);
            alert('L·ªói khi g·ª≠i b√†i vi·∫øt: ' + (error.message || error));
        }
    }

    // ===== MESSAGE OPTIONS MENU =====
    let isMultiSelectMode = false;
    let selectedMessages = new Set();

    // Toggle options menu when clicking 3-dot button
    document.addEventListener('click', function(e) {
        const optionsBtn = e.target.closest('.message-options-btn');
        
        if (optionsBtn) {
            e.stopPropagation();
            
            // Close all other menus
            document.querySelectorAll('.message-options-menu').forEach(menu => {
                if (menu !== optionsBtn.nextElementSibling) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle current menu
            const menu = optionsBtn.nextElementSibling;
            menu.classList.toggle('show');
        } else {
            // Close all menus if clicking outside
            document.querySelectorAll('.message-options-menu').forEach(menu => {
                menu.classList.remove('show');
            });
        }
    });

    function enterMultiSelectMode() {
        isMultiSelectMode = true;
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.classList.add('multi-select-mode');
        
        // Show multi-select toolbar
        document.getElementById('multi-select-toolbar').style.display = 'block';
        
        // Hide all options menus
        document.querySelectorAll('.message-options-menu').forEach(menu => {
            menu.classList.remove('show');
        });
    }

    function exitMultiSelectMode() {
        isMultiSelectMode = false;
        const messagesContainer = document.getElementById('chat-messages');
        messagesContainer.classList.remove('multi-select-mode');
        
        // Hide multi-select toolbar
        document.getElementById('multi-select-toolbar').style.display = 'none';
        
        // Clear selections
        selectedMessages.clear();
        document.querySelectorAll('.message-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateSelectedCount();
    }

    // Handle checkbox changes
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('message-checkbox')) {
            const messageId = parseInt(e.target.getAttribute('data-message-id'));
            
            if (e.target.checked) {
                selectedMessages.add(messageId);
            } else {
                selectedMessages.delete(messageId);
            }
            
            updateSelectedCount();
        }
    });

    function updateSelectedCount() {
        document.getElementById('selected-count').textContent = selectedMessages.size;
    }

    // Cancel multi-select mode
    document.getElementById('cancel-multi-select-btn').addEventListener('click', exitMultiSelectMode);

    // Delete selected messages
    document.getElementById('delete-selected-btn').addEventListener('click', async function() {
        if (selectedMessages.size === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt tin nh·∫Øn ƒë·ªÉ x√≥a');
            return;
        }
        
        if (!confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ${selectedMessages.size} tin nh·∫Øn ƒë√£ ch·ªçn?`)) {
            return;
        }
        
        try {
            const response = await fetch('/api/supportchat/messages', {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(Array.from(selectedMessages))
            });
            
            if (response.ok) {
                // Remove messages from UI
                selectedMessages.forEach(id => {
                    const checkbox = document.querySelector(`.message-checkbox[data-message-id="${id}"]`);
                    if (checkbox) {
                        checkbox.closest('.d-flex').remove();
                    }
                });
                
                exitMultiSelectMode();
                alert('ƒê√£ x√≥a tin nh·∫Øn th√†nh c√¥ng');
            } else {
                alert('Kh√¥ng th·ªÉ x√≥a tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } catch (error) {
            console.error('Error deleting messages:', error);
            alert('L·ªói khi x√≥a tin nh·∫Øn');
        }
    });

    // Delete single message
    async function deleteSingleMessage(messageId) {
        if (!confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a tin nh·∫Øn n√†y?')) {
            return;
        }
        
        try {
            const response = await fetch(`/api/supportchat/message/${messageId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                // Remove message from UI
                const checkbox = document.querySelector(`.message-checkbox[data-message-id="${messageId}"]`);
                if (checkbox) {
                    checkbox.closest('.d-flex').remove();
                }
                alert('ƒê√£ x√≥a tin nh·∫Øn th√†nh c√¥ng');
            } else {
                alert('Kh√¥ng th·ªÉ x√≥a tin nh·∫Øn. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } catch (error) {
            console.error('Error deleting message:', error);
            alert('L·ªói khi x√≥a tin nh·∫Øn');
        }
    }

    // ===== CHAT TRANSFER =====
    async function loadStaffForTransfer() {
        try {
            const response = await fetch('/api/supportchat/staff-list');
            if (response.ok) {
                const staffList = await response.json();
                const select = document.getElementById('transfer-staff-select');
                select.innerHTML = '<option value="">-- Ch·ªçn staff --</option>';
                
                staffList.forEach(staff => {
                    const option = document.createElement('option');
                    option.value = staff.id;
                    option.textContent = `${staff.name} (${staff.role})`;
                    select.appendChild(option);
                });
            }
        } catch (error) {
            console.error('Error loading staff for transfer:', error);
        }
    }

    document.getElementById('transfer-chat-btn')?.addEventListener('click', async function() {
        if (!currentConversationId) {
            alert('Vui l√≤ng ch·ªçn conversation ƒë·ªÉ chuy·ªÉn');
            return;
        }
        
        await loadStaffForTransfer();
        const modal = new bootstrap.Modal(document.getElementById('transferChatModal'));
        modal.show();
    });

    document.getElementById('confirm-transfer-btn')?.addEventListener('click', async function() {
        const staffId = document.getElementById('transfer-staff-select').value;
        const reason = document.getElementById('transfer-reason').value;
        const notify = document.getElementById('transfer-notify').checked;

        if (!staffId) {
            alert('Vui l√≤ng ch·ªçn staff ƒë·ªÉ chuy·ªÉn');
            return;
        }

        try {
            const response = await fetch(`/api/supportchat/transfer/${currentConversationId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ staffId, reason, notify })
            });

            if (response.ok) {
                bootstrap.Modal.getInstance(document.getElementById('transferChatModal')).hide();
                showSuccessToast('ƒê√£ chuy·ªÉn conversation th√†nh c√¥ng!');
                loadConversations();
                
                // Clear form
                document.getElementById('transfer-staff-select').value = '';
                document.getElementById('transfer-reason').value = '';
            } else {
                alert('Kh√¥ng th·ªÉ chuy·ªÉn conversation. Vui l√≤ng th·ª≠ l·∫°i.');
            }
        } catch (error) {
            console.error('Error transferring conversation:', error);
            alert('L·ªói khi chuy·ªÉn conversation');
        }
    });

    // Analytics moved to separate page: /Admin/Chat/Analytics
</script>
